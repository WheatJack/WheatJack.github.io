<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://WheatJack.github.io</id>
    <title>JackJack</title>
    <updated>2024-01-25T03:48:49.722Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://WheatJack.github.io"/>
    <link rel="self" href="https://WheatJack.github.io/atom.xml"/>
    <subtitle>è®°å½•è‡ªå·±çš„ç”Ÿæ´»</subtitle>
    <logo>https://WheatJack.github.io/images/avatar.png</logo>
    <icon>https://WheatJack.github.io/favicon.ico</icon>
    <rights>All rights reserved 2024, JackJack</rights>
    <entry>
        <title type="html"><![CDATA[Macè®¾ç½®å¤šä¸ªJDKç‰ˆæœ¬]]></title>
        <id>https://WheatJack.github.io/post/mac-she-zhi-duo-ge-jdk-ban-ben/</id>
        <link href="https://WheatJack.github.io/post/mac-she-zhi-duo-ge-jdk-ban-ben/">
        </link>
        <updated>2024-01-25T03:18:11.000Z</updated>
        <content type="html"><![CDATA[<ol>
<li>
<p>å»Oracleä¸‹è½½å¤šä¸ªéœ€è¦çš„ç‰ˆæœ¬,å¹¶ä¸€æ­¥æ­¥nextå®‰è£…</p>
<blockquote>
<p>https://www.oracle.com/cn/java/technologies/downloads/</p>
</blockquote>
</li>
<li>
<p>ç¼–è¾‘bash_profileæ–‡ä»¶</p>
<blockquote>
<pre><code class="language-shell">vi ~/.bash_profile
</code></pre>
<p>æ–°å¢é…ç½®ï¼š</p>
<pre><code class="language-shell"># è®¾ç½® jdk1.8
 
export JAVA_8_HOME='$(/usr/libexec/java_home -v 1.8)'
 
# è®¾ç½® jdk17
 
export JAVA_17_HOME='$(/usr/libexec/java_home -v 17)'
 
# é»˜è®¤ jdk ä½¿ç”¨1.8ç‰ˆæœ¬
 
JAVA_HOME=$JAVA_8_HOME
 
PATH=$JAVA_HOME/bin:$PATH
 
CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
 
  export JAVA_HOME PATH CLASSPATH
  
  alias jdk11=&quot;export JAVA_HOME=$JAVA_11_HOME&quot; 
 
alias jdk8=&quot;export JAVA_HOME=$JAVA_8_HOME&quot;
</code></pre>
<p>åˆ·æ–°é…ç½®</p>
<pre><code class="language-shell">source ï½/.bash_profile
</code></pre>
</blockquote>
</li>
<li>
<p>ç¼–è¾‘ /etc/profile æ–‡ä»¶</p>
<blockquote>
<pre><code class="language-shell">vi /etc/profile
</code></pre>
<p>å¢åŠ é…ç½®</p>
<pre><code> alias jdk11=&quot;export JAVA_HOME=$JAVA_11_HOME&quot; 
 
alias jdk8=&quot;export JAVA_HOME=$JAVA_8_HOME&quot;
</code></pre>
<p>åˆ·æ–°é…ç½®</p>
<pre><code>source /etc/profile
</code></pre>
</blockquote>
</li>
<li>
<p>éªŒè¯</p>
</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://WheatJack.github.io/post-images/1706153997556.png" alt="éªŒè¯å›¾ç‰‡" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Mysql åŸºç¡€ç¯‡]]></title>
        <id>https://WheatJack.github.io/post/mysql-ji-chu-pian/</id>
        <link href="https://WheatJack.github.io/post/mysql-ji-chu-pian/">
        </link>
        <updated>2022-02-27T07:39:57.000Z</updated>
        <content type="html"><![CDATA[<h1 id="mysqlå­¦ä¹ ">MYSQLå­¦ä¹ </h1>
<blockquote>
<p>å¼€å§‹å­¦ä¹ mysqläº†ï¼Œå¥¥åŠ›ç»™â›½ï¸â›½ï¸</p>
</blockquote>
<h1 id="ä¸€-åŸºç¡€å­¦ä¹ ">ä¸€ã€åŸºç¡€å­¦ä¹ </h1>
<h2 id="1-é€šç”¨è¯­æ³•åŠåˆ†ç±»">1ã€é€šç”¨è¯­æ³•åŠåˆ†ç±»</h2>
<h3 id="sqlåˆ†ç±»">SQLåˆ†ç±»</h3>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzjxc4b8mmj20m00663z3.jpg" alt="image-20220220134319454" loading="lazy"></figure>
<h4 id="ddlè¯­å¥">DDLè¯­å¥</h4>
<h5 id="æ•°æ®åº“æ“ä½œ-crud">æ•°æ®åº“æ“ä½œ-CRUD</h5>
<pre><code class="language-mysql">// æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“
show Database;
// æŸ¥è¯¢å½“å‰æ•°æ®åº“
select database();
// åˆ›å»ºæ•°æ®åº“
Create database [if not exists] æ•°æ®åº“å [default charset utf8mb4][collate æ’åºè§„åˆ™];
// åˆ é™¤æ•°æ®åº“
drop database  if exists test_database;
// ä½¿ç”¨æ•°æ®åº“
use test_database;

</code></pre>
<h5 id="è¡¨æ“ä½œ-æŸ¥è¯¢">è¡¨æ“ä½œ-æŸ¥è¯¢</h5>
<pre><code class="language-mysql">// æŸ¥è¯¢æ•°æ®åº“æ‰€æœ‰çš„è¡¨
show tables;
// æŸ¥è¯¢æ‰€æœ‰è¡¨çš„çŠ¶æ€
show table status;
// æŸ¥è¯¢è¡¨ç»“æ„
desc table_name;
// æŸ¥è¯¢æŒ‡å®šè¡¨çš„å»ºè¡¨è¯­å¥
show create table table_name;
</code></pre>
<h5 id="è¡¨æ“ä½œ-åˆ›å»º">è¡¨æ“ä½œ-åˆ›å»º</h5>
<pre><code class="language-mysql">// åˆ›å»ºè¡¨--ç»“æ„
CREATE TABLE table_name (
'id' varchar(50) [comment æ³¨é‡Š],
'id' varchar(50) [comment æ³¨é‡Š],
'id' varchar(50) [comment æ³¨é‡Š],
)[comment è¡¨æ³¨é‡Š];

// åˆ›å»ºè¡¨
CREATE TABLE `employ` (
  `id` varchar(50) NOT NULL COMMENT 'ä¸»å¥id',
  `name` varchar(5) DEFAULT NULL COMMENT 'name',
  `time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `age` int DEFAULT NULL COMMENT 'å¹´çºª',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='å‘˜å·¥è¡¨';
</code></pre>
<h5 id="è¡¨æ•°æ®ç±»å‹åŠæ¡ˆä¾‹">è¡¨æ•°æ®ç±»å‹åŠæ¡ˆä¾‹</h5>
<h6 id="æ•°å€¼ç±»å‹"><strong>æ•°å€¼ç±»å‹</strong></h6>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>å¤§å°</th>
<th>æœ‰ç¬¦å·(SIGNED)èŒƒå›´</th>
<th>æ— ç¬¦å·(UNSIGNED)èŒƒå›´</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>TINYINT</td>
<td>1  byte</td>
<td>(-128ï¼Œ127)</td>
<td>(0ï¼Œ255)</td>
<td>å°æ•´æ•°å€¼</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>2  bytes</td>
<td>(-32768ï¼Œ32767)</td>
<td>(0ï¼Œ65535)</td>
<td>å¤§æ•´æ•°å€¼</td>
</tr>
<tr>
<td>MEDIUMINT</td>
<td>3  bytes</td>
<td>(-8388608ï¼Œ8388607)</td>
<td>(0ï¼Œ16777215)</td>
<td>å¤§æ•´æ•°å€¼</td>
</tr>
<tr>
<td>INTæˆ–INTEGER</td>
<td>4  bytes</td>
<td>(-2147483648ï¼Œ2147483647)</td>
<td>(0ï¼Œ4294967295)</td>
<td>å¤§æ•´æ•°å€¼</td>
</tr>
<tr>
<td>BIGINT</td>
<td>8  bytes</td>
<td>(-2<sup>63ï¼Œ2</sup>63-1)</td>
<td>(0ï¼Œ2^64-1)</td>
<td>æå¤§æ•´æ•°å€¼</td>
</tr>
<tr>
<td>FLOAT</td>
<td>4  bytes</td>
<td>(-3.402823466 E+38ï¼Œ3.402823466351  E+38)</td>
<td>0 å’Œ (1.175494351  E-38ï¼Œ3.402823466 E+38)</td>
<td>å•ç²¾åº¦æµ®ç‚¹æ•°å€¼</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8  bytes</td>
<td>(-1.7976931348623157 E+308ï¼Œ1.7976931348623157 E+308)</td>
<td>0 å’Œ  (2.2250738585072014 E-308ï¼Œ1.7976931348623157 E+308)</td>
<td>åŒç²¾åº¦æµ®ç‚¹æ•°å€¼</td>
</tr>
<tr>
<td>DECIMAL</td>
<td></td>
<td>ä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)çš„å€¼</td>
<td>ä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)çš„å€¼</td>
<td>å°æ•°å€¼(ç²¾ç¡®å®šç‚¹æ•°)</td>
</tr>
</tbody>
</table>
<h6 id="å­—ç¬¦ä¸²ç±»å‹">å­—ç¬¦ä¸²ç±»å‹</h6>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>å¤§å°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHAR</td>
<td>0-255 bytes</td>
<td>å®šé•¿å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>VARCHAR</td>
<td>0-65535 bytes</td>
<td>å˜é•¿å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>TINYBLOB</td>
<td>0-255 bytes</td>
<td>ä¸è¶…è¿‡255ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>TINYTEXT</td>
<td>0-255 bytes</td>
<td>çŸ­æ–‡æœ¬å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>BLOB</td>
<td>0-65 535 bytes</td>
<td>äºŒè¿›åˆ¶å½¢å¼çš„é•¿æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>TEXT</td>
<td>0-65 535 bytes</td>
<td>é•¿æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>MEDIUMBLOB</td>
<td>0-16 777 215 bytes</td>
<td>äºŒè¿›åˆ¶å½¢å¼çš„ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>0-16 777 215 bytes</td>
<td>ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>LONGBLOB</td>
<td>0-4 294 967 295 bytes</td>
<td>äºŒè¿›åˆ¶å½¢å¼çš„æå¤§æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>0-4 294 967 295 bytes</td>
<td>æå¤§æ–‡æœ¬æ•°æ®</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">explain</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">char(10)  -----------&gt; æ€§èƒ½å¥½</td>
<td>ç”¨æˆ·å username   varchar(50)</td>
</tr>
<tr>
<td style="text-align:left">varchar(10)  ---------&gt; æ€§èƒ½è¾ƒå·®</td>
<td>æ€§åˆ« gender   char(1)</td>
</tr>
</tbody>
</table>
<h6 id="æ—¶é—´ç±»å‹"><strong>æ—¶é—´ç±»å‹</strong></h6>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>å¤§å°</th>
<th>èŒƒå›´</th>
<th>æ ¼å¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>DATE</td>
<td>3</td>
<td>1000-01-01 è‡³  9999-12-31</td>
<td>YYYY-MM-DD</td>
<td>æ—¥æœŸå€¼</td>
</tr>
<tr>
<td>TIME</td>
<td>3</td>
<td>-838:59:59 è‡³  838:59:59</td>
<td>HH:MM:SS</td>
<td>æ—¶é—´å€¼æˆ–æŒç»­æ—¶é—´</td>
</tr>
<tr>
<td>YEAR</td>
<td>1</td>
<td>1901 è‡³ 2155</td>
<td>YYYY</td>
<td>å¹´ä»½å€¼</td>
</tr>
<tr>
<td>DATETIME</td>
<td>8</td>
<td>1000-01-01 00:00:00 è‡³ 9999-12-31 23:59:59</td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>æ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>4</td>
<td>1970-01-01 00:00:01 è‡³ 2038-01-19 03:14:07</td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>æ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼ï¼Œæ—¶é—´æˆ³</td>
</tr>
</tbody>
</table>
<h5 id="è¡¨ç»“æ„-ä¿®æ”¹">è¡¨ç»“æ„-ä¿®æ”¹</h5>
<pre><code class="language-mysql">// æ–°å¢å­—æ®µ
alter table table_name add å­—æ®µ ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// åªä¿®æ”¹æ•°æ®ç±»å‹
alter table table_name modify å­—æ®µ ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// ä¿®æ”¹å­—æ®µåå’Œå­—æ®µç±»å‹
Alter table table_name change æ—§å­—æ®µå æ–°å­—æ®µå ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// åˆ é™¤å­—æ®µ
alter table table_name drop å­—æ®µå;
// ä¿®æ”¹è¡¨å
alter table table_name rename to new_table_name;
// åˆ é™¤è¡¨
drop table if exists table_name;
// åˆ é™¤(æˆªæ–­)æŒ‡å®šè¡¨ å¹¶é‡æ–°åˆ›å»ºè¯¥è¡¨
truncate table table_name;
</code></pre>
<h4 id="dmlè¯­å¥">DMLè¯­å¥</h4>
<h5 id="æ·»åŠ æ•°æ®">æ·»åŠ æ•°æ®</h5>
<pre><code class="language-mysql">// ç»™æŒ‡å®šå­—æ®µæ·»åŠ æ•°æ®
insert into table_name (å­—æ®µ1,å­—æ®µ2) values (å€¼1,å€¼2......);
// ç»™å…¨éƒ¨å­—æ®µæ·»åŠ æ•°æ®
insert into table_name values (å€¼1,å€¼2......);
// æ‰¹é‡æ·»åŠ æ•°æ®
insert into table_name (å­—æ®µ1,å­—æ®µ2) values (å€¼1,å€¼2......),(å€¼1,å€¼2......),(å€¼1,å€¼2......);
insert into table_name values (å€¼1,å€¼2......),(å€¼1,å€¼2......),(å€¼1,å€¼2......);
// ä»åˆ«çš„è¡¨å–æ•° æ’å…¥åˆ°è¿™ä¸ªè¡¨
insert into table_name select * from table_name2;
</code></pre>
<p>Notesï¼š</p>
<ul>
<li>æ’å…¥æ•°æ®æ—¶ï¼ŒæŒ‡å®šçš„å­—æ®µé¡ºåºéœ€è¦ä¸å€¼çš„é¡ºåºä¸€ä¸€å¯¹åº”çš„</li>
<li><strong>å­—ç¬¦ä¸²å’Œæ—¥æœŸç±»å‹åº”è¯¥åŒ…å«åœ¨å¼•å·ä¸­</strong></li>
<li>æ’å…¥çš„æ•°æ®å¤§å° åº”è¯¥åœ¨å­—æ®µçš„è§„å®šèŒƒå›´å†…</li>
</ul>
<h5 id="ä¿®æ”¹æ•°æ®">ä¿®æ”¹æ•°æ®</h5>
<pre><code class="language-mysql">// æ›´æ–°æ•°æ®
update table_name set å­—æ®µ1=å€¼1,å­—æ®µ2=å€¼2	.... [where æ¡ä»¶];
// åˆ é™¤æ•°æ®
delete from table_name  [where æ¡ä»¶];
</code></pre>
<h4 id="dqlè¯­å¥">DQLè¯­å¥</h4>
<pre><code class="language-mysql">// ç»“æ„
select 
	å­—æ®µåˆ—è¡¨ 
from 
	table_name 
where æ¡ä»¶åˆ—è¡¨ 
group by åˆ†ç»„å­—æ®µåˆ—è¡¨ 
having åˆ†ç»„åæ¡ä»¶æŸ¥è¯¢ 
order by æ’åºå­—æ®µåˆ—è¡¨ 
limit åˆ†é¡µå‚æ•° ;
</code></pre>
<p><strong>æŸ¥è¯¢å­¦ä¹ ï¼š</strong></p>
<ul>
<li>åŸºæœ¬æŸ¥è¯¢</li>
<li>æ¡ä»¶æŸ¥è¯¢ where</li>
<li>èšåˆå‡½æ•° ï¼ˆcountã€maxã€minã€avgã€sumï¼‰</li>
<li>åˆ†ç»„æŸ¥è¯¢ group by</li>
<li>æ’åºæŸ¥è¯¢ order by</li>
<li>åˆ†é¡µæŸ¥è¯¢ limit</li>
</ul>
<h5 id="åŸºæœ¬æŸ¥è¯¢">åŸºæœ¬æŸ¥è¯¢</h5>
<pre><code class="language-mysql">// æŸ¥è¯¢å…¨éƒ¨
select * from table_name;
// è®¾ç½®å­—æ®µåˆ«å  as å¯ä»¥çœç•¥
select name as userName from table_name;
// å»é™¤é‡å¤ distinct
select distinct name from table_name;

</code></pre>
<h5 id="æ¡ä»¶æŸ¥è¯¢">æ¡ä»¶æŸ¥è¯¢</h5>
<pre><code class="language-mysql">select * from table_name where æ¡ä»¶åˆ—è¡¨;
// æŸ¥è¯¢åå­—ä¸ºä¸¤ä¸ªå­—çš„å‘˜å·¥ä¿¡æ¯---ä½¿ç”¨like æˆ–è€…ä½¿ç”¨length
select * from emp where name like '__';
</code></pre>
<p><strong>æ¡ä»¶åˆ—è¡¨ï¼š</strong></p>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzk0fhu4bij20ed08qgm2.jpg" alt="image-20220220153026880" loading="lazy"></figure>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzk0fv6c9kj20do03u0st.jpg" alt="image-20220220153048518" loading="lazy"></figure>
<hr>
<h5 id="èšåˆå‡½æ•°">èšåˆå‡½æ•°</h5>
<blockquote>
<p>å°†<strong>ä¸€åˆ—</strong>æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘è®¡ç®—</p>
<p><strong>æ‰€æœ‰çš„nullå€¼æ˜¯ä¸å‚ä¸èšåˆå‡½æ•°çš„</strong></p>
</blockquote>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzk0mip1bgj20f204wjrf.jpg" alt="image-20220220153712548" loading="lazy"></figure>
<pre><code class="language-mysql">// è¯­æ³•
select max(age) from table_name;
</code></pre>
<hr>
<h5 id="åˆ†ç»„æŸ¥è¯¢">åˆ†ç»„æŸ¥è¯¢</h5>
<pre><code class="language-mysql">// è¯­æ³•
select å­—æ®µåˆ—è¡¨ from table_name where æ¡ä»¶  group by åˆ†ç»„å­—æ®µå having  åˆ†ç»„è¿‡æ»¤æ¡ä»¶;
</code></pre>
<p><strong>WHEREä¸HAVINGçš„åŒºåˆ«ï¼š</strong></p>
<ul>
<li>æ‰§è¡Œæ—¶æœºä¸åŒï¼š<strong>where æ˜¯åˆ†ç»„ä¹‹å‰</strong>è¿›è¡Œè¿‡æ»¤çš„ ä¸æ»¡è¶³whereæ¡ä»¶ ä¸å‚ä¸åˆ†ç»„ï¼›<strong>havingæ˜¯åˆ†ç»„ä¹‹å</strong>å¯¹ç»“æœè¿›è¡Œè¿‡æ»¤</li>
<li>åˆ¤æ–­æ¡ä»¶ä¸åŒï¼šwhereä¸èƒ½å¯¹èšåˆå‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼Œè€Œhavingå¯ä»¥</li>
</ul>
<p><strong>Notesï¼š</strong></p>
<ul>
<li>æ‰§è¡Œé¡ºåºï¼šwhere&gt;èšåˆå‡½æ•°&gt;having</li>
<li>åˆ†ç»„ä¹‹åï¼ŒæŸ¥è¯¢çš„å­—æ®µä¸€èˆ¬ä¸ºèšåˆå‡½æ•°å’Œåˆ†ç»„å­—æ®µï¼ŒæŸ¥è¯¢å…¶ä»–å­—æ®µæ— ä»»ä½•æ„ä¹‰</li>
</ul>
<hr>
<h5 id="æ’åºæŸ¥è¯¢">æ’åºæŸ¥è¯¢</h5>
<pre><code class="language-mysql">// è¯­æ³•  é»˜è®¤asc  
Select å­—æ®µåˆ—è¡¨ from table_name  order by å­—æ®µ1 asc,å­—æ®µ2 desc;
</code></pre>
<hr>
<h5 id="åˆ†é¡µæŸ¥è¯¢">åˆ†é¡µæŸ¥è¯¢</h5>
<pre><code class="language-mysql">// è¯­æ³•
select * from table_name limit èµ·å§‹ç´¢å¼•,æŸ¥è¯¢è®°å½•æ•°;

</code></pre>
<p><strong>Notes:</strong></p>
<ul>
<li>èµ·å§‹ç´¢å¼• ä»0å¼€å§‹ èµ·å§‹ç´¢å¼•= æŸ¥è¯¢é¡µç -1  * æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°</li>
<li>åˆ†é¡µæŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æ–¹è¨€ï¼Œä¸åŒçš„æ•°æ®åº“æœ‰ä¸åŒçš„å®ç° Mysqlæ˜¯Limit</li>
<li>å¦‚æœæŸ¥è¯¢çš„æ˜¯ç¬¬ä¸€é¡µæ•°æ®ï¼Œèµ·å§‹ç´¢å¼•å¯ä»¥çœç•¥ï¼Œç›´æ¥ç®€å†™ä¸º limit 10</li>
</ul>
<hr>
<h5 id="æ‰§è¡Œé¡ºåº">æ‰§è¡Œé¡ºåº</h5>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzk99ryqehj20t80crwfo.jpg" alt="image-20220220203618076" loading="lazy"></figure>
<hr>
<h4 id="dclè¯­å¥">DCLè¯­å¥</h4>
<blockquote>
<p>Data Control Language ï¼Œç”¨æ¥ç®¡ç†æ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™ç­‰ç­‰</p>
</blockquote>
<h5 id="åŸºç¡€crud">åŸºç¡€CRUD</h5>
<pre><code class="language-mysql">// ä½¿ç”¨mysql åº“
use mysql;
// æŸ¥è¯¢ç”¨æˆ·
select * from user;

// åˆ›å»ºç”¨æˆ· test_user
create user 'test_user'@'ä¸»æœºåï¼šlocalhost' identified  by '123456';

// ä¿®æ”¹ç”¨æˆ·å¯†ç 
alter user 'test_user ç”¨æˆ·å'@'ä¸»æœºå: localhost' identified  with mysql_native_password By 'æ–°å¯†ç ';

// åˆ é™¤ç”¨æˆ·
drop user 'test_user ç”¨æˆ·å'@'ä¸»æœºå: localhost';
</code></pre>
<hr>
<h5 id="æƒé™æ§åˆ¶">æƒé™æ§åˆ¶</h5>
<p>æƒé™åˆ—è¡¨</p>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzkbahykr6j20t409xwf0.jpg" alt="image-20220220214614372" loading="lazy"></figure>
<pre><code class="language-mysql">// æŸ¥è¯¢æƒé™
SHOW GRANTS FOR 'root'@'%';

// æˆäºˆæƒé™ å¦‚æœæˆäºˆæ‰€æœ‰çš„ å°±ä½¿ç”¨*.*
GRANTS æƒé™åˆ—è¡¨ ON æ•°æ®åº“.è¡¨å TO 'ç”¨æˆ·åï¼štest_user'@'ä¸»æœºåï¼šlocalhost';
grant all on *.* to 'test_user'@'localhost';

//æ’¤é”€æƒé™
REVOKE æƒé™åˆ—è¡¨ ON æ•°æ®åº“.è¡¨å FROM 'ç”¨æˆ·åï¼štest_user'@'ä¸»æœºåï¼šlocalhost';
REVOKE all ON *.* FROM 'test_user'@'localhost';

</code></pre>
<h3 id="2-å‡½æ•°">2ã€å‡½æ•°</h3>
<blockquote>
<p>å¯ä»¥ç›´æ¥è¢«è°ƒç”¨çš„ç¨‹åºæˆ–ä»£ç </p>
</blockquote>
<h4 id="å­—ç¬¦ä¸²å‡½æ•°">å­—ç¬¦ä¸²å‡½æ•°</h4>
<figure data-type="image" tabindex="7"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzkburecjrj20t80aewfq.jpg" alt="image-20220220220543391" loading="lazy"></figure>
<pre><code class="language-mysql">// å­—ç¬¦ä¸²æ‹¼æ¥
select concat('aaaa', name) from employ where id = 1;
select concat('hello', 'world');
// è½¬å¤§å°å†™
select lower('hello');
select upper('hello');
// å·¦å³å¡«å……
select  lpad('aaa',10,'___');
select  rpad('aaa',10,'___');
// å»æ‰ç©ºæ ¼
select  trim(' hello world  ');
// æˆªå–å­—ç¬¦ä¸²
select  substr('11aaaaaa',1,5);
</code></pre>
<p><strong>æ¡ˆä¾‹ï¼šä½¿å¾—å‘˜å·¥ç¼–å·å°äº5ä½çš„å‰é¢è‡ªåŠ¨è¡¥0ï¼Œä¾‹å¦‚ 1å˜æˆ00001ï¼›</strong></p>
<pre><code class="language-mysql">update employ set  id = lpad(id,5,'0');
</code></pre>
<hr>
<h4 id="æ•°å€¼å‡½æ•°">æ•°å€¼å‡½æ•°</h4>
<figure data-type="image" tabindex="8"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gznrhydzjlj20ri07fwex.jpg" alt="image-20220223212333518" loading="lazy"></figure>
<pre><code class="language-mysql">// å‘ä¸Šå–æ•´ --13
select ceil(12.1);
// å‘ä¸‹å–æ•´  --1
select floor(1.1);
//è¿”å›x/yçš„æ¨¡ --20
select mod(20,100);
// è¿”å›0-1çš„éšæœºæ•°
select rand();
// å‚æ•°xçš„å››èˆäº”å…¥ï¼Œä¿ç•™æŒ‡å®šå°æ•° ----1.2222
select round(1.222222,4);
</code></pre>
<p><strong>ç”Ÿæˆ6ä½éšæœºæ•°</strong></p>
<pre><code class="language-mysql">select lpad(round((select rand()*1000000),0),6,'0');
</code></pre>
<hr>
<h4 id="æ—¥æœŸå‡½æ•°">æ—¥æœŸå‡½æ•°</h4>
<figure data-type="image" tabindex="9"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gznrtp75f4j20rr0bbmy7.jpg" alt="image-20220223213455206" loading="lazy"></figure>
<pre><code class="language-mysql">-- å½“å‰æ—¥æœŸ  2022-03-15
select curdate();
-- å½“å‰æ—¶é—´  21:04:07
select curtime();
-- å½“å‰æ—¥æœŸå’Œæ—¶é—´2022-03-15 21:04:32
select now();
// è·å–dataçš„å¹´ä»½
select year(now());
// è·å–dataçš„æœˆä»½
select month(now());
// è·å–dataçš„æ—¥ä»½
select day(now());
// æ˜¯æ—¶é—´ç›¸åŠ 
select date_add(now(),INTERVAL 100 YEAR );
select date_add(now(),INTERVAL 100 day );
select date_add(now(),INTERVAL 100 month );
// æ—¶é—´å·®
select datediff(now(),now());
</code></pre>
<hr>
<h4 id="æµç¨‹å‡½æ•°">æµç¨‹å‡½æ•°</h4>
<figure data-type="image" tabindex="10"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzns458rvyj20rs06pq3n.jpg" alt="image-20220223214454850" loading="lazy"></figure>
<pre><code class="language-mysql">-- IFNULL
select ifnull('',111);
select ifnull('2222',111);
select ifnull(null,'22');
-- IF
select if(true,'1','0');
-- CASE WHEN
select name, (case age when 10 then '10å²' when 11 then '11å²' else 'ä¸æ˜¯è¿™ä¸ªå¹´çºª' end) as age
from employ;

</code></pre>
<hr>
<h3 id="3-çº¦æŸ">3ã€çº¦æŸ</h3>
<blockquote>
<p><strong>ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œç”¨äºé™åˆ¶å­˜å‚¨åœ¨è¡¨ä¸­çš„æ•°æ®</strong></p>
</blockquote>
<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>
<figure data-type="image" tabindex="11"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gznsitdjlgj20ok081q3y.jpg" alt="image-20220223215903635" loading="lazy"></figure>
<p>Notesï¼š</p>
<p><strong>çº¦æŸæ˜¯ä½œç”¨äºè¡¨å­—æ®µä¸Šçš„ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨/ä¿®æ”¹è¡¨çš„æ—¶å€™æ·»åŠ çº¦æŸ</strong></p>
<h4 id="çº¦æŸæ¼”ç¤º">çº¦æŸæ¼”ç¤º</h4>
<p>id ä¸»é”®ã€è‡ªåŠ¨å¢é•¿</p>
<p>name ä¸ä¸ºç©º å”¯ä¸€</p>
<p>age &gt;0 å°äºç­‰äº120</p>
<p>status å¦‚æœæ²¡æœ‰æŒ‡å®šå€¼ï¼Œé»˜è®¤ä¸º1</p>
<pre><code class="language-mysql">CREATE TABLE `table_user` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(10) NOT NULL COMMENT 'name',
  `age` int DEFAULT NULL COMMENT 'å¹´çºª',
  `status` char(1) DEFAULT '1' COMMENT 'status',
  `gender` char(1) NOT NULL COMMENT 'gender',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`),
  CONSTRAINT `table_user_chk_1` CHECK (((`age` &gt; (0 &amp; `age`)) &lt;= 120))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ç”¨æˆ·è¡¨';
</code></pre>
<h4 id="å¤–é”®çº¦æŸ">å¤–é”®çº¦æŸ</h4>
<blockquote>
<p>ç›®å‰ä¸åœ¨ä½¿ç”¨å¼ºå…³è”ç‰©ç†å¤–é”®çº¦æŸ</p>
</blockquote>
<pre><code class="language-mssql">-- æ·»åŠ å¤–é”®
alter table  employ add constraint  foreign_key_id foreign key (id) references table_user(id);
-- åˆ é™¤å¤–é”®
alter table  employ drop foreign key  foreign_key_id;
</code></pre>
<h5 id="åˆ é™¤æ›´æ–°è¡Œä¸º">åˆ é™¤/æ›´æ–°è¡Œä¸º</h5>
<figure data-type="image" tabindex="12"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gznti7j9hyj20sr06x3zs.jpg" alt="image-20220223223305281" loading="lazy"></figure>
<h3 id="4-å¤šè¡¨æŸ¥è¯¢">4ã€å¤šè¡¨æŸ¥è¯¢</h3>
<h4 id="å¤šè¡¨å…³ç³»">å¤šè¡¨å…³ç³»</h4>
<p><em>å…³ç³»åˆ†ä¸ºï¼š</em></p>
<ul>
<li>ä¸€å¯¹ä¸€**ï¼ˆå•è¡¨æ‹†åˆ†ï¼Œåœ¨ä»»æ„ä¸€æ–¹åŠ å…¥å¤–é”®ç›˜ï¼Œå…³è”å¦ä¸€æ–¹çš„å¤–é”®ï¼Œå¹¶è®¾ç½®å¤–é”®ä¸ºuniqueï¼‰**</li>
<li>ä¸€å¯¹å¤š</li>
<li>å¤šå¯¹å¤š**ï¼ˆéœ€è¦ä¸­é—´è¡¨ç»´æŠ¤å…³ç³»ï¼‰**</li>
</ul>
<h4 id="å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°">å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°</h4>
<pre><code class="language-mysql">-- ä¸¤ä¸ªè¡¨å…³è” éšå¼å†…è¿æ¥ å½¢æˆç¬›å¡å°”ç§¯
select * from employ,table_user;
</code></pre>
<hr>
<h4 id="å†…è¿æ¥">å†…è¿æ¥</h4>
<blockquote>
<p><strong>æŸ¥è¯¢ABäº¤é›†çš„éƒ¨åˆ†æ•°æ®</strong></p>
</blockquote>
<h5 id="éšå¼å†…è¿æ¥">éšå¼å†…è¿æ¥</h5>
<pre><code class="language-mysql">select * from employ e,gift_history g where e.id =g.id;
</code></pre>
<h5 id="æ˜¾å¼å†…è¿æ¥">æ˜¾å¼å†…è¿æ¥</h5>
<pre><code class="language-mysql">select * from employ e inner join  gift_history g on  e.id =g.id;
</code></pre>
<hr>
<h4 id="å¤–è¿æ¥">å¤–è¿æ¥</h4>
<h5 id="å·¦å¤–è¿æ¥">å·¦å¤–è¿æ¥</h5>
<blockquote>
<p><strong>æŸ¥è¯¢å·¦è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®</strong></p>
</blockquote>
<pre><code class="language-mysql">select * from employ  e left join table_user P on e.id = P.id where e.name is not null ;
</code></pre>
<h5 id="å³å¤–è¿æ¥">å³å¤–è¿æ¥</h5>
<blockquote>
<p><strong>æŸ¥è¯¢å³è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®</strong></p>
</blockquote>
<pre><code class="language-mysql">select * from employ  e right outer join  table_user P on e.id = P.id where e.name is not null ;
</code></pre>
<h4 id="è‡ªè¿æ¥">è‡ªè¿æ¥</h4>
<blockquote>
<p><strong>è‡ªå·±ä¸è‡ªå·±å…³è”æŸ¥è¯¢</strong></p>
</blockquote>
<pre><code class="language-mysql">-- æ˜¾ç¤ºè‡ªè¿æ¥
select * from employ  e1 join employ e2 on e1.id = e2.id;
-- éšå¼è‡ªè¿æ¥
select * from employ  e1 , employ e2 on e1.id = e2.id;
</code></pre>
<p>ä¸šåŠ¡åœºæ™¯ï¼šæ¯”å¦‚å‘˜å·¥è¡¨ï¼Œéœ€è¦æŸ¥è¯¢å‘˜å·¥çš„ä¸Šçº§é¢†å¯¼æ˜¯è°ï¼Œé‚£ä¹ˆå°±è‡ªè¿æ¥ï¼Œæ ¹æ®è‡ªå·±çš„manager_id ç­‰äºè‡ªå·±è¡¨çš„id ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŸ¥è¯¢å¯¹åº”çš„ä¿¡æ¯å‡ºæ¥</p>
<p>Notesï¼šè‡ªè¿æ¥æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯å†…è¿æ¥æŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–è¿æ¥æŸ¥è¯¢</p>
<hr>
<h4 id="è”åˆæŸ¥è¯¢">è”åˆæŸ¥è¯¢</h4>
<blockquote>
<p><strong>å¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†</strong></p>
</blockquote>
<p>unionï¼Œunion all</p>
<p>å¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†</p>
<pre><code class="language-mysql">select * from employ where age&gt;10
union
select * from employ where age&lt;10
union
select a.id,a.age,a.name,a.status
from table_user a where a.id&gt;1;
</code></pre>
<p>Notesï¼š</p>
<ul>
<li>å¯¹äºè”åˆæŸ¥è¯¢çš„å¤šå¼ è¡¨çš„æ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå­—æ®µç±»å‹ä¹Ÿéœ€è¦ä¿æŒä¸€è‡´</li>
<li>union all ä¼šå°†å…¨éƒ¨çš„æ•°æ®ç›´æ¥åˆå¹¶åœ¨ä¸€èµ·**ï¼ˆä¸åšä»»ä½•æ“ä½œï¼‰**ï¼Œ<strong>unionä¼šå¯¹åˆå¹¶ä¹‹åçš„æ•°æ®å»é‡ã€æ’åº</strong></li>
</ul>
<hr>
<h4 id="å­æŸ¥è¯¢">å­æŸ¥è¯¢</h4>
<blockquote>
<p>sqlä¸­åµŒå¥—selectè¯­å¥</p>
</blockquote>
<pre><code class="language-mysql">select * from table_name where column =(select id form table_name2 where ....);
</code></pre>
<h5 id="æ ‡é‡å­æŸ¥è¯¢">æ ‡é‡å­æŸ¥è¯¢</h5>
<p>æŸ¥è¯¢ç»“æœä¸ºå•ä¸ªå€¼ ---ä¸€ç§æ¡ä»¶ ç¡®å®š</p>
<pre><code class="language-mysql">select * from employ where id &gt; (select id from employ where age ='11');
</code></pre>
<h5 id="åˆ—å­æŸ¥è¯¢">åˆ—å­æŸ¥è¯¢</h5>
<p>æŸ¥è¯¢ç»“æœä¸ºä¸€åˆ—--- inã€not in</p>
<pre><code class="language-mysql">select * from employ where id in (select id from employ where age &gt;1);
-- all ç”¨æ³• æ»¡è¶³æŸ¥è¯¢å‡ºæ¥çš„æ‰€æœ‰æ¡ä»¶
select * from employ where id &gt; all (select id from employ where age ='1');
-- some ç”¨æ³• æ»¡è¶³æŸ¥è¯¢å‡ºæ¥çš„å…¶ä¸­ä¸€ä¸ªæ¡ä»¶
select * from employ where id &gt; some (select id from employ where age ='1');
</code></pre>
<h5 id="è¡Œå­æŸ¥è¯¢">è¡Œå­æŸ¥è¯¢</h5>
<p>æŸ¥è¯¢ç»“æœä¸ºä¸€è¡Œ</p>
<pre><code class="language-mysql">-- æ–°è¯­æ³•ğŸ®ğŸº
select * from employ where  (name,age)!=(select name,age from employ where id =00011);

</code></pre>
<h5 id="è¡¨å­æŸ¥è¯¢">è¡¨å­æŸ¥è¯¢</h5>
<p>æŸ¥è¯¢ç»“æœä¸ºå¤šè¡Œå¤šåˆ—</p>
<pre><code class="language-mysql">-- å¤šæ¡ä»¶in ğŸ®ğŸº
select * from employ where  (name,age) in(select name,age from employ where id is not null);
-- å­æŸ¥è¯¢å½“ä¸€ä¸ªè¡¨
select * from (select * from employ where time&lt;now()) as a;
</code></pre>
<hr>
<h3 id="5-äº‹åŠ¡">5ã€äº‹åŠ¡</h3>
<h4 id="äº‹åŠ¡ç®€ä»‹">äº‹åŠ¡ç®€ä»‹</h4>
<blockquote>
<p>è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¼šæŠŠæ‰€æœ‰çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»ç»Ÿæäº¤æˆ–è€…æ’¤é”€æ“ä½œè¯·æ±‚</p>
</blockquote>
<p>é»˜è®¤mysqlçš„äº‹åŠ¡æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å½“æ‰§è¡Œä¸€æ¡dmlè¯­å¥ï¼Œmysqlä¼šç«‹å³éšå¼çš„æäº¤äº‹åŠ¡</strong></p>
<h4 id="äº‹åŠ¡æ“ä½œ">äº‹åŠ¡æ“ä½œ</h4>
<pre><code class="language-mysql">-- é“¶è¡Œè½¬è´¦ä¾‹å­
-- æŸ¥çœ‹å½“å‰äº‹åŠ¡æ˜¯å¦è‡ªåŠ¨æäº¤  1å°±æ˜¯è‡ªåŠ¨æäº¤  åŸºäºsessionçº§åˆ«
select @@autocommit;
-- è®¾ç½®ä¸ºæ‰‹åŠ¨æäº¤
set @@autocommit = 0;
-- å¼€å¯äº‹åŠ¡
start transaction æˆ–è€… begin;

-- å¼€å§‹å¤„ç†ä¸šåŠ¡é€»è¾‘
update account set money = money-1000 where name = 'Jack';
update account set money = money+1000 where name = 'Tony';
-- æäº¤æ“ä½œ
commit;
-- å¼‚å¸¸å›æ»šæ“ä½œ
rollback;

</code></pre>
<h4 id="äº‹åŠ¡å››å¤§ç‰¹æ€§acid">äº‹åŠ¡å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰</h4>
<p><strong>åŸå­æ€§ï¼ˆatomicityï¼‰</strong>ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°å•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p>
<p><strong>ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰</strong>ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œå¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€</p>
<p><strong>éš”ç¦»æ€§ï¼ˆisolationï¼‰</strong>ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œ</p>
<p><strong>æŒä¹…æ€§ï¼ˆdurabilityï¼‰</strong>ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ“ä½œçš„æ”¹å˜æ—¶æ°¸ä¹…çš„</p>
<hr>
<h4 id="å¹¶å‘äº‹åŠ¡é—®é¢˜">å¹¶å‘äº‹åŠ¡é—®é¢˜ğŸŒŸ</h4>
<ul>
<li><strong>è„è¯»</strong>ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤çš„æ•°æ®</li>
<li><strong>ä¸å¯é‡å¤è¯»</strong>ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ä¸¤æ¬¡è¯»å–åˆ°æ•°æ®ä¸åŒï¼Œç§°ä¹‹ä¸ºä¸å¯é‡å¤è¯»</li>
<li><strong>å¹»è¯»</strong>ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®è¡Œï¼Œä½†æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²ç»å­˜åœ¨ï¼Œå¥½åƒå‡ºç°äº†å¹»è§‰</li>
</ul>
<h4 id="äº‹åŠ¡éš”ç¦»çº§åˆ«">äº‹åŠ¡éš”ç¦»çº§åˆ«ğŸŒŸ</h4>
<p>å„ä¸ªçº§åˆ«ä¼šå‡ºç°çš„æƒ…å†µï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">éš”ç¦»çº§åˆ«</th>
<th style="text-align:center">è„è¯»</th>
<th style="text-align:center">ä¸å¯é‡å¤è¯»</th>
<th style="text-align:center">å¹»è¯»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Read uncommitted</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:center">âˆš</td>
</tr>
<tr>
<td style="text-align:center">Read committed</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:center">âˆš</td>
</tr>
<tr>
<td style="text-align:center"><strong>Repeatable Readï¼ˆé»˜è®¤ï¼‰</strong></td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">âˆš</td>
</tr>
<tr>
<td style="text-align:center">Serializable</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">Ã—</td>
</tr>
</tbody>
</table>
<pre><code class="language-mysql">-- æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«
select @@transaction_isolation;

-- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
set session  transaction isolation level read uncommitted ;
set session  transaction isolation level read committed ;
set session  transaction isolation level repeatable read ;
set session  transaction isolation level serializable ;
</code></pre>
<hr>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[JUCå­¦ä¹ å‘€]]></title>
        <id>https://WheatJack.github.io/post/juc-xue-xi-ya/</id>
        <link href="https://WheatJack.github.io/post/juc-xue-xi-ya/">
        </link>
        <updated>2022-01-17T14:21:30.000Z</updated>
        <content type="html"><![CDATA[<ol start="2">
<li>è¿›ç¨‹ä¸çº¿ç¨‹</li>
</ol>
<p>2.1 è¿›ç¨‹ä¸çº¿ç¨‹</p>
<p>è¿›ç¨‹</p>
<p>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç†IOçš„</p>
<p>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚</p>
<p>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹(ä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ç­‰)ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹(ä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ã€360å®‰å…¨å«å£«ç­‰)</p>
<p>çº¿ç¨‹</p>
<p>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚</p>
<p>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œ<br>
Javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨</p>
<p>äºŒè€…å¯¹æ¯”</p>
<p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†<br>
è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«<br>
è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚</p>
<p>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸ºIPC(Inter-process communication)<br>
ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚HTTP<br>
çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡<br>
çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</p>
<p>2.2 å¹¶å‘å’Œå¹¶è¡Œ</p>
<p>å•æ ¸cpuä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°†cpuçš„æ—¶é—´ç‰‡(windowsä¸‹æ—¶é—´ç‰‡æœ€å°çº¦ä¸º15æ¯«ç§’)åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä»¬ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºcpuåœ¨çº¿ç¨‹é—´(æ—¶é—´ç‰‡å¾ˆçŸ­)çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯:å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ</p>
<p>ä¸€èˆ¬ä¼šå°†è¿™ç§ çº¿ç¨‹è½®æµä½¿ç”¨ CPUçš„åšæ³•ç§°ä¸ºå¹¶å‘ concurrent</p>
<p>å¼•ç”¨RobPikeçš„ä¸€æ®µæè¿°ï¼š</p>
<p>å¹¶å‘ï¼ˆconcurrentï¼‰æ˜¯åŒä¸€æ—¶é—´åº”å¯¹ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚</p>
<p>å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</p>
<p>2.3 åº”ç”¨</p>
<p>åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨ï¼ˆæ¡ˆä¾‹1ï¼‰</p>
<p>ä»æ–¹æ³•è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœ</p>
<p>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥ã€‚</p>
<p>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</p>
<p>æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰å¦å¤–ä¸€å±‚æ„æ€ï¼Œæ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´</p>
<p>1ï¼‰è®¾è®¡</p>
<p>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ï¼ˆå³ä¸è¦å·´å·´å¹²ç­‰ç€ï¼‰æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº†5ç§’é’Ÿï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™5ç§’è°ƒç”¨è€…ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶ä»£ç éƒ½å¾—æš‚åœ..</p>
<p>2ï¼‰ç»“è®º</p>
<p>æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹</p>
<p>tomcatçš„å¼‚æ­¥servletä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡tomcatçš„å·¥ä½œçº¿ç¨‹â– uiç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡uiçº¿ç¨‹</p>
<p>3ï¼‰æ€»ç»“</p>
<p>ä»£ç è§ã€åº”ç”¨ä¹‹æ•ˆç‡-æ¡ˆä¾‹1ã€‘<br>
1.å•æ ¸cpuä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨cpuï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»<br>
2.å¤šæ ¸cpuå¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„ï¼Œ</p>
<p>æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»»åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å°”å®šå¾‹ã€‘ï¼‰ã€‚</p>
<p>ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰</p>
<p>3.IOæ“ä½œä¸å ç”¨cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡I0ã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨cpuï¼Œä½†éœ€è¦ä¸€ç›´ç­‰å¾…IOç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„ã€éé˜»å¡I0ã€‘å’Œã€å¼‚æ­¥IOã€‘ä¼˜åŒ–</p>
<p>3.Javaçº¿ç¨‹åˆ›å»º</p>
<p>3.1 åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</p>
<p>æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨Thread</p>
<pre><code>public static void main(String[] args) {
</code></pre>
<p>â€‹<br>
new Thread(() -&gt; {<br>
log.debug(&quot;aaa&quot;);<br>
}, &quot;aa&quot;).start();<br>
log.debug(&quot;bbb&quot;);<br>
}<br>
æ–¹æ³•äºŒï¼šä½¿ç”¨runnable</p>
<p>public static void main(String[] args) {<br>
â€‹<br>
Runnable runnable = new Runnable() {<br>
@Override<br>
public void run() {<br>
log.debug(&quot;runnable&quot;);<br>
}<br>
};<br>
â€‹<br>
Thread aa = new Thread(runnable, &quot;runnable&quot;);<br>
aa.start();<br>
log.debug(&quot;bbb&quot;);<br>
}<br>
åŸç†ä¹‹Threadä¸Runnableçš„å…³ç³»</p>
<p>åˆ†æThreadçš„æºç ï¼Œç†æ¸…å®ƒä¸Runnableçš„å…³ç³»</p>
<p>å°ç»“</p>
<p>æ–¹æ³•1æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•2æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†</p>
<p>ç”¨Runnableæ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§APIé…åˆ</p>
<p>ç”¨Runnableè®©ä»»åŠ¡ç±»è„±ç¦»äº†Threadç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»</p>
<p>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨futureTaskåˆ›å»º</p>
<pre><code>public static void main(String[] args) throws ExecutionException, InterruptedException {

    FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(new Callable&lt;Integer&gt;() {
        @Override
        public Integer call() throws Exception {
            log.debug(Thread.currentThread().getName() + &quot;çº¿ç¨‹è¾“å‡º:&quot; + &quot;Thread1Callable&quot;);
            Thread.sleep(1000);
            return 200;
        }
    });

    Thread aa = new Thread(futureTask, &quot;futureTask&quot;);

    aa.start();
    // é˜»å¡ç­‰å¾…çº¿ç¨‹ç»“æœ
    Integer integer = futureTask.get();
    log.debug(&quot;çº¿ç¨‹è¿”å›ç»“æœï¼š{}&quot;, integer);
    log.debug(Thread.currentThread().getName() + &quot;çº¿ç¨‹è¾“å‡º:&quot; + &quot;bbb&quot;);
}
</code></pre>
<p>3.2 æŸ¥çœ‹è¿›ç¨‹çš„æ–¹æ³•</p>
<p>windows</p>
<p>ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹</p>
<p>tasklistæŸ¥çœ‹è¿›ç¨‹</p>
<p>taskkillæ€æ­»è¿›ç¨‹</p>
<p>linux</p>
<p>ps-feæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</p>
<p>ps-fT-pã€ŠPIDã€‹æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</p>
<p>killæ€æ­»è¿›ç¨‹</p>
<p>topæŒ‰å¤§å†™Håˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹</p>
<p>top -H -pã€ŠPIDã€‹æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</p>
<p>Java</p>
<p>â– pså‘½ä»¤æŸ¥çœ‹æ‰€æœ‰Javaè¿›ç¨‹</p>
<p>jstack ã€ŠPIDã€‹æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</p>
<p>jconsoleæ¥æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</p>
<p>jconsoleè¿œç¨‹ç›‘æ§é…ç½®<br>
ã€‚éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„javaç±»<br>
java -Djava.rmi.server.hostname=~ipåœ°å€-Dcom.sun.management.jmxremote-<br>
Dcom.sun.management.jmxremote.port='è¿æ¥ç«¯å£-Dcom.sun.management.jmxremote.ssl=æ˜¯å¦å®‰å…¨è¿æ¥-Dcom.sun.management.jmxremote.authenticate=æ˜¯å¦è®¤è¯javaç±»<br>
â– ä¿®æ”¹/etc/hostsæ–‡ä»¶å°†127.0.0.1æ˜ å°„è‡³ä¸»æœºå<br>
å¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤<br>
â– å¤åˆ¶jmxremote.passwordæ–‡ä»¶<br>
â– ä¿®æ”¹jmxremote.passwordå’Œjmxremote.accessæ–‡ä»¶çš„æƒé™ä¸º600å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™â– è¿æ¥æ—¶å¡«å…¥controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&amp;Dï¼ˆå¯†ç ï¼‰</p>
<p>3.3 çº¿ç¨‹è¿è¡ŒåŸç†</p>
<p>æ ˆä¸æ ˆå¸§</p>
<p>Java Virtual Machine Stacks ï¼ˆJavaè™šæ‹Ÿæœºæ ˆï¼‰</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“JVMä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ï¼Œæ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜â– æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</p>
<p>æ ˆå¸§æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„æ ˆå¸§ã€‚</p>
<p>å•çº¿ç¨‹æ ˆå¸§æ¼”ç¤º</p>
<p>æ¯æ¬¡æ–°çš„çº¿ç¨‹èµ·æ¥ï¼Œå°±ä¼šå…¥æ ˆï¼Œä½¿ç”¨å®Œæ¯•åå°±å‡ºæ ˆã€‚</p>
<p>image-20210725113349782</p>
<p>image-20210725114453084</p>
<p>å‡ºæ ˆ ä¼šå¸¦ç€è¿”å›åœ°å€ï¼Œæ‰¾åˆ°è¦è¿”å›çš„é‚£ä¸ªåœ°å€</p>
<p>image-20210725113438700</p>
<p>image-20210725114525969</p>
<p>aaa</p>
<p>image-20210725114555917</p>
<p>å¤šçº¿ç¨‹æ ˆå¸§æ¼”ç¤º</p>
<pre><code>public static void main(String[] args) {

    new Thread(() -&gt; {
        method1(20);
    }, &quot;t1&quot;).start();

    method1(10);
}

public static void method1(int x) {

    System.out.println(x);
    Object o = method2(x);
    System.out.println(o);
}

public static Object method2(int x) {
    return new Object();
}
</code></pre>
<p>é¦–å…ˆæ”¹å˜æ–­ç‚¹æ¨¡å¼</p>
<p>image-20210725114927737</p>
<p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢(Thread Context Switch)</p>
<p>å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´cpuä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç </p>
<p>çº¿ç¨‹çš„cpuæ—¶é—´ç‰‡ç”¨å®Œ</p>
<p>åƒåœ¾å›æ”¶</p>
<p>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</p>
<p>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleepã€ yieldã€ waitã€joinã€ parkã€ synchronizedã€lockç­‰æ–¹æ³•</p>
<p>ä¸Šä¸‹æ–‡åˆ‡æ¢å›¾ä¾‹</p>
<p>image-20210725142530526</p>
<p>å½“Context Switchå‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJavaä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡jvmæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„</p>
<p>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</p>
<p>Context Switché¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</p>
<p>3.4 å¸¸è§æ–¹æ³•</p>
<p>start()<br>
å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œstartæ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunï¼ˆCPUçš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªæ–¹æ³•ä¸­çš„ä»£ç èƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°IllegalThreadStateException</p>
<p>image-20210725142719859</p>
<p>é‡ç‚¹æ³¨æ„âš ï¸</p>
<p>isInterrupted()   åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</p>
<p>interrupted())   static   åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­. ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</p>
<p>image-20210725143039366</p>
<ol>
<li>runå’Œstart</li>
</ol>
<p>Run()æ–¹æ³•è°ƒç”¨---æ‰§è¡Œçš„æ˜¯æ™®é€šæ–¹æ³•ï¼Œæ˜¯mainçº¿ç¨‹è°ƒç”¨çš„ éæ–°å¼€çº¿ç¨‹è°ƒç”¨</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;runæ–¹æ³•&quot;);
    }, &quot;aaa&quot;);

    // æ‰§è¡Œçš„æ˜¯æ™®é€šæ–¹æ³•ï¼Œæ˜¯mainçº¿ç¨‹è°ƒç”¨çš„ éæ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.run();

}
</code></pre>
<p>start() æ‰§è¡Œçš„æ–°å¼€çº¿ç¨‹è°ƒç”¨</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹:&quot; + &quot;runæ–¹æ³•&quot;);
    }, &quot;aaa&quot;);

    // æ‰§è¡Œçš„æ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.start();
    log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹æ‰§è¡Œäº†æ—¥å¿—&quot; + &quot;ï¼šaaa&quot;);

}
</code></pre>
<ol start="2">
<li>sleepå’Œyield</li>
</ol>
<p>yield è®©å‡ºå½“å‰çº¿ç¨‹</p>
<p>è°ƒç”¨yieldä¼šè®©å½“å‰çº¿ç¨‹ä»Runningè¿›å…¥RumableçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒåŒä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚å¦‚æœè¿™æ—¶æ²¡æœ‰åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸èƒ½ä¿è¯è®©å½“å‰çº¿ç¨‹æš‚åœçš„æ•ˆæœ</p>
<p>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</p>
<p>æ¡ˆä¾‹</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
Thread thread = new Thread(() -&gt; {<br>
int count = 0;<br>
for (; ; ) {<br>
System.out.println(&quot;---&gt;&quot;+Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼š&quot; + count++);<br>
}<br>
}, &quot;thrad1&quot;);</p>
<pre><code>    Thread thread2 = new Thread(() -&gt; {
        int count = 0;

        for (; ; ) {
            Thread.yield();
            System.out.println(&quot;                    --------&gt;&quot;+Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼š&quot; + count++);
        }
    }, &quot;thrad2&quot;);

    thread.start();
    thread2.start();
}
</code></pre>
<p>sleep</p>
<p>è°ƒç”¨sleepä¼šè®©å½“å‰çº¿ç¨‹ä»Runningè¿›å…¥Timed WaitingçŠ¶æ€</p>
<p>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨interruptæ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶sleepæ–¹æ³•ä¼šæŠ›å‡ºInterruptedException</p>
<p>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ</p>
<p>å»ºè®®ç”¨TimeUnitçš„sleepä»£æ›¿Threadçš„sleepæ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</p>
<p>1ã€çŠ¶æ€æ¼”ç¤º</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹:&quot; + &quot;runæ–¹æ³•&quot;);
    }, &quot;aaa&quot;);

    System.out.println(thread.getName()+&quot;çº¿ç¨‹ï¼š&quot;+thread.getState());
    // æ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.start();
    System.out.println(thread.getName()+&quot;çº¿ç¨‹ï¼š&quot;+thread.getState());
    log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹æ‰§è¡Œäº†æ—¥å¿—&quot; + &quot;ï¼šaaa&quot;);
    System.out.println(thread.getName()+&quot;çº¿ç¨‹ï¼š&quot;+thread.getState());

}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>//infoæ—¥å¿—<br>
aaaçº¿ç¨‹ï¼šNEW<br>
aaaçº¿ç¨‹ï¼šRUNNABLE<br>
15:01:04.816 [main] INFO com.example.heimajuc.my2thread.Thread1SleepMethodStatus - mainçº¿ç¨‹æ‰§è¡Œäº†æ—¥å¿—ï¼šaaa<br>
aaaçº¿ç¨‹ï¼šTIMED_WAITING<br>
15:01:05.813 [aaa] INFO com.example.heimajuc.my2thread.Thread1SleepMethodStatus - aaaçº¿ç¨‹:runæ–¹æ³•<br>
çº¿ç¨‹ä¸­æ–­-æ‰“æ–­</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            log.info(&quot;interrupt .....&quot;);
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹:&quot; + &quot;runæ–¹æ³•&quot;);
    }, &quot;aaa&quot;);

    // æ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.start();
    Thread.sleep(1000);
    log.info(Thread.currentThread().getName() + &quot;ï¼šinterrupt aa Thread&quot;);
    // ä¸­é—´threadçº¿ç¨‹
    thread.interrupt();

}
</code></pre>
<p>2.1 çº¿ç¨‹ä¼˜å…ˆçº§</p>
<p>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œç»¸åº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ</p>
<p>å¦‚æœcpuæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†cpué—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        int count = 0;
        for (; ; ) {
            System.out.println(&quot;---&gt;&quot; + Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼š&quot; + count++);
        }
    }, &quot;thrad1&quot;);

    Thread thread2 = new Thread(() -&gt; {
        int count = 0;
        for (; ; ) {
            System.out.println(&quot;                    --------&gt;&quot; + Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼š&quot; + count++);
        }
    }, &quot;thrad2&quot;);

    thread.setPriority(Thread.MAX_PRIORITY);
    thread2.setPriority(Thread.MIN_PRIORITY);
    thread.start();
    thread2.start();
}
</code></pre>
<ol start="3">
<li>joinä½¿ç”¨</li>
</ol>
<p>ç­‰å¾…å…¶ä»–çº¿ç¨‹ç»“æŸå®Œæˆ<br>
ä¸ºä»€ä¹ˆä½¿ç”¨joinï¼Ÿç»“æœæ˜¯å•¥</p>
<p>private static int anInt = 0;</p>
<pre><code>public static void main(String[] args) throws ExecutionException, InterruptedException {
    method1();
}

public static void method1() {
    log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šstart&quot;);
    new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šsleep start&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;ï¼šsleepï¼šend&quot;);
        anInt = 100;
    }, &quot;thrad1&quot;).start();

    log.info(&quot;int,{}&quot;, anInt);
    log.info(&quot;int,{}&quot;, &quot;end&quot;);
}
</code></pre>
<p>ç»“æœæ˜¯0ï¼›</p>
<p>åˆ†æï¼š</p>
<p>mainçº¿ç¨‹è¿˜æ²¡æœ‰ç­‰thrad1çº¿ç¨‹æ‰§è¡Œå®Œï¼Œå°±å·²ç»å»æ‹¿æ•°æ®äº†ã€‚æ‰€ä»¥æ˜¯0</p>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>ä½¿ç”¨sleep ä¸æ¨èä½¿ç”¨ å› ä¸ºä¸çŸ¥é“è¦ä¼‘çœ å¤šä¹…</p>
<p>ä½¿ç”¨join</p>
<p>ä½¿ç”¨futureTask getæ–¹æ³• æ‹¿åˆ°ç»“æœ</p>
<p>æ–¹æ³•2è§£å†³</p>
<p>private static int anInt = 0;</p>
<pre><code>public static void main(String[] args) throws ExecutionException, InterruptedException {
    method1();
}

public static void method1() {
    log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šstart&quot;);
    Thread thread = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šsleep start&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;ï¼šsleepï¼šend&quot;);
        anInt = 100;
    }, &quot;thrad1&quot;);
    thread.start();

    // ç­‰å¾…çº¿ç¨‹ç»“æŸ åœ¨æ‰§è¡Œä¸‹é¢çš„ä»£ç 
    try {
        thread.join();
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.info(&quot;intç»“æœ,{}&quot;, anInt);
    log.info(&quot;intç»“æœ,{}&quot;, &quot;end&quot;);
}
</code></pre>
<p>image-20210725155740764</p>
<p>å¦‚æœä½¿ç”¨å¤šä¸ªåŒæ­¥æ“ä½œå‘¢ã€‚å®é™…è€—è´¹1sä¸­</p>
<p>private static int anInt = 0;</p>
<pre><code>public static void main(String[] args) throws ExecutionException, InterruptedException {
    method1();
}

public static void method1() throws InterruptedException {
    log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šstart&quot;);
    Thread thread = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šsleep start&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;ï¼šsleepï¼šend&quot;);
        anInt = 100;
    }, &quot;thrad1&quot;);

    Thread thread2 = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šsleep start&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;ï¼šsleepï¼šend&quot;);
        anInt = 200;
    }, &quot;thrad1&quot;);

    thread.start();
    thread2.start();
    // ç­‰å¾…çº¿ç¨‹ç»“æŸ åœ¨æ‰§è¡Œä¸‹é¢çš„ä»£ç 
    log.info(&quot;join1--begin&quot;);
    thread.join();
    log.info(&quot;join1--end&quot;);

    log.info(&quot;join2--begin&quot;);
    thread2.join();
    log.info(&quot;join2--end&quot;);
    log.info(&quot;intç»“æœ,{}&quot;, anInt);
}
</code></pre>
<p>joinæ–¹æ³•ç­‰å¾…å…¶ä»–çº¿ç¨‹æ“ä½œ</p>
<p>image-20210725161055059</p>
<p>å¸¦ç­‰å¾…æ—¶é—´çš„join</p>
<p>private static int anInt = 0;</p>
<pre><code>public static void main(String[] args) throws ExecutionException, InterruptedException {
    method1();
}

public static void method1() throws InterruptedException {
    log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šstart&quot;);
    Thread thread = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;ï¼šçº¿ç¨‹ï¼šsleep start&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;ï¼šsleepï¼šend&quot;);
        anInt = 100;
    }, &quot;thrad1&quot;);

    thread.start();
    Instant now = Instant.now();
    // ç­‰å¾…çº¿ç¨‹ç»“æŸ åœ¨æ‰§è¡Œä¸‹é¢çš„ä»£ç 
    log.info(&quot;join1--begin&quot;);
    // å¦‚æœç­‰åˆ°æ—¶é—´å°äºä¼‘çœ æ—¶é—´ é‚£ä¹ˆå°±ä¼šä¸å†ç­‰å¾…
</code></pre>
<p>//        thread.join(500);<br>
// å¦‚æœç­‰åˆ°æ—¶é—´å¤§äºä¼‘çœ æ—¶é—´ é‚£ä¹ˆå°±ä¼šæå‰ç»“æŸ<br>
thread.join(2000);<br>
log.info(&quot;join1--end&quot;);<br>
long l = Duration.between(now, Instant.now()).toMillis();<br>
log.info(&quot;intç»“æœ,{}&quot;, anInt);<br>
log.info(&quot;æ—¶é—´,{}&quot;, l);<br>
}<br>
4. interruptä½¿ç”¨</p>
<p>æ‰“æ–­é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ï¼šsleepã€waitã€joinçº¿ç¨‹<br>
æ‰“æ–­é˜»å¡çº¿ç¨‹æ‰æ˜¯æ¸…æ¥šã€‚éé˜»å¡çº¿ç¨‹éƒ½æ˜¯é€šçŸ¥</p>
<p>æ‰“æ–­sleepã€waitã€joinçº¿ç¨‹éƒ½æ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        try {
            TimeUnit.SECONDS.sleep(5);
        } catch (InterruptedException e) {
            log.info(&quot;interrupt .....&quot;);
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;çº¿ç¨‹:&quot; + &quot;runæ–¹æ³•&quot;);
    }, &quot;aaa&quot;);

    // æ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.start();
    TimeUnit.SECONDS.sleep(2);
    log.info(Thread.currentThread().getName() + &quot;ï¼šinterrupt aa Thread&quot;);
    // ä¸­é—´threadçº¿ç¨‹
    thread.interrupt();
    log.info(thread.getName() + &quot;ï¼šæ‰“æ–­æ ‡è®°ï¼š&quot;+thread.isInterrupted());
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>20:04:24.739 [main] INFO com.example.heimajuc.my2thread.Thread1InterruptMethodJoin - mainï¼šinterrupt aa Thread<br>
20:04:24.744 [main] INFO com.example.heimajuc.my2thread.Thread1InterruptMethodJoin - aaaï¼šæ‰“æ–­æ ‡è®°ï¼šfalse<br>
20:04:24.745 [aaa] INFO com.example.heimajuc.my2thread.Thread1InterruptMethodJoin - interrupt .....<br>
20:04:24.746 [aaa] INFO com.example.heimajuc.my2thread.Thread1InterruptMethodJoin - aaaçº¿ç¨‹:runæ–¹æ³•<br>
java.lang.InterruptedException: sleep interrupted<br>
at java.lang.Thread.sleep(Native Method)<br>
at java.lang.Thread.sleep(Thread.java:340)<br>
at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:386)<br>
at com.example.heimajuc.my2thread.Thread1InterruptMethodJoin.lambda$main$0(Thread1InterruptMethodJoin.java:19)<br>
at java.lang.Thread.run(Thread.java:748)<br>
æ­£å¸¸çº¿ç¨‹</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {</p>
<pre><code>    Thread thread = new Thread(() -&gt; {
        while (true) {
            boolean interrupted = Thread.interrupted();
            if (interrupted) {
                // çº¿ç¨‹è¢«äººé€šçŸ¥æ‰“æ–­
                log.info(&quot;çº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯&quot;);
                break;
            }

        }
    }, &quot;aaa&quot;);
    // æ–°å¼€çº¿ç¨‹è°ƒç”¨
    thread.start();
    TimeUnit.SECONDS.sleep(2);
    // ä¸­é—´threadçº¿ç¨‹
    thread.interrupt();
    log.info(thread.getName() + &quot;ï¼šæ‰“æ–­æ ‡è®°ï¼š&quot; + thread.isInterrupted());
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>20:21:00.488 [main] INFO com.example.heimajuc.my2thread.Thread1InterruptMethod - aaaï¼šæ‰“æ–­æ ‡è®°ï¼šfalse<br>
20:21:00.489 [aaa] INFO com.example.heimajuc.my2thread.Thread1InterruptMethod - çº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯<br>
æ‰“æ–­parkçº¿ç¨‹</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
Thread thread =  new Thread(() -&gt; {<br>
log.info(&quot;park  ing .....&quot;);<br>
LockSupport.park();<br>
log.info(&quot;park  end .....&quot;);<br>
log.info(&quot;æ‰“æ–­çŠ¶æ€ï¼š{}&quot;,Thread.currentThread().isInterrupted());<br>
// æ‰“æ–­æ ‡è®°ä¸ºçœŸçš„æ—¶å€™ å°±ä¸å†æ‰“æ–­äº† parkå¤±æ•ˆçŠ¶æ€<br>
LockSupport.park();<br>
log.info(&quot;park  end .....&quot;);<br>
}, &quot;thread&quot;);<br>
thread.start();<br>
System.out.println(thread.getName()+&quot;çº¿ç¨‹ï¼š&quot;+thread.getState());<br>
System.out.println(Thread.currentThread().getName()+&quot;çº¿ç¨‹ï¼š&quot;+Thread.currentThread().getState());<br>
thread.interrupt();<br>
System.out.println(thread.getName()+&quot;çº¿ç¨‹ï¼š&quot;+thread.getState());<br>
}<br>
// æ‰“æ–­æ ‡è®°ä¸ºçœŸçš„æ—¶å€™ å°±ä¸å†æ‰“æ–­äº† parkå¤±æ•ˆçŠ¶æ€**<br>
LockSupport.park();**</p>
<p>è¾“å‡ºï¼š</p>
<p>threadçº¿ç¨‹ï¼šRUNNABLE<br>
mainçº¿ç¨‹ï¼šRUNNABLE<br>
threadçº¿ç¨‹ï¼šRUNNABLE<br>
22:44:07.018 [thread] INFO com.example.heimajuc.my2thread.Thread1InterruptPark - park  ing .....<br>
22:44:07.022 [thread] INFO com.example.heimajuc.my2thread.Thread1InterruptPark - park  end .....<br>
22:44:07.022 [thread] INFO com.example.heimajuc.my2thread.Thread1InterruptPark - æ‰“æ–­çŠ¶æ€ï¼štrue<br>
3.5 ä¸»çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaè¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p>
<p>å®ˆæŠ¤çº¿ç¨‹</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
Thread thread =  new Thread(() -&gt; {<br>
while (true){<br>
if (Thread.currentThread().isInterrupted()){<br>
break;<br>
}<br>
System.out.print(&quot;aa&quot;);<br>
}<br>
log.info(&quot;aaa&quot;);<br>
}, &quot;thread&quot;);<br>
// å®ˆæŠ¤çº¿ç¨‹<br>
thread.setDaemon(true);<br>
thread.start();<br>
System.out.println(Thread.currentThread().getName()+&quot;çº¿ç¨‹ï¼š&quot;+Thread.currentThread().getState());<br>
}<br>
æ³¨æ„âš ï¸</p>
<p>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</p>
<p>Tomcatä¸­çš„Acceptorå’ŒPollerçº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥Tomcatæ¥æ”¶åˆ°shutdownå‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</p>
<p>3.6 çº¿ç¨‹çš„äº”ç§çŠ¶æ€</p>
<p>ä»æ“ä½œç³»ç»Ÿå±‚é¢æ¥æè¿°ã€‚</p>
<p>image-20210726203444819</p>
<p>ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</p>
<p>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘Runnableï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰</p>
<p>å¯ä»¥ç”±CPUè°ƒåº¦æ‰§è¡Œã€è¿è¡ŒçŠ¶æ€ã€‘start æŒ‡è·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€</p>
<p>å½“CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘Running è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘Runnableï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<p>ã€è¿è¡ŒçŠ¶æ€ã€‘è·å–cpuè°ƒåº¦ä½¿ç”¨</p>
<p>ã€é˜»å¡çŠ¶æ€ã€‘</p>
<p>å¦‚æœè°ƒç”¨äº†é˜»å¡APIï¼Œå¦‚BIOè¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ã€é˜»å¡çŠ¶æ€ã€‘</p>
<p>ç­‰BIOæ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</p>
<p>ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘è°ƒåº¦å®ƒä»¬</p>
<p>ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€</p>
<p>3.7 çº¿ç¨‹çš„å…­ç§çŠ¶æ€</p>
<p>è¿™æ˜¯ä» Java APIå±‚é¢æ¥æè¿°çš„<br>
æ ¹æ® Thread. Stateæšä¸¾,åˆ†ä¸ºå…­ç§çŠ¶æ€</p>
<p>NEW,RUNNABLE,BLOCKED,WAITING,TIMED_WAITING,TERMINATED;</p>
<p>image-20210726204505441</p>
<p>NEWçº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨startï¼ˆï¼‰æ–¹æ³•</p>
<p>RUNNABLEå½“è°ƒç”¨äº†startï¼ˆï¼‰æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava APIå±‚é¢çš„RUNNABLEçŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äºBIOå¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨Javaé‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸ºæ˜¯å¯è¿è¡Œï¼‰</p>
<p>BLOCKEDï¼ŒWAITINGï¼ŒTIMED_WAITINGéƒ½æ˜¯JavaAPIå±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚è¯¦è¿°</p>
<p>TERMINATEDå½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
// NEWçŠ¶æ€<br>
Thread thread1 = new Thread(() -&gt; {<br>
}, &quot;thread1&quot;);</p>
<pre><code>    //RUNNABLE
    Thread thread2 = new Thread(() -&gt; {
        while (true) {
        }
    }, &quot;thread2&quot;);
    thread2.start();

    // TERMINATED
    Thread thread3 = new Thread(() -&gt; {
        log.info(&quot;thread3.......&quot;);
    }, &quot;thread3&quot;);
    thread3.start();

    // TIMED_WAITING
    Thread thread4 = new Thread(() -&gt; {
        synchronized (Thread1Status.class){
            try {
                TimeUnit.SECONDS.sleep(10000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }, &quot;thread4&quot;);
    thread4.start();

    // WAITING
    Thread thread5 = new Thread(() -&gt; {
        try {
            thread2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }, &quot;thread5&quot;);
    thread5.start();

    //BLOCK
    Thread thread6 = new Thread(() -&gt; {
        synchronized (Thread1Status.class){
            try {
                TimeUnit.SECONDS.sleep(1000000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }, &quot;thread6&quot;);
    thread6.start();

    TimeUnit.SECONDS.sleep(1);

    System.out.println(thread1.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread1.getState());
    System.out.println(thread2.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread2.getState());
    System.out.println(thread3.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread3.getState());
    System.out.println(thread4.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread4.getState());
    System.out.println(thread5.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread5.getState());
    System.out.println(thread6.getName() + &quot;çº¿ç¨‹ï¼š&quot; + thread6.getState());
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>thread1çº¿ç¨‹ï¼šNEW<br>
thread2çº¿ç¨‹ï¼šRUNNABLE<br>
thread3çº¿ç¨‹ï¼šTERMINATED<br>
thread4çº¿ç¨‹ï¼šTIMED_WAITING<br>
thread5çº¿ç¨‹ï¼šWAITING<br>
thread6çº¿ç¨‹ï¼šBLOCKED<br>
3.7 ä¹ é¢˜</p>
<p>é˜…è¯»åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹ï¼Œç»™å‡ºçƒ§æ°´æ³¡èŒ¶çš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œæç¤º</p>
<p>å‚è€ƒå›¾äºŒï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼ˆä¸¤ä¸ªäººåä½œï¼‰æ¨¡æ‹Ÿçƒ§æ°´æ³¡èŒ¶è¿‡ç¨‹</p>
<p>æ–‡ä¸­åŠæ³•ä¹™ã€ä¸™éƒ½ç›¸å½“äºä»»åŠ¡ä¸²è¡Œ</p>
<p>è€Œå›¾ä¸€ç›¸å½“äºå¯åŠ¨äº†4ä¸ªçº¿ç¨‹ï¼Œæœ‰ç‚¹æµªè´¹</p>
<p>ç”¨sleepï¼ˆnï¼‰æ¨¡æ‹Ÿæ´—èŒ¶å£¶ã€æ´—æ°´å£¶ç­‰è€—è´¹çš„æ—¶é—´</p>
<p>é™„ï¼šåç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹<br>
ç»Ÿç­¹æ–¹æ³•ï¼Œæ˜¯ä¸€ç§å®‰æ’å·¥ä½œè¿›ç¨‹çš„æ•°å­¦æ–¹æ³•ã€‚å®ƒçš„å®ç”¨èŒƒå›´æå¹¿æ³›ï¼Œåœ¨ä¼ä¸šç®¡ç†å’ŒåŸºæœ¬å»ºè®¾ä¸­ï¼Œä»¥åŠå…³ç³»å¤æ‚çš„ç§‘ç ”é¡¹ç›®çš„ç»„ç»‡ä¸ç®¡ç†ä¸­ï¼Œéƒ½å¯ä»¥åº”ç”¨ã€‚<br>
æ€æ ·åº”ç”¨å‘¢ï¼Ÿä¸»è¦æ˜¯æŠŠå·¥åºå®‰æ’å¥½ã€‚<br>
æ¯”å¦‚ï¼Œæƒ³æ³¡å£¶èŒ¶å–ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯ï¼šå¼€æ°´æ²¡æœ‰ï¼›æ°´å£¶è¦æ´—ï¼ŒèŒ¶å£¶ã€èŒ¶æ¯è¦æ´—ï¼›ç«å·²ç”Ÿäº†ï¼ŒèŒ¶å¶ä¹Ÿæœ‰äº†ã€‚æ€ä¹ˆåŠï¼Ÿ</p>
<p>åŠæ³•ç”²ï¼šæ´—å¥½æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåœ¨ç­‰å¾…æ°´å¼€çš„æ—¶é—´é‡Œï¼Œæ´—èŒ¶å£¶ã€æ´—èŒ¶æ¯ã€æ‹¿èŒ¶å¶ï¼›ç­‰æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</p>
<p>åŠæ³•ä¹™ï¼šå…ˆåšå¥½ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ´—æ°´å£¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼›ä¸€åˆ‡å°±ç»ªï¼ŒçŒæ°´çƒ§æ°´ï¼›åå¾…æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</p>
<p>åŠæ³•ä¸™ï¼šæ´—å‡€æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåå¾…æ°´å¼€ï¼›æ°´å¼€äº†ä¹‹åï¼Œæ€¥æ€¥å¿™å¿™æ‰¾èŒ¶å¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ³¡èŒ¶å–ã€‚</p>
<p>å“ªä¸€ç§åŠæ³•çœæ—¶é—´ï¼Ÿæˆ‘ä»¬èƒ½ä¸€çœ¼çœ‹å‡ºï¼Œç¬¬ä¸€ç§åŠæ³•å¥½ï¼Œåä¸¤ç§åŠæ³•éƒ½çªäº†å·¥ã€‚</p>
<p>è¿™æ˜¯å°äº‹ï¼Œä½†è¿™æ˜¯å¼•å­ï¼Œå¯ä»¥å¼•å‡ºç”Ÿäº§ç®¡ç†ç­‰æ–¹é¢æœ‰ç”¨çš„æ–¹æ³•æ¥ã€‚</p>
<p>æ°´å£¶ä¸æ´—ï¼Œä¸èƒ½çƒ§å¼€æ°´ï¼Œå› è€Œæ´—æ°´å£¶æ˜¯çƒ§å¼€æ°´çš„å‰æã€‚æ²¡å¼€æ°´ã€æ²¡èŒ¶å¶ã€ä¸æ´—èŒ¶å£¶èŒ¶æ¯ï¼Œå°±ä¸èƒ½æ³¡èŒ¶ï¼Œå› è€Œè¿™äº›åˆæ˜¯æ³¡èŒ¶çš„å‰æã€‚å®ƒä»¬çš„ç›¸äº’å…³ç³»ï¼Œå¯ä»¥ç”¨ä¸‹è¾¹çš„ç®­å¤´å›¾æ¥è¡¨ç¤ºï¼š</p>
<p>image-20210726211924941</p>
<p>å·¥ä¸šçš„é”™ç»¼å¤æ‚çš„å·¥è‰ºè¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å°±ä¸æ˜¯åƒæ³¡èŒ¶å–è¿™ä¹ˆç®€å•äº†ã€‚ä»»åŠ¡å¤šäº†ï¼Œå‡ ç™¾å‡ åƒï¼Œç”šè‡³æœ‰å¥½å‡ ä¸‡ä¸ªä»»åŠ¡ã€‚å…³ç³»å¤šäº†ï¼Œé”™ç»¼å¤æ‚ï¼Œåƒå¤´ä¸‡ç»ªï¼Œå¾€å¾€å‡ºç°â€œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£â€çš„æƒ…å†µã€‚ç”±äºä¸€ä¸¤ä¸ªé›¶ä»¶æ²¡å®Œæˆï¼Œè€½è¯¯äº†ä¸€å°å¤æ‚æœºå™¨çš„å‡ºå‚æ—¶é—´ã€‚æˆ–å¾€å¾€å› ä¸ºæŠ“çš„ä¸æ˜¯å…³é”®ï¼Œè¿å¤œä¸‰ç­ï¼Œæ€¥æ€¥å¿™å¿™ï¼Œå®Œæˆè¿™ä¸€ç¯èŠ‚ä¹‹åï¼Œè¿˜å¾—ç­‰å¾…æ—çš„ç¯èŠ‚æ‰èƒ½è£…é…ã€‚<br>
æ´—èŒ¶å£¶ï¼Œæ´—èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼Œæˆ–å…ˆæˆ–åï¼Œå…³ç³»ä¸å¤§ï¼Œè€Œä¸”åŒæ˜¯ä¸€ä¸ªäººçš„æ´»å„¿ï¼Œå› è€Œå¯ä»¥åˆå¹¶æˆä¸ºï¼š</p>
<p>image-20210726214512602</p>
<p>çœ‹æ¥è¿™æ˜¯â€œå°é¢˜å¤§åšâ€ï¼Œä½†åœ¨å·¥ä½œç¯èŠ‚å¤ªå¤šçš„æ—¶å€™ï¼Œè¿™æ ·åšå°±éå¸¸å¿…è¦äº†ã€‚<br>
è¿™é‡Œè®²çš„ä¸»è¦æ˜¯æ—¶é—´æ–¹é¢çš„äº‹ï¼Œä½†åœ¨å…·ä½“ç”Ÿäº§å®è·µä¸­ï¼Œè¿˜æœ‰å…¶ä»–æ–¹é¢çš„è®¸å¤šäº‹ã€‚è¿™ç§æ–¹æ³•è™½ç„¶ä¸ä¸€å®šèƒ½ç›´æ¥è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™ç§æ–¹æ³•æ¥è€ƒè™‘é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸æ— è£¨ç›Šçš„ã€‚</p>
<p>coding</p>
<p>public static void main(String[] args) {<br>
Thread t1 = new Thread(() -&gt; {<br>
// å¼€å§‹æ´—æ°´å£¶ èŠ±è´¹ä¸€åˆ†é’Ÿ<br>
log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;å¼€å§‹æ´—æ°´å£¶&quot;);<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;æ´—å®Œäº†æ´—æ°´å£¶ èŠ±è´¹1s&quot;);<br>
log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;æ°´å£¶æ´—å®Œï¼Œå°±å¼€å§‹çƒ§æ°´&quot;);<br>
try {<br>
TimeUnit.SECONDS.sleep(8);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;çƒ§æ°´çƒ§å®Œäº†ï¼ŒèŠ±è´¹8ç§’&quot;);<br>
}, &quot;001&quot;);<br>
t1.start();</p>
<pre><code>    Thread t2 = new Thread(() -&gt; {
        log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;å¼€å§‹--æ´—èŒ¶æ¯ã€æ´—èŒ¶å£¶ã€æ‹¿èŒ¶å¶&quot;);
        try {
            TimeUnit.SECONDS.sleep(3);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;æ´—èŒ¶æ¯ã€æ´—èŒ¶å£¶ã€æ‹¿èŒ¶å¶,æ´—å®Œäº†èŠ±è´¹3ç§’&quot;);
        try {
            t1.join();
            log.info(Thread.currentThread().getName() + &quot;:&quot; + &quot;å¼€å§‹æ³¡èŒ¶&quot;);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }, &quot;002&quot;);
    t2.start();
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>21:44:08.018 [001] INFO com.example.heimajuc.sample.ThreadTeaSample - 001:å¼€å§‹æ´—æ°´å£¶<br>
21:44:08.022 [002] INFO com.example.heimajuc.sample.ThreadTeaSample - 002:å¼€å§‹--æ´—èŒ¶æ¯ã€æ´—èŒ¶å£¶ã€æ‹¿èŒ¶å¶<br>
21:44:09.022 [001] INFO com.example.heimajuc.sample.ThreadTeaSample - 001:æ´—å®Œäº†æ´—æ°´å£¶ èŠ±è´¹1s<br>
21:44:09.022 [001] INFO com.example.heimajuc.sample.ThreadTeaSample - 001:æ°´å£¶æ´—å®Œï¼Œå°±å¼€å§‹çƒ§æ°´<br>
21:44:11.022 [002] INFO com.example.heimajuc.sample.ThreadTeaSample - 002:æ´—èŒ¶æ¯ã€æ´—èŒ¶å£¶ã€æ‹¿èŒ¶å¶,æ´—å®Œäº†èŠ±è´¹3ç§’<br>
21:44:17.025 [001] INFO com.example.heimajuc.sample.ThreadTeaSample - 001:çƒ§æ°´çƒ§å®Œäº†ï¼ŒèŠ±è´¹8ç§’<br>
21:44:17.025 [002] INFO com.example.heimajuc.sample.ThreadTeaSample - 002:å¼€å§‹æ³¡èŒ¶<br>
è§£æ³•1çš„ç¼ºé™·ï¼š</p>
<p>ä¸Šé¢æ¨¡æ‹Ÿçš„æ˜¯å°ç‹ç­‰è€ç‹çš„æ°´çƒ§å¼€äº†ï¼Œå°ç‹æ³¡èŒ¶ï¼Œå¦‚æœåè¿‡æ¥è¦å®ç°è€ç‹ç­‰å°ç‹çš„èŒ¶å¶æ‹¿æ¥äº†ï¼Œè€ç‹æ³¡èŒ¶å‘¢ï¼Ÿä»£ç æœ€å¥½èƒ½é€‚åº”ä¸¤ç§æƒ…å†µ</p>
<p>ä¸Šé¢çš„ä¸¤ä¸ªçº¿ç¨‹å…¶å®æ˜¯å„æ‰§è¡Œå„çš„ï¼Œå¦‚æœè¦æ¨¡æ‹Ÿè€ç‹æŠŠæ°´å£¶äº¤ç»™å°ç‹æ³¡èŒ¶ï¼Œæˆ–æ¨¡æ‹Ÿå°ç‹æŠŠèŒ¶å¶äº¤ç»™è€ç‹æ³¡èŒ¶å‘¢</p>
<p>æœ¬ç« æ€»ç»“</p>
<p>æœ¬ç« çš„é‡ç‚¹åœ¨äºæŒæ¡</p>
<p>çº¿ç¨‹åˆ›å»º</p>
<p>çº¿ç¨‹é‡è¦apiï¼Œå¦‚startï¼Œrunï¼Œsleepï¼Œjoinï¼Œinterruptç­‰</p>
<p>çº¿ç¨‹çŠ¶æ€</p>
<p>åº”ç”¨æ–¹é¢</p>
<p>å¼‚æ­¥è°ƒç”¨ï¼šä¸»çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œå…¶å®ƒçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œè€—æ—¶æ“ä½œã€‚æé«˜æ•ˆç‡ï¼šå¹¶è¡Œè®¡ç®—ï¼Œç¼©çŸ­è¿ç®—æ—¶é—´</p>
<p>åŒæ­¥ç­‰å¾…ï¼šjoin</p>
<p>ç»Ÿç­¹è§„åˆ’ï¼šåˆç†ä½¿ç”¨çº¿ç¨‹ï¼Œå¾—åˆ°æœ€ä¼˜æ•ˆæœ</p>
<p>åŸç†æ–¹é¢</p>
<p>çº¿ç¨‹è¿è¡Œæµç¨‹ï¼šæ ˆã€æ ˆå¸§ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ç¨‹åºè®¡æ•°å™¨ï¼ŒThreadä¸¤ç§åˆ›å»ºæ–¹å¼çš„æºç </p>
<p>æ¨¡å¼æ–¹é¢</p>
<p>ä¸¤é˜¶æ®µç»ˆæ­¢</p>
<ol start="4">
<li>å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</li>
</ol>
<p>å…±äº«é—®é¢˜ &quot; synchronized</p>
<p>çº¿ç¨‹å®‰å…¨åˆ†æ</p>
<p>Monitor</p>
<p>wait/notify</p>
<p>çº¿ç¨‹çŠ¶æ€è½¬æ¢</p>
<p>æ´»è·ƒæ€§</p>
<p>Lock</p>
<p>4.1 å…±äº«å¸¦æ¥çš„é—®é¢˜</p>
<p>image-20210726221529667</p>
<p>image-20210726221701681</p>
<p>image-20210726221946430</p>
<p>image-20210726221848245</p>
<p>Javaä½“ç°</p>
<p>static int anInt = 0;</p>
<pre><code>public static void main(String[] args) throws InterruptedException {
    Thread thread = new Thread(() -&gt; {
        for (int i = 0; i &lt; 5000; i++) {
            anInt++;
        }
    });

    Thread thread1 = new Thread(() -&gt; {
        for (int i = 0; i &lt; 5000; i++) {
            anInt--;
        }
    });
    thread.start();
    thread1.start();
    thread.join();
    thread1.join();
    System.out.println(anInt);
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>56<br>
ä¸Šä¸‹åˆ‡æ¢å¯¼è‡´</p>
<p>è´Ÿæ•°æƒ…å†µï¼š</p>
<p>image-20210726231003297</p>
<p>æ­£æ•°æƒ…å†µï¼š</p>
<p>image-20210726231123189</p>
<p>ä¸´ç•ŒåŒº</p>
<p>ä¸´ç•ŒåŒº Critical Section</p>
<p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<p>é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œå¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºå…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚åœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒº</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ä¸´ç•ŒåŒº</p>
<p>static int counter = 0;<br>
static void increment() {cqunter++;}// ä¸´ç•ŒåŒº<br>
static void decrement() {counter--;}//ä¸´ç•ŒåŒº<br>
ç«æ€æ¡ä»¶</p>
<p>ç«æ€æ¡ä»¶ Race Condition<br>
å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶</p>
<p>4.1 synchronizedè§£å†³æ–¹æ¡ˆ</p>
<p>åº”ç”¨ä¹‹äº’æ–¥</p>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p>
<p>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock</p>
<p>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</p>
<p>æœ¬æ¬¡è¯¾ä½¿ç”¨é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ³¨æ„ï¼Œè™½ç„¶javaä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨synchronizedå…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p>
<p>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </p>
<p>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</p>
<p>åŠ é”è§£å†³ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ•°æ®ä¸å¯¹çš„é—®é¢˜ï¼š</p>
<p>â€‹<br>
static int anInt = 0;<br>
static Object object = new Object();<br>
â€‹<br>
public static void main(String[] args) throws InterruptedException {<br>
Thread thread = new Thread(() -&gt; {<br>
for (int i = 0; i &lt; 5000; i++) {<br>
synchronized (object) {<br>
anInt++;<br>
}<br>
}<br>
});<br>
â€‹<br>
Thread thread1 = new Thread(() -&gt; {<br>
for (int i = 0; i &lt; 5000; i++) {<br>
synchronized (object) {<br>
anInt--;<br>
}<br>
}<br>
});<br>
thread.start();<br>
thread1.start();<br>
thread.join();<br>
thread1.join();<br>
System.out.println(anInt);<br>
}<br>
ç±»æ¯”ï¼š</p>
<p>image-20210728202754938</p>
<p>image-20210728203143848</p>
<p>image-20210728203207647</p>
<p>æ€è€ƒ</p>
<p>synchronizedå®é™…æ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚<br>
ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼š</p>
<p>å¦‚æœæŠŠsynchronizedï¼ˆobjï¼‰æ”¾åœ¨forå¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ</p>
<p>å¾ªç¯å¤–ï¼Œæ˜¯ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ•´ä¸ªforå¾ªç¯ï¼Œæ‰§è¡Œå®Œä»¥ååœ¨æ‰§è¡Œå…¶ä»–çš„æ“ä½œ</p>
<p>å¦‚æœtl synchronizedï¼ˆobJ1ï¼‰è€Œt2synchronizedï¼ˆobj2ï¼‰ä¼šæ€æ ·è¿ä½œï¼Ÿ</p>
<p>å¯¹è±¡ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œè·å–çš„å¯¹è±¡é”ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æ— æ•ˆ</p>
<p>å¦‚æœtl synchronizedï¼ˆobjï¼‰è€Œ2æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ</p>
<p>2æ²¡æœ‰åŠ synchronizeï¼Œæ—¶é—´ç‰‡è½®åˆ°çº¿ç¨‹2çš„æ—¶å€™ï¼Œä¸ä¼šå»æ‹¿å¯¹è±¡é”ï¼Œä»–è‡ªå·±æ‰§è¡Œè‡ªå·±çš„å†…å®¹</p>
<p>4.2 æ–¹æ³•ä¸Šçš„synchronized</p>
<p>public synchronized void addCount() {<br>
count++;<br>
}<br>
// ç­‰ä»·äº<br>
public void addCount() {<br>
synchronized (this) {<br>
count++;<br>
}<br>
}<br>
æ‰€è°“çš„â€œçº¿ç¨‹å…«é”â€</p>
<p>æƒ…å†µ1:</p>
<p>ç­”æ¡ˆä¸ºï¼š12æˆ–è€…21</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A a = new A();<br>
Thread thread = new Thread(() -&gt; { a.a1(); });</p>
<pre><code>    Thread thread1 = new Thread(() -&gt; { a.a2(); });
    thread.start();
    thread1.start();
}
</code></pre>
<p>}</p>
<p>@Slf4j<br>
class A {<br>
// synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
public synchronized void a1() {<br>
log.info(&quot;111111&quot;);<br>
}</p>
<pre><code>public synchronized void a2() {
    log.info(&quot;222222&quot;);
}
</code></pre>
<p>æƒ…å†µ2ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š12æˆ–è€…21</p>
<p>ä¸¤ç§æƒ…å†µï¼š</p>
<p>å­˜åœ¨thread1 å…ˆæ‹¿åˆ°æ—¶é—´ç‰‡ ç„¶åè¾“å‡ºæ–¹æ³•ï¼›ç„¶åthreadåœ¨æ‹¿åˆ°æ—¶é—´ç‰‡ï¼Œåœ¨ç¡çœ 1sï¼Œåœ¨è¾“å‡º</p>
<p>threadæ‹¿åˆ°æ—¶é—´ç‰‡ï¼Œç„¶åç­‰åˆ°ä¸€ç§’åï¼Œè¾“å‡ºï¼Œthread2æ‹¿åˆ°æ—¶é—´ç‰‡ï¼Œè¾“å‡º</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A1 a = new A1();<br>
Thread thread = new Thread(() -&gt; {a.a1(); });</p>
<pre><code>    Thread thread1 = new Thread(() -&gt; { a.a2(); });
    thread.start();
    thread1.start();
}
</code></pre>
<p>}</p>
<p>@Slf4j<br>
class A1 {<br>
// synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
public synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}</p>
<pre><code>public synchronized void a2() {
    log.info(&quot;222222&quot;);
}
</code></pre>
<p>}<br>
æƒ…å†µ3ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š312æˆ–è€… 321 æˆ–è€…231</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A2 a = new A2();<br>
new Thread(() -&gt; { a.a1(); }).start();<br>
new Thread(() -&gt; { a.a2(); }).start();<br>
new Thread(() -&gt; { a.a3(); }).start();<br>
}<br>
}</p>
<p>@Slf4j<br>
class A2 {<br>
// synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
public synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(2);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}</p>
<pre><code>public synchronized void a2() {
    log.info(&quot;222222&quot;);
}
public  void a3() { log.info(&quot;3333&quot;); }
</code></pre>
<p>æƒ…å†µ4ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š2 1s 1</p>
<pre><code>public static void main(String[] args) throws InterruptedException {
    A2 a1 = new A2();
    A2 a2 = new A2();
    new Thread(() -&gt; { a1.a1(); }).start();
    new Thread(() -&gt; { a2.a2(); }).start();
}
</code></pre>
<p>}</p>
<p>@Slf4j<br>
class A3 {<br>
// synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
public synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}<br>
public synchronized void a2() {<br>
log.info(&quot;222222&quot;);<br>
}<br>
æƒ…å†µ5ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š2 1s 1</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A4 a1 = new A4();<br>
new Thread(() -&gt; { a1.a1(); }).start();<br>
new Thread(() -&gt; { a1.a2(); }).start();<br>
}<br>
}</p>
<p>@Slf4j<br>
class A4 {<br>
/**<br>
* desc:synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
* static é”ä½çš„æ˜¯A4 å¯¹è±¡<br>
*/<br>
public static synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}<br>
public synchronized void a2() {<br>
log.info(&quot;222222&quot;);<br>
}<br>
æƒ…å†µ6ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š2 1s 1 æˆ–è€…1 1s 2</p>
<p>staticé”ä½çš„å¯¹è±¡éƒ½æ˜¯A6</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A6 a1 = new A6();<br>
new Thread(() -&gt; { a1.a1(); }).start();<br>
new Thread(() -&gt; { a1.a2(); }).start();<br>
}<br>
}</p>
<p>@Slf4j<br>
class A6 {<br>
/**<br>
* desc:synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
* static é”ä½çš„æ˜¯A6 å¯¹è±¡<br>
*/<br>
public static synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}<br>
public  static synchronized void a2() {<br>
log.info(&quot;222222&quot;);<br>
}<br>
æƒ…å†µ7ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š2 1s 1</p>
<p>staticé”ä½çš„å¯¹è±¡éƒ½æ˜¯A7</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A7 a1 = new A7();<br>
A7 a2 = new A7();<br>
new Thread(() -&gt; {<br>
a1.a1();<br>
}).start();<br>
new Thread(() -&gt; {<br>
a2.a2();<br>
}).start();<br>
}<br>
}</p>
<p>@Slf4j<br>
class A7 {<br>
/**<br>
* desc:synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
* static é”ä½çš„æ˜¯A6 å¯¹è±¡<br>
*/<br>
public static synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}</p>
<pre><code>public  synchronized void a2() {
    log.info(&quot;222222&quot;);
}
</code></pre>
<p>æƒ…å†µ8ï¼š</p>
<p>ç­”æ¡ˆä¸ºï¼š2 1s 1 æˆ–è€… 1 1s 2</p>
<p>staticé”ä½çš„å¯¹è±¡éƒ½æ˜¯A8</p>
<p>public static void main(String[] args) throws InterruptedException {<br>
A8 a1 = new A8();<br>
A8 a2 = new A8();</p>
<pre><code>    new Thread(() -&gt; {
        a2.a2();
    }).start();
    new Thread(() -&gt; {
        a1.a1();
    }).start();
}
</code></pre>
<p>}</p>
<p>@Slf4j<br>
class A8 {<br>
/**<br>
* desc:synchronized é”ä½çš„æ˜¯thiså¯¹è±¡<br>
* static é”ä½çš„æ˜¯A6 å¯¹è±¡<br>
*/<br>
public static synchronized void a1() {<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.info(&quot;111111&quot;);<br>
}</p>
<pre><code>public static synchronized void a2() {
    log.info(&quot;222222&quot;);
}
</code></pre>
<p>}<br>
4.3 å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</p>
<p>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</p>
<p>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</p>
<p>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ</p>
<p>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</p>
<p>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</p>
<p>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</p>
<p>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…</p>
<p>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</p>
<p>public static void main(String[] args) {<br>
ThreadUnsafe threadUnsafe = new ThreadUnsafe();<br>
for (int i = 0; i &lt; 2; i++) {<br>
new Thread(() -&gt; {<br>
threadUnsafe.test();<br>
});</p>
<pre><code>    }
}
</code></pre>
<p>}</p>
<p>class ThreadUnsafe {<br>
public static List<Integer> list = new ArrayList&lt;&gt;();</p>
<pre><code>public void test() {
    add();
    in();
}

public void add() {
    list.add(1);
}

public void in() {
    list.remove(0);
}
</code></pre>
<p>é™æ€å˜é‡è®¿é—®çš„æ˜¯åœ¨å…±äº«å†…å­˜ä¸­çš„ï¼Œå¤šä¸ªæ ˆå¸§è®¿é—®å°±ä¼šå‡ºç°ä¸å®‰å…¨çš„æƒ…å†µ</p>
<p>image-20210731171800940</p>
<p>å±€éƒ¨å˜é‡</p>
<p>public static void main(String[] args) {<br>
ThreadSafe threadUnsafe = new ThreadSafe();<br>
for (int i = 0; i &lt; 20; i++) {<br>
new Thread(() -&gt; {<br>
threadUnsafe.test();<br>
});</p>
<pre><code>    }
}
</code></pre>
<p>}</p>
<p>class ThreadSafe {</p>
<pre><code>public void test() {
    List&lt;Integer&gt; list = new ArrayList&lt;&gt;();
    add(list);
    in(list);
}

public void add(List&lt;Integer&gt; list) {
    list.add(1);
}

public void in(List&lt;Integer&gt; list) {
    list.remove(0);
}
</code></pre>
<p>å±€éƒ¨å˜é‡ä½¿ç”¨çš„æ—¶å€™ï¼Œåˆ›å»ºå®ä¾‹çš„æ—¶å€™ä¼šå•ç‹¬åˆ›å»ºå¯¹è±¡ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨çš„</p>
<p>image-20210731172201260</p>
<p>å¦‚æœæ–¹æ³•ä¿®é¥°ç¬¦ï¼šæ˜¯ä½¿ç”¨privite  é‚£ä¹ˆåªèƒ½è‡ªå·±å»è°ƒç”¨ï¼Œè‚¯å®šçº¿ç¨‹å®‰å…¨ã€‚å¦‚æœæ˜¯finalä¿®é¥° é‚£ä¹ˆå°±ä¸èƒ½è¢«æ”¹å˜ã€‚</p>
<p>å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»</p>
<p>String</p>
<p>Integer</p>
<p>StringBuffer</p>
<p>Random</p>
<p>Vector</p>
<p>Hashtable</p>
<p>java.util.concurrentåŒ…ä¸‹çš„ç±»</p>
<p>è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸ºå®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„</p>
<p>ä½†æ³¨æ„å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ï¼Œè§åé¢åˆ†æ</p>
<p>çº¿ç¨‹å®‰å…¨ç±»çš„ç»„åˆ</p>
<p>åˆ†æä»¥ä¸‹ä»£ç æ˜¯å¦å®‰å…¨</p>
<p>public static void main(String[] args) {<br>
Hashtable&lt;String, String&gt; hashtable = new Hashtable&lt;&gt;();<br>
if (Objects.isNull(hashtable.get(&quot;key&quot;))){<br>
hashtable.put(&quot;key&quot;, &quot;a&quot;);<br>
}<br>
}<br>
å­˜åœ¨çº¿ç¨‹1 çº¿ç¨‹2 åŒæ—¶æ“ä½œtable ä½†æ˜¯ç”±äºä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œçº¿ç¨‹1æ‰§è¡Œåˆ°äº†åˆ¤æ–­ä¸ºnull çš„æ—¶å€™ï¼Œå°±æŠŠæ—¶é—´ç‰‡äº¤å‡ºå»äº†ï¼Œç„¶åçº¿ç¨‹2 åˆ¤æ–­äº†ä¸ºnullï¼Œç„¶åèµ‹å€¼æ“ä½œï¼Œæ—¶é—´ç‰‡åœ¨äº¤ç»™1ï¼Œå°±ä¼šå­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„æ“ä½œ</p>
<p>çº¿ç¨‹1<br>
çº¿ç¨‹1<br>
çº¿ç¨‹2<br>
çº¿ç¨‹2<br>
table<br>
table<br>
get(&quot;key&quot;)==null<br>
get(&quot;key&quot;)==null<br>
put(&quot;key&quot;,v2)<br>
put(&quot;key&quot;,v1)<br>
ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<p>Stringã€Integerç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„<br>
æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒStringæœ‰replaceï¼Œsubstringç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ</p>
<p>å®ä¾‹åˆ†æ</p>
<p>ä¾‹1:</p>
<p>public class MyServlet extends HttpServlet {<br>
â€‹<br>
/*<em>çº¿ç¨‹ä¸å®‰å…¨</em>/<br>
Map&lt;String, String&gt; map = new HashMap&lt;&gt;();<br>
/*<em>çº¿ç¨‹å®‰å…¨</em>/<br>
String s1 = &quot;a&quot;;<br>
/*<em>çº¿ç¨‹å®‰å…¨</em>/<br>
final String s2 = &quot;22&quot;;<br>
/*<em>çº¿ç¨‹ä¸å®‰å…¨</em>/<br>
Date date = new Date();<br>
/*<em>çº¿ç¨‹ä¸å®‰å…¨</em>/<br>
final Date date2 = new Date();<br>
â€‹<br>
@Override<br>
public void doGet(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse){<br>
// ä½¿ç”¨ä¸Šé¢çš„å˜é‡<br>
â€‹<br>
}<br>
}<br>
ä¾‹2:</p>
<p>çº¿ç¨‹ä¸å®‰å…¨ï¼Œä¼šæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨count</p>
<p>â€‹<br>
public class MyServlet extends HttpServlet {<br>
@Autowired<br>
private UserService userService;<br>
â€‹<br>
@Override<br>
public void doGet(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse){<br>
// ä½¿ç”¨ä¸Šé¢çš„å˜é‡<br>
userService.update();<br>
}}<br>
â€‹<br>
public class UserServiceImpl implements UserService {<br>
private int count = 0;<br>
â€‹<br>
@Override<br>
public void update() {<br>
count++;<br>
}<br>
}</p>
<p>ä¾‹3:</p>
<p>ä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä½¿ç”¨äº†å…±äº«å˜é‡ï¼Œæ¨¡å¼æ˜¯å•ä¾‹æ¨¡å¼</p>
<p>long l;<br>
â€‹<br>
@Pointcut(&quot;execution(* com.example.heimajuc.<em>.</em>(..))&quot;)<br>
public void pointcut() {<br>
â€‹<br>
}<br>
â€‹<br>
@Before(&quot;pointcut()&quot;)<br>
public void before() {<br>
l = System.nanoTime();<br>
System.out.println(&quot;before&quot;);<br>
}<br>
â€‹<br>
@After(&quot;pointcut()&quot;)<br>
public void after() {<br>
System.out.println(&quot;after&quot;);<br>
System.out.println(&quot;è€—æ—¶ï¼š&quot; + (System.nanoTime() - l));<br>
}<br>
ä¾‹4:</p>
<p>å¸¸è§„æ“ä½œå†™æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºéƒ½æ˜¯å¼€å¯äº†æ–°çš„æ ˆå¸§ï¼Œå¹¶ä¸”æ²¡æœ‰å¼•ç”¨éƒ½æ˜¯ç¨€æœ‰çš„ï¼Œåªèƒ½è‡ªå·±è°ƒç”¨ã€‚</p>
<p>public class MyServlet extends HttpServlet {<br>
@Autowired<br>
private UserService userService;<br>
â€‹<br>
@Override<br>
public void doGet(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse){<br>
// ä½¿ç”¨ä¸Šé¢çš„å˜é‡<br>
userService.update();<br>
}}</p>
<p>@Service<br>
public class UserServiceImpl implements UserService {<br>
â€‹<br>
@Autowired<br>
private UserMapper userMapper;<br>
â€‹<br>
@Override<br>
public void update() {<br>
List<User> userList=  userMapper.SelectList(null);<br>
}<br>
}<br>
ä¾‹5:</p>
<p>å¸¸è§„æ“ä½œå†™æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒUserDaoImplè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œæ‰€ä»¥conn è¢«å…±äº«äº†ã€‚æ‰€ä»¥å¯èƒ½å­˜åœ¨çº¿ç¨‹1åœ¨è·å–connçš„æ—¶å€™ï¼Œçº¿ç¨‹2 å·²ç»è·å–åˆ°äº†å¹¶ä¸”æ‰§è¡Œå®Œäº†ï¼Œç„¶åconnå…³é—­äº† close</p>
<p>public class MyServlet extends HttpServlet {<br>
@Autowired<br>
private UserService userService;<br>
â€‹<br>
@Override<br>
public void doGet(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse){<br>
// ä½¿ç”¨ä¸Šé¢çš„å˜é‡<br>
userService.update();<br>
}}</p>
<p>@Service<br>
public class UserServiceImpl implements UserService {<br>
â€‹<br>
@Autowired<br>
private UserDao userDao;<br>
â€‹<br>
â€‹<br>
@Override<br>
public void update() {<br>
userDao.update();<br>
}<br>
}<br>
â€‹<br>
@Mapper<br>
public class UserDaoImpl implements UserService {<br>
â€‹<br>
private Connect conn=null;</p>
<pre><code>@Override
public void update() {
  String sql =&quot;update user set password = ? where username =?&quot;; 
conn = DriverManager.getconnection(&quot;&quot;,&quot;&quot;,&quot;&quot;);
conn.close();
}
</code></pre>
<p>}<br>
â€‹<br>
â€‹<br>
ä¾‹6:</p>
<p>å¸¸è§„æ“ä½œå†™æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒUserServiceImplæ¯æ¬¡éƒ½æ˜¯æ–°å»ºç«‹çš„ï¼Œç§æœ‰çš„æ ˆå¸§</p>
<p>public class MyServlet extends HttpServlet {<br>
@Autowired<br>
private UserService userService;<br>
â€‹<br>
@Override<br>
public void doGet(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse){<br>
// ä½¿ç”¨ä¸Šé¢çš„å˜é‡<br>
userService.update();<br>
}}</p>
<p>@Service<br>
public class UserServiceImpl implements UserService {<br>
â€‹<br>
@Override<br>
public void update() {<br>
UserDao userDao =new UserDaoImpl();</p>
<pre><code>userDao.update();
}
</code></pre>
<p>}<br>
â€‹<br>
@Mapper<br>
public class UserDaoImpl implements UserService {<br>
â€‹<br>
private Connect conn=null;</p>
<pre><code>@Override
public void update() {
  String sql =&quot;update user set password = ? where username =?&quot;; 
conn = DriverManager.getconnection(&quot;&quot;,&quot;&quot;,&quot;&quot;);
conn.close();
}
</code></pre>
<p>}<br>
â€‹<br>
â€‹<br>
ä¾‹7:</p>
<p>å¸¸è§„æ“ä½œå†™æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</p>
<p>Stringç±»ä¸ºä»€ä¹ˆè®¾ç½®ä¸ºfinal ï¼Œå› ä¸ºå¦‚æœä¸è®¾ç½®æˆfinalï¼Œstringçš„å­ç±»å¯èƒ½è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ï¼Œç„¶åå¯èƒ½å¯¼è‡´ä¿®æ”¹æˆ–è€…è¦†ç›–æ‰äº†çˆ¶ç±»çš„ä¸€äº›è¡Œä¸ºï¼Œå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p>4.4 ç»ƒä¹ </p>
<p>å–ç¥¨ç»ƒä¹ </p>
<p>çº¿ç¨‹ä¸å®‰å…¨</p>
<p>ä¸´ç•ŒåŒºï¼šå¯¹å…±äº«å˜é‡æœ‰è¯»å†™æ“ä½œçš„åŒºåŸŸ</p>
<p>public class SellTicketDemo {<br>
â€‹<br>
public static void main(String[] args) {<br>
â€‹<br>
WindowsSell windowsSell = new WindowsSell(1000);<br>
// çº¿ç¨‹å®‰å…¨çš„List<br>
List<Integer> sellCount = new Vector&lt;&gt;();<br>
List<Thread> list = new ArrayList&lt;&gt;();<br>
for (int i = 0; i &lt; 2000; i++) {<br>
Thread thread = new Thread(() -&gt; {<br>
// å¼€å§‹ä¹°ç¥¨<br>
int sell = windowsSell.sell(getRandom());<br>
sellCount.add(sell);<br>
});<br>
thread.start();<br>
list.add(thread);<br>
}<br>
for (Thread thread : list) {<br>
try {<br>
thread.join();<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
}<br>
System.out.println(&quot;å–å‡ºçš„æ€»æ•°ï¼š&quot; + sellCount.stream().mapToInt(Integer::intValue).sum());<br>
System.out.println(&quot;å‰©ä½™çš„æ€»æ•°ï¼š&quot; + windowsSell.getCount());<br>
â€‹<br>
}<br>
â€‹<br>
/**<br>
* ç”Ÿäº§éšæœºæ•°<br>
*/<br>
private static Integer getRandom() {<br>
return new Random().nextInt(5) + 1;<br>
}<br>
â€‹<br>
}<br>
â€‹<br>
â€‹<br>
class WindowsSell {<br>
private int count;<br>
â€‹<br>
WindowsSell(int ticketCount) {<br>
this.count = ticketCount;<br>
}<br>
â€‹<br>
int getCount() {<br>
return count;<br>
}<br>
â€‹<br>
int sell(int tickerNum) {<br>
if (tickerNum &lt; count) {<br>
this.count -= tickerNum;<br>
return tickerNum;<br>
}<br>
return 0;<br>
}<br>
}<br>
è¾“å‡ºï¼š</p>
<p>å–å‡ºçš„æ€»æ•°ï¼š1008<br>
å‰©ä½™çš„æ€»æ•°ï¼š1<br>
è§£å†³åŠæ³•1ï¼šåŠ synchronized</p>
<p>synchronized int sell(int tickerNum) {<br>
if (tickerNum &lt; count) {<br>
this.count -= tickerNum;<br>
return tickerNum;<br>
}<br>
return 0;<br>
}<br>
4.5 Monitoræ¦‚å¿µ</p>
<p>Javaå¯¹è±¡å¤´</p>
<p>ä»¥32ä½è™šæ‹Ÿæœºä¸ºä¾‹</p>
<p>æ™®é€šå¯¹è±¡ï¼š</p>
<p>image-20210801205334561</p>
<p>æ•°ç»„å¯¹è±¡ï¼š</p>
<p>image-20210801205400575</p>
<p>å…¶ä¸­Mark Wordç»“æ„ä¸ºï¼š</p>
<p>image-20210801205706101</p>
<p>Monitor(é”)</p>
<p>Monitorè¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹<br>
æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨synchronizedç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Wordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆ</p>
<p>Monitorç»“æ„å¦‚ä¸‹</p>
<p>image-20210801210926521</p>
<p>è¿‡ç¨‹ï¼š</p>
<p>åˆšå¼€å§‹ monitorçš„Owneræ˜¯æ²¡æœ‰ä¸»äººçš„</p>
<p>å½“Thread2è·å–é”å¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šæˆä¸ºMonitorçš„Ownerï¼Œä¸€ä¸ªMonitoråªæœ‰ä¸€ä¸ªOwner</p>
<p>åœ¨Thread2æ‰§è¡Œè¿‡ç¨‹è¿‡ç¨‹ä¸­çš„æ—¶å€™ï¼Œå…¶ä»–çš„Threadçº¿ç¨‹æ¥æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç çš„æ—¶å€™ï¼Œå°±ä¼šè¿›å…¥åˆ°EntryListä¸­å˜æˆBLOCKEDçŠ¶æ€</p>
<p>å½“Thread2æ‰§è¡Œå®Œæ¯•åï¼Œå°±ä¸å†æ˜¯æ˜¯Monitorçš„ä¸»äººï¼ŒOwnerçš„ä¸ºç©ºï¼Œç„¶åå°±ä¼šå”¤é†’EntryListä¸­çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶å€™æ˜¯éå…¬å¹³çš„ï¼Œå°±ä¼šå¼€å§‹ç«äº‰è·å–Owner</p>
<p>å›¾ä¸­Thread2æ˜¯ä¹‹å‰è·å–åˆ°é”çš„ï¼Œä½†æ˜¯ä¸æ»¡è¶³æ¡ä»¶è¿›å…¥WAITINGçŠ¶æ€çš„çº¿ç¨‹</p>
<p>æ³¨æ„âš ï¸ï¼š</p>
<p>synchronizedå¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„monitoræ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</p>
<p>ä¸åŠ synchronizedï¼Œçš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</p>
<p>åŸç†ä¹‹synchronized</p>
<p>é‡ç‚¹é‡ç‚¹ğŸŒŸCode</p>
<p>public class MonitorDemo {<br>
static int count = 0;<br>
static final Object OBJECT = new Object();<br>
public static void main(String[] args) {<br>
synchronized (OBJECT.class) {<br>
count++;<br>
}<br>
â€‹<br>
}<br>
}<br>
å¯¹åº”çš„å­—èŠ‚ç ï¼š</p>
<p>image-20210801220837207</p>
<p>æ•…äº‹ï¼š</p>
<p>image-20210801221105163</p>
<p>image-20210801221145300</p>
<p>SynchronizedåŸç†è¿›é˜¶</p>
<p>è½»é‡çº§é”</p>
<p>è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚<br>
è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯synchronized</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</p>
<p>private static  final Object OBJECT = new Object();<br>
â€‹<br>
private static void method1() {<br>
synchronized (OBJECT){<br>
method();<br>
}<br>
}<br>
private static void method() {<br>
synchronized (OBJECT){<br>
â€‹<br>
}<br>
}<br>
image-20210801231540211</p>
<p>image-20210801231557726</p>
<p>image-20210801231717225</p>
<p>image-20210801231756727</p>
<p>image-20210801232009436</p>
<p>image-20210801232048833</p>
<p>é”è†¨èƒ€</p>
<p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­,CASæ“ä½œæ— æ³•æˆåŠŸ,è¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”(æœ‰ç«äº‰),è¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€,å°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</p>
<p>image-20210805214701753</p>
<p>image-20210805214613850</p>
<p>image-20210805214819790</p>
<p>ã€‚å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§Monitoråœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œè®¾ç½®Ownerä¸ºnullï¼Œå”¤é†’EntryListä¸­BLOCKEDçº¿ç¨‹</p>
<p>è‡ªæ—‹ä¼˜åŒ–</p>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p>
<p>image-20210808124421980</p>
<p>image-20210808124519420</p>
<p>åœ¨Java6ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</p>
<p>è‡ªæ—‹ä¼šå ç”¨CPUæ—¶é—´ï¼Œå•æ ¸CPUè‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸CPUè‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚<br>
Java7ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½</p>
<p>åå‘é”</p>
<p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡ŒCASæ“ä½œã€‚<br>
Java6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡çš„Mark Wordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹Dæ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–°CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰ã€‚</p>
<p>é”é‡å…¥-- mainè°ƒç”¨m1,ç„¶åm1è°ƒç”¨m2,m1ã€m2åŠ äº†é”ï¼Œå½“è¿›å…¥m2çš„æ—¶å€™ï¼Œå‘ç”Ÿäº†é‡å…¥ï¼Œç„¶åm2æ–¹æ³•è°ƒç”¨m3çš„æ˜¯ï¼Œåˆé”é‡å…¥</p>
<p>private static final Object OBJECT = new Object();</p>
<pre><code>public static void main(String[] args) {
    m1();
}

static void m1() {
    synchronized (OBJECT) {
        m2();
    }
}

static void m2() {
    synchronized (OBJECT) {
        m3();
    }
}

static void m3() {
    synchronized (OBJECT) {
        System.out.println(&quot;1&quot;);
    }
}
</code></pre>
<p>image-20210808125526972</p>
<p>image-20210808125804598</p>
<p>åå‘çŠ¶æ€</p>
<p>å¯¹è±¡å¤´æ ¼å¼</p>
<p>biased_lockï¼š1 è¡¨ç¤ºåå‘çŠ¶æ€ã€‚é»˜è®¤å¼€å¯</p>
<p>image-20210808172019584</p>
<p>1ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š<br>
å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼ä¸º0x05å³æœ€å3ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„thread. epoch. ageéƒ½ä¸º0</p>
<p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ VMå‚æ•°- xXï¼šBiasedLockingStartupDelay=0æ¥ç¦ç”¨å»¶è¿Ÿ</p>
<p>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼ä¸º0x01å³æœ€å3ä½ä¸º001ï¼Œè¿™æ—¶å®ƒçš„hashcodeã€age éƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼</p>
<p>image-20210808175029112</p>
<p>3ï¼‰æµ‹è¯•ç¦ç”¨<br>
åœ¨ä¸Šé¢æµ‹è¯•ä»£ç è¿è¡Œæ—¶åœ¨æ·»åŠ VMå‚æ•°-xXï¼š-UseBiasedLockingç¦ç”¨åå‘é”</p>
<p>4ï¼‰æµ‹è¯•hashCode</p>
<p>public static void main(String[] args) {<br>
Dog dog = new Dog();<br>
// æ‰“å°hashcodeä»¥åï¼Œåå‘é”ä¼šå…³é—­ï¼Œå› ä¸ºåœ¨å¼€å¯åå‘é”çŠ¶æ€çš„æ—¶å€™ ï¼Œæ²¡æœ‰åœ°æ–¹å­˜hashcodeï¼Œæ‰€ä»¥åªèƒ½æ˜¯æœªå¼€å¯åå‘çŠ¶æ€æ‰èƒ½å­˜å‚¨hashcode<br>
dog.hashCode();<br>
log.info(&quot;åŠ é”å‰ï¼Œ{}&quot;, ClassLayout.parseInstance(dog).toPrintable());<br>
4.6 wait/notify</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦wait/notifyï¼Ÿ</p>
<p>image-20210815111733460</p>
<p>image-20210815111826451</p>
<p>åŸç†ä¹‹notify/wait</p>
<p>image-20210815111948526</p>
<p>APIä»‹ç»</p>
<p>æ‰€æœ‰çš„å‰ææ¡ä»¶ï¼šæ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡é”</p>
<p>object.wait(); è¿›å…¥waitsetä¸­ç­‰å¾…å”¤é†’</p>
<p>object.wait(2); è¿›å…¥waitsetä¸­ç­‰å¾…å”¤é†’ï¼Œå¦‚æœåˆ°äº†2sä¸­è¿˜æ˜¯æ²¡æœ‰å”¤é†’ï¼Œå°±ä¸å†ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œæ“ä½œ</p>
<p>object.notify();å”¤é†’waitSetä¸­çš„æŸä¸€ä¸ªçº¿ç¨‹</p>
<p>object.notifyAll();å”¤é†’waitSetä¸­çš„æ‰€æœ‰çš„çº¿ç¨‹</p>
<p>private static Object object = new Object();</p>
<pre><code>public static void main(String[] args) {
    new Thread(() -&gt; {
        log.info(&quot;t1å¼€å§‹äº†&quot;);
        synchronized (object) {
            try {
                object.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            log.info(&quot;t1å¼€å§‹å…¶ä»–äº†&quot;);
        }
    }, &quot;t1&quot;).start();


    new Thread(() -&gt; {
        log.info(&quot;t2å¼€å§‹äº†&quot;);
        synchronized (object) {
            try {
                // è¿›å…¥ç­‰å¾…
                object.wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            log.info(&quot;t2å¼€å§‹å…¶ä»–äº†&quot;);
        }
    }, &quot;t2&quot;).start();

    try {
        TimeUnit.SECONDS.sleep(2);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    synchronized (object) {
        // å”¤é†’waitSetä¸­çš„æŸä¸€ä¸ª
</code></pre>
<p>//            object.notify();<br>
// å”¤é†’waitSetä¸­çš„æ‰€æœ‰çš„<br>
object.notifyAll();<br>
}</p>
<pre><code>}
</code></pre>
<p>4.7 wait/notifyçš„æ­£ç¡®å§¿åŠ¿</p>
<p>sleepå’Œwaitçš„åŒºåˆ«</p>
<p>waitæ˜¯Objectçš„é˜²èŒƒï¼Œsleepæ˜¯Threadçš„é™æ€æ–¹æ³•</p>
<p>waitéœ€è¦å’Œsynchronizedä¸€èµ·ä½¿ç”¨ï¼Œå¿…é¡»è¦è·å¾—å¯¹è±¡é”ï¼Œsleepä¸éœ€è¦å¼ºåˆ¶å’Œsynchronizeä¸€èµ·ä½¿ç”¨</p>
<p>waitçš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œsleepåœ¨ç¡çœ çš„æ—¶å€™ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”</p>
<p>ä»–ä»¬çš„çŠ¶æ€éƒ½æ˜¯TIMED_WAITING</p>
<p>Step1</p>
<p>ä¸Šè¿°æ•…äº‹å¼€å§‹ç¬¬ä¸€æ­¥</p>
<p>static final Object OBJECT = new Object();<br>
static boolean hasCigarette = false;<br>
static boolean hasTokenTime = false;</p>
<pre><code>public static void main(String[] args) {
    new Thread(() -&gt; {
        synchronized (OBJECT){
            log.info(&quot;å—å¼€å§‹å¹²æ´»å„¿&quot;);
            if (!hasCigarette) {
                log.info(&quot;æ²¡æœ‰çƒŸä¸å¹²æ´»å„¿&quot;);
                try {
                    TimeUnit.SECONDS.sleep(2);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;æœ‰çƒŸ?ï¼Œ{}&quot;, hasCigarette);
            if (hasCigarette) {
                log.info(&quot;æœ‰çƒŸå¼€å§‹å¹²æ´»å„¿&quot;);
            }
        }
    }, &quot;å°å—&quot;).start();

    for (int i = 0; i &lt; 5; i++) {
        synchronized (OBJECT){
            new Thread(()-&gt;{
                log.info(&quot;å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿&quot;);
            },&quot;å…¶ä»–äºº&quot;).start();
        }
    }
    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    new Thread(()-&gt;{
        hasCigarette = true;
        log.info(&quot;é€çƒŸ&quot;);
    },&quot;ğŸš¬&quot;).start();
}
</code></pre>
<p>é—®é¢˜ï¼š</p>
<p>å°å—æ²¡æœ‰çƒŸçš„æ—¶å€™å°±ä¼šé˜»å¡ä¸¤ç§’ï¼Œä¸ç®¡çƒŸæ˜¯ä¸¤ç§’å‰é€åˆ°è¿˜æœ‰ä¸¤ç§’åé€åˆ°ï¼Œå°å—éƒ½è¦ä¼‘çœ 2s</p>
<p>å°å—ä¼‘æ¯çš„æ—¶å€™ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¹Ÿæ— æ³•æ‰§è¡Œ</p>
<p>è§£å†³åŠæ³•ï¼šä½¿ç”¨interruptæ‰“æ–­sleep æˆ–è€…ä½¿ç”¨wait/notify</p>
<p>Step2</p>
<p>ä½¿ç”¨wait/notify</p>
<p>static final Object OBJECT = new Object();<br>
static boolean hasCigarette = false;<br>
static boolean hasTokenTime = false;</p>
<pre><code>public static void main(String[] args) {
    new Thread(() -&gt; {
        synchronized (OBJECT){
            log.info(&quot;å—å¼€å§‹å¹²æ´»å„¿&quot;);
            if (!hasCigarette) {
                log.info(&quot;æ²¡æœ‰çƒŸä¸å¹²æ´»å„¿&quot;);
                try {
                    OBJECT.wait(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;æœ‰çƒŸ?ï¼Œ{}&quot;, hasCigarette);
            if (hasCigarette) {
                log.info(&quot;æœ‰çƒŸå¼€å§‹å¹²æ´»å„¿&quot;);
            }
        }
    }, &quot;å°å—&quot;).start();

    for (int i = 0; i &lt; 5; i++) {

        new Thread(()-&gt;{
            synchronized (OBJECT){
                log.info(&quot;å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿&quot;);
            }
        },&quot;å…¶ä»–äºº&quot;).start();
    }
    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    new Thread(()-&gt;{
        synchronized (OBJECT){
            log.info(&quot;é€çƒŸ&quot;);
            hasCigarette = true;
            OBJECT.notifyAll();
        }
    },&quot;ğŸš¬&quot;).start();
}
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p>19:55:33.517 [å°å—] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å—å¼€å§‹å¹²æ´»å„¿<br>
19:55:33.521 [å°å—] INFO com.example.heimajuc.demo.demo1UserWaitNotify - æ²¡æœ‰çƒŸä¸å¹²æ´»å„¿<br>
19:55:33.522 [å…¶ä»–äºº] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿<br>
19:55:33.523 [å…¶ä»–äºº] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿<br>
19:55:33.523 [å…¶ä»–äºº] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿<br>
19:55:33.524 [å…¶ä»–äºº] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿<br>
19:55:33.524 [å…¶ä»–äºº] INFO com.example.heimajuc.demo.demo1UserWaitNotify - å…¶ä»–äººå¼€å§‹å¹²æ´»å„¿<br>
19:55:34.528 [ğŸš¬] INFO com.example.heimajuc.demo.demo1UserWaitNotify - é€çƒŸ<br>
19:55:34.528 [å°å—] INFO com.example.heimajuc.demo.demo1UserWaitNotify - æœ‰çƒŸ?ï¼Œtrue<br>
19:55:34.530 [å°å—] INFO com.example.heimajuc.demo.demo1UserWaitNotify - æœ‰çƒŸå¼€å§‹å¹²æ´»å„¿<br>
è§£å†³å…¶ä»–å¹²æ´»çš„çº¿ç¨‹é˜»å¡é—®é¢˜</p>
<p>ä½†æ˜¯å¦‚æœå…¶ä»–çº¿ç¨‹ä¹Ÿæœ‰ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿï¼Ÿ</p>
<p>Step3</p>
<p>OBJECT.notify(); æ˜¯éšæœºå«é†’çº¿ç¨‹</p>
<p>static final Object OBJECT = new Object();<br>
static boolean hasCigarette = false;<br>
static boolean hasTokenTime = false;</p>
<pre><code>// è™šå‡å”¤é†’
public static void main(String[] args) {
    new Thread(() -&gt; {
        synchronized (OBJECT){
            log.info(&quot;å—å¼€å§‹å¹²æ´»å„¿&quot;);
            if (!hasCigarette) {
                log.info(&quot;æ²¡æœ‰çƒŸä¸å¹²æ´»å„¿&quot;);
                try {
                    OBJECT.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;æœ‰çƒŸ?ï¼Œ{}&quot;, hasCigarette);
            if (hasCigarette) {
                log.info(&quot;æœ‰çƒŸå¼€å§‹å¹²æ´»å„¿&quot;);
            }
        }
    }, &quot;å°å—&quot;).start();
    new Thread(() -&gt; {
        synchronized (OBJECT){
            log.info(&quot;å¥³å¼€å§‹å¹²æ´»å„¿&quot;);
            if (!hasTokenTime) {
                log.info(&quot;æ²¡æœ‰å¤–å–ä¸å¹²æ´»å„¿&quot;);
                try {
                    OBJECT.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;æœ‰å¤–å–ä»–ï¼Ÿï¼Ÿï¼Œ{}&quot;, hasTokenTime);
            if (hasTokenTime) {
                log.info(&quot;æœ‰å¤–å–å¼€å§‹å¹²æ´»å„¿&quot;);
            }
        }
    }, &quot;å°å¥³&quot;).start();



    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    new Thread(()-&gt;{
        synchronized (OBJECT){
            log.info(&quot;é€å¤–å–&quot;);
            hasTokenTime = true;
            OBJECT.notify();
            OBJECT.notifyAll();
        }
    },&quot;ğŸ¥¡&quot;).start();
}
</code></pre>
<p>å¦‚ä½•è§£å†³è™šå‡å”¤é†’çº¿ç¨‹ï¼Ÿ</p>
<p>ä½¿ç”¨notifyAllå¯ä»¥å«é†’æ‰€æœ‰çš„waitçº¿ç¨‹</p>
<p>ä½†æ˜¯ifåŠ waitåªæœ‰ä¸€æ¬¡æœºä¼šï¼Œå¦‚æœå”¤é†’çš„æ—¶å€™ï¼Œæ¡ä»¶æ²¡æœ‰è¾¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ç»“æŸäº†ï¼Œä¸ç¬¦åˆé¢„æœŸï¼Œå¿…é¡»æ˜¯ç­‰å¾…çŠ¶æ€</p>
<p>Step4</p>
<p>è§£å†³åŠæ³•æ˜¯ç”¨while+waitè§£å†³é—®é¢˜ï¼Œå¦‚æœæ¡ä»¶æ²¡æœ‰è¾¾åˆ°ï¼Œé‚£ä¹ˆå°±ä¸€ç›´ç­‰å¾…</p>
<p>new Thread(() -&gt; {<br>
synchronized (OBJECT){<br>
log.info(&quot;å—å¼€å§‹å¹²æ´»å„¿&quot;);<br>
while (!hasCigarette) {<br>
log.info(&quot;æ²¡æœ‰çƒŸä¸å¹²æ´»å„¿&quot;);<br>
try {<br>
OBJECT.wait();<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
}<br>
log.info(&quot;æœ‰çƒŸ?ï¼Œ{}&quot;, hasCigarette);<br>
if (hasCigarette) {<br>
log.info(&quot;æœ‰çƒŸå¼€å§‹å¹²æ´»å„¿&quot;);<br>
}<br>
}<br>
}, &quot;å°å—&quot;).start();<br>
æ€»ç»“ï¼šæ­£ç¡®å§¿åŠ¿</p>
<p>synchronized(LOCK){<br>
// çº¿ç¨‹1<br>
while(æ¡ä»¶ä¸æˆç«‹){<br>
LOCK.wait();<br>
}<br>
// æ¡ä»¶æˆç«‹ï¼Œå»å¹²æ´»å„¿<br>
}</p>
<p>// çº¿ç¨‹2<br>
synchronized(LOCK){<br>
// æ¡ä»¶æˆç«‹ å”¤é†’æ“ä½œ<br>
LOCK.notifyAll();<br>
}<br>
æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ -&gt;æ¨¡å¼ç¯‡md</p>
<p>4.8 Parkå’ŒUnParkçš„ä½¿ç”¨</p>
<p>åŸºæœ¬ä½¿ç”¨</p>
<p>LockSupport.park();<br>
LockSupport.unpark(thread);<br>
Demo</p>
<p>@Slf4j<br>
public class ParkAndUnPark {</p>
<pre><code>public static void main(String[] args) {

    Thread thread = new Thread(() -&gt; {
        try {
            TimeUnit.SECONDS.sleep(2);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(&quot;å¼€å§‹park&quot;);
        LockSupport.park();
        log.info(&quot;å¼€å§‹resume&quot;);
    }, &quot;çº¿ç¨‹1&quot;);

    thread.start();

    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.info(&quot;å¼€å§‹unpark&quot;);
    LockSupport.unpark(thread);
}
</code></pre>
<p>}<br>
è¾“å‡ºï¼š</p>
<p>17:12:34.654 [main] INFO com.example.heimajuc.park2demo.ParkAndUnPark - å¼€å§‹unpark<br>
17:12:35.645 [çº¿ç¨‹1] INFO com.example.heimajuc.park2demo.ParkAndUnPark - å¼€å§‹park<br>
17:12:35.645 [çº¿ç¨‹1] INFO com.example.heimajuc.park2demo.ParkAndUnPark - å¼€å§‹resume<br>
ç‰¹ç‚¹ï¼šä¸notifyAllã€waitçš„åŒºåˆ«</p>
<p>waitï¼Œnotifyå’ŒnotifyAllå¿…é¡»é…åˆObject Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œparkï¼Œunparkä¸å¿…</p>
<p>park &amp; unparkæ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œnotifyåªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAllæ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘</p>
<p>park &amp; unparkå¯ä»¥å…ˆunparkï¼Œè€Œwait &amp; notifyä¸èƒ½å…ˆnotify</p>
<p>åŸç†</p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªParkerå¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆcounterï¼Œcondå’Œ_mutexæ‰“ä¸ªæ¯”å–»</p>
<p>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParkerå°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚_counterå°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³ï¼‰</p>
<p>è°ƒç”¨parkå°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯<br>
1ã€å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯</p>
<p>2ã€å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›</p>
<p>è°ƒç”¨unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³<br>
1ã€å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›<br>
2ã€å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨parkæ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›<br>
aã€å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨unparkä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®</p>
<p>å›¾è§£ï¼š</p>
<p>image-20210829172232556</p>
<p>1.å½“å‰çº¿ç¨‹è°ƒç”¨Unsafe.park()æ–¹æ³•<br>
2.æ£€æŸ¥counterï¼Œæœ¬æƒ…å†µä¸º0ï¼Œè¿™æ—¶ï¼Œè·å¾—mutexäº’æ–¥é”<br>
3.çº¿ç¨‹è¿›å…¥condæ¡ä»¶å˜é‡é˜»å¡<br>
4.è®¾ç½®counter=0</p>
<p>image-20210829223727960</p>
<p>è°ƒç”¨Unsafe.unparkï¼ˆThread_0ï¼‰æ–¹æ³•ï¼Œè®¾ç½®_counterä¸º1</p>
<p>å”¤é†’_condæ¡ä»¶å˜é‡ä¸­çš„Thread_0</p>
<p>Thread_Oæ¢å¤è¿è¡Œ</p>
<p>è®¾ç½®_counterä¸º0</p>
<p>image-20210829223620343</p>
<p>1.è°ƒç”¨Unsafe.unparkï¼ˆThread_0ï¼‰æ–¹æ³•ï¼Œè®¾ç½®counterä¸º1<br>
2.å½“å‰çº¿ç¨‹è°ƒç”¨Unsafe.parkï¼ˆï¼‰æ–¹æ³•<br>
3.æ£€æŸ¥counterï¼Œæœ¬æƒ…å†µä¸º1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ<br>
4.è®¾ç½®_counterä¸º0</p>
<p>4.10 é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</p>
<p>image-20210829224618064</p>
<p>æƒ…å†µ1 NEW-&gt;RUNNABLE</p>
<p>new Thread().start();</p>
<p>æƒ…å†µ2 RUNNABLE&lt;---&gt;WAITING</p>
<p>tçº¿ç¨‹ synchronized(obj) è·å–äº†å¯¹è±¡é”ä»¥å</p>
<p>è°ƒç”¨obj.wait(); ,tçº¿ç¨‹å°±ä¼šä»RUNNABLE-&gt;WAITING</p>
<p>å½“obj.notifyAll(); ä¼šå‡ºç°ä¸¤ç§æƒ…å†µ</p>
<p>ç«äº‰é”æˆåŠŸï¼Œtçº¿ç¨‹ä»WAITING-&gt;RUNNING</p>
<p>ç«äº‰é”å¤±è´¥ï¼Œtçº¿ç¨‹ä»WAITING-&gt;BLOCKED</p>
<p>image-20210920215318339</p>
<p>image-20210920215532572</p>
<p>ä»£ç CODEï¼š</p>
<p>public class TestWaitNotify {</p>
<pre><code>private static Object object = new Object();

public static void main(String[] args) {
    new Thread(() -&gt; {
        log.info(&quot;t1çº¿ç¨‹å¼€å§‹&quot;);
        try {
            synchronized (object) {
                object.wait();
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(&quot;t1çº¿ç¨‹å¼€ç»“æŸ&quot;);
    }, &quot;t1&quot;).start();
    new Thread(() -&gt; {
        log.info(&quot;t2çº¿ç¨‹å¼€å§‹&quot;);
        try {
            synchronized (object) {
                object.wait();
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info(&quot;t2çº¿ç¨‹å¼€ç»“æŸ&quot;);
    }, &quot;t2&quot;).start();

    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    synchronized (object) {
        // å”¤é†’waitSetä¸­çš„æŸä¸€ä¸ª
</code></pre>
<p>//            object.notify();<br>
// å”¤é†’waitSetä¸­çš„æ‰€æœ‰çš„<br>
object.notifyAll();<br>
}<br>
}<br>
}<br>
æƒ…å†µ3 RUNNABLE&lt;---&gt;WAITING</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ t.join()æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»Runnable--&gt;Waiting</p>
<p>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨tçº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</p>
<p>tçº¿ç¨‹è¿è¡Œç»“æŸåï¼Œæˆ–è€…è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„interrupt()æ–¹æ³•çš„æ—¶å€™ï¼Œå½“å‰çº¿ç¨‹æ˜¯ä»Waiting--&gt;Runnable</p>
<p>æƒ…å†µ4 WAITING&lt;---&gt;RUNNABLE</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨LockSupport.park()æ–¹æ³•çš„æ—¶å€™ï¼Œå½“å‰çº¿ç¨‹ä¼šä»RUNNABLE--&gt;WAITING</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨unpark(ç›®æ ‡çº¿ç¨‹)æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ–è€…è°ƒç”¨äº†interruptæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹çš„çŠ¶æ€ä»WAITING--&gt;RUNNABLE</p>
<p>æƒ…å†µ5 RUNNABLE&lt;---&gt;TIME_WAITING</p>
<p>tçº¿ç¨‹è·å¾—å¯¹è±¡é”sychronized(obj)çš„æ—¶å€™</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ obj.wait(long n)æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»Runnable--&gt;TIME_Waiting</p>
<p>tçº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡nç§’ä»¥åï¼Œæˆ–è€…è°ƒç”¨äº†obj.notify(),obj.notifyAll()æ–¹æ³•åï¼Œæˆ–è€…è°ƒç”¨äº†t.interrupt()æ–¹æ³•å</p>
<p>ç«äº‰é”æˆåŠŸï¼Œtçº¿ç¨‹ä»TIME_WAITING---&gt;RUNNABLE</p>
<p>ç«äº‰é”å¤±è´¥ï¼Œtçº¿ç¨‹ä»TIME_WAITING---&gt;BLOCKED</p>
<p>æƒ…å†µ6 RUNNABLE&lt;---&gt;TIME_WAITING</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ t.join(long n)æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»RUNNABLE--&gt;TIME_WAITING</p>
<p>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨tçº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</p>
<p>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡næ¯«ç§’ä»¥åï¼Œæˆ–è€…tçº¿ç¨‹éªŒè¯ç»“æŸåï¼Œæˆ–è€…è°ƒç”¨å½“å‰çº¿ç¨‹çš„interrupt()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹ä»TIME_WAITING---&gt;RUNNABLE</p>
<p>æƒ…å†µ7 RUNNABLE&lt;---&gt;TIME_WAITING</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ LockSupport.parkNanos(long nanos)æ–¹æ³•æ—¶ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹è°ƒç”¨äº†LockSupport.parkUntil(long deadline)æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»RUNNABLE--&gt;TIME_WAITING</p>
<p>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡næ¯«ç§’ä»¥åï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹è°ƒç”¨unpark(ç›®æ ‡çº¿ç¨‹)æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ–è€…è°ƒç”¨äº†interruptæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹çš„çŠ¶æ€ä»TIME_WAITING---&gt;RUNNABLE</p>
<p>æƒ…å†µ8 RUNNABLE&lt;---&gt;TIME_WAITING</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ Thread.sleep(long ms)æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»RUNNABLE--&gt;TIME_WAITING</p>
<p>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡næ¯«ç§’ä»¥åï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹è°ƒç”¨unpark(ç›®æ ‡çº¿ç¨‹)æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ–è€…è°ƒç”¨äº†interruptæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹çš„çŠ¶æ€ä»TIME_WAITING---&gt;RUNNABLE</p>
<p>æƒ…å†µ9 RUNNABLE&lt;---&gt;BLOCKED</p>
<p>T1çº¿ç¨‹åœ¨ä½¿ç”¨synchronize(obj)ç«äº‰é”çš„æ—¶å€™ï¼Œå¦‚æœç«äº‰é”å¤±è´¥ï¼ŒT1çº¿ç¨‹å°±ä»RUNNABLE--&gt;BLOCKED</p>
<p>æŒæœ‰OBJé”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•åï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰BLOCKEDçš„çº¿ç¨‹å…¨éƒ¨é‡æ–°ç«äº‰é”ï¼Œå¦‚æœç«äº‰åˆ°äº†ï¼Œå°±ä¼šä»BLOCKEDå˜æˆRUNNABLEï¼Œå…¶ä»–å¤±è´¥çš„çº¿ç¨‹ä¾ç„¶æ˜¯BLOCKEDçŠ¶æ€ã€‚</p>
<p>æƒ…å†µ10 RUNNABLE&lt;---&gt;TERMINATE</p>
<p>å½“å‰çº¿ç¨‹è¿è¡Œç»“æŸä»¥åï¼Œå½“å‰çº¿ç¨‹ä»RUNNABLE--&gt;TERMINATE</p>
<p>4.11 å¤šæŠŠé”ğŸ”’</p>
<p>ä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚</p>
<p>ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰</p>
<p>@Slf4j<br>
public class MoreLockDemo {</p>
<pre><code>public static void main(String[] args) {
    BigRoom bigRoom = new BigRoom();
    new Thread(() -&gt; {
        bigRoom.sleep();
    }, &quot;çº¿ç¨‹1&quot;).start();
    new Thread(() -&gt; {
        bigRoom.study();
    }, &quot;çº¿ç¨‹2&quot;).start();
}
</code></pre>
<p>}</p>
<p>@Slf4j<br>
class BigRoom {<br>
private final Object obj = new Object();</p>
<pre><code>public void sleep() {
    synchronized (obj) {
        log.info(&quot;å¼€å§‹ç¡è§‰&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

public void study() {
    synchronized (obj) {
        log.info(&quot;å¼€å§‹å­¦ä¹ &quot;);
        try {
            TimeUnit.SECONDS.sleep(2);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>}<br>
è¾“å‡ºç»“æœï¼Œå¹¶å‘ä¸é«˜</p>
<p>15:01:43.777 [çº¿ç¨‹1] INFO com.example.heimajuc.demo.BigRoom - å¼€å§‹ç¡è§‰<br>
15:01:44.780 [çº¿ç¨‹2] INFO com.example.heimajuc.demo.BigRoom - å¼€å§‹å­¦ä¹ <br>
é‡‡ç”¨å¤šæŠŠé”ï¼Œæ§åˆ¶ï¼Œæé«˜å¹¶å‘</p>
<p>@Slf4j<br>
class BigRoom {<br>
private final Object sleep = new Object();<br>
private final Object study = new Object();</p>
<pre><code>public void sleep() {
    synchronized (sleep) {
        log.info(&quot;å¼€å§‹ç¡è§‰&quot;);
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

public void study() {
    synchronized (study) {
        log.info(&quot;å¼€å§‹å­¦ä¹ &quot;);
        try {
            TimeUnit.SECONDS.sleep(2);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>}<br>
è¾“å‡ºç»“æœï¼š</p>
<p>15:02:06.507 [çº¿ç¨‹2] INFO com.example.heimajuc.demo.BigRoom - å¼€å§‹å­¦ä¹ <br>
15:02:06.507 [çº¿ç¨‹1] INFO com.example.heimajuc.demo.BigRoom - å¼€å§‹ç¡è§‰<br>
å°†é”çš„ç²’åº¦ç»†åˆ†ï¼š</p>
<p>å¥½å¤„ï¼Œä¼šå¢åŠ å¹¶å‘åº¦</p>
<p>å¥½å¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</p>
<p>4.12 æ´»è·ƒåº¦</p>
<p>æ­»é”</p>
<p>æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”</p>
<p>t1çº¿ç¨‹è·å¾—Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Bå¯¹è±¡çš„é”</p>
<p>t2çº¿ç¨‹è·å¾—Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Aå¯¹è±¡çš„é”</p>
<p>demoï¼š</p>
<p>public static void main(String[] args) {<br>
Object o1 = new Object();<br>
Object o2 = new Object();<br>
new Thread(() -&gt; {<br>
synchronized (o1) {<br>
log.info(&quot;t1---info&quot;);<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
synchronized (o2) {<br>
log.info(&quot;111&quot;);<br>
}<br>
}<br>
}, &quot;t1&quot;).start();</p>
<pre><code>    new Thread(() -&gt; {
        synchronized (o2) {
            log.info(&quot;t2---info&quot;);
            try {
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (o1) {
                log.info(&quot;222&quot;);
            }
        }
    }, &quot;t2&quot;).start();

}
</code></pre>
<p>å®šä½æ­»é”</p>
<p>æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨jpså®šä½è¿›ç¨‹idï¼Œå†ç”¨jstackå®šä½æ­»é”ï¼š</p>
<p>jpså®šä½è¿›ç¨‹id:</p>
<p>âœ  heima-juc git:(master) âœ— jps<br>
90551 RemoteMavenServer36<br>
91065 TestDeadLock<br>
91064 Launcher<br>
17806 IptiqLixApp<br>
23167<br>
91102 Jps<br>
ç”¨jstackå®šä½æ­»é”:</p>
<p>âœ  heima-juc git:(master) âœ— jstack 91065</p>
<p>&quot;t2&quot; #11 prio=5 os_prio=31 tid=0x00007fbd730fe000 nid=0x3a03 waiting for monitor entry [0x00007000088ff000]<br>
java.lang.Thread.State: BLOCKED (on object monitor)<br>
at com.example.heimajuc.demo.TestDeadLock.lambda$main<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>(</mo><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>D</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>L</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>42</mn><mo>)</mo><mo>âˆ’</mo><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo>&lt;</mo><mn>0</mn><mi>x</mi><mn>000000076</mn><mi>b</mi><mn>3753</mn><mi>a</mi><mn>8</mn><mo>&gt;</mo><mo>(</mo><mi>a</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo>)</mo><mo>âˆ’</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo>&lt;</mo><mn>0</mn><mi>x</mi><mn>000000076</mn><mi>b</mi><mn>3753</mn><mi>b</mi><mn>8</mn><mo>&gt;</mo><mo>(</mo><mi>a</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo>)</mo><mi>a</mi><mi>t</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">.</mi><mi>e</mi><mi>x</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>h</mi><mi>e</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>j</mi><mi>u</mi><mi>c</mi><mi mathvariant="normal">.</mi><mi>d</mi><mi>e</mi><mi>m</mi><mi>o</mi><mi mathvariant="normal">.</mi><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>D</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>L</mi><mi>o</mi><mi>c</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">1(TestDeadLock.java:42)
        - waiting to lock &lt;0x000000076b3753a8&gt; (a java.lang.Object)
        - locked &lt;0x000000076b3753b8&gt; (a java.lang.Object)
        at com.example.heimajuc.demo.TestDeadLock</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">a</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">7</span><span class="mord">6</span><span class="mord mathdefault">b</span><span class="mord">3</span><span class="mord">7</span><span class="mord">5</span><span class="mord">3</span><span class="mord mathdefault">a</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">7</span><span class="mord">6</span><span class="mord mathdefault">b</span><span class="mord">3</span><span class="mord">7</span><span class="mord">5</span><span class="mord">3</span><span class="mord mathdefault">b</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord">.</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord">.</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">u</span><span class="mord mathdefault">c</span><span class="mord">.</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>$Lambda$2/2110121908.run(Unknown Source)<br>
at java.lang.Thread.run(Thread.java:748)</p>
<p>&quot;t1&quot; #10 prio=5 os_prio=31 tid=0x00007fbd730ae800 nid=0x3903 waiting for monitor entry [0x00007000087fc000]<br>
java.lang.Thread.State: BLOCKED (on object monitor)<br>
at com.example.heimajuc.demo.TestDeadLock.lambda$main<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>(</mo><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>D</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>L</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>28</mn><mo>)</mo><mo>âˆ’</mo><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo>&lt;</mo><mn>0</mn><mi>x</mi><mn>000000076</mn><mi>b</mi><mn>3753</mn><mi>b</mi><mn>8</mn><mo>&gt;</mo><mo>(</mo><mi>a</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo>)</mo><mo>âˆ’</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo>&lt;</mo><mn>0</mn><mi>x</mi><mn>000000076</mn><mi>b</mi><mn>3753</mn><mi>a</mi><mn>8</mn><mo>&gt;</mo><mo>(</mo><mi>a</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo>)</mo><mi>a</mi><mi>t</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">.</mi><mi>e</mi><mi>x</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>h</mi><mi>e</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>j</mi><mi>u</mi><mi>c</mi><mi mathvariant="normal">.</mi><mi>d</mi><mi>e</mi><mi>m</mi><mi>o</mi><mi mathvariant="normal">.</mi><mi>T</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>D</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>L</mi><mi>o</mi><mi>c</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">0(TestDeadLock.java:28)
        - waiting to lock &lt;0x000000076b3753b8&gt; (a java.lang.Object)
        - locked &lt;0x000000076b3753a8&gt; (a java.lang.Object)
        at com.example.heimajuc.demo.TestDeadLock</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">a</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">7</span><span class="mord">6</span><span class="mord mathdefault">b</span><span class="mord">3</span><span class="mord">7</span><span class="mord">5</span><span class="mord">3</span><span class="mord mathdefault">b</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mord mathdefault">x</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">7</span><span class="mord">6</span><span class="mord mathdefault">b</span><span class="mord">3</span><span class="mord">7</span><span class="mord">5</span><span class="mord">3</span><span class="mord mathdefault">a</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord">.</span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord">.</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">u</span><span class="mord mathdefault">c</span><span class="mord">.</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>$Lambda$1/231685785.run(Unknown Source)<br>
at java.lang.Thread.run(Thread.java:748)<br>
ä½¿ç”¨jconsoleæ£€æµ‹æ­»é”ä»¥åŠå®šä½æ­»é”</p>
<p>image-20211031115537515</p>
<p>image-20211031115605879</p>
<p>å“²å­¦å®¶å°±é¤é—®é¢˜</p>
<p>image-20211031115720369</p>
<p>æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ã€‚</p>
<p>â– ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€-ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­åæ¥ç€æ€è€ƒã€‚</p>
<p>â– åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰5æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚</p>
<p>â– å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…</p>
<p>é—®é¢˜ï¼šå¦‚æœæ¯ä¸ªäººéƒ½æ‹¿èµ·äº†ä¸€ä¸ªç­·å­ï¼Œé‚£ä¹ˆå°±æ˜¯æ­»é”äº†ï¼Œæ‰€æœ‰äººéƒ½åœ¨ç­‰å¾…</p>
<p>Code:</p>
<p>@Slf4j<br>
public class PhilosophersEatProblem {</p>
<pre><code>public static void main(String[] args) {

    Chopsticks chopsticks1 = new Chopsticks(&quot;1&quot;);
    Chopsticks chopsticks2 = new Chopsticks(&quot;2&quot;);
    Chopsticks chopsticks3 = new Chopsticks(&quot;3&quot;);
    Chopsticks chopsticks4 = new Chopsticks(&quot;4&quot;);
    Chopsticks chopsticks5 = new Chopsticks(&quot;5&quot;);
    new Philosophers(&quot;è‹æ ¼æ‹‰åº•&quot;, chopsticks1, chopsticks2).start();
    new Philosophers(&quot;æŸæ‹‰å›¾&quot;, chopsticks2, chopsticks3).start();
    new Philosophers(&quot;äºšé‡Œå£«å¤šå¾·&quot;, chopsticks3, chopsticks4).start();
    new Philosophers(&quot;å¼ ä¸‰&quot;, chopsticks4, chopsticks5).start();
    new Philosophers(&quot;é‡Œæ–¯&quot;, chopsticks5, chopsticks1).start();

}
</code></pre>
<p>}</p>
<p>/**</p>
<ul>
<li>
<p>@author JackGao</p>
</li>
<li>
<p>@since 2021/10/31</p>
</li>
<li>
<p>desc: å“²å­¦å®¶ç±»<br>
*/<br>
@EqualsAndHashCode(callSuper = true)<br>
@Data<br>
@Slf4j<br>
class Philosophers extends Thread {</p>
<p>Chopsticks left;<br>
Chopsticks right;</p>
<p>public Philosophers(String name, Chopsticks left, Chopsticks right) {<br>
super(name);<br>
this.left = left;<br>
this.right = right;<br>
}</p>
<p>@Override<br>
public void run() {<br>
while (true) {<br>
synchronized (left) {<br>
synchronized (right) {<br>
eat();<br>
}<br>
}<br>
}</p>
<p>}</p>
<p>private void eat() {<br>
log.info(&quot;eating...&quot;);<br>
// æ€è€ƒé—®é¢˜ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br>
try {<br>
TimeUnit.SECONDS.sleep(1);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
}<br>
}</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>@author JackGao</li>
<li>@since 2021/10/31</li>
<li>
<p>
</li>
<li>desc:ç­·å­</li>
<li>
</p>
</li>
</ul>
<p>*/<br>
@Data<br>
class Chopsticks {</p>
<pre><code>String name;

public Chopsticks(String name) {
    this.name = name;
}

@Override
public String toString() {
    return &quot;Chopsticks{&quot; +
            &quot;name='&quot; + name + '\'' +
            '}';
}
</code></pre>
<p>}</p>
<p>console resultï¼š</p>
<p>14:26:20.360 [äºšé‡Œå£«å¤šå¾·] INFO com.example.heimajuc.demo.Philosophers - eating...<br>
14:26:21.361 [æŸæ‹‰å›¾] INFO com.example.heimajuc.demo.Philosophers - eating...<br>
14:26:22.362 [æŸæ‹‰å›¾] INFO com.example.heimajuc.demo.Philosophers - eating...<br>
14:26:23.366 [æŸæ‹‰å›¾] INFO com.example.heimajuc.demo.Philosophers - eating...<br>
14:26:24.366 [æŸæ‹‰å›¾] INFO com.example.heimajuc.demo.Philosophers - eating...<br>
ä½¿ç”¨jconsoleæŸ¥çœ‹ç»“æœï¼šå‘ç°äº§ç”Ÿäº†æ­»é”</p>
<p>image-20211101143339725</p>
<p>æ´»é”</p>
<p>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜äº†å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚</p>
<p>codeï¼š</p>
<p>@Slf4j<br>
public class LiveLockDemo {<br>
static volatile int COUNT = 10;<br>
static final Object OBJECT = new Object();</p>
<pre><code>public static void main(String[] args) {
    new Thread(() -&gt; {
        while (COUNT &gt; 0) {
            try {
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            COUNT--;
            log.info(&quot;count,{}&quot;, COUNT);
        }
    }, &quot;t1&quot;).start();

    new Thread(() -&gt; {
        while (COUNT &lt; 20) {
            try {
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            COUNT++;
            log.info(&quot;count,{}&quot;, COUNT);
        }
    }, &quot;t2&quot;).start();
}
</code></pre>
<p>}<br>
console resultï¼š</p>
<p>14:59:17.514 [t1] INFO com.example.heimajuc.demo.LiveLockDemo - count,10<br>
14:59:18.520 [t1] INFO com.example.heimajuc.demo.LiveLockDemo - count,10<br>
14:59:18.520 [t2] INFO com.example.heimajuc.demo.LiveLockDemo - count,10<br>
14:59:19.520 [t2] INFO com.example.heimajuc.demo.LiveLockDemo - count,10<br>
14:59:19.520 [t1] INFO com.example.heimajuc.demo.LiveLockDemo - count,9<br>
14:59:20.524 [t2] INFO com.example.heimajuc.demo.LiveLockDemo - count,11<br>
14:59:20.524 [t1] INFO com.example.heimajuc.demo.LiveLockDemo - count,11<br>
è§£å†³åŠæ³•ï¼šä½¿ä¸¤ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´æœ‰äº¤é”™ï¼Œå°±å¯ä»¥é¿å…æˆ–è€…å¢åŠ éšæœºç¡çœ æ—¶é—´</p>
<p>é¥¥é¥¿</p>
<p>å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ°CPUè°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜<br>
ä¸‹é¢æˆ‘è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿çš„ä¾‹å­ï¼Œå…ˆæ¥çœ‹çœ‹ä½¿ç”¨é¡ºåºåŠ é”çš„æ–¹å¼è§£å†³ä¹‹å‰çš„æ­»é”é—®é¢˜</p>
<p>image-20211101150501490</p>
<p>é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<p>image-20211101150523056</p>
<p>4.13 ReentrantLock</p>
<p>reentrant é‡å…¥  reentrantLock å¯ä»¥é‡å…¥é”<br>
ç›¸å¯¹äºsynchronizedå®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼Œ</p>
<p>å¯ä¸­æ–­</p>
<p>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</p>
<p>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</p>
<p>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</p>
<p>ä¸synchronizedä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥</p>
<p>åŸºæœ¬è¯­æ³•ï¼š</p>
<p>// è·å–é”<br>
reentrantLock.lock();<br>
try {<br>
// ä¸´ç•ŒåŒº<br>
}finally {<br>
reentrantLock.unlock();<br>
}<br>
å¯é‡å…¥é”</p>
<p>å¯é‡å…¥ï¼šæ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”<br>
å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½</p>
<p>codeï¼š</p>
<p>@Slf4j<br>
public class ReentrantLockDemo {<br>
private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();</p>
<pre><code>public static void main(String[] args) {

    REENTRANT_LOCK.lock();
    try {
        // ä¸´ç•ŒåŒº
        log.info(&quot;main&quot;);
        m1();
    } finally {
        REENTRANT_LOCK.unlock();
    }

}

private static void m1() {
    REENTRANT_LOCK.lock();
    try {
        // ä¸´ç•ŒåŒº
        log.info(&quot;m1&quot;);
        m2();
    } finally {
        REENTRANT_LOCK.unlock();
    }
}

private static void m2() {
    REENTRANT_LOCK.lock();
    try {
        // ä¸´ç•ŒåŒº
        log.info(&quot;m2&quot;);
    } finally {
        REENTRANT_LOCK.unlock();
    }
}
</code></pre>
<p>}<br>
console resultï¼š</p>
<p>15:50:51.472 [main] INFO com.example.heimajuc.demo.ReentrantLockDemo - main<br>
15:50:51.479 [main] INFO com.example.heimajuc.demo.ReentrantLockDemo - m1<br>
15:50:51.479 [main] INFO com.example.heimajuc.demo.ReentrantLockDemo - m2<br>
å¯æ‰“æ–­</p>
<p>synchronizeä¸èƒ½è¢«æ‰“æ–­ï¼Œè·å–åˆ°é”äº†ï¼Œå°±æ˜¯è·å–åˆ°é”äº†ï¼Œä½†æ˜¯reentrantLockå¯ä»¥è¢«æ‰“æ–­</p>
<p>codeï¼š</p>
<p>@Slf4j<br>
public class ReentrantLock_interruptDemo {<br>
private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();</p>
<pre><code>public static void main(String[] args) {

    Thread thread = new Thread(() -&gt; {
        try {
            log.info(&quot;å°è¯•è·å–é”&quot;);
            REENTRANT_LOCK.lockInterruptibly();
        } catch (InterruptedException e) {
            log.info(&quot;è¢«æ‰“æ–­&quot;);
            e.printStackTrace();
            // å¦‚æœè¢«æ‰“æ–­  æ²¡æœ‰returnè¿”å› é‚£ä¹ˆä¼šç»§ç»­å¾€ä¸‹èµ° é‡
            log.info(&quot;1ã€è§£é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
            return;
        }
        try {
            log.info(&quot;è·å–åˆ°é”&quot;);
            log.info(&quot;2ã€è§£é”äº†å—?ï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
        } finally {
            REENTRANT_LOCK.unlock();
            log.info(&quot;3ã€è§£é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
        }
    });

    REENTRANT_LOCK.lock();
    thread.start();
    log.info(&quot;æ‰“æ–­threadçº¿ç¨‹&quot;);
    thread.interrupt();
    log.info(&quot;4ã€è§£é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
</code></pre>
<p>//        REENTRANT_LOCK.unlock();<br>
//        log.info(&quot;5ã€è§£é”äº†å—ï¼Ÿï¼Œ{}&quot;,REENTRANT_LOCK.isLocked());<br>
}<br>
}<br>
ï¼Ÿï¼Ÿï¼Ÿå¦‚æœçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œæ²¡æœ‰é‡Šæ”¾é”ã€‚ã€‚å’‹åŠï¼Ÿï¼Ÿ</p>
<p>é”è¶…æ—¶</p>
<p>ç«‹å³é‡Šæ”¾é”ï¼Œå¦‚æœè·å–ä¸åˆ°é”å°±ç»“æŸ</p>
<p>REENTRANT_LOCK.tryLock()<br>
demoï¼š</p>
<p>@Slf4j<br>
public class ReentrantLock_TimeOutDemo {<br>
private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();</p>
<pre><code>public static void main(String[] args) {

    Thread thread = new Thread(() -&gt; {
        log.info(&quot;å°è¯•è·å–åˆ°é”&quot;);
        if (!REENTRANT_LOCK.tryLock()) {
            log.info(&quot;è·å–ä¸åˆ°é”&quot;);
            log.info(&quot;1ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
            // ç»“æŸ
            return;
        }
        try {
            log.info(&quot;è·å–åˆ°äº†é”&quot;);
        } finally {
            REENTRANT_LOCK.unlock();
            log.info(&quot;3ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
        }
    });
    REENTRANT_LOCK.lock();
    thread.start();
    log.info(&quot;2ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
}
</code></pre>
<p>}<br>
ç‰¹å®šæ—¶é—´æ‹¿ä¸åˆ°é”åï¼Œå°±ç»“æŸ</p>
<p>REENTRANT_LOCK.tryLock(2, TimeUnit.SECONDS)<br>
demoï¼š</p>
<p>@Slf4j<br>
public class ReentrantLock_HasTimeOutDemo {<br>
private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();</p>
<pre><code>public static void main(String[] args) {

    Thread thread = new Thread(() -&gt; {
        log.info(&quot;å°è¯•è·å–åˆ°é”&quot;);
        try {
            if (!REENTRANT_LOCK.tryLock(2, TimeUnit.SECONDS)) {
                log.info(&quot;è·å–ä¸åˆ°é”&quot;);
                log.info(&quot;1ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
                // ç»“æŸ
                return;
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        try {
            log.info(&quot;è·å–åˆ°äº†é”&quot;);
        } finally {
            log.info(&quot;3ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
            REENTRANT_LOCK.unlock();
        }
    },&quot;t1&quot;);
    REENTRANT_LOCK.lock();
    thread.start();
    try {
        TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    log.info(&quot;ä¸»çº¿ç¨‹é‡Šæ”¾é”&quot;);
    REENTRANT_LOCK.unlock();
    log.info(&quot;2ã€è¢«é”äº†å—ï¼Ÿï¼Œ{}&quot;, REENTRANT_LOCK.isLocked());
}
</code></pre>
<p>}<br>
é”å…¬å¹³</p>
<p>ReentrantLocké»˜è®¤æ˜¯ä¸å…¬å¹³çš„</p>
<p>æºç ï¼šæ˜¯ä¸å…¬å¹³çš„</p>
<pre><code>/**
 * Creates an instance of {@code ReentrantLock} with the
 * given fairness policy.
 *
 * @param fair {@code true} if this lock should use a fair ordering policy
 */
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
</code></pre>
<p>å…¬å¹³é”ä¸€èˆ¬æ²¡å¿…è¦è®¾ç½®ï¼Œä½¿ç”¨å…¬å¹³é”ä¸€èˆ¬ä¼šé™ä½å¹¶å‘ã€‚</p>
<p>æ¡ä»¶å˜é‡</p>
<p>synchronizedä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®²åŸç†æ—¶é‚£ä¸ªwaitSetä¼‘æ¯å®¤ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥waitSetç­‰å¾…<br>
ReentrantLockçš„æ¡ä»¶å˜é‡æ¯”synchronizedå¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ï¼Œè¿™å°±å¥½æ¯”ï¼š</p>
<p>synchronizedæ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯ã€‚</p>
<p>è€ŒReentrantLockæ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’</p>
<p>ä½¿ç”¨æµç¨‹ï¼š</p>
<p>awaitå‰éœ€è¦è·å¾—é”</p>
<p>awaitæ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥conditionObjectç­‰å¾…</p>
<p>awaitçš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰locké”</p>
<p>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</p>
<p>Code template:</p>
<p>é€éªŒé€å¤–å–æ¡ˆä¾‹ï¼š</p>
<p>@Slf4j<br>
public class ReentrantLock_ConditionDemo1 {<br>
private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();<br>
static boolean HAS_CIGARETTE_WAIT = false;<br>
static boolean HAS_TAKEOUT_WAIT = false;<br>
static Condition waitCigaretteRoom = REENTRANT_LOCK.newCondition();<br>
static Condition waitTakeoutRoom = REENTRANT_LOCK.newCondition();</p>
<pre><code>public static void main(String[] args) throws InterruptedException {


    new Thread(() -&gt; {
        REENTRANT_LOCK.lock();
        try {
            while (!HAS_CIGARETTE_WAIT) {
                log.info(&quot;æ²¡æœ‰çƒŸï¼Œä¼‘æ¯ä¸€ä¼šå„¿&quot;);
                // å»ç­‰çƒŸä¼‘æ¯å®¤å†…ç­‰ä¼šå„¿
                try {
                    waitCigaretteRoom.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;æœ‰çƒŸäº†ï¼Œå¼€å§‹iå¹²æ´»æ´»å„¿&quot;);
        } finally {
            REENTRANT_LOCK.unlock();
        }
    }, &quot;t1&quot;).start();


    new Thread(() -&gt; {
        REENTRANT_LOCK.lock();
        try {
            while (!HAS_TAKEOUT_WAIT) {
                log.info(&quot;æ²¡æœ‰ğŸ¥¡ å¤–å–ï¼Œä¼‘æ¯ä¸€ä¼šå„¿&quot;);
                // å»ç­‰å¤–å–å®¤å†…ç­‰ä¼šå„¿
                try {
                    waitTakeoutRoom.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.info(&quot;å¤–å–äº†ï¼Œå¼€å§‹iå¹²æ´»æ´»å„¿&quot;);
        } finally {
            REENTRANT_LOCK.unlock();
        }
    }, &quot;t2&quot;).start();


    TimeUnit.SECONDS.sleep(1);
    new Thread(() -&gt; {
        REENTRANT_LOCK.lock();
        try {
            log.info(&quot;å¼€å§‹ä¹‹å‰é€çƒŸ&quot;);
            HAS_CIGARETTE_WAIT = true;
            waitCigaretteRoom.signal();
        } finally {
            REENTRANT_LOCK.unlock();
        }
    }, &quot;t3&quot;).start();

    TimeUnit.SECONDS.sleep(1);
    new Thread(() -&gt; {
        REENTRANT_LOCK.lock();
        try {
            log.info(&quot;å¼€å§‹ä¹‹å‰é€å¤–å–&quot;);
            HAS_TAKEOUT_WAIT = true;
            waitTakeoutRoom.signal();
        } finally {
            REENTRANT_LOCK.unlock();
        }
    }, &quot;t4&quot;).start();
}
</code></pre>
<p>}<br>
ç¬¬å››ç« æ€»ç»“</p>
<p>æœ¬ç« æˆ‘ä»¬éœ€è¦é‡ç‚¹æŒæ¡çš„æ˜¯ï¼š</p>
<p>åˆ†æå¤šçº¿ç¨‹è®¿é—®å’Œå…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº</p>
<p>ä½¿ç”¨synchronized äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<p>æŒæ¡sychronizedé”å¯¹è±¡è¯­æ³•</p>
<p>æŒæ¡sychronizedåŠ è½½æˆå‘˜æ–¹æ³•ï¼ˆthisï¼‰å’Œé™æ€æ–¹æ³•ï¼ˆclassï¼‰è¯­æ³•</p>
<p>æŒæ¡wait/notifyåŒæ­¥æ–¹æ³•</p>
<p>ä½¿ç”¨lockäº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<p>æŒæ¡lockçš„ä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ï¼ˆè¶…æ—¶é‡Šæ”¾ï¼‰ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡</p>
<p>å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€æŒæ¡å¸¸è§çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨</p>
<p>äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿</p>
<p>åº”ç”¨æ–¹é¢</p>
<p>äº’æ–¥ï¼šä½¿ç”¨stnchronizedæˆ–Lockè¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ</p>
<p>åŒæ­¥ï¼šä½¿ç”¨wait/notifyæˆ–è€…Lockçš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡é—®é¢˜</p>
<p>åŸç†æ–¹é¢</p>
<p>monitorã€sychronizedã€wait/notifyåŸç†</p>
<p>sychronizedè¿›é˜¶åŸç†</p>
<p>park &amp; unparkåŸç†</p>
<p>æ¨¡å¼æ–¹é¢</p>
<p>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</p>
<p>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</p>
<p>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¥‡æ·«æŠ€å·§ä¹‹IDEA]]></title>
        <id>https://WheatJack.github.io/post/idea-kuai-jie-jian-qi-yin-ji-qiao/</id>
        <link href="https://WheatJack.github.io/post/idea-kuai-jie-jian-qi-yin-ji-qiao/">
        </link>
        <updated>2022-01-05T06:29:35.000Z</updated>
        <content type="html"><![CDATA[<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>Windows</th>
<th>Mac</th>
</tr>
</thead>
<tbody>
<tr>
<td>è·³å›ä¸Šä¸€ä¸ªæ“ä½œ</td>
<td></td>
<td>common +[</td>
</tr>
<tr>
<td>è·³å›ä¸‹ä¸€ä¸ªæ“ä½œ</td>
<td></td>
<td>common +]</td>
</tr>
<tr>
<td>Go to implentation</td>
<td></td>
<td>command+option+B</td>
</tr>
<tr>
<td>File Structure</td>
<td></td>
<td>command +F12</td>
</tr>
<tr>
<td>Class</td>
<td></td>
<td>command+ option + U</td>
</tr>
<tr>
<td>Jump  to Source</td>
<td></td>
<td>F4</td>
</tr>
<tr>
<td>æŠ½å–var</td>
<td></td>
<td>ctrl+alt+v</td>
</tr>
<tr>
<td>find all structure</td>
<td></td>
<td>command+ F12</td>
</tr>
<tr>
<td>ç”Ÿæˆtrycatch if ç­‰ç­‰ç­‰</td>
<td></td>
<td>Ctrl+alt +t</td>
</tr>
<tr>
<td>æŸ¥çœ‹å¯¹åº”çš„æ–¹æ³•å‚æ•°å®ç° (ä¾‹å¦‚éœ€è¦å¡«å†™å“ªäº›å‚æ•°)</td>
<td></td>
<td>Ctrl+P</td>
</tr>
</tbody>
</table>
<h1 id="å¥½ç”¨çš„ideaæ’ä»¶">å¥½ç”¨çš„ideaæ’ä»¶</h1>
<h3 id="1-codeglance-ä»£ç è¿·ä½ ç¼©æ”¾å›¾æ’ä»¶"><strong>1ã€CodeGlance ä»£ç è¿·ä½ ç¼©æ”¾å›¾æ’ä»¶</strong></h3>
<h3 id="2-codota">2ã€<strong>Codota</strong></h3>
<h3 id="3-alibaba-cloud-toolkitå¿«é€Ÿéƒ¨ç½²åˆ°æœåŠ¡å™¨">3ã€<strong>Alibaba Cloud Toolkit</strong>å¿«é€Ÿéƒ¨ç½²åˆ°æœåŠ¡å™¨</h3>
<h3 id="4-jrebel-çƒ­åŠ è½½æ’ä»¶">4ã€<strong>JRebel çƒ­åŠ è½½æ’ä»¶</strong></h3>
<h3 id="5-junitgenerator-è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ä»£ç ">5ã€<strong>JUnitGenerator</strong>ã€‚è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ä»£ç ã€‚</h3>
<h3 id="6-mybatis-log-plugin-ç¥çº§-æ ¹æ®æ‰§è¡Œsql-æ›¿æ¢æ‰-æ˜¾ç¤ºå®Œæ•´-sql-ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°æ•°æ®åº“-å°±å¯ä»¥æ‰§è¡Œ">6ã€<strong>MyBatis Log Plugin ç¥çº§</strong> æ ¹æ®æ‰§è¡Œsql æ›¿æ¢æ‰ï¼Œ æ˜¾ç¤ºå®Œæ•´ sql, ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°æ•°æ®åº“ å°±å¯ä»¥æ‰§è¡Œ</h3>
<h3 id="7-mybatiscodehelperpro-è¶…çº§ç‰›é€¼ç¥çº§">7 ã€<strong>MyBatisCodeHelperPro è¶…çº§ç‰›é€¼ç¥çº§</strong></h3>
<h3 id="8-restfultoolkit-æ ¹æ®url-æŸ¥æ‰¾controller">8ã€<strong>RESTfultoolkit æ ¹æ®url æŸ¥æ‰¾controller</strong></h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes Note]]></title>
        <id>https://WheatJack.github.io/post/kubernetes-note/</id>
        <link href="https://WheatJack.github.io/post/kubernetes-note/">
        </link>
        <updated>2022-01-03T06:37:48.000Z</updated>
        <content type="html"><![CDATA[<p>Kubernetes</p>
<h1 id="1-kubernetesä»‹ç»">1. Kubernetesä»‹ç»</h1>
<h2 id="11-åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜">1.1 åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜</h2>
<p>åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼ä¸Šï¼Œä¸»è¦ç»å†äº†ä¸‰ä¸ªæ—¶ä»£ï¼š</p>
<ul>
<li>
<p><strong>ä¼ ç»Ÿéƒ¨ç½²</strong>ï¼šäº’è”ç½‘æ—©æœŸï¼Œä¼šç›´æ¥å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ç‰©ç†æœºä¸Š</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼šç®€å•ï¼Œä¸éœ€è¦å…¶å®ƒæŠ€æœ¯çš„å‚ä¸</p>
<p>ç¼ºç‚¹ï¼šä¸èƒ½ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰èµ„æºä½¿ç”¨è¾¹ç•Œï¼Œå¾ˆéš¾åˆç†åœ°åˆ†é…è®¡ç®—èµ„æºï¼Œè€Œä¸”ç¨‹åºä¹‹é—´å®¹æ˜“äº§ç”Ÿå½±å“</p>
</blockquote>
</li>
<li>
<p><strong>è™šæ‹ŸåŒ–éƒ¨ç½²</strong>ï¼šå¯ä»¥åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼Œæ¯ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªç¯å¢ƒ</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼šç¨‹åºç¯å¢ƒä¸ä¼šç›¸äº’äº§ç”Ÿå½±å“ï¼Œæä¾›äº†ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§</p>
<p>ç¼ºç‚¹ï¼šå¢åŠ äº†æ“ä½œç³»ç»Ÿï¼Œæµªè´¹äº†éƒ¨åˆ†èµ„æº</p>
</blockquote>
</li>
<li>
<p><strong>å®¹å™¨åŒ–éƒ¨ç½²</strong>ï¼šä¸è™šæ‹ŸåŒ–ç±»ä¼¼ï¼Œä½†æ˜¯å…±äº«äº†æ“ä½œç³»ç»Ÿ</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<p>å¯ä»¥ä¿è¯æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰</p>
<p>è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„èµ„æºéƒ½è¢«å®¹å™¨åŒ…è£…ï¼Œå¹¶å’Œåº•å±‚åŸºç¡€æ¶æ„è§£è€¦</p>
<p>å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå¯ä»¥è·¨äº‘æœåŠ¡å•†ã€è·¨Linuxæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆè¿›è¡Œéƒ¨ç½²</p>
</blockquote>
</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gx13o92j30uw0bm0ui.jpg" alt="image-20200505183738289" loading="lazy"></figure>
<p>å®¹å™¨åŒ–éƒ¨ç½²æ–¹å¼ç»™å¸¦æ¥å¾ˆå¤šçš„ä¾¿åˆ©ï¼Œä½†æ˜¯ä¹Ÿä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ï¼š</p>
<ul>
<li>ä¸€ä¸ªå®¹å™¨æ•…éšœåœæœºäº†ï¼Œæ€ä¹ˆæ ·è®©å¦å¤–ä¸€ä¸ªå®¹å™¨ç«‹åˆ»å¯åŠ¨å»æ›¿è¡¥åœæœºçš„å®¹å™¨</li>
<li>å½“å¹¶å‘è®¿é—®é‡å˜å¤§çš„æ—¶å€™ï¼Œæ€ä¹ˆæ ·åšåˆ°æ¨ªå‘æ‰©å±•å®¹å™¨æ•°é‡</li>
</ul>
<p>è¿™äº›å®¹å™¨ç®¡ç†çš„é—®é¢˜ç»Ÿç§°ä¸º<strong>å®¹å™¨ç¼–æ’</strong>é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›å®¹å™¨ç¼–æ’é—®é¢˜ï¼Œå°±äº§ç”Ÿäº†ä¸€äº›å®¹å™¨ç¼–æ’çš„è½¯ä»¶ï¼š</p>
<ul>
<li><strong>Swarm</strong>ï¼šDockerè‡ªå·±çš„å®¹å™¨ç¼–æ’å·¥å…·</li>
<li><strong>Mesos</strong>ï¼šApacheçš„ä¸€ä¸ªèµ„æºç»Ÿä¸€ç®¡æ§çš„å·¥å…·ï¼Œéœ€è¦å’ŒMarathonç»“åˆä½¿ç”¨</li>
<li><strong>Kubernetes</strong>ï¼šGoogleå¼€æºçš„çš„å®¹å™¨ç¼–æ’å·¥å…·</li>
</ul>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gx67bbbj30gh07kjrg.jpg" alt="image-20200524150339551" loading="lazy"></figure>
<h2 id="12-kubernetesç®€ä»‹">1.2 kubernetesç®€ä»‹</h2>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gxa886fj30f107tt8y.jpg" alt="image-20200406232838722" loading="lazy"></figure>
<p>kubernetesï¼Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„åŸºäºå®¹å™¨æŠ€æœ¯çš„åˆ†å¸ƒå¼æ¶æ„é¢†å…ˆæ–¹æ¡ˆï¼Œæ˜¯è°·æ­Œä¸¥æ ¼ä¿å¯†åå‡ å¹´çš„ç§˜å¯†æ­¦å™¨----Borgç³»ç»Ÿçš„ä¸€ä¸ªå¼€æºç‰ˆæœ¬ï¼Œäº2014å¹´9æœˆå‘å¸ƒç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œ2015å¹´7æœˆå‘å¸ƒç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚</p>
<p>kubernetesçš„æœ¬è´¨æ˜¯<strong>ä¸€ç»„æœåŠ¡å™¨é›†ç¾¤</strong>ï¼Œå®ƒå¯ä»¥åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç‰¹å®šçš„ç¨‹åºï¼Œæ¥å¯¹èŠ‚ç‚¹ä¸­çš„å®¹å™¨è¿›è¡Œç®¡ç†ã€‚ç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ï¼Œä¸»è¦æä¾›äº†å¦‚ä¸‹çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>è‡ªæˆ‘ä¿®å¤</strong>ï¼šä¸€æ—¦æŸä¸€ä¸ªå®¹å™¨å´©æºƒï¼Œèƒ½å¤Ÿåœ¨1ç§’ä¸­å·¦å³è¿…é€Ÿå¯åŠ¨æ–°çš„å®¹å™¨</li>
<li><strong>å¼¹æ€§ä¼¸ç¼©</strong>ï¼šå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªåŠ¨å¯¹é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ•°é‡è¿›è¡Œè°ƒæ•´</li>
<li><strong>æœåŠ¡å‘ç°</strong>ï¼šæœåŠ¡å¯ä»¥é€šè¿‡è‡ªåŠ¨å‘ç°çš„å½¢å¼æ‰¾åˆ°å®ƒæ‰€ä¾èµ–çš„æœåŠ¡</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡èµ·åŠ¨äº†å¤šä¸ªå®¹å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å®ç°è¯·æ±‚çš„è´Ÿè½½å‡è¡¡</li>
<li><strong>ç‰ˆæœ¬å›é€€</strong>ï¼šå¦‚æœå‘ç°æ–°å‘å¸ƒçš„ç¨‹åºç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°åŸæ¥çš„ç‰ˆæœ¬</li>
<li><strong>å­˜å‚¨ç¼–æ’</strong>ï¼šå¯ä»¥æ ¹æ®å®¹å™¨è‡ªèº«çš„éœ€æ±‚è‡ªåŠ¨åˆ›å»ºå­˜å‚¨å·</li>
</ul>
<figure data-type="image" tabindex="4"><img src="Kubenetes.assets/image-20200526203726071-1626780706899.png" alt="image-20200526203726071" loading="lazy"></figure>
<h2 id="13-kubernetesç»„ä»¶">1.3 kubernetesç»„ä»¶</h2>
<p>ä¸€ä¸ªkubernetesé›†ç¾¤ä¸»è¦æ˜¯ç”±<strong>æ§åˆ¶èŠ‚ç‚¹(master)</strong>ã€**å·¥ä½œèŠ‚ç‚¹(node)**æ„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šå®‰è£…ä¸åŒçš„ç»„ä»¶ã€‚</p>
<p><strong>masterï¼šé›†ç¾¤çš„æ§åˆ¶å¹³é¢ï¼Œè´Ÿè´£é›†ç¾¤çš„å†³ç­– ( ç®¡ç† )</strong></p>
<blockquote>
<p><strong>ApiServer</strong> : èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶</p>
<p><strong>Scheduler</strong> : è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š</p>
<p><strong>ControllerManager</strong> : è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰</p>
<p><strong>Etcd</strong> ï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯</p>
</blockquote>
<p><strong>nodeï¼šé›†ç¾¤çš„æ•°æ®å¹³é¢ï¼Œè´Ÿè´£ä¸ºå®¹å™¨æä¾›è¿è¡Œç¯å¢ƒ ( å¹²æ´» )</strong></p>
<blockquote>
<p><strong>Kubelet</strong> : è´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨</p>
<p><strong>KubeProxy</strong> : è´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</p>
<p><strong>Docker</strong> : è´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ</p>
</blockquote>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gxcqsfij313w0kpwhr.jpg" alt="image-20200406184656917" loading="lazy"></figure>
<p>ä¸‹é¢ï¼Œä»¥éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡æ¥è¯´æ˜kubernetesç³»ç»Ÿå„ä¸ªç»„ä»¶è°ƒç”¨å…³ç³»ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆè¦æ˜ç¡®ï¼Œä¸€æ—¦kubernetesç¯å¢ƒå¯åŠ¨ä¹‹åï¼Œmasterå’Œnodeéƒ½ä¼šå°†è‡ªèº«çš„ä¿¡æ¯å­˜å‚¨åˆ°etcdæ•°æ®åº“ä¸­</p>
</li>
<li>
<p>ä¸€ä¸ªnginxæœåŠ¡çš„å®‰è£…è¯·æ±‚ä¼šé¦–å…ˆè¢«å‘é€åˆ°masterèŠ‚ç‚¹çš„apiServerç»„ä»¶</p>
</li>
<li>
<p>apiServerç»„ä»¶ä¼šè°ƒç”¨schedulerç»„ä»¶æ¥å†³å®šåˆ°åº•åº”è¯¥æŠŠè¿™ä¸ªæœåŠ¡å®‰è£…åˆ°å“ªä¸ªnodeèŠ‚ç‚¹ä¸Š</p>
<p>åœ¨æ­¤æ—¶ï¼Œå®ƒä¼šä»etcdä¸­è¯»å–å„ä¸ªnodeèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è¿›è¡Œé€‰æ‹©ï¼Œå¹¶å°†ç»“æœå‘ŠçŸ¥apiServer</p>
</li>
<li>
<p>apiServerè°ƒç”¨controller-managerå»è°ƒåº¦NodeèŠ‚ç‚¹å®‰è£…nginxæœåŠ¡</p>
</li>
<li>
<p>kubeletæ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œä¼šé€šçŸ¥dockerï¼Œç„¶åç”±dockeræ¥å¯åŠ¨ä¸€ä¸ªnginxçš„pod</p>
<p>podæ˜¯kubernetesçš„æœ€å°æ“ä½œå•å…ƒï¼Œå®¹å™¨å¿…é¡»è·‘åœ¨podä¸­è‡³æ­¤ï¼Œ</p>
</li>
<li>
<p>ä¸€ä¸ªnginxæœåŠ¡å°±è¿è¡Œäº†ï¼Œå¦‚æœéœ€è¦è®¿é—®nginxï¼Œå°±éœ€è¦é€šè¿‡kube-proxyæ¥å¯¹podäº§ç”Ÿè®¿é—®çš„ä»£ç†</p>
</li>
</ol>
<p>è¿™æ ·ï¼Œå¤–ç•Œç”¨æˆ·å°±å¯ä»¥è®¿é—®é›†ç¾¤ä¸­çš„nginxæœåŠ¡äº†</p>
<h2 id="14-kubernetesæ¦‚å¿µ">1.4 kubernetesæ¦‚å¿µ</h2>
<p><strong>Master</strong>ï¼šé›†ç¾¤æ§åˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªé›†ç¾¤éœ€è¦è‡³å°‘ä¸€ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡æ§</p>
<p><strong>Node</strong>ï¼šå·¥ä½œè´Ÿè½½èŠ‚ç‚¹ï¼Œç”±masteråˆ†é…å®¹å™¨åˆ°è¿™äº›nodeå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œç„¶ånodeèŠ‚ç‚¹ä¸Šçš„dockerè´Ÿè´£å®¹å™¨çš„è¿è¡Œ</p>
<p><strong>Pod</strong>ï¼škubernetesçš„æœ€å°æ§åˆ¶å•å…ƒï¼Œå®¹å™¨éƒ½æ˜¯è¿è¡Œåœ¨podä¸­çš„ï¼Œä¸€ä¸ªpodä¸­å¯ä»¥æœ‰1ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨</p>
<p><strong>Controller</strong>ï¼šæ§åˆ¶å™¨ï¼Œé€šè¿‡å®ƒæ¥å®ç°å¯¹podçš„ç®¡ç†ï¼Œæ¯”å¦‚å¯åŠ¨podã€åœæ­¢podã€ä¼¸ç¼©podçš„æ•°é‡ç­‰ç­‰</p>
<p><strong>Service</strong>ï¼špodå¯¹å¤–æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œä¸‹é¢å¯ä»¥ç»´æŠ¤è€…åŒä¸€ç±»çš„å¤šä¸ªpod</p>
<p><strong>Label</strong>ï¼šæ ‡ç­¾ï¼Œç”¨äºå¯¹podè¿›è¡Œåˆ†ç±»ï¼ŒåŒä¸€ç±»podä¼šæ‹¥æœ‰ç›¸åŒçš„æ ‡ç­¾</p>
<p><strong>NameSpace</strong>ï¼šå‘½åç©ºé—´ï¼Œç”¨æ¥éš”ç¦»podçš„è¿è¡Œç¯å¢ƒ</p>
<h1 id="2-kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º">2. kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º</h1>
<h2 id="21-å‰ç½®çŸ¥è¯†ç‚¹">2.1 å‰ç½®çŸ¥è¯†ç‚¹</h2>
<p>ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetes é›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p><strong>kubeadm</strong></p>
<p>Kubeadm æ˜¯ä¸€ä¸ªK8s éƒ¨ç½²å·¥å…·ï¼Œæä¾›kubeadm init å’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetes é›†ç¾¤ã€‚</p>
<p>å®˜æ–¹åœ°å€ï¼šhttps://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</p>
<p><strong>äºŒè¿›åˆ¶åŒ…</strong></p>
<p>ä»github ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetes é›†ç¾¤ã€‚</p>
<p>Kubeadm é™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetes é›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gxhkbmzj30zv0e9wfx.jpg" alt="image-20200404094800622" loading="lazy"></figure>
<h2 id="22-kubeadm-éƒ¨ç½²æ–¹å¼ä»‹ç»">2.2 kubeadm éƒ¨ç½²æ–¹å¼ä»‹ç»</h2>
<p>kubeadm æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetes é›†ç¾¤çš„éƒ¨ç½²ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªMaster èŠ‚ç‚¹kubeadm init</li>
<li>å°†Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­$ kubeadm join &lt;Master èŠ‚ç‚¹çš„IP å’Œç«¯å£&gt;</li>
</ul>
<h2 id="23-å®‰è£…è¦æ±‚">2.3 å®‰è£…è¦æ±‚</h2>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetes é›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»ŸCentOS7.x-86_x64</li>
<li>ç¡¬ä»¶é…ç½®ï¼š2GB æˆ–æ›´å¤šRAMï¼Œ2 ä¸ªCPU æˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GB æˆ–æ›´å¤š</li>
<li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š</li>
<li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ</li>
<li>ç¦æ­¢swap åˆ†åŒº</li>
</ul>
<h2 id="24-æœ€ç»ˆç›®æ ‡">2.4 æœ€ç»ˆç›®æ ‡</h2>
<ul>
<li>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Docker å’Œkubeadm</li>
<li>éƒ¨ç½²Kubernetes Master</li>
<li>éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶</li>
<li>éƒ¨ç½²Kubernetes Nodeï¼Œå°†èŠ‚ç‚¹åŠ å…¥Kubernetes é›†ç¾¤ä¸­</li>
<li>éƒ¨ç½²Dashboard Web é¡µé¢ï¼Œå¯è§†åŒ–æŸ¥çœ‹Kubernetes èµ„æº</li>
</ul>
<h2 id="25-å‡†å¤‡ç¯å¢ƒ">2.5 å‡†å¤‡ç¯å¢ƒ</h2>
<figure data-type="image" tabindex="7"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gxkd984j30ie0cngmx.jpg" alt="image-20210609000002940" loading="lazy"></figure>
<table>
<thead>
<tr>
<th style="text-align:left">è§’è‰²</th>
<th style="text-align:left">IPåœ°å€</th>
<th style="text-align:left">ç»„ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">k8s-master01</td>
<td style="text-align:left">192.168.5.3</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
<tr>
<td style="text-align:left">k8s-node01</td>
<td style="text-align:left">192.168.5.4</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
<tr>
<td style="text-align:left">k8s-node02</td>
<td style="text-align:left">192.168.5.5</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
</tbody>
</table>
<h2 id="26-ç³»ç»Ÿåˆå§‹åŒ–">2.6 ç³»ç»Ÿåˆå§‹åŒ–</h2>
<h3 id="261-è®¾ç½®ç³»ç»Ÿä¸»æœºåä»¥åŠ-host-æ–‡ä»¶çš„ç›¸äº’è§£æ">2.6.1 è®¾ç½®ç³»ç»Ÿä¸»æœºåä»¥åŠ Host æ–‡ä»¶çš„ç›¸äº’è§£æ</h3>
<pre><code class="language-shell">hostnamectl set-hostname k8s-master01 &amp;&amp; bash
hostnamectl set-hostname k8s-node01 &amp;&amp; bash
hostnamectl set-hostname k8s-node02 &amp;&amp; bash
</code></pre>
<pre><code class="language-shell">cat &lt;&lt;EOF&gt;&gt; /etc/hosts
192.168.5.3     k8s-master01
192.168.5.4     k8s-node01
192.168.5.5     k8s-node02
EOF
</code></pre>
<pre><code class="language-shell">scp /etc/hosts root@192.168.5.4:/etc/hosts 
scp /etc/hosts root@192.168.5.5:/etc/hosts 
</code></pre>
<h3 id="262-å®‰è£…ä¾èµ–æ–‡ä»¶æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.2 å®‰è£…ä¾èµ–æ–‡ä»¶ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git
</code></pre>
<h3 id="263-è®¾ç½®é˜²ç«å¢™ä¸º-iptables-å¹¶è®¾ç½®ç©ºè§„åˆ™æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.3 è®¾ç½®é˜²ç«å¢™ä¸º Iptables å¹¶è®¾ç½®ç©ºè§„åˆ™ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">systemctl stop firewalld &amp;&amp; systemctl disable firewalld

yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save
</code></pre>
<h3 id="264-å…³é—­-selinuxæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.4 å…³é—­ SELINUXï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">swapoff -a &amp;&amp; sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
</code></pre>
<h3 id="265-è°ƒæ•´å†…æ ¸å‚æ•°å¯¹äº-k8sæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.5 è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº K8Sï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">modprobe br_netfilter

cat &lt;&lt;EOF&gt; kubernetes.conf 
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
vm.swappiness=0 # ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ
vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨
vm.panic_on_oom=0 # å¼€å¯ OOM
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
EOF

cp kubernetes.conf /etc/sysctl.d/kubernetes.conf

sysctl -p /etc/sysctl.d/kubernetes.conf
</code></pre>
<h3 id="266-è°ƒæ•´ç³»ç»Ÿæ—¶åŒºæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.6 è°ƒæ•´ç³»ç»Ÿæ—¶åŒºï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell"># è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸º ä¸­å›½/ä¸Šæµ·
timedatectl set-timezone Asia/Shanghai
# å°†å½“å‰çš„ UTC æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ
timedatectl set-local-rtc 0
# é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡
systemctl restart rsyslog
systemctl restart crond
</code></pre>
<h3 id="267-è®¾ç½®-rsyslogd-å’Œ-systemd-journaldæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.7 è®¾ç½® rsyslogd å’Œ systemd journaldï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell"># æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•
mkdir /var/log/journal 
mkdir /etc/systemd/journald.conf.d
cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF
[Journal]
# æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜
Storage=persistent

# å‹ç¼©å†å²æ—¥å¿—
Compress=yes

SyncIntervalSec=5m
RateLimitInterval=30s
RateLimitBurst=1000

# æœ€å¤§å ç”¨ç©ºé—´ 10G
SystemMaxUse=10G

# å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M
SystemMaxFileSize=200M

# æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨
MaxRetentionSec=2week

# ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog
ForwardToSyslog=no
EOF

systemctl restart systemd-journald
</code></pre>
<h3 id="268-kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.8 kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">cat &lt;&lt;EOF&gt; /etc/sysconfig/modules/ipvs.modules 
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4
</code></pre>
<h3 id="269-å®‰è£…-docker-è½¯ä»¶æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.9 å®‰è£… Docker è½¯ä»¶ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">yum install -y yum-utils device-mapper-persistent-data lvm2

yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum install -y docker-ce

## åˆ›å»º /etc/docker ç›®å½•
mkdir /etc/docker

cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
&quot;log-driver&quot;: &quot;json-file&quot;,
&quot;log-opts&quot;: {
&quot;max-size&quot;: &quot;100m&quot;
}
}
EOF
mkdir -p /etc/systemd/system/docker.service.d
# é‡å¯dockeræœåŠ¡
systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker
</code></pre>
<p>ä¸Šä¼ æ–‡ä»¶åˆ°<code>/etc/yum.repos.d/</code>ç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥ ä»£æ›¿ <code>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code> å‘½ä»¤</p>
<p>docker-ce.repo</p>
<pre><code class="language-shell">[docker-ce-stable]
name=Docker CE Stable - $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/stable
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-stable-debuginfo]
name=Docker CE Stable - Debuginfo $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/stable
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-stable-source]
name=Docker CE Stable - Sources
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/stable
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-test]
name=Docker CE Test - $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/test
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-test-debuginfo]
name=Docker CE Test - Debuginfo $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/test
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-test-source]
name=Docker CE Test - Sources
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/test
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-nightly]
name=Docker CE Nightly - $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/nightly
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-nightly-debuginfo]
name=Docker CE Nightly - Debuginfo $basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/nightly
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg

[docker-ce-nightly-source]
name=Docker CE Nightly - Sources
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/nightly
enabled=0
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
</code></pre>
<h3 id="2610-å®‰è£…-kubeadm-æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œ">2.6.10 å®‰è£… Kubeadm ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ“ä½œï¼‰</h3>
<pre><code class="language-shell">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum install -y kubelet kubeadm kubectl &amp;&amp; systemctl enable kubelet
</code></pre>
<h2 id="27-éƒ¨ç½²kubernetes-master">2.7 éƒ¨ç½²Kubernetes Master</h2>
<h3 id="271-åˆå§‹åŒ–ä¸»èŠ‚ç‚¹ä¸»èŠ‚ç‚¹æ“ä½œ">2.7.1 åˆå§‹åŒ–ä¸»èŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹æ“ä½œï¼‰</h3>
<pre><code class="language-shell">kubeadm init --apiserver-advertise-address=192.168.5.3 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.21.1 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16

mkdir -p $HOME/.kube

sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<h3 id="272-åŠ å…¥ä¸»èŠ‚ç‚¹ä»¥åŠå…¶ä½™å·¥ä½œèŠ‚ç‚¹">2.7.2 åŠ å…¥ä¸»èŠ‚ç‚¹ä»¥åŠå…¶ä½™å·¥ä½œèŠ‚ç‚¹</h3>
<pre><code class="language-shell">kubeadm join 192.168.5.3:6443 --token h0uelc.l46qp29nxscke7f7 \
        --discovery-token-ca-cert-hash sha256:abc807778e24bff73362ceeb783cc7f6feec96f20b4fd707c3f8e8312294e28f 
</code></pre>
<h3 id="273-éƒ¨ç½²ç½‘ç»œ">2.7.3 éƒ¨ç½²ç½‘ç»œ</h3>
<pre><code class="language-shell">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<p>ä¸‹è¾¹æ˜¯æ–‡ä»¶</p>
<pre><code class="language-yaml">---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: psp.flannel.unprivileged
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default
    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
spec:
  privileged: false
  volumes:
  - configMap
  - secret
  - emptyDir
  - hostPath
  allowedHostPaths:
  - pathPrefix: &quot;/etc/cni/net.d&quot;
  - pathPrefix: &quot;/etc/kube-flannel&quot;
  - pathPrefix: &quot;/run/flannel&quot;
  readOnlyRootFilesystem: false
  # Users and groups
  runAsUser:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  # Privilege Escalation
  allowPrivilegeEscalation: false
  defaultAllowPrivilegeEscalation: false
  # Capabilities
  allowedCapabilities: ['NET_ADMIN', 'NET_RAW']
  defaultAddCapabilities: []
  requiredDropCapabilities: []
  # Host namespaces
  hostPID: false
  hostIPC: false
  hostNetwork: true
  hostPorts:
  - min: 0
    max: 65535
  # SELinux
  seLinux:
    # SELinux is unused in CaaSP
    rule: 'RunAsAny'
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
rules:
- apiGroups: ['extensions']
  resources: ['podsecuritypolicies']
  verbs: ['use']
  resourceNames: ['psp.flannel.unprivileged']
- apiGroups:
  - &quot;&quot;
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - &quot;&quot;
  resources:
  - nodes
  verbs:
  - list
  - watch
- apiGroups:
  - &quot;&quot;
  resources:
  - nodes/status
  verbs:
  - patch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-system
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-system
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: |
    {
      &quot;name&quot;: &quot;cbr0&quot;,
      &quot;cniVersion&quot;: &quot;0.3.1&quot;,
      &quot;plugins&quot;: [
        {
          &quot;type&quot;: &quot;flannel&quot;,
          &quot;delegate&quot;: {
            &quot;hairpinMode&quot;: true,
            &quot;isDefaultGateway&quot;: true
          }
        },
        {
          &quot;type&quot;: &quot;portmap&quot;,
          &quot;capabilities&quot;: {
            &quot;portMappings&quot;: true
          }
        }
      ]
    }
  net-conf.json: |
    {
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-system
  labels:
    tier: node
    app: flannel
spec:
  selector:
    matchLabels:
      app: flannel
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      hostNetwork: true
      priorityClassName: system-node-critical
      tolerations:
      - operator: Exists
        effect: NoSchedule
      serviceAccountName: flannel
      initContainers:
      - name: install-cni
        image: quay.io/coreos/flannel:v0.14.0
        command:
        - cp
        args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
        volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      containers:
      - name: kube-flannel
        image: quay.io/coreos/flannel:v0.14.0
        command:
        - /opt/bin/flanneld
        args:
        - --ip-masq
        - --kube-subnet-mgr
        resources:
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
          limits:
            cpu: &quot;100m&quot;
            memory: &quot;50Mi&quot;
        securityContext:
          privileged: false
          capabilities:
            add: [&quot;NET_ADMIN&quot;, &quot;NET_RAW&quot;]
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: run
          mountPath: /run/flannel
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      volumes:
      - name: run
        hostPath:
          path: /run/flannel
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: flannel-cfg
        configMap:
          name: kube-flannel-cfg
</code></pre>
<h2 id="28-æµ‹è¯•kubernetes-é›†ç¾¤">2.8 æµ‹è¯•kubernetes é›†ç¾¤</h2>
<h3 id="281-éƒ¨ç½²nginx-æµ‹è¯•">2.8.1 éƒ¨ç½²nginx æµ‹è¯•</h3>
<pre><code class="language-shell">kubectl create deployment nginx --image=nginx

kubectl expose deployment nginx --port=80 --type=NodePort

kubectl get pod,svc
</code></pre>
<h1 id="3-èµ„æºç®¡ç†">3. èµ„æºç®¡ç†</h1>
<h2 id="31-èµ„æºç®¡ç†ä»‹ç»">3.1 èµ„æºç®¡ç†ä»‹ç»</h2>
<p>åœ¨kubernetesä¸­ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œç”¨æˆ·éœ€è¦é€šè¿‡æ“ä½œèµ„æºæ¥ç®¡ç†kubernetesã€‚</p>
<blockquote>
<p>kubernetesçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé›†ç¾¤ç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥åœ¨é›†ç¾¤ä¸­éƒ¨ç½²å„ç§æœåŠ¡ï¼Œæ‰€è°“çš„éƒ¨ç½²æœåŠ¡ï¼Œå…¶å®å°±æ˜¯åœ¨kubernetesé›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªä¸ªçš„å®¹å™¨ï¼Œå¹¶å°†æŒ‡å®šçš„ç¨‹åºè·‘åœ¨å®¹å™¨ä¸­ã€‚</p>
<p>kubernetesçš„æœ€å°ç®¡ç†å•å…ƒæ˜¯podè€Œä¸æ˜¯å®¹å™¨ï¼Œæ‰€ä»¥åªèƒ½å°†å®¹å™¨æ”¾åœ¨<code>Pod</code>ä¸­ï¼Œè€Œkubernetesä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥ç®¡ç†Podï¼Œè€Œæ˜¯é€šè¿‡<code>Podæ§åˆ¶å™¨</code>æ¥ç®¡ç†Podçš„ã€‚</p>
<p>Podå¯ä»¥æä¾›æœåŠ¡ä¹‹åï¼Œå°±è¦è€ƒè™‘å¦‚ä½•è®¿é—®Podä¸­æœåŠ¡ï¼Œkubernetesæä¾›äº†<code>Service</code>èµ„æºå®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœPodä¸­ç¨‹åºçš„æ•°æ®éœ€è¦æŒä¹…åŒ–ï¼Œkubernetesè¿˜æä¾›äº†å„ç§<code>å­˜å‚¨</code>ç³»ç»Ÿã€‚</p>
</blockquote>
<figure data-type="image" tabindex="8"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gxt7q4ij30xn0iewh5.jpg" alt="image-20200406225334627" loading="lazy"></figure>
<blockquote>
<p>å­¦ä¹ kubernetesçš„æ ¸å¿ƒï¼Œå°±æ˜¯å­¦ä¹ å¦‚ä½•å¯¹é›†ç¾¤ä¸Šçš„<code>Podã€Podæ§åˆ¶å™¨ã€Serviceã€å­˜å‚¨</code>ç­‰å„ç§èµ„æºè¿›è¡Œæ“ä½œ</p>
</blockquote>
<h2 id="32-yamlè¯­è¨€ä»‹ç»">3.2 YAMLè¯­è¨€ä»‹ç»</h2>
<p>YAMLæ˜¯ä¸€ä¸ªç±»ä¼¼ XMLã€JSON çš„æ ‡è®°æ€§è¯­è¨€ã€‚å®ƒå¼ºè°ƒä»¥<strong>æ•°æ®</strong>ä¸ºä¸­å¿ƒï¼Œå¹¶ä¸æ˜¯ä»¥æ ‡è¯†è¯­è¨€ä¸ºé‡ç‚¹ã€‚å› è€ŒYAMLæœ¬èº«çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå·ç§°&quot;ä¸€ç§äººæ€§åŒ–çš„æ•°æ®æ ¼å¼è¯­è¨€&quot;ã€‚</p>
<pre><code>&lt;heima&gt;
    &lt;age&gt;15&lt;/age&gt;
    &lt;address&gt;Beijing&lt;/address&gt;
&lt;/heima&gt;
</code></pre>
<pre><code>heima:
  age: 15
  address: Beijing
</code></pre>
<p>YAMLçš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>å¤§å°å†™æ•æ„Ÿ</li>
<li>ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»</li>
<li>ç¼©è¿›ä¸å…è®¸ä½¿ç”¨tabï¼Œåªå…è®¸ç©ºæ ¼( ä½ç‰ˆæœ¬é™åˆ¶ )</li>
<li>ç¼©è¿›çš„ç©ºæ ¼æ•°ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦å¯¹é½å³å¯</li>
<li>'#'è¡¨ç¤ºæ³¨é‡Š</li>
</ul>
<p>YAMLæ”¯æŒä»¥ä¸‹å‡ ç§æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li>çº¯é‡ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼</li>
<li>å¯¹è±¡ï¼šé”®å€¼å¯¹çš„é›†åˆï¼Œåˆç§°ä¸ºæ˜ å°„ï¼ˆmappingï¼‰/ å“ˆå¸Œï¼ˆhashï¼‰ / å­—å…¸ï¼ˆdictionaryï¼‰</li>
<li>æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼ï¼Œåˆç§°ä¸ºåºåˆ—ï¼ˆsequenceï¼‰ / åˆ—è¡¨ï¼ˆlistï¼‰</li>
</ul>
<pre><code># çº¯é‡, å°±æ˜¯æŒ‡çš„ä¸€ä¸ªç®€å•çš„å€¼ï¼Œå­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€Nullã€æ—¶é—´ã€æ—¥æœŸ
# 1 å¸ƒå°”ç±»å‹
c1: true (æˆ–è€…True)
# 2 æ•´å‹
c2: 234
# 3 æµ®ç‚¹å‹
c3: 3.14
# 4 nullç±»å‹ 
c4: ~  # ä½¿ç”¨~è¡¨ç¤ºnull
# 5 æ—¥æœŸç±»å‹
c5: 2018-02-17    # æ—¥æœŸå¿…é¡»ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œå³yyyy-MM-dd
# 6 æ—¶é—´ç±»å‹
c6: 2018-02-17T15:02:31+08:00  # æ—¶é—´ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œæ—¶é—´å’Œæ—¥æœŸä¹‹é—´ä½¿ç”¨Tè¿æ¥ï¼Œæœ€åä½¿ç”¨+ä»£è¡¨æ—¶åŒº
# 7 å­—ç¬¦ä¸²ç±»å‹
c7: heima     # ç®€å•å†™æ³•ï¼Œç›´æ¥å†™å€¼ , å¦‚æœå­—ç¬¦ä¸²ä¸­é—´æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¿…é¡»ä½¿ç”¨åŒå¼•å·æˆ–è€…å•å¼•å·åŒ…è£¹ 
c8: line1
    line2     # å­—ç¬¦ä¸²è¿‡å¤šçš„æƒ…å†µå¯ä»¥æ‹†æˆå¤šè¡Œï¼Œæ¯ä¸€è¡Œä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªç©ºæ ¼
</code></pre>
<pre><code># å¯¹è±¡
# å½¢å¼ä¸€(æ¨è):
heima:
  age: 15
  address: Beijing
# å½¢å¼äºŒ(äº†è§£):
heima: {age: 15,address: Beijing}
</code></pre>
<pre><code># æ•°ç»„
# å½¢å¼ä¸€(æ¨è):
address:
  - é¡ºä¹‰
  - æ˜Œå¹³  
# å½¢å¼äºŒ(äº†è§£):
address: [é¡ºä¹‰,æ˜Œå¹³]
</code></pre>
<blockquote>
<p>å°æç¤ºï¼š</p>
<p>1 ä¹¦å†™yamlåˆ‡è®°<code>:</code> åé¢è¦åŠ ä¸€ä¸ªç©ºæ ¼</p>
<p>2 å¦‚æœéœ€è¦å°†å¤šæ®µyamlé…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸­é—´è¦ä½¿ç”¨<code>---</code>åˆ†éš”</p>
<p>3 ä¸‹é¢æ˜¯ä¸€ä¸ªyamlè½¬jsonçš„ç½‘ç«™ï¼Œå¯ä»¥é€šè¿‡å®ƒéªŒè¯yamlæ˜¯å¦ä¹¦å†™æ­£ç¡®</p>
<p>https://www.json2yaml.com/convert-yaml-to-json</p>
</blockquote>
<h2 id="33-èµ„æºç®¡ç†æ–¹å¼">3.3 èµ„æºç®¡ç†æ–¹å¼</h2>
<ul>
<li>
<p>å‘½ä»¤å¼å¯¹è±¡ç®¡ç†ï¼šç›´æ¥ä½¿ç”¨å‘½ä»¤å»æ“ä½œkubernetesèµ„æº</p>
<p><code>kubectl run nginx-pod --image=nginx:1.17.1 --port=80</code></p>
</li>
<li>
<p>å‘½ä»¤å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡å‘½ä»¤é…ç½®å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº</p>
<p><code>kubectl create/patch -f nginx-pod.yaml</code></p>
</li>
<li>
<p>å£°æ˜å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡applyå‘½ä»¤å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº</p>
<p><code>kubectl apply -f nginx-pod.yaml</code></p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»å‹</th>
<th style="text-align:left">æ“ä½œå¯¹è±¡</th>
<th style="text-align:left">é€‚ç”¨ç¯å¢ƒ</th>
<th style="text-align:left">ä¼˜ç‚¹</th>
<th style="text-align:left">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">å‘½ä»¤å¼å¯¹è±¡ç®¡ç†</td>
<td style="text-align:left">å¯¹è±¡</td>
<td style="text-align:left">æµ‹è¯•</td>
<td style="text-align:left">ç®€å•</td>
<td style="text-align:left">åªèƒ½æ“ä½œæ´»åŠ¨å¯¹è±¡ï¼Œæ— æ³•å®¡è®¡ã€è·Ÿè¸ª</td>
</tr>
<tr>
<td style="text-align:left">å‘½ä»¤å¼å¯¹è±¡é…ç½®</td>
<td style="text-align:left">æ–‡ä»¶</td>
<td style="text-align:left">å¼€å‘</td>
<td style="text-align:left">å¯ä»¥å®¡è®¡ã€è·Ÿè¸ª</td>
<td style="text-align:left">é¡¹ç›®å¤§æ—¶ï¼Œé…ç½®æ–‡ä»¶å¤šï¼Œæ“ä½œéº»çƒ¦</td>
</tr>
<tr>
<td style="text-align:left">å£°æ˜å¼å¯¹è±¡é…ç½®</td>
<td style="text-align:left">ç›®å½•</td>
<td style="text-align:left">å¼€å‘</td>
<td style="text-align:left">æ”¯æŒç›®å½•æ“ä½œ</td>
<td style="text-align:left">æ„å¤–æƒ…å†µä¸‹éš¾ä»¥è°ƒè¯•</td>
</tr>
</tbody>
</table>
<h3 id="331-å‘½ä»¤å¼å¯¹è±¡ç®¡ç†">3.3.1 å‘½ä»¤å¼å¯¹è±¡ç®¡ç†</h3>
<p><strong>kubectlå‘½ä»¤</strong></p>
<p>kubectlæ˜¯kubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡å®ƒèƒ½å¤Ÿå¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚kubectlå‘½ä»¤çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>kubectl [command] [type] [name] [flags]
</code></pre>
<p><strong>comand</strong>ï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚createã€getã€delete</p>
<p><strong>type</strong>ï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œæ¯”å¦‚deploymentã€podã€service</p>
<p><strong>name</strong>ï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°å¤§å°å†™æ•æ„Ÿ</p>
<p><strong>flags</strong>ï¼šæŒ‡å®šé¢å¤–çš„å¯é€‰å‚æ•°</p>
<pre><code class="language-shell"># æŸ¥çœ‹æ‰€æœ‰pod
kubectl get pod 

# æŸ¥çœ‹æŸä¸ªpod
kubectl get pod pod_name

# æŸ¥çœ‹æŸä¸ªpod,ä»¥yamlæ ¼å¼å±•ç¤ºç»“æœ
kubectl get pod pod_name -o yaml
</code></pre>
<p><strong>èµ„æºç±»å‹</strong></p>
<p>kubernetesä¸­æ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹:</p>
<pre><code>kubectl api-resources
</code></pre>
<p>ç»å¸¸ä½¿ç”¨çš„èµ„æºæœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">èµ„æºåˆ†ç±»</th>
<th style="text-align:left">èµ„æºåç§°</th>
<th style="text-align:left">ç¼©å†™</th>
<th style="text-align:left">èµ„æºä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">é›†ç¾¤çº§åˆ«èµ„æº</td>
<td style="text-align:left">nodes</td>
<td style="text-align:left">no</td>
<td style="text-align:left">é›†ç¾¤ç»„æˆéƒ¨åˆ†</td>
</tr>
<tr>
<td style="text-align:left">namespaces</td>
<td style="text-align:left">ns</td>
<td style="text-align:left">éš”ç¦»Pod</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">podèµ„æº</td>
<td style="text-align:left">pods</td>
<td style="text-align:left">po</td>
<td style="text-align:left">è£…è½½å®¹å™¨</td>
</tr>
<tr>
<td style="text-align:left">podèµ„æºæ§åˆ¶å™¨</td>
<td style="text-align:left">replicationcontrollers</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">replicasets</td>
<td style="text-align:left">rs</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">deployments</td>
<td style="text-align:left">deploy</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">daemonsets</td>
<td style="text-align:left">ds</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">jobs</td>
<td style="text-align:left"></td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cronjobs</td>
<td style="text-align:left">cj</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">horizontalpodautoscalers</td>
<td style="text-align:left">hpa</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">statefulsets</td>
<td style="text-align:left">sts</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left">æœåŠ¡å‘ç°èµ„æº</td>
<td style="text-align:left">services</td>
<td style="text-align:left">svc</td>
<td style="text-align:left">ç»Ÿä¸€podå¯¹å¤–æ¥å£</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ingress</td>
<td style="text-align:left">ing</td>
<td style="text-align:left">ç»Ÿä¸€podå¯¹å¤–æ¥å£</td>
</tr>
<tr>
<td style="text-align:left">å­˜å‚¨èµ„æº</td>
<td style="text-align:left">volumeattachments</td>
<td style="text-align:left"></td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumes</td>
<td style="text-align:left">pv</td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumeclaims</td>
<td style="text-align:left">pvc</td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left">é…ç½®èµ„æº</td>
<td style="text-align:left">configmaps</td>
<td style="text-align:left">cm</td>
<td style="text-align:left">é…ç½®</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">secrets</td>
<td style="text-align:left"></td>
<td style="text-align:left">é…ç½®</td>
</tr>
</tbody>
</table>
<p><strong>æ“ä½œ</strong></p>
<p>kuberneteså…è®¸å¯¹èµ„æºè¿›è¡Œå¤šç§æ“ä½œï¼Œå¯ä»¥é€šè¿‡--helpæŸ¥çœ‹è¯¦ç»†çš„æ“ä½œå‘½ä»¤</p>
<pre><code>kubectl --help
</code></pre>
<p>ç»å¸¸ä½¿ç”¨çš„æ“ä½œæœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">å‘½ä»¤åˆ†ç±»</th>
<th style="text-align:left">å‘½ä»¤</th>
<th style="text-align:left">ç¿»è¯‘</th>
<th style="text-align:left">å‘½ä»¤ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">åŸºæœ¬å‘½ä»¤</td>
<td style="text-align:left">create</td>
<td style="text-align:left">åˆ›å»º</td>
<td style="text-align:left">åˆ›å»ºä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">edit</td>
<td style="text-align:left">ç¼–è¾‘</td>
<td style="text-align:left">ç¼–è¾‘ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">get</td>
<td style="text-align:left">è·å–</td>
<td style="text-align:left">è·å–ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">patch</td>
<td style="text-align:left">æ›´æ–°</td>
<td style="text-align:left">æ›´æ–°ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">delete</td>
<td style="text-align:left">åˆ é™¤</td>
<td style="text-align:left">åˆ é™¤ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">explain</td>
<td style="text-align:left">è§£é‡Š</td>
<td style="text-align:left">å±•ç¤ºèµ„æºæ–‡æ¡£</td>
</tr>
<tr>
<td style="text-align:left">è¿è¡Œå’Œè°ƒè¯•</td>
<td style="text-align:left">run</td>
<td style="text-align:left">è¿è¡Œ</td>
<td style="text-align:left">åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒ</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">expose</td>
<td style="text-align:left">æš´éœ²</td>
<td style="text-align:left">æš´éœ²èµ„æºä¸ºService</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">describe</td>
<td style="text-align:left">æè¿°</td>
<td style="text-align:left">æ˜¾ç¤ºèµ„æºå†…éƒ¨ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">logs</td>
<td style="text-align:left">æ—¥å¿—è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿—</td>
<td style="text-align:left">è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿—</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">attach</td>
<td style="text-align:left">ç¼ ç»•è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨</td>
<td style="text-align:left">è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">exec</td>
<td style="text-align:left">æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤</td>
<td style="text-align:left">æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cp</td>
<td style="text-align:left">å¤åˆ¶</td>
<td style="text-align:left">åœ¨Podå†…å¤–å¤åˆ¶æ–‡ä»¶</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">rollout</td>
<td style="text-align:left">é¦–æ¬¡å±•ç¤º</td>
<td style="text-align:left">ç®¡ç†èµ„æºçš„å‘å¸ƒ</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">scale</td>
<td style="text-align:left">è§„æ¨¡</td>
<td style="text-align:left">æ‰©(ç¼©)å®¹Podçš„æ•°é‡</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">autoscale</td>
<td style="text-align:left">è‡ªåŠ¨è°ƒæ•´</td>
<td style="text-align:left">è‡ªåŠ¨è°ƒæ•´Podçš„æ•°é‡</td>
</tr>
<tr>
<td style="text-align:left">é«˜çº§å‘½ä»¤</td>
<td style="text-align:left">apply</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">é€šè¿‡æ–‡ä»¶å¯¹èµ„æºè¿›è¡Œé…ç½®</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">label</td>
<td style="text-align:left">æ ‡ç­¾</td>
<td style="text-align:left">æ›´æ–°èµ„æºä¸Šçš„æ ‡ç­¾</td>
</tr>
<tr>
<td style="text-align:left">å…¶ä»–å‘½ä»¤</td>
<td style="text-align:left">cluster-info</td>
<td style="text-align:left">é›†ç¾¤ä¿¡æ¯</td>
<td style="text-align:left">æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">version</td>
<td style="text-align:left">ç‰ˆæœ¬</td>
<td style="text-align:left">æ˜¾ç¤ºå½“å‰Serverå’ŒClientçš„ç‰ˆæœ¬</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢ä»¥ä¸€ä¸ªnamespace / podçš„åˆ›å»ºå’Œåˆ é™¤ç®€å•æ¼”ç¤ºä¸‹å‘½ä»¤çš„ä½¿ç”¨ï¼š</p>
<pre><code class="language-shell"># åˆ›å»ºä¸€ä¸ªnamespace
[root@master ~]# kubectl create namespace dev
namespace/dev created

# è·å–namespace
[root@master ~]# kubectl get ns
NAME              STATUS   AGE
default           Active   21h
dev               Active   21s
kube-node-lease   Active   21h
kube-public       Active   21h
kube-system       Active   21h

# åœ¨æ­¤namespaceä¸‹åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªnginxçš„Pod
[root@master ~]# kubectl run pod --image=nginx:latest -n dev
kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.
deployment.apps/pod created

# æŸ¥çœ‹æ–°åˆ›å»ºçš„pod
[root@master ~]# kubectl get pod -n dev
NAME  READY   STATUS    RESTARTS   AGE
pod   1/1     Running   0          21s

# åˆ é™¤æŒ‡å®šçš„pod
[root@master ~]# kubectl delete pod pod-864f9875b9-pcw7x
pod &quot;pod&quot; deleted

# åˆ é™¤æŒ‡å®šçš„namespace
[root@master ~]# kubectl delete ns dev
namespace &quot;dev&quot; deleted
</code></pre>
<h3 id="332-å‘½ä»¤å¼å¯¹è±¡é…ç½®">3.3.2 å‘½ä»¤å¼å¯¹è±¡é…ç½®</h3>
<p>å‘½ä»¤å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨å‘½ä»¤é…åˆé…ç½®æ–‡ä»¶ä¸€èµ·æ¥æ“ä½œkubernetesèµ„æºã€‚</p>
<p>1ï¼‰ åˆ›å»ºä¸€ä¸ªnginxpod.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: dev

---

apiVersion: v1
kind: Pod
metadata:
  name: nginxpod
  namespace: dev
spec:
  containers:
  - name: nginx-containers
    image: nginx:latest
</code></pre>
<p>2ï¼‰æ‰§è¡Œcreateå‘½ä»¤ï¼Œåˆ›å»ºèµ„æºï¼š</p>
<pre><code class="language-yaml">[root@master ~]# kubectl create -f nginxpod.yaml
namespace/dev created
pod/nginxpod created
</code></pre>
<p>æ­¤æ—¶å‘ç°åˆ›å»ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯namespaceå’Œpod</p>
<p>3ï¼‰æ‰§è¡Œgetå‘½ä»¤ï¼ŒæŸ¥çœ‹èµ„æºï¼š</p>
<pre><code class="language-shell">[root@master ~]#  kubectl get -f nginxpod.yaml
NAME            STATUS   AGE
namespace/dev   Active   18s

NAME            READY   STATUS    RESTARTS   AGE
pod/nginxpod    1/1     Running   0          17s
</code></pre>
<p>è¿™æ ·å°±æ˜¾ç¤ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡çš„ä¿¡æ¯</p>
<p>4ï¼‰æ‰§è¡Œdeleteå‘½ä»¤ï¼Œåˆ é™¤èµ„æºï¼š</p>
<pre><code class="language-shell">[root@master ~]# kubectl delete -f nginxpod.yaml
namespace &quot;dev&quot; deleted
pod &quot;nginxpod&quot; deleted
</code></pre>
<p>æ­¤æ—¶å‘ç°ä¸¤ä¸ªèµ„æºå¯¹è±¡è¢«åˆ é™¤äº†</p>
<pre><code>æ€»ç»“:
    å‘½ä»¤å¼å¯¹è±¡é…ç½®çš„æ–¹å¼æ“ä½œèµ„æºï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºï¼šå‘½ä»¤  +  yamlé…ç½®æ–‡ä»¶ï¼ˆé‡Œé¢æ˜¯å‘½ä»¤éœ€è¦çš„å„ç§å‚æ•°ï¼‰
</code></pre>
<h3 id="333-å£°æ˜å¼å¯¹è±¡é…ç½®">3.3.3 å£°æ˜å¼å¯¹è±¡é…ç½®</h3>
<p>å£°æ˜å¼å¯¹è±¡é…ç½®è·Ÿå‘½ä»¤å¼å¯¹è±¡é…ç½®å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒåªæœ‰ä¸€ä¸ªå‘½ä»¤applyã€‚</p>
<pre><code class="language-shell"># é¦–å…ˆæ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°åˆ›å»ºäº†èµ„æº
[root@master ~]#  kubectl apply -f nginxpod.yaml
namespace/dev created
pod/nginxpod created

# å†æ¬¡æ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°è¯´èµ„æºæ²¡æœ‰å˜åŠ¨
[root@master ~]#  kubectl apply -f nginxpod.yaml
namespace/dev unchanged
pod/nginxpod unchanged
</code></pre>
<pre><code>æ€»ç»“:
    å…¶å®å£°æ˜å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨applyæè¿°ä¸€ä¸ªèµ„æºæœ€ç»ˆçš„çŠ¶æ€ï¼ˆåœ¨yamlä¸­å®šä¹‰çŠ¶æ€ï¼‰
    ä½¿ç”¨applyæ“ä½œèµ„æºï¼š
        å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºï¼Œç›¸å½“äº kubectl create
        å¦‚æœèµ„æºå·²å­˜åœ¨ï¼Œå°±æ›´æ–°ï¼Œç›¸å½“äº kubectl patch
</code></pre>
<blockquote>
<p>æ‰©å±•ï¼škubectlå¯ä»¥åœ¨nodeèŠ‚ç‚¹ä¸Šè¿è¡Œå— ?</p>
</blockquote>
<p>kubectlçš„è¿è¡Œæ˜¯éœ€è¦è¿›è¡Œé…ç½®çš„ï¼Œå®ƒçš„é…ç½®æ–‡ä»¶æ˜¯$HOME/.kubeï¼Œå¦‚æœæƒ³è¦åœ¨nodeèŠ‚ç‚¹è¿è¡Œæ­¤å‘½ä»¤ï¼Œéœ€è¦å°†masterä¸Šçš„.kubeæ–‡ä»¶å¤åˆ¶åˆ°nodeèŠ‚ç‚¹ä¸Šï¼Œå³åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢æ“ä½œï¼š</p>
<pre><code class="language-shell">scp  -r  HOME/.kube   node1: HOME/
</code></pre>
<blockquote>
<p>ä½¿ç”¨æ¨è: ä¸‰ç§æ–¹å¼åº”è¯¥æ€ä¹ˆç”¨ ?</p>
</blockquote>
<p>åˆ›å»º/æ›´æ–°èµ„æº ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½® kubectl apply -f XXX.yaml</p>
<p>åˆ é™¤èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡é…ç½® kubectl delete -f XXX.yaml</p>
<p>æŸ¥è¯¢èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡ç®¡ç† kubectl get(describe) èµ„æºåç§°</p>
<h1 id="4-å®æˆ˜å…¥é—¨">4. å®æˆ˜å…¥é—¨</h1>
<p>æœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•åœ¨kubernetesé›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œè®¿é—®ã€‚</p>
<h2 id="41-namespace">4.1 Namespace</h2>
<p>Namespaceæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ç§éå¸¸é‡è¦èµ„æºï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å®ç°<strong>å¤šå¥—ç¯å¢ƒçš„èµ„æºéš”ç¦»</strong>æˆ–è€…<strong>å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»</strong>ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubernetesé›†ç¾¤ä¸­çš„æ‰€æœ‰çš„Podéƒ½æ˜¯å¯ä»¥ç›¸äº’è®¿é—®çš„ã€‚ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œå¯èƒ½ä¸æƒ³è®©ä¸¤ä¸ªPodä¹‹é—´è¿›è¡Œäº’ç›¸çš„è®¿é—®ï¼Œé‚£æ­¤æ—¶å°±å¯ä»¥å°†ä¸¤ä¸ªPodåˆ’åˆ†åˆ°ä¸åŒçš„namespaceä¸‹ã€‚kubernetesé€šè¿‡å°†é›†ç¾¤å†…éƒ¨çš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„Namespaceä¸­ï¼Œå¯ä»¥å½¢æˆé€»è¾‘ä¸Šçš„&quot;ç»„&quot;ï¼Œä»¥æ–¹ä¾¿ä¸åŒçš„ç»„çš„èµ„æºè¿›è¡Œéš”ç¦»ä½¿ç”¨å’Œç®¡ç†ã€‚</p>
<p>å¯ä»¥é€šè¿‡kubernetesçš„æˆæƒæœºåˆ¶ï¼Œå°†ä¸åŒçš„namespaceäº¤ç»™ä¸åŒç§Ÿæˆ·è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·å°±å®ç°äº†å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚æ­¤æ—¶è¿˜èƒ½ç»“åˆkubernetesçš„èµ„æºé…é¢æœºåˆ¶ï¼Œé™å®šä¸åŒç§Ÿæˆ·èƒ½å ç”¨çš„èµ„æºï¼Œä¾‹å¦‚CPUä½¿ç”¨é‡ã€å†…å­˜ä½¿ç”¨é‡ç­‰ç­‰ï¼Œæ¥å®ç°ç§Ÿæˆ·å¯ç”¨èµ„æºçš„ç®¡ç†ã€‚</p>
<figure data-type="image" tabindex="9"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gy0nfeoj30uh0fwabe.jpg" alt="image-20200407100850484" loading="lazy"></figure>
<p>kubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œä¼šé»˜è®¤åˆ›å»ºå‡ ä¸ªnamespace</p>
<pre><code class="language-shell">[root@master ~]# kubectl  get namespace
NAME              STATUS   AGE
default           Active   45h     #  æ‰€æœ‰æœªæŒ‡å®šNamespaceçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åœ¨defaultå‘½åç©ºé—´
kube-node-lease   Active   45h     #  é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„å¿ƒè·³ç»´æŠ¤ï¼Œv1.13å¼€å§‹å¼•å…¥
kube-public       Active   45h     #  æ­¤å‘½åç©ºé—´ä¸‹çš„èµ„æºå¯ä»¥è¢«æ‰€æœ‰äººè®¿é—®ï¼ˆåŒ…æ‹¬æœªè®¤è¯ç”¨æˆ·ï¼‰
kube-system       Active   45h     #  æ‰€æœ‰ç”±Kubernetesç³»ç»Ÿåˆ›å»ºçš„èµ„æºéƒ½å¤„äºè¿™ä¸ªå‘½åç©ºé—´
</code></pre>
<p>ä¸‹é¢æ¥çœ‹namespaceèµ„æºçš„å…·ä½“æ“ä½œï¼š</p>
<p><strong>æŸ¥çœ‹</strong></p>
<pre><code class="language-shell"># 1 æŸ¥çœ‹æ‰€æœ‰çš„ns  å‘½ä»¤ï¼škubectl get ns
[root@master ~]# kubectl get ns
NAME              STATUS   AGE
default           Active   45h
kube-node-lease   Active   45h
kube-public       Active   45h     
kube-system       Active   45h     

# 2 æŸ¥çœ‹æŒ‡å®šçš„ns   å‘½ä»¤ï¼škubectl get ns nsåç§°
[root@master ~]# kubectl get ns default
NAME      STATUS   AGE
default   Active   45h

# 3 æŒ‡å®šè¾“å‡ºæ ¼å¼  å‘½ä»¤ï¼škubectl get ns nsåç§°  -o æ ¼å¼å‚æ•°
# kubernetesæ”¯æŒçš„æ ¼å¼æœ‰å¾ˆå¤šï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯wideã€jsonã€yaml
[root@master ~]# kubectl get ns default -o yaml
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: &quot;2021-05-08T04:44:16Z&quot;
  name: default
  resourceVersion: &quot;151&quot;
  selfLink: /api/v1/namespaces/default
  uid: 7405f73a-e486-43d4-9db6-145f1409f090
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
  
# 4 æŸ¥çœ‹nsè¯¦æƒ…  å‘½ä»¤ï¼škubectl describe ns nsåç§°
[root@master ~]# kubectl describe ns default
Name:         default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Status:       Active  # Active å‘½åç©ºé—´æ­£åœ¨ä½¿ç”¨ä¸­  Terminating æ­£åœ¨åˆ é™¤å‘½åç©ºé—´

# ResourceQuota é’ˆå¯¹namespaceåšçš„èµ„æºé™åˆ¶
# LimitRangeé’ˆå¯¹namespaceä¸­çš„æ¯ä¸ªç»„ä»¶åšçš„èµ„æºé™åˆ¶
No resource quota.
No LimitRange resource.
</code></pre>
<p><strong>åˆ›å»º</strong></p>
<pre><code class="language-shell"># åˆ›å»ºnamespace
[root@master ~]# kubectl create ns dev
namespace/dev created
</code></pre>
<p><strong>åˆ é™¤</strong></p>
<pre><code class="language-shell"># åˆ é™¤namespace
[root@master ~]# kubectl delete ns dev
namespace &quot;dev&quot; deleted
</code></pre>
<p><strong>é…ç½®æ–¹å¼</strong></p>
<p>é¦–å…ˆå‡†å¤‡ä¸€ä¸ªyamlæ–‡ä»¶ï¼šns-dev.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: dev
</code></pre>
<p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f ns-dev.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f ns-dev.yaml</p>
<h2 id="42-pod">4.2 Pod</h2>
<p>Podæ˜¯kubernetesé›†ç¾¤è¿›è¡Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œç¨‹åºè¦è¿è¡Œå¿…é¡»éƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œè€Œå®¹å™¨å¿…é¡»å­˜åœ¨äºPodä¸­ã€‚</p>
<p>Podå¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„å°è£…ï¼Œä¸€ä¸ªPodä¸­å¯ä»¥å­˜åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ã€‚</p>
<figure data-type="image" tabindex="10"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gy51oh8j30hl0cw0te.jpg" alt="image-20200407121501907" loading="lazy"></figure>
<p>kubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œé›†ç¾¤ä¸­çš„å„ä¸ªç»„ä»¶ä¹Ÿéƒ½æ˜¯ä»¥Podæ–¹å¼è¿è¡Œçš„ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<pre><code class="language-shell">[root@master ~]# kubectl get pod -n kube-system
NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE
kube-system   coredns-6955765f44-68g6v         1/1     Running   0          2d1h
kube-system   coredns-6955765f44-cs5r8         1/1     Running   0          2d1h
kube-system   etcd-master                      1/1     Running   0          2d1h
kube-system   kube-apiserver-master            1/1     Running   0          2d1h
kube-system   kube-controller-manager-master   1/1     Running   0          2d1h
kube-system   kube-flannel-ds-amd64-47r25      1/1     Running   0          2d1h
kube-system   kube-flannel-ds-amd64-ls5lh      1/1     Running   0          2d1h
kube-system   kube-proxy-685tk                 1/1     Running   0          2d1h
kube-system   kube-proxy-87spt                 1/1     Running   0          2d1h
kube-system   kube-scheduler-master            1/1     Running   0          2d1h
</code></pre>
<p><strong>åˆ›å»ºå¹¶è¿è¡Œ</strong></p>
<p>kubernetesæ²¡æœ‰æä¾›å•ç‹¬è¿è¡ŒPodçš„å‘½ä»¤ï¼Œéƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®ç°çš„</p>
<pre><code class="language-shell"># å‘½ä»¤æ ¼å¼ï¼š kubectl run (podæ§åˆ¶å™¨åç§°) [å‚æ•°] 
# --image  æŒ‡å®šPodçš„é•œåƒ
# --port   æŒ‡å®šç«¯å£
# --namespace  æŒ‡å®šnamespace
[root@master ~]# kubectl run nginx --image=nginx:latest --port=80 --namespace dev 
deployment.apps/nginx created
</code></pre>
<p><strong>æŸ¥çœ‹podä¿¡æ¯</strong></p>
<pre><code class="language-shell"># æŸ¥çœ‹PodåŸºæœ¬ä¿¡æ¯
[root@master ~]# kubectl get pods -n dev
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          43s

# æŸ¥çœ‹Podçš„è¯¦ç»†ä¿¡æ¯
[root@master ~]# kubectl describe pod nginx -n dev
Name:         nginx
Namespace:    dev
Priority:     0
Node:         node1/192.168.5.4
Start Time:   Wed, 08 May 2021 09:29:24 +0800
Labels:       pod-template-hash=5ff7956ff6
              run=nginx
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.244.1.23
IPs:
  IP:           10.244.1.23
Controlled By:  ReplicaSet/nginx
Containers:
  nginx:
    Container ID:   docker://4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c
    Image:          nginx:latest
    Image ID:       docker-pullable://nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Wed, 08 May 2021 09:30:01 +0800
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-hwvvw:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-hwvvw
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason     Age        From               Message
  ----    ------     ----       ----               -------
  Normal  Scheduled  &lt;unknown&gt;  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1
  Normal  Pulling    4m11s      kubelet, node1     Pulling image &quot;nginx:latest&quot;
  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image &quot;nginx:latest&quot;
  Normal  Created    3m36s      kubelet, node1     Created container nginx
  Normal  Started    3m36s      kubelet, node1     Started container nginx
</code></pre>
<p><strong>è®¿é—®Pod</strong></p>
<pre><code class="language-shell"># è·å–podIP
[root@master ~]# kubectl get pods -n dev -o wide
NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    ... 
nginx   1/1     Running   0          190s   10.244.1.23   node1   ...

#è®¿é—®POD
[root@master ~]# curl http://10.244.1.23:80
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>åˆ é™¤æŒ‡å®šPod</strong></p>
<pre><code class="language-shell"># åˆ é™¤æŒ‡å®šPod
[root@master ~]# kubectl delete pod nginx -n dev
pod &quot;nginx&quot; deleted

# æ­¤æ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤PodæˆåŠŸï¼Œä½†æ˜¯å†æŸ¥è¯¢ï¼Œå‘ç°åˆæ–°äº§ç”Ÿäº†ä¸€ä¸ª 
[root@master ~]# kubectl get pods -n dev
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          21s

# è¿™æ˜¯å› ä¸ºå½“å‰Podæ˜¯ç”±Podæ§åˆ¶å™¨åˆ›å»ºçš„ï¼Œæ§åˆ¶å™¨ä¼šç›‘æ§PodçŠ¶å†µï¼Œä¸€æ—¦å‘ç°Podæ­»äº¡ï¼Œä¼šç«‹å³é‡å»º
# æ­¤æ—¶è¦æƒ³åˆ é™¤Podï¼Œå¿…é¡»åˆ é™¤Podæ§åˆ¶å™¨

# å…ˆæ¥æŸ¥è¯¢ä¸€ä¸‹å½“å‰namespaceä¸‹çš„Podæ§åˆ¶å™¨
[root@master ~]# kubectl get deploy -n  dev
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   1/1     1            1           9m7s

# æ¥ä¸‹æ¥ï¼Œåˆ é™¤æ­¤PodPodæ§åˆ¶å™¨
[root@master ~]# kubectl delete deploy nginx -n dev
deployment.apps &quot;nginx&quot; deleted

# ç¨ç­‰ç‰‡åˆ»ï¼Œå†æŸ¥è¯¢Podï¼Œå‘ç°Podè¢«åˆ é™¤äº†
[root@master ~]# kubectl get pods -n dev
No resources found in dev namespace.
</code></pre>
<p><strong>é…ç½®æ“ä½œ</strong></p>
<p>åˆ›å»ºä¸€ä¸ªpod-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: dev
spec:
  containers:
  - image: nginx:latest
    name: pod
    ports:
    - name: nginx-port
      containerPort: 80
      protocol: TCP
</code></pre>
<p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f pod-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f pod-nginx.yaml</p>
<h2 id="43-label">4.3 Label</h2>
<p>Labelæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚å®ƒçš„ä½œç”¨å°±æ˜¯åœ¨èµ„æºä¸Šæ·»åŠ æ ‡è¯†ï¼Œç”¨æ¥å¯¹å®ƒä»¬è¿›è¡ŒåŒºåˆ†å’Œé€‰æ‹©ã€‚</p>
<p>Labelçš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¸€ä¸ªLabelä¼šä»¥key/valueé”®å€¼å¯¹çš„å½¢å¼é™„åŠ åˆ°å„ç§å¯¹è±¡ä¸Šï¼Œå¦‚Nodeã€Podã€Serviceç­‰ç­‰</li>
<li>ä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„Label ï¼ŒåŒä¸€ä¸ªLabelä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šå»</li>
<li>Labelé€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–è€…åˆ é™¤</li>
</ul>
<p>å¯ä»¥é€šè¿‡Labelå®ç°èµ„æºçš„å¤šç»´åº¦åˆ†ç»„ï¼Œä»¥ä¾¿çµæ´»ã€æ–¹ä¾¿åœ°è¿›è¡Œèµ„æºåˆ†é…ã€è°ƒåº¦ã€é…ç½®ã€éƒ¨ç½²ç­‰ç®¡ç†å·¥ä½œã€‚</p>
<blockquote>
<p>ä¸€äº›å¸¸ç”¨çš„Label ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç‰ˆæœ¬æ ‡ç­¾ï¼š&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......</li>
<li>ç¯å¢ƒæ ‡ç­¾ï¼š&quot;environment&quot;:&quot;dev&quot;ï¼Œ&quot;environment&quot;:&quot;test&quot;ï¼Œ&quot;environment&quot;:&quot;pro&quot;</li>
<li>æ¶æ„æ ‡ç­¾ï¼š&quot;tier&quot;:&quot;frontend&quot;ï¼Œ&quot;tier&quot;:&quot;backend&quot;</li>
</ul>
</blockquote>
<p>æ ‡ç­¾å®šä¹‰å®Œæ¯•ä¹‹åï¼Œè¿˜è¦è€ƒè™‘åˆ°æ ‡ç­¾çš„é€‰æ‹©ï¼Œè¿™å°±è¦ä½¿ç”¨åˆ°Label Selectorï¼Œå³ï¼š</p>
<p>Labelç”¨äºç»™æŸä¸ªèµ„æºå¯¹è±¡å®šä¹‰æ ‡è¯†</p>
<p>Label Selectorç”¨äºæŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›æ ‡ç­¾çš„èµ„æºå¯¹è±¡</p>
<p>å½“å‰æœ‰ä¸¤ç§Label Selectorï¼š</p>
<ul>
<li>
<p>åŸºäºç­‰å¼çš„Label Selector</p>
<p>name = slave: é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­key=&quot;name&quot;ä¸”value=&quot;slave&quot;çš„å¯¹è±¡</p>
<p>env != production: é€‰æ‹©æ‰€æœ‰åŒ…æ‹¬Labelä¸­çš„key=&quot;env&quot;ä¸”valueä¸ç­‰äº&quot;production&quot;çš„å¯¹è±¡</p>
</li>
<li>
<p>åŸºäºé›†åˆçš„Label Selector</p>
<p>name in (master, slave): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=&quot;name&quot;ä¸”value=&quot;master&quot;æˆ–&quot;slave&quot;çš„å¯¹è±¡</p>
<p>name not in (frontend): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=&quot;name&quot;ä¸”valueä¸ç­‰äº&quot;frontend&quot;çš„å¯¹è±¡</p>
</li>
</ul>
<p>æ ‡ç­¾çš„é€‰æ‹©æ¡ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªï¼Œæ­¤æ—¶å°†å¤šä¸ªLabel Selectorè¿›è¡Œç»„åˆï¼Œä½¿ç”¨é€—å·&quot;,&quot;è¿›è¡Œåˆ†éš”å³å¯ã€‚ä¾‹å¦‚ï¼š</p>
<p>name=slaveï¼Œenv!=production</p>
<p>name not in (frontend)ï¼Œenv!=production</p>
<p><strong>å‘½ä»¤æ–¹å¼</strong></p>
<pre><code class="language-shell"># ä¸ºpodèµ„æºæ‰“æ ‡ç­¾
[root@master ~]# kubectl label pod nginx-pod version=1.0 -n dev
pod/nginx-pod labeled

# ä¸ºpodèµ„æºæ›´æ–°æ ‡ç­¾
[root@master ~]# kubectl label pod nginx-pod version=2.0 -n dev --overwrite
pod/nginx-pod labeled

# æŸ¥çœ‹æ ‡ç­¾
[root@master ~]# kubectl get pod nginx-pod  -n dev --show-labels
NAME        READY   STATUS    RESTARTS   AGE   LABELS
nginx-pod   1/1     Running   0          10m   version=2.0

# ç­›é€‰æ ‡ç­¾
[root@master ~]# kubectl get pod -n dev -l version=2.0  --show-labels
NAME        READY   STATUS    RESTARTS   AGE   LABELS
nginx-pod   1/1     Running   0          17m   version=2.0
[root@master ~]# kubectl get pod -n dev -l version!=2.0 --show-labels
No resources found in dev namespace.

#åˆ é™¤æ ‡ç­¾
[root@master ~]# kubectl label pod nginx-pod version- -n dev
pod/nginx-pod labeled
</code></pre>
<p><strong>é…ç½®æ–¹å¼</strong></p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: dev
  labels:
    version: &quot;3.0&quot; 
    env: &quot;test&quot;
spec:
  containers:
  - image: nginx:latest
    name: pod
    ports:
    - name: nginx-port
      containerPort: 80
      protocol: TCP
</code></pre>
<p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„æ›´æ–°å‘½ä»¤äº†ï¼škubectl apply -f pod-nginx.yaml</p>
<h2 id="44-deployment">4.4 Deployment</h2>
<p>åœ¨kubernetesä¸­ï¼ŒPodæ˜¯æœ€å°çš„æ§åˆ¶å•å…ƒï¼Œä½†æ˜¯kuberneteså¾ˆå°‘ç›´æ¥æ§åˆ¶Podï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®Œæˆçš„ã€‚Podæ§åˆ¶å™¨ç”¨äºpodçš„ç®¡ç†ï¼Œç¡®ä¿podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œå½“podçš„èµ„æºå‡ºç°æ•…éšœæ—¶ï¼Œä¼šå°è¯•è¿›è¡Œé‡å¯æˆ–é‡å»ºpodã€‚</p>
<p>åœ¨kubernetesä¸­Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰å¾ˆå¤šï¼Œæœ¬ç« èŠ‚åªä»‹ç»ä¸€ç§ï¼šDeploymentã€‚</p>
<figure data-type="image" tabindex="11"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gya55fjj30l90bm3zh.jpg" alt="image-20200408193950807" loading="lazy"></figure>
<p><strong>å‘½ä»¤æ“ä½œ</strong></p>
<pre><code class="language-shell"># å‘½ä»¤æ ¼å¼: kubectl create deployment åç§°  [å‚æ•°] 
# --image  æŒ‡å®špodçš„é•œåƒ
# --port   æŒ‡å®šç«¯å£
# --replicas  æŒ‡å®šåˆ›å»ºpodæ•°é‡
# --namespace  æŒ‡å®šnamespace
[root@master ~]# kubectl create deploy nginx --image=nginx:latest --port=80 --replicas=3 -n dev
deployment.apps/nginx created

# æŸ¥çœ‹åˆ›å»ºçš„Pod
[root@master ~]# kubectl get pods -n dev
NAME                     READY   STATUS    RESTARTS   AGE
nginx-5ff7956ff6-6k8cb   1/1     Running   0          19s
nginx-5ff7956ff6-jxfjt   1/1     Running   0          19s
nginx-5ff7956ff6-v6jqw   1/1     Running   0          19s

# æŸ¥çœ‹deploymentçš„ä¿¡æ¯
[root@master ~]# kubectl get deploy -n dev
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   3/3     3            3           2m42s

# UP-TO-DATEï¼šæˆåŠŸå‡çº§çš„å‰¯æœ¬æ•°é‡
# AVAILABLEï¼šå¯ç”¨å‰¯æœ¬çš„æ•°é‡
[root@master ~]# kubectl get deploy -n dev -o wide
NAME    READY UP-TO-DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR
nginx   3/3     3         3           2m51s   nginx        nginx:latest        run=nginx

# æŸ¥çœ‹deploymentçš„è¯¦ç»†ä¿¡æ¯
[root@master ~]# kubectl describe deploy nginx -n dev
Name:                   nginx
Namespace:              dev
CreationTimestamp:      Wed, 08 May 2021 11:14:14 +0800
Labels:                 run=nginx
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               run=nginx
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  run=nginx
  Containers:
   nginx:
    Image:        nginx:latest
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   nginx-5ff7956ff6 (3/3 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  5m43s  deployment-controller  Scaled up replicaset nginx-5ff7956ff6 to 3
  
# åˆ é™¤ 
[root@master ~]# kubectl delete deploy nginx -n dev
deployment.apps &quot;nginx&quot; deleted
</code></pre>
<p><strong>é…ç½®æ“ä½œ</strong></p>
<p>åˆ›å»ºä¸€ä¸ªdeploy-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: dev
spec:
  replicas: 3
  selector:
    matchLabels:
      run: nginx
  template:
    metadata:
      labels:
        run: nginx
    spec:
      containers:
      - image: nginx:latest
        name: nginx
        ports:
        - containerPort: 80
          protocol: TCP
</code></pre>
<p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f deploy-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f deploy-nginx.yaml</p>
<h2 id="45-service">4.5 Service</h2>
<p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œå·²ç»èƒ½å¤Ÿåˆ©ç”¨Deploymentæ¥åˆ›å»ºä¸€ç»„Podæ¥æä¾›å…·æœ‰é«˜å¯ç”¨æ€§çš„æœåŠ¡ã€‚</p>
<p>è™½ç„¶æ¯ä¸ªPodéƒ½ä¼šåˆ†é…ä¸€ä¸ªå•ç‹¬çš„Pod IPï¼Œç„¶è€Œå´å­˜åœ¨å¦‚ä¸‹ä¸¤é—®é¢˜ï¼š</p>
<ul>
<li>Pod IP ä¼šéšç€Podçš„é‡å»ºäº§ç”Ÿå˜åŒ–</li>
<li>Pod IP ä»…ä»…æ˜¯é›†ç¾¤å†…å¯è§çš„è™šæ‹ŸIPï¼Œå¤–éƒ¨æ— æ³•è®¿é—®</li>
</ul>
<p>è¿™æ ·å¯¹äºè®¿é—®è¿™ä¸ªæœåŠ¡å¸¦æ¥äº†éš¾åº¦ã€‚å› æ­¤ï¼Œkubernetesè®¾è®¡äº†Serviceæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>Serviceå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç»„åŒç±»Pod<strong>å¯¹å¤–çš„è®¿é—®æ¥å£</strong>ã€‚å€ŸåŠ©Serviceï¼Œåº”ç”¨å¯ä»¥æ–¹ä¾¿åœ°å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</p>
<figure data-type="image" tabindex="12"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gydwoj8j30tt0dtq4q.jpg" alt="image-20200408194716912" loading="lazy"></figure>
<p><strong>æ“ä½œä¸€ï¼šåˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„Service</strong></p>
<pre><code class="language-shell"># æš´éœ²Service
[root@master ~]# kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev
service/svc-nginx1 exposed

# æŸ¥çœ‹service
[root@master ~]# kubectl get svc svc-nginx1 -n dev -o wide
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR
svc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   run=nginx

# è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ªCLUSTER-IPï¼Œè¿™å°±æ˜¯serviceçš„IPï¼Œåœ¨Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸ä¼šå˜åŠ¨çš„
# å¯ä»¥é€šè¿‡è¿™ä¸ªIPè®¿é—®å½“å‰serviceå¯¹åº”çš„POD
[root@master ~]# curl 10.109.179.231:80
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
.......
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>æ“ä½œäºŒï¼šåˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„Service</strong></p>
<pre><code class="language-shell"># ä¸Šé¢åˆ›å»ºçš„Serviceçš„typeç±»å‹ä¸ºClusterIPï¼Œè¿™ä¸ªipåœ°å€åªç”¨é›†ç¾¤å†…éƒ¨å¯è®¿é—®
# å¦‚æœéœ€è¦åˆ›å»ºå¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®çš„Serviceï¼Œéœ€è¦ä¿®æ”¹typeä¸ºNodePort
[root@master ~]# kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev
service/svc-nginx2 exposed

# æ­¤æ—¶æŸ¥çœ‹ï¼Œä¼šå‘ç°å‡ºç°äº†NodePortç±»å‹çš„Serviceï¼Œè€Œä¸”æœ‰ä¸€å¯¹Portï¼ˆ80:31928/TCï¼‰
[root@master ~]# kubectl get svc  svc-nginx2  -n dev -o wide
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE    SELECTOR
svc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     run=nginx

# æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡é›†ç¾¤å¤–çš„ä¸»æœºè®¿é—® èŠ‚ç‚¹IP:31928è®¿é—®æœåŠ¡äº†
# ä¾‹å¦‚åœ¨çš„ç”µè„‘ä¸»æœºä¸Šé€šè¿‡æµè§ˆå™¨è®¿é—®ä¸‹é¢çš„åœ°å€
http://192.168.5.4:31928/
</code></pre>
<p><strong>åˆ é™¤Service</strong></p>
<pre><code class="language-shell">[root@master ~]# kubectl delete svc svc-nginx-1 -n dev service &quot;svc-nginx-1&quot; deleted
</code></pre>
<p><strong>é…ç½®æ–¹å¼</strong></p>
<p>åˆ›å»ºä¸€ä¸ªsvc-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: svc-nginx
  namespace: dev
spec:
  clusterIP: 10.109.179.231 #å›ºå®šsvcçš„å†…ç½‘ip
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    run: nginx
  type: ClusterIP
</code></pre>
<p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f svc-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f svc-nginx.yaml</p>
<blockquote>
<p><strong>å°ç»“</strong></p>
<p>è‡³æ­¤ï¼Œå·²ç»æŒæ¡äº†Namespaceã€Podã€Deploymentã€Serviceèµ„æºçš„åŸºæœ¬æ“ä½œï¼Œæœ‰äº†è¿™äº›æ“ä½œï¼Œå°±å¯ä»¥åœ¨kubernetesé›†ç¾¤ä¸­å®ç°ä¸€ä¸ªæœåŠ¡çš„ç®€å•éƒ¨ç½²å’Œè®¿é—®äº†ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æ›´å¥½çš„ä½¿ç”¨kubernetesï¼Œå°±éœ€è¦æ·±å…¥å­¦ä¹ è¿™å‡ ç§èµ„æºçš„ç»†èŠ‚å’ŒåŸç†ã€‚</p>
</blockquote>
<h1 id="5-podè¯¦è§£">5. Podè¯¦è§£</h1>
<h2 id="51-podä»‹ç»">5.1 Podä»‹ç»</h2>
<h3 id="511-podç»“æ„">5.1.1 Podç»“æ„</h3>
<figure data-type="image" tabindex="13"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gyi2hikj30hl0cw0te.jpg" alt="image-20200407121501907" loading="lazy"></figure>
<p>æ¯ä¸ªPodä¸­éƒ½å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>
<p>ç”¨æˆ·ç¨‹åºæ‰€åœ¨çš„å®¹å™¨ï¼Œæ•°é‡å¯å¤šå¯å°‘</p>
</li>
<li>
<p>Pauseå®¹å™¨ï¼Œè¿™æ˜¯æ¯ä¸ªPodéƒ½ä¼šæœ‰çš„ä¸€ä¸ª<strong>æ ¹å®¹å™¨</strong>ï¼Œå®ƒçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>
<p>å¯ä»¥ä»¥å®ƒä¸ºä¾æ®ï¼Œè¯„ä¼°æ•´ä¸ªPodçš„å¥åº·çŠ¶æ€</p>
</li>
<li>
<p>å¯ä»¥åœ¨æ ¹å®¹å™¨ä¸Šè®¾ç½®Ipåœ°å€ï¼Œå…¶å®ƒå®¹å™¨éƒ½æ­¤Ipï¼ˆPod IPï¼‰ï¼Œä»¥å®ç°Podå†…éƒ¨çš„ç½‘è·¯é€šä¿¡</p>
<pre><code>è¿™é‡Œæ˜¯Podå†…éƒ¨çš„é€šè®¯ï¼ŒPodçš„ä¹‹é—´çš„é€šè®¯é‡‡ç”¨è™šæ‹ŸäºŒå±‚ç½‘ç»œæŠ€æœ¯æ¥å®ç°ï¼Œæˆ‘ä»¬å½“å‰ç¯å¢ƒç”¨çš„æ˜¯Flannel
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="512-podå®šä¹‰">5.1.2 Podå®šä¹‰</h3>
<p>ä¸‹é¢æ˜¯Podçš„èµ„æºæ¸…å•ï¼š</p>
<pre><code class="language-shell">apiVersion: v1     #å¿…é€‰ï¼Œç‰ˆæœ¬å·ï¼Œä¾‹å¦‚v1
kind: Pod       ã€€ #å¿…é€‰ï¼Œèµ„æºç±»å‹ï¼Œä¾‹å¦‚ Pod
metadata:       ã€€ #å¿…é€‰ï¼Œå…ƒæ•°æ®
  name: string     #å¿…é€‰ï¼ŒPodåç§°
  namespace: string  #Podæ‰€å±çš„å‘½åç©ºé—´,é»˜è®¤ä¸º&quot;default&quot;
  labels:       ã€€ã€€  #è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨
    - name: string      ã€€          
spec:  #å¿…é€‰ï¼ŒPodä¸­å®¹å™¨çš„è¯¦ç»†å®šä¹‰
  containers:  #å¿…é€‰ï¼ŒPodä¸­å®¹å™¨åˆ—è¡¨
  - name: string   #å¿…é€‰ï¼Œå®¹å™¨åç§°
    image: string  #å¿…é€‰ï¼Œå®¹å™¨çš„é•œåƒåç§°
    imagePullPolicy: [ Always|Never|IfNotPresent ]  #è·å–é•œåƒçš„ç­–ç•¥ 
    command: [string]   #å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤
    args: [string]      #å®¹å™¨çš„å¯åŠ¨å‘½ä»¤å‚æ•°åˆ—è¡¨
    workingDir: string  #å®¹å™¨çš„å·¥ä½œç›®å½•
    volumeMounts:       #æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½®
    - name: string      #å¼•ç”¨podå®šä¹‰çš„å…±äº«å­˜å‚¨å·çš„åç§°ï¼Œéœ€ç”¨volumes[]éƒ¨åˆ†å®šä¹‰çš„çš„å·å
      mountPath: string #å­˜å‚¨å·åœ¨å®¹å™¨å†…mountçš„ç»å¯¹è·¯å¾„ï¼Œåº”å°‘äº512å­—ç¬¦
      readOnly: boolean #æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼
    ports: #éœ€è¦æš´éœ²çš„ç«¯å£åº“å·åˆ—è¡¨
    - name: string        #ç«¯å£çš„åç§°
      containerPort: int  #å®¹å™¨éœ€è¦ç›‘å¬çš„ç«¯å£å·
      hostPort: int       #å®¹å™¨æ‰€åœ¨ä¸»æœºéœ€è¦ç›‘å¬çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸Containerç›¸åŒ
      protocol: string    #ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP
    env:   #å®¹å™¨è¿è¡Œå‰éœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
    - name: string  #ç¯å¢ƒå˜é‡åç§°
      value: string #ç¯å¢ƒå˜é‡çš„å€¼
    resources: #èµ„æºé™åˆ¶å’Œè¯·æ±‚çš„è®¾ç½®
      limits:  #èµ„æºé™åˆ¶çš„è®¾ç½®
        cpu: string     #Cpuçš„é™åˆ¶ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå°†ç”¨äºdocker run --cpu-shareså‚æ•°
        memory: string  #å†…å­˜é™åˆ¶ï¼Œå•ä½å¯ä»¥ä¸ºMib/Gibï¼Œå°†ç”¨äºdocker run --memoryå‚æ•°
      requests: #èµ„æºè¯·æ±‚çš„è®¾ç½®
        cpu: string    #Cpuè¯·æ±‚ï¼Œå®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡
        memory: string #å†…å­˜è¯·æ±‚,å®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡
    lifecycle: #ç”Ÿå‘½å‘¨æœŸé’©å­
        postStart: #å®¹å™¨å¯åŠ¨åç«‹å³æ‰§è¡Œæ­¤é’©å­,å¦‚æœæ‰§è¡Œå¤±è´¥,ä¼šæ ¹æ®é‡å¯ç­–ç•¥è¿›è¡Œé‡å¯
        preStop: #å®¹å™¨ç»ˆæ­¢å‰æ‰§è¡Œæ­¤é’©å­,æ— è®ºç»“æœå¦‚ä½•,å®¹å™¨éƒ½ä¼šç»ˆæ­¢
    livenessProbe:  #å¯¹Podå†…å„å®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œå½“æ¢æµ‹æ— å“åº”å‡ æ¬¡åå°†è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨
      exec:       ã€€ #å¯¹Podå®¹å™¨å†…æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºexecæ–¹å¼
        command: [string]  #execæ–¹å¼éœ€è¦åˆ¶å®šçš„å‘½ä»¤æˆ–è„šæœ¬
      httpGet:       #å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ³•è®¾ç½®ä¸ºHttpGetï¼Œéœ€è¦åˆ¶å®šPathã€port
        path: string
        port: number
        host: string
        scheme: string
        HttpHeaders:
        - name: string
          value: string
      tcpSocket:     #å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºtcpSocketæ–¹å¼
         port: number
       initialDelaySeconds: 0       #å®¹å™¨å¯åŠ¨å®Œæˆåé¦–æ¬¡æ¢æµ‹çš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’
       timeoutSeconds: 0    ã€€ã€€    #å¯¹å®¹å™¨å¥åº·æ£€æŸ¥æ¢æµ‹ç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤1ç§’
       periodSeconds: 0     ã€€ã€€    #å¯¹å®¹å™¨ç›‘æ§æ£€æŸ¥çš„å®šæœŸæ¢æµ‹æ—¶é—´è®¾ç½®ï¼Œå•ä½ç§’ï¼Œé»˜è®¤10ç§’ä¸€æ¬¡
       successThreshold: 0
       failureThreshold: 0
       securityContext:
         privileged: false
  restartPolicy: [Always | Never | OnFailure]  #Podçš„é‡å¯ç­–ç•¥
  nodeName: &lt;string&gt; #è®¾ç½®NodeNameè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°æŒ‡å®šåˆ°åç§°çš„nodeèŠ‚ç‚¹ä¸Š
  nodeSelector: obeject #è®¾ç½®NodeSelectorè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™ä¸ªlabelçš„nodeä¸Š
  imagePullSecrets: #Pullé•œåƒæ—¶ä½¿ç”¨çš„secretåç§°ï¼Œä»¥keyï¼šsecretkeyæ ¼å¼æŒ‡å®š
  - name: string
  hostNetwork: false   #æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
  volumes:   #åœ¨è¯¥podä¸Šå®šä¹‰å…±äº«å­˜å‚¨å·åˆ—è¡¨
  - name: string    #å…±äº«å­˜å‚¨å·åç§° ï¼ˆvolumesç±»å‹æœ‰å¾ˆå¤šç§ï¼‰
    emptyDir: {}       #ç±»å‹ä¸ºemtyDirçš„å­˜å‚¨å·ï¼Œä¸PodåŒç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚ä¸ºç©ºå€¼
    hostPath: string   #ç±»å‹ä¸ºhostPathçš„å­˜å‚¨å·ï¼Œè¡¨ç¤ºæŒ‚è½½Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•
      path: string      ã€€ã€€        #Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•ï¼Œå°†è¢«ç”¨äºåŒæœŸä¸­mountçš„ç›®å½•
    secret:       ã€€ã€€ã€€#ç±»å‹ä¸ºsecretçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é›†ç¾¤ä¸å®šä¹‰çš„secretå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨
      scretname: string  
      items:     
      - key: string
        path: string
    configMap:         #ç±»å‹ä¸ºconfigMapçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é¢„å®šä¹‰çš„configMapå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨
      name: string
      items:
      - key: string
        path: string
</code></pre>
<pre><code class="language-shell">#å°æç¤ºï¼š
#   åœ¨è¿™é‡Œï¼Œå¯é€šè¿‡ä¸€ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹æ¯ç§èµ„æºçš„å¯é…ç½®é¡¹
#   kubectl explain èµ„æºç±»å‹         æŸ¥çœ‹æŸç§èµ„æºå¯ä»¥é…ç½®çš„ä¸€çº§å±æ€§
#   kubectl explain èµ„æºç±»å‹.å±æ€§     æŸ¥çœ‹å±æ€§çš„å­å±æ€§
[root@k8s-master01 ~]# kubectl explain pod
KIND:     Pod
VERSION:  v1
FIELDS:
   apiVersion   &lt;string&gt;
   kind &lt;string&gt;
   metadata     &lt;Object&gt;
   spec &lt;Object&gt;
   status       &lt;Object&gt;

[root@k8s-master01 ~]# kubectl explain pod.metadata
KIND:     Pod
VERSION:  v1
RESOURCE: metadata &lt;Object&gt;
FIELDS:
   annotations  &lt;map[string]string&gt;
   clusterName  &lt;string&gt;
   creationTimestamp    &lt;string&gt;
   deletionGracePeriodSeconds   &lt;integer&gt;
   deletionTimestamp    &lt;string&gt;
   finalizers   &lt;[]string&gt;
   generateName &lt;string&gt;
   generation   &lt;integer&gt;
   labels       &lt;map[string]string&gt;
   managedFields        &lt;[]Object&gt;
   name &lt;string&gt;
   namespace    &lt;string&gt;
   ownerReferences      &lt;[]Object&gt;
   resourceVersion      &lt;string&gt;
   selfLink     &lt;string&gt;
   uid  &lt;string&gt;
</code></pre>
<p>åœ¨kubernetesä¸­åŸºæœ¬æ‰€æœ‰èµ„æºçš„ä¸€çº§å±æ€§éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸»è¦åŒ…å«5éƒ¨åˆ†ï¼š</p>
<ul>
<li>apiVersion <string> ç‰ˆæœ¬ï¼Œç”±kuberneteså†…éƒ¨å®šä¹‰ï¼Œç‰ˆæœ¬å·å¿…é¡»å¯ä»¥ç”¨ kubectl api-versions æŸ¥è¯¢åˆ°</li>
<li>kind <string> ç±»å‹ï¼Œç”±kuberneteså†…éƒ¨å®šä¹‰ï¼Œç‰ˆæœ¬å·å¿…é¡»å¯ä»¥ç”¨ kubectl api-resources æŸ¥è¯¢åˆ°</li>
<li>metadata <Object> å…ƒæ•°æ®ï¼Œä¸»è¦æ˜¯èµ„æºæ ‡è¯†å’Œè¯´æ˜ï¼Œå¸¸ç”¨çš„æœ‰nameã€namespaceã€labelsç­‰</li>
<li>spec <Object> æè¿°ï¼Œè¿™æ˜¯é…ç½®ä¸­æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œé‡Œé¢æ˜¯å¯¹å„ç§èµ„æºé…ç½®çš„è¯¦ç»†æè¿°</li>
<li>status <Object> çŠ¶æ€ä¿¡æ¯ï¼Œé‡Œé¢çš„å†…å®¹ä¸éœ€è¦å®šä¹‰ï¼Œç”±kubernetesè‡ªåŠ¨ç”Ÿæˆ</li>
</ul>
<p>åœ¨ä¸Šé¢çš„å±æ€§ä¸­ï¼Œspecæ˜¯æ¥ä¸‹æ¥ç ”ç©¶çš„é‡ç‚¹ï¼Œç»§ç»­çœ‹ä¸‹å®ƒçš„å¸¸è§å­å±æ€§:</p>
<ul>
<li>containers &lt;[]Object&gt; å®¹å™¨åˆ—è¡¨ï¼Œç”¨äºå®šä¹‰å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯</li>
<li>nodeName <String> æ ¹æ®nodeNameçš„å€¼å°†podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Š</li>
<li>nodeSelector &lt;map[]&gt; æ ¹æ®NodeSelectorä¸­å®šä¹‰çš„ä¿¡æ¯é€‰æ‹©å°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™äº›labelçš„Node ä¸Š</li>
<li>hostNetwork <boolean> æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ</li>
<li>volumes &lt;[]Object&gt; å­˜å‚¨å·ï¼Œç”¨äºå®šä¹‰Podä¸Šé¢æŒ‚åœ¨çš„å­˜å‚¨ä¿¡æ¯</li>
<li>restartPolicy <string> é‡å¯ç­–ç•¥ï¼Œè¡¨ç¤ºPodåœ¨é‡åˆ°æ•…éšœçš„æ—¶å€™çš„å¤„ç†ç­–ç•¥</li>
</ul>
<h2 id="52-podé…ç½®">5.2 Podé…ç½®</h2>
<p>æœ¬å°èŠ‚ä¸»è¦æ¥ç ”ç©¶<code>pod.spec.containers</code>å±æ€§ï¼Œè¿™ä¹Ÿæ˜¯podé…ç½®ä¸­æœ€ä¸ºå…³é”®çš„ä¸€é¡¹é…ç½®ã€‚</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl explain pod.spec.containers
KIND:     Pod
VERSION:  v1
RESOURCE: containers &lt;[]Object&gt;   # æ•°ç»„ï¼Œä»£è¡¨å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨
FIELDS:
   name  &lt;string&gt;     # å®¹å™¨åç§°
   image &lt;string&gt;     # å®¹å™¨éœ€è¦çš„é•œåƒåœ°å€
   imagePullPolicy  &lt;string&gt; # é•œåƒæ‹‰å–ç­–ç•¥ 
   command  &lt;[]string&gt; # å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤
   args     &lt;[]string&gt; # å®¹å™¨çš„å¯åŠ¨å‘½ä»¤éœ€è¦çš„å‚æ•°åˆ—è¡¨
   env      &lt;[]Object&gt; # å®¹å™¨ç¯å¢ƒå˜é‡çš„é…ç½®
   ports    &lt;[]Object&gt;     # å®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£å·åˆ—è¡¨
   resources &lt;Object&gt;      # èµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚çš„è®¾ç½®
</code></pre>
<h3 id="521-åŸºæœ¬é…ç½®">5.2.1 åŸºæœ¬é…ç½®</h3>
<p>åˆ›å»ºpod-base.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-base
  namespace: dev
  labels:
    user: heima
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  - name: busybox
    image: busybox:1.30
</code></pre>
<figure data-type="image" tabindex="14"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gynp00kj30bx01uaa6.jpg" alt="image-20210617223823675" loading="lazy"></figure>
<p>ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•Podçš„é…ç½®ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªå®¹å™¨ï¼š</p>
<ul>
<li>nginxï¼šç”¨1.17.1ç‰ˆæœ¬çš„nginxé•œåƒåˆ›å»ºï¼Œï¼ˆnginxæ˜¯ä¸€ä¸ªè½»é‡çº§webå®¹å™¨ï¼‰</li>
<li>busyboxï¼šç”¨1.30ç‰ˆæœ¬çš„busyboxé•œåƒåˆ›å»ºï¼Œï¼ˆbusyboxæ˜¯ä¸€ä¸ªå°å·§çš„linuxå‘½ä»¤é›†åˆï¼‰</li>
</ul>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 pod]# kubectl apply -f pod-base.yaml
pod/pod-base created

# æŸ¥çœ‹PodçŠ¶å†µ
# READY 1/2 : è¡¨ç¤ºå½“å‰Podä¸­æœ‰2ä¸ªå®¹å™¨ï¼Œå…¶ä¸­1ä¸ªå‡†å¤‡å°±ç»ªï¼Œ1ä¸ªæœªå°±ç»ª
# RESTARTS  : é‡å¯æ¬¡æ•°ï¼Œå› ä¸ºæœ‰1ä¸ªå®¹å™¨æ•…éšœäº†ï¼ŒPodä¸€ç›´åœ¨é‡å¯è¯•å›¾æ¢å¤å®ƒ
[root@k8s-master01 pod]# kubectl get pod -n dev
NAME       READY   STATUS    RESTARTS   AGE
pod-base   1/2     Running   4          95s

# å¯ä»¥é€šè¿‡describeæŸ¥çœ‹å†…éƒ¨çš„è¯¦æƒ…
# æ­¤æ—¶å·²ç»è¿è¡Œèµ·æ¥äº†ä¸€ä¸ªåŸºæœ¬çš„Podï¼Œè™½ç„¶å®ƒæš‚æ—¶æœ‰é—®é¢˜
[root@k8s-master01 pod]# kubectl describe pod pod-base -n dev
</code></pre>
<h3 id="522-é•œåƒæ‹‰å–">5.2.2 é•œåƒæ‹‰å–</h3>
<p>åˆ›å»ºpod-imagepullpolicy.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-imagepullpolicy
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    imagePullPolicy: Never # ç”¨äºè®¾ç½®é•œåƒæ‹‰å–ç­–ç•¥
  - name: busybox
    image: busybox:1.30
</code></pre>
<figure data-type="image" tabindex="15"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gyrrlwzj30dr027t8y.jpg" alt="image-20210617223923659" loading="lazy"></figure>
<p>imagePullPolicyï¼Œç”¨äºè®¾ç½®é•œåƒæ‹‰å–ç­–ç•¥ï¼Œkubernetesæ”¯æŒé…ç½®ä¸‰ç§æ‹‰å–ç­–ç•¥ï¼š</p>
<ul>
<li>Alwaysï¼šæ€»æ˜¯ä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒï¼ˆä¸€ç›´è¿œç¨‹ä¸‹è½½ï¼‰</li>
<li>IfNotPresentï¼šæœ¬åœ°æœ‰åˆ™ä½¿ç”¨æœ¬åœ°é•œåƒï¼Œæœ¬åœ°æ²¡æœ‰åˆ™ä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒï¼ˆæœ¬åœ°æœ‰å°±æœ¬åœ° æœ¬åœ°æ²¡è¿œç¨‹ä¸‹è½½ï¼‰</li>
<li>Neverï¼šåªä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä»ä¸å»è¿œç¨‹ä»“åº“æ‹‰å–ï¼Œæœ¬åœ°æ²¡æœ‰å°±æŠ¥é”™ ï¼ˆä¸€ç›´ä½¿ç”¨æœ¬åœ°ï¼‰</li>
</ul>
<blockquote>
<p>é»˜è®¤å€¼è¯´æ˜ï¼š</p>
<p>å¦‚æœé•œåƒtagä¸ºå…·ä½“ç‰ˆæœ¬å·ï¼Œ é»˜è®¤ç­–ç•¥æ˜¯ï¼šIfNotPresent</p>
<p>å¦‚æœé•œåƒtagä¸ºï¼šlatestï¼ˆæœ€ç»ˆç‰ˆæœ¬ï¼‰ ï¼Œé»˜è®¤ç­–ç•¥æ˜¯always</p>
</blockquote>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 pod]# kubectl create -f pod-imagepullpolicy.yaml
pod/pod-imagepullpolicy created

# æŸ¥çœ‹Podè¯¦æƒ…
# æ­¤æ—¶æ˜æ˜¾å¯ä»¥çœ‹åˆ°nginxé•œåƒæœ‰ä¸€æ­¥Pulling image &quot;nginx:1.17.1&quot;çš„è¿‡ç¨‹
[root@k8s-master01 pod]# kubectl describe pod pod-imagepullpolicy -n dev
......
Events:
  Type     Reason     Age               From               Message
  ----     ------     ----              ----               -------
  Normal   Scheduled  &lt;unknown&gt;         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1
  Normal   Pulling    32s               kubelet, node1     Pulling image &quot;nginx:1.17.1&quot;
  Normal   Pulled     26s               kubelet, node1     Successfully pulled image &quot;nginx:1.17.1&quot;
  Normal   Created    26s               kubelet, node1     Created container nginx
  Normal   Started    25s               kubelet, node1     Started container nginx
  Normal   Pulled     7s (x3 over 25s)  kubelet, node1     Container image &quot;busybox:1.30&quot; already present on machine
  Normal   Created    7s (x3 over 25s)  kubelet, node1     Created container busybox
  Normal   Started    7s (x3 over 25s)  kubelet, node1     Started container busybox
</code></pre>
<h3 id="523-å¯åŠ¨å‘½ä»¤">5.2.3 å¯åŠ¨å‘½ä»¤</h3>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œä¸€ç›´æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼Œå°±æ˜¯çš„busyboxå®¹å™¨ä¸€ç›´æ²¡æœ‰æˆåŠŸè¿è¡Œï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´è¿™ä¸ªå®¹å™¨çš„æ•…éšœå‘¢ï¼Ÿ</p>
<p>åŸæ¥busyboxå¹¶ä¸æ˜¯ä¸€ä¸ªç¨‹åºï¼Œè€Œæ˜¯ç±»ä¼¼äºä¸€ä¸ªå·¥å…·ç±»çš„é›†åˆï¼Œkubernetesé›†ç¾¤å¯åŠ¨ç®¡ç†åï¼Œå®ƒä¼šè‡ªåŠ¨å…³é—­ã€‚è§£å†³æ–¹æ³•å°±æ˜¯è®©å…¶ä¸€ç›´åœ¨è¿è¡Œï¼Œè¿™å°±ç”¨åˆ°äº†commandé…ç½®ã€‚</p>
<p>åˆ›å»ºpod-command.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-command
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&quot;]
</code></pre>
<figure data-type="image" tabindex="16"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gywjczij30dt02paae.jpg" alt="image-20210617224457945" loading="lazy"></figure>
<p>commandï¼Œç”¨äºåœ¨podä¸­çš„å®¹å™¨åˆå§‹åŒ–å®Œæ¯•ä¹‹åè¿è¡Œä¸€ä¸ªå‘½ä»¤ã€‚</p>
<blockquote>
<p>ç¨å¾®è§£é‡Šä¸‹ä¸Šé¢å‘½ä»¤çš„æ„æ€ï¼š</p>
<p>&quot;/bin/sh&quot;,&quot;-c&quot;, ä½¿ç”¨shæ‰§è¡Œå‘½ä»¤</p>
<p>touch /tmp/hello.txt; åˆ›å»ºä¸€ä¸ª/tmp/hello.txt æ–‡ä»¶</p>
<p>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done; æ¯éš”3ç§’å‘æ–‡ä»¶ä¸­å†™å…¥å½“å‰æ—¶é—´</p>
</blockquote>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 pod]# kubectl create  -f pod-command.yaml
pod/pod-command created

# æŸ¥çœ‹PodçŠ¶æ€
# æ­¤æ—¶å‘ç°ä¸¤ä¸ªpodéƒ½æ­£å¸¸è¿è¡Œäº†
[root@k8s-master01 pod]# kubectl get pods pod-command -n dev
NAME          READY   STATUS   RESTARTS   AGE
pod-command   2/2     Runing   0          2s

# è¿›å…¥podä¸­çš„busyboxå®¹å™¨ï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹
# è¡¥å……ä¸€ä¸ªå‘½ä»¤: kubectl exec  podåç§° -n å‘½åç©ºé—´ -it -c å®¹å™¨åç§° /bin/sh  åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤
# ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥è¿›å…¥æŸä¸ªå®¹å™¨çš„å†…éƒ¨ï¼Œç„¶åè¿›è¡Œç›¸å…³æ“ä½œäº†
# æ¯”å¦‚ï¼Œå¯ä»¥æŸ¥çœ‹txtæ–‡ä»¶çš„å†…å®¹
[root@k8s-master01 pod]# kubectl exec pod-command -n dev -it -c busybox /bin/sh
/ # tail -f /tmp/hello.txt
14:44:19
14:44:22
14:44:25
</code></pre>
<pre><code>ç‰¹åˆ«è¯´æ˜ï¼š
    é€šè¿‡ä¸Šé¢å‘ç°commandå·²ç»å¯ä»¥å®Œæˆå¯åŠ¨å‘½ä»¤å’Œä¼ é€’å‚æ•°çš„åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦æä¾›ä¸€ä¸ªargsé€‰é¡¹ï¼Œç”¨äºä¼ é€’å‚æ•°å‘¢?è¿™å…¶å®è·Ÿdockeræœ‰ç‚¹å…³ç³»ï¼Œkubernetesä¸­çš„commandã€argsä¸¤é¡¹å…¶å®æ˜¯å®ç°è¦†ç›–Dockerfileä¸­ENTRYPOINTçš„åŠŸèƒ½ã€‚
 1 å¦‚æœcommandå’Œargså‡æ²¡æœ‰å†™ï¼Œé‚£ä¹ˆç”¨Dockerfileçš„é…ç½®ã€‚
 2 å¦‚æœcommandå†™äº†ï¼Œä½†argsæ²¡æœ‰å†™ï¼Œé‚£ä¹ˆDockerfileé»˜è®¤çš„é…ç½®ä¼šè¢«å¿½ç•¥ï¼Œæ‰§è¡Œè¾“å…¥çš„command
 3 å¦‚æœcommandæ²¡å†™ï¼Œä½†argså†™äº†ï¼Œé‚£ä¹ˆDockerfileä¸­é…ç½®çš„ENTRYPOINTçš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä½¿ç”¨å½“å‰argsçš„å‚æ•°
 4 å¦‚æœcommandå’Œargséƒ½å†™äº†ï¼Œé‚£ä¹ˆDockerfileçš„é…ç½®è¢«å¿½ç•¥ï¼Œæ‰§è¡Œcommandå¹¶è¿½åŠ ä¸Šargså‚æ•°
</code></pre>
<h3 id="524-ç¯å¢ƒå˜é‡">5.2.4 ç¯å¢ƒå˜é‡</h3>
<p>åˆ›å»ºpod-env.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-env
  namespace: dev
spec:
  containers:
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;]
    env: # è®¾ç½®ç¯å¢ƒå˜é‡åˆ—è¡¨
    - name: &quot;username&quot;
      value: &quot;admin&quot;
    - name: &quot;password&quot;
      value: &quot;123456&quot;
</code></pre>
<p>envï¼Œç¯å¢ƒå˜é‡ï¼Œç”¨äºåœ¨podä¸­çš„å®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</p>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-env.yaml
pod/pod-env created

# è¿›å…¥å®¹å™¨ï¼Œè¾“å‡ºç¯å¢ƒå˜é‡
[root@k8s-master01 ~]# kubectl exec pod-env -n dev -c busybox -it /bin/sh
/ # echo $username
admin
/ # echo $password
123456
</code></pre>
<p>è¿™ç§æ–¹å¼ä¸æ˜¯å¾ˆæ¨èï¼Œæ¨èå°†è¿™äº›é…ç½®å•ç‹¬å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™ç§æ–¹å¼å°†åœ¨åé¢ä»‹ç»ã€‚</p>
<h3 id="525-ç«¯å£è®¾ç½®">5.2.5 ç«¯å£è®¾ç½®</h3>
<p>æœ¬å°èŠ‚æ¥ä»‹ç»å®¹å™¨çš„ç«¯å£è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯containersçš„portsé€‰é¡¹ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹portsæ”¯æŒçš„å­é€‰é¡¹ï¼š</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl explain pod.spec.containers.ports
KIND:     Pod
VERSION:  v1
RESOURCE: ports &lt;[]Object&gt;
FIELDS:
   name         &lt;string&gt;  # ç«¯å£åç§°ï¼Œå¦‚æœæŒ‡å®šï¼Œå¿…é¡»ä¿è¯nameåœ¨podä¸­æ˜¯å”¯ä¸€çš„		
   containerPort&lt;integer&gt; # å®¹å™¨è¦ç›‘å¬çš„ç«¯å£(0&lt;x&lt;65536)
   hostPort     &lt;integer&gt; # å®¹å™¨è¦åœ¨ä¸»æœºä¸Šå…¬å¼€çš„ç«¯å£ï¼Œå¦‚æœè®¾ç½®ï¼Œä¸»æœºä¸Šåªèƒ½è¿è¡Œå®¹å™¨çš„ä¸€ä¸ªå‰¯æœ¬(ä¸€èˆ¬çœç•¥) 
   hostIP       &lt;string&gt;  # è¦å°†å¤–éƒ¨ç«¯å£ç»‘å®šåˆ°çš„ä¸»æœºIP(ä¸€èˆ¬çœç•¥)
   protocol     &lt;string&gt;  # ç«¯å£åè®®ã€‚å¿…é¡»æ˜¯UDPã€TCPæˆ–SCTPã€‚é»˜è®¤ä¸ºâ€œTCPâ€ã€‚
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œåˆ›å»ºpod-ports.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-ports
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports: # è®¾ç½®å®¹å™¨æš´éœ²çš„ç«¯å£åˆ—è¡¨
    - name: nginx-port
      containerPort: 80
      protocol: TCP
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-ports.yaml
pod/pod-ports created

# æŸ¥çœ‹pod
# åœ¨ä¸‹é¢å¯ä»¥æ˜æ˜¾çœ‹åˆ°é…ç½®ä¿¡æ¯
[root@k8s-master01 ~]# kubectl get pod pod-ports -n dev -o yaml
......
spec:
  containers:
  - image: nginx:1.17.1
    imagePullPolicy: IfNotPresent
    name: nginx
    ports:
    - containerPort: 80
      name: nginx-port
      protocol: TCP
......
</code></pre>
<p>è®¿é—®å®¹å™¨ä¸­çš„ç¨‹åºéœ€è¦ä½¿ç”¨çš„æ˜¯<code>Podip:containerPort</code></p>
<h3 id="526-èµ„æºé…é¢">5.2.6 èµ„æºé…é¢</h3>
<p>å®¹å™¨ä¸­çš„ç¨‹åºè¦è¿è¡Œï¼Œè‚¯å®šæ˜¯è¦å ç”¨ä¸€å®šèµ„æºçš„ï¼Œæ¯”å¦‚cpuå’Œå†…å­˜ç­‰ï¼Œå¦‚æœä¸å¯¹æŸä¸ªå®¹å™¨çš„èµ„æºåšé™åˆ¶ï¼Œé‚£ä¹ˆå®ƒå°±å¯èƒ½åƒæ‰å¤§é‡èµ„æºï¼Œå¯¼è‡´å…¶å®ƒå®¹å™¨æ— æ³•è¿è¡Œã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetesæä¾›äº†å¯¹å†…å­˜å’Œcpuçš„èµ„æºè¿›è¡Œé…é¢çš„æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶ä¸»è¦é€šè¿‡resourcesé€‰é¡¹å®ç°ï¼Œä»–æœ‰ä¸¤ä¸ªå­é€‰é¡¹ï¼š</p>
<ul>
<li>limitsï¼šç”¨äºé™åˆ¶è¿è¡Œæ—¶å®¹å™¨çš„æœ€å¤§å ç”¨èµ„æºï¼Œå½“å®¹å™¨å ç”¨èµ„æºè¶…è¿‡limitsæ—¶ä¼šè¢«ç»ˆæ­¢ï¼Œå¹¶è¿›è¡Œé‡å¯</li>
<li>requests ï¼šç”¨äºè®¾ç½®å®¹å™¨éœ€è¦çš„æœ€å°èµ„æºï¼Œå¦‚æœç¯å¢ƒèµ„æºä¸å¤Ÿï¼Œå®¹å™¨å°†æ— æ³•å¯åŠ¨</li>
</ul>
<p>å¯ä»¥é€šè¿‡ä¸Šé¢ä¸¤ä¸ªé€‰é¡¹è®¾ç½®èµ„æºçš„ä¸Šä¸‹é™ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œåˆ›å»ºpod-resources.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-resources
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    resources: # èµ„æºé…é¢
      limits:  # é™åˆ¶èµ„æºï¼ˆä¸Šé™ï¼‰
        cpu: &quot;2&quot; # CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°
        memory: &quot;10Gi&quot; # å†…å­˜é™åˆ¶
      requests: # è¯·æ±‚èµ„æºï¼ˆä¸‹é™ï¼‰
        cpu: &quot;1&quot;  # CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°
        memory: &quot;10Mi&quot;  # å†…å­˜é™åˆ¶
</code></pre>
<p>åœ¨è¿™å¯¹cpuå’Œmemoryçš„å•ä½åšä¸€ä¸ªè¯´æ˜ï¼š</p>
<ul>
<li>cpuï¼šcoreæ•°ï¼Œå¯ä»¥ä¸ºæ•´æ•°æˆ–å°æ•°</li>
<li>memoryï¼š å†…å­˜å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨Giã€Miã€Gã€Mç­‰å½¢å¼</li>
</ul>
<pre><code class="language-shell"># è¿è¡ŒPod
[root@k8s-master01 ~]# kubectl create  -f pod-resources.yaml
pod/pod-resources created

# æŸ¥çœ‹å‘ç°podè¿è¡Œæ­£å¸¸
[root@k8s-master01 ~]# kubectl get pod pod-resources -n dev
NAME            READY   STATUS    RESTARTS   AGE  
pod-resources   1/1     Running   0          39s   

# æ¥ä¸‹æ¥ï¼Œåœæ­¢Pod
[root@k8s-master01 ~]# kubectl delete  -f pod-resources.yaml
pod &quot;pod-resources&quot; deleted

# ç¼–è¾‘podï¼Œä¿®æ”¹resources.requests.memoryçš„å€¼ä¸º10Gi
[root@k8s-master01 ~]# vim pod-resources.yaml

# å†æ¬¡å¯åŠ¨pod
[root@k8s-master01 ~]# kubectl create  -f pod-resources.yaml
pod/pod-resources created

# æŸ¥çœ‹PodçŠ¶æ€ï¼Œå‘ç°Podå¯åŠ¨å¤±è´¥
[root@k8s-master01 ~]# kubectl get pod pod-resources -n dev -o wide
NAME            READY   STATUS    RESTARTS   AGE          
pod-resources   0/1     Pending   0          20s    

# æŸ¥çœ‹podè¯¦æƒ…ä¼šå‘ç°ï¼Œå¦‚ä¸‹æç¤º
[root@k8s-master01 ~]# kubectl describe pod pod-resources -n dev
......
Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate, 2 Insufficient memory.(å†…å­˜ä¸è¶³)
</code></pre>
<h2 id="53-podç”Ÿå‘½å‘¨æœŸ">5.3 Podç”Ÿå‘½å‘¨æœŸ</h2>
<p>æˆ‘ä»¬ä¸€èˆ¬å°†podå¯¹è±¡ä»åˆ›å»ºè‡³ç»ˆçš„è¿™æ®µæ—¶é—´èŒƒå›´ç§°ä¸ºpodçš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¸»è¦åŒ…å«ä¸‹é¢çš„è¿‡ç¨‹ï¼š</p>
<ul>
<li>podåˆ›å»ºè¿‡ç¨‹</li>
<li>è¿è¡Œåˆå§‹åŒ–å®¹å™¨ï¼ˆinit containerï¼‰è¿‡ç¨‹</li>
<li>è¿è¡Œä¸»å®¹å™¨ï¼ˆmain containerï¼‰
<ul>
<li>å®¹å™¨å¯åŠ¨åé’©å­ï¼ˆpost startï¼‰ã€å®¹å™¨ç»ˆæ­¢å‰é’©å­ï¼ˆpre stopï¼‰</li>
<li>å®¹å™¨çš„å­˜æ´»æ€§æ¢æµ‹ï¼ˆliveness probeï¼‰ã€å°±ç»ªæ€§æ¢æµ‹ï¼ˆreadiness probeï¼‰</li>
</ul>
</li>
<li>podç»ˆæ­¢è¿‡ç¨‹</li>
</ul>
<figure data-type="image" tabindex="17"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gz1qxumj30t90f8abr.jpg" alt="image-20200412111402706" loading="lazy"></figure>
<p>åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒPodä¼šå‡ºç°5ç§<strong>çŠ¶æ€</strong>ï¼ˆ<strong>ç›¸ä½</strong>ï¼‰ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŒ‚èµ·ï¼ˆPendingï¼‰ï¼šapiserverå·²ç»åˆ›å»ºäº†podèµ„æºå¯¹è±¡ï¼Œä½†å®ƒå°šæœªè¢«è°ƒåº¦å®Œæˆæˆ–è€…ä»å¤„äºä¸‹è½½é•œåƒçš„è¿‡ç¨‹ä¸­</li>
<li>è¿è¡Œä¸­ï¼ˆRunningï¼‰ï¼špodå·²ç»è¢«è°ƒåº¦è‡³æŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²ç»è¢«kubeletåˆ›å»ºå®Œæˆ</li>
<li>æˆåŠŸï¼ˆSucceededï¼‰ï¼špodä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»æˆåŠŸç»ˆæ­¢å¹¶ä¸”ä¸ä¼šè¢«é‡å¯</li>
<li>å¤±è´¥ï¼ˆFailedï¼‰ï¼šæ‰€æœ‰å®¹å™¨éƒ½å·²ç»ç»ˆæ­¢ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ç»ˆæ­¢å¤±è´¥ï¼Œå³å®¹å™¨è¿”å›äº†é0å€¼çš„é€€å‡ºçŠ¶æ€</li>
<li>æœªçŸ¥ï¼ˆUnknownï¼‰ï¼šapiserveræ— æ³•æ­£å¸¸è·å–åˆ°podå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šå¸¸ç”±ç½‘ç»œé€šä¿¡å¤±è´¥æ‰€å¯¼è‡´</li>
</ul>
<h3 id="531-åˆ›å»ºå’Œç»ˆæ­¢">5.3.1 åˆ›å»ºå’Œç»ˆæ­¢</h3>
<p><strong>podçš„åˆ›å»ºè¿‡ç¨‹</strong></p>
<ol>
<li>
<p>ç”¨æˆ·é€šè¿‡kubectlæˆ–å…¶ä»–apiå®¢æˆ·ç«¯æäº¤éœ€è¦åˆ›å»ºçš„podä¿¡æ¯ç»™apiServer</p>
</li>
<li>
<p>apiServerå¼€å§‹ç”Ÿæˆpodå¯¹è±¡çš„ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥etcdï¼Œç„¶åè¿”å›ç¡®è®¤ä¿¡æ¯è‡³å®¢æˆ·ç«¯</p>
</li>
<li>
<p>apiServerå¼€å§‹åæ˜ etcdä¸­çš„podå¯¹è±¡çš„å˜åŒ–ï¼Œå…¶å®ƒç»„ä»¶ä½¿ç”¨watchæœºåˆ¶æ¥è·Ÿè¸ªæ£€æŸ¥apiServerä¸Šçš„å˜åŠ¨</p>
</li>
<li>
<p>schedulerå‘ç°æœ‰æ–°çš„podå¯¹è±¡è¦åˆ›å»ºï¼Œå¼€å§‹ä¸ºPodåˆ†é…ä¸»æœºå¹¶å°†ç»“æœä¿¡æ¯æ›´æ–°è‡³apiServer</p>
</li>
<li>
<p>nodeèŠ‚ç‚¹ä¸Šçš„kubeletå‘ç°æœ‰podè°ƒåº¦è¿‡æ¥ï¼Œå°è¯•è°ƒç”¨dockerå¯åŠ¨å®¹å™¨ï¼Œå¹¶å°†ç»“æœå›é€è‡³apiServer</p>
</li>
<li>
<p>apiServerå°†æ¥æ”¶åˆ°çš„podçŠ¶æ€ä¿¡æ¯å­˜å…¥etcdä¸­</p>
<figure data-type="image" tabindex="18"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gz5mu0ej313w0kpwhr.jpg" alt="image-20200406184656917" loading="lazy"></figure>
</li>
</ol>
<p><strong>podçš„ç»ˆæ­¢è¿‡ç¨‹</strong></p>
<ol>
<li>ç”¨æˆ·å‘apiServerå‘é€åˆ é™¤podå¯¹è±¡çš„å‘½ä»¤</li>
<li>apiServcerä¸­çš„podå¯¹è±¡ä¿¡æ¯ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ›´æ–°ï¼Œåœ¨å®½é™æœŸå†…ï¼ˆé»˜è®¤30sï¼‰ï¼Œpodè¢«è§†ä¸ºdead</li>
<li>å°†podæ ‡è®°ä¸ºterminatingçŠ¶æ€</li>
<li>kubeletåœ¨ç›‘æ§åˆ°podå¯¹è±¡è½¬ä¸ºterminatingçŠ¶æ€çš„åŒæ—¶å¯åŠ¨podå…³é—­è¿‡ç¨‹</li>
<li>ç«¯ç‚¹æ§åˆ¶å™¨ç›‘æ§åˆ°podå¯¹è±¡çš„å…³é—­è¡Œä¸ºæ—¶å°†å…¶ä»æ‰€æœ‰åŒ¹é…åˆ°æ­¤ç«¯ç‚¹çš„serviceèµ„æºçš„ç«¯ç‚¹åˆ—è¡¨ä¸­ç§»é™¤</li>
<li>å¦‚æœå½“å‰podå¯¹è±¡å®šä¹‰äº†preStopé’©å­å¤„ç†å™¨ï¼Œåˆ™åœ¨å…¶æ ‡è®°ä¸ºterminatingåå³ä¼šä»¥åŒæ­¥çš„æ–¹å¼å¯åŠ¨æ‰§è¡Œ</li>
<li>podå¯¹è±¡ä¸­çš„å®¹å™¨è¿›ç¨‹æ”¶åˆ°åœæ­¢ä¿¡å·</li>
<li>å®½é™æœŸç»“æŸåï¼Œè‹¥podä¸­è¿˜å­˜åœ¨ä»åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆpodå¯¹è±¡ä¼šæ”¶åˆ°ç«‹å³ç»ˆæ­¢çš„ä¿¡å·</li>
<li>kubeletè¯·æ±‚apiServerå°†æ­¤podèµ„æºçš„å®½é™æœŸè®¾ç½®ä¸º0ä»è€Œå®Œæˆåˆ é™¤æ“ä½œï¼Œæ­¤æ—¶podå¯¹äºç”¨æˆ·å·²ä¸å¯è§</li>
</ol>
<h3 id="532-åˆå§‹åŒ–å®¹å™¨">5.3.2 åˆå§‹åŒ–å®¹å™¨</h3>
<p>åˆå§‹åŒ–å®¹å™¨æ˜¯åœ¨podçš„ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰è¦è¿è¡Œçš„å®¹å™¨ï¼Œä¸»è¦æ˜¯åšä¸€äº›ä¸»å®¹å™¨çš„å‰ç½®å·¥ä½œï¼Œå®ƒå…·æœ‰ä¸¤å¤§ç‰¹å¾ï¼š</p>
<ol>
<li>åˆå§‹åŒ–å®¹å™¨å¿…é¡»è¿è¡Œå®Œæˆç›´è‡³ç»“æŸï¼Œè‹¥æŸåˆå§‹åŒ–å®¹å™¨è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆkuberneteséœ€è¦é‡å¯å®ƒç›´åˆ°æˆåŠŸå®Œæˆ</li>
<li>åˆå§‹åŒ–å®¹å™¨å¿…é¡»æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œï¼Œå½“ä¸”ä»…å½“å‰ä¸€ä¸ªæˆåŠŸä¹‹åï¼Œåé¢çš„ä¸€ä¸ªæ‰èƒ½è¿è¡Œ</li>
</ol>
<p>åˆå§‹åŒ–å®¹å™¨æœ‰å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ï¼Œä¸‹é¢åˆ—å‡ºçš„æ˜¯æœ€å¸¸è§çš„å‡ ä¸ªï¼š</p>
<ul>
<li>æä¾›ä¸»å®¹å™¨é•œåƒä¸­ä¸å…·å¤‡çš„å·¥å…·ç¨‹åºæˆ–è‡ªå®šä¹‰ä»£ç </li>
<li>åˆå§‹åŒ–å®¹å™¨è¦å…ˆäºåº”ç”¨å®¹å™¨ä¸²è¡Œå¯åŠ¨å¹¶è¿è¡Œå®Œæˆï¼Œå› æ­¤å¯ç”¨äºå»¶ååº”ç”¨å®¹å™¨çš„å¯åŠ¨ç›´è‡³å…¶ä¾èµ–çš„æ¡ä»¶å¾—åˆ°æ»¡è¶³</li>
</ul>
<p>æ¥ä¸‹æ¥åšä¸€ä¸ªæ¡ˆä¾‹ï¼Œæ¨¡æ‹Ÿä¸‹é¢è¿™ä¸ªéœ€æ±‚ï¼š</p>
<p>å‡è®¾è¦ä»¥ä¸»å®¹å™¨æ¥è¿è¡Œnginxï¼Œä½†æ˜¯è¦æ±‚åœ¨è¿è¡Œnginxä¹‹å‰å…ˆè¦èƒ½å¤Ÿè¿æ¥ä¸Šmysqlå’Œredisæ‰€åœ¨æœåŠ¡å™¨</p>
<p>ä¸ºäº†ç®€åŒ–æµ‹è¯•ï¼Œäº‹å…ˆè§„å®šå¥½mysql<code>(192.168.5.4)</code>å’Œredis<code>(192.168.5.5)</code>æœåŠ¡å™¨çš„åœ°å€</p>
<p>åˆ›å»ºpod-initcontainer.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-initcontainer
  namespace: dev
spec:
  containers:
  - name: main-container
    image: nginx:1.17.1
    ports: 
    - name: nginx-port
      containerPort: 80
  initContainers:
  - name: test-mysql
    image: busybox:1.30
    command: ['sh', '-c', 'until ping 192.168.5.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;']
  - name: test-redis
    image: busybox:1.30
    command: ['sh', '-c', 'until ping 192.168.5.15 -c 1 ; do echo waiting for reids...; sleep 2; done;']
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-initcontainer.yaml
pod/pod-initcontainer created

# æŸ¥çœ‹podçŠ¶æ€
# å‘ç°podå¡åœ¨å¯åŠ¨ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿‡ç¨‹ä¸­ï¼Œåé¢çš„å®¹å™¨ä¸ä¼šè¿è¡Œ
root@k8s-master01 ~]# kubectl describe pod  pod-initcontainer -n dev
........
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1
  Normal  Pulled     48s   kubelet, node1     Container image &quot;busybox:1.30&quot; already present on machine
  Normal  Created    48s   kubelet, node1     Created container test-mysql
  Normal  Started    48s   kubelet, node1     Started container test-mysql

# åŠ¨æ€æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods pod-initcontainer -n dev -w
NAME                             READY   STATUS     RESTARTS   AGE
pod-initcontainer                0/1     Init:0/2   0          15s
pod-initcontainer                0/1     Init:1/2   0          52s
pod-initcontainer                0/1     Init:1/2   0          53s
pod-initcontainer                0/1     PodInitializing   0          89s
pod-initcontainer                1/1     Running           0          90s

# æ¥ä¸‹æ¥æ–°å¼€ä¸€ä¸ªshellï¼Œä¸ºå½“å‰æœåŠ¡å™¨æ–°å¢ä¸¤ä¸ªipï¼Œè§‚å¯Ÿpodçš„å˜åŒ–
[root@k8s-master01 ~]# ifconfig ens33:1 192.168.5.14 netmask 255.255.255.0 up
[root@k8s-master01 ~]# ifconfig ens33:2 192.168.5.15 netmask 255.255.255.0 up
</code></pre>
<h3 id="533-é’©å­å‡½æ•°">5.3.3 é’©å­å‡½æ•°</h3>
<p>é’©å­å‡½æ•°èƒ½å¤Ÿæ„ŸçŸ¥è‡ªèº«ç”Ÿå‘½å‘¨æœŸä¸­çš„äº‹ä»¶ï¼Œå¹¶åœ¨ç›¸åº”çš„æ—¶åˆ»åˆ°æ¥æ—¶è¿è¡Œç”¨æˆ·æŒ‡å®šçš„ç¨‹åºä»£ç ã€‚</p>
<p>kubernetesåœ¨ä¸»å®¹å™¨çš„å¯åŠ¨ä¹‹åå’Œåœæ­¢ä¹‹å‰æä¾›äº†ä¸¤ä¸ªé’©å­å‡½æ•°ï¼š</p>
<ul>
<li>post startï¼šå®¹å™¨åˆ›å»ºä¹‹åæ‰§è¡Œï¼Œå¦‚æœå¤±è´¥äº†ä¼šé‡å¯å®¹å™¨</li>
<li>pre stop ï¼šå®¹å™¨ç»ˆæ­¢ä¹‹å‰æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆä¹‹åå®¹å™¨å°†æˆåŠŸç»ˆæ­¢ï¼Œåœ¨å…¶å®Œæˆä¹‹å‰ä¼šé˜»å¡åˆ é™¤å®¹å™¨çš„æ“ä½œ</li>
</ul>
<p>é’©å­å¤„ç†å™¨æ”¯æŒä½¿ç”¨ä¸‹é¢ä¸‰ç§æ–¹å¼å®šä¹‰åŠ¨ä½œï¼š</p>
<ul>
<li>
<p>Execå‘½ä»¤ï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€æ¬¡å‘½ä»¤</p>
<pre><code class="language-yaml">â€¦â€¦
  lifecycle:
    postStart: 
      exec:
        command:
        - cat
        - /tmp/healthy
â€¦â€¦
</code></pre>
</li>
<li>
<p>TCPSocketï¼šåœ¨å½“å‰å®¹å™¨å°è¯•è®¿é—®æŒ‡å®šçš„socket</p>
<pre><code class="language-yaml">â€¦â€¦      
  lifecycle:
    postStart:
      tcpSocket:
        port: 8080
â€¦â€¦
</code></pre>
</li>
<li>
<p>HTTPGetï¼šåœ¨å½“å‰å®¹å™¨ä¸­å‘æŸurlå‘èµ·httpè¯·æ±‚</p>
<pre><code class="language-yaml">â€¦â€¦
  lifecycle:
    postStart:
      httpGet:
        path: / #URIåœ°å€
        port: 80 #ç«¯å£å·
        host: 192.168.5.3 #ä¸»æœºåœ°å€
        scheme: HTTP #æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https
â€¦â€¦
</code></pre>
</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œä»¥execæ–¹å¼ä¸ºä¾‹ï¼Œæ¼”ç¤ºä¸‹é’©å­å‡½æ•°çš„ä½¿ç”¨ï¼Œåˆ›å»ºpod-hook-exec.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-hook-exec
  namespace: dev
spec:
  containers:
  - name: main-container
    image: nginx:1.17.1
    ports:
    - name: nginx-port
      containerPort: 80
    lifecycle:
      postStart: 
        exec: # åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œä¿®æ”¹æ‰nginxçš„é»˜è®¤é¦–é¡µå†…å®¹
          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;]
      preStop:
        exec: # åœ¨å®¹å™¨åœæ­¢ä¹‹å‰åœæ­¢nginxæœåŠ¡
          command: [&quot;/usr/sbin/nginx&quot;,&quot;-s&quot;,&quot;quit&quot;]
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-hook-exec.yaml
pod/pod-hook-exec created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods  pod-hook-exec -n dev -o wide
NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    
pod-hook-exec  1/1     Running    0          29s    10.244.2.48   node2   

# è®¿é—®pod
[root@k8s-master01 ~]# curl 10.244.2.48
postStart...
</code></pre>
<h3 id="534-å®¹å™¨æ¢æµ‹">5.3.4 å®¹å™¨æ¢æµ‹</h3>
<p>å®¹å™¨æ¢æµ‹ç”¨äºæ£€æµ‹å®¹å™¨ä¸­çš„åº”ç”¨å®ä¾‹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ˜¯ä¿éšœä¸šåŠ¡å¯ç”¨æ€§çš„ä¸€ç§ä¼ ç»Ÿæœºåˆ¶ã€‚å¦‚æœç»è¿‡æ¢æµ‹ï¼Œå®ä¾‹çš„çŠ¶æ€ä¸ç¬¦åˆé¢„æœŸï¼Œé‚£ä¹ˆkuberneteså°±ä¼šæŠŠè¯¥é—®é¢˜å®ä¾‹&quot; æ‘˜é™¤ &quot;ï¼Œä¸æ‰¿æ‹…ä¸šåŠ¡æµé‡ã€‚kubernetesæä¾›äº†ä¸¤ç§æ¢é’ˆæ¥å®ç°å®¹å™¨æ¢æµ‹ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>liveness probesï¼šå­˜æ´»æ€§æ¢é’ˆï¼Œç”¨äºæ£€æµ‹åº”ç”¨å®ä¾‹å½“å‰æ˜¯å¦å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ï¼Œk8sä¼šé‡å¯å®¹å™¨</li>
<li>readiness probesï¼šå°±ç»ªæ€§æ¢é’ˆï¼Œç”¨äºæ£€æµ‹åº”ç”¨å®ä¾‹å½“å‰æ˜¯å¦å¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœä¸èƒ½ï¼Œk8sä¸ä¼šè½¬å‘æµé‡</li>
</ul>
<blockquote>
<p>livenessProbe å†³å®šæ˜¯å¦é‡å¯å®¹å™¨ï¼ŒreadinessProbe å†³å®šæ˜¯å¦å°†è¯·æ±‚è½¬å‘ç»™å®¹å™¨ã€‚</p>
</blockquote>
<p>ä¸Šé¢ä¸¤ç§æ¢é’ˆç›®å‰å‡æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹å¼ï¼š</p>
<ul>
<li>
<p>Execå‘½ä»¤ï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡Œçš„é€€å‡ºç ä¸º0ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<pre><code class="language-yaml">â€¦â€¦
  livenessProbe:
    exec:
      command:
      - cat
      - /tmp/healthy
â€¦â€¦
</code></pre>
</li>
<li>
<p>TCPSocketï¼šå°†ä¼šå°è¯•è®¿é—®ä¸€ä¸ªç”¨æˆ·å®¹å™¨çš„ç«¯å£ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹è¿™æ¡è¿æ¥ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<pre><code class="language-yaml">â€¦â€¦      
  livenessProbe:
    tcpSocket:
      port: 8080
â€¦â€¦
</code></pre>
</li>
<li>
<p>HTTPGetï¼šè°ƒç”¨å®¹å™¨å†…Webåº”ç”¨çš„URLï¼Œå¦‚æœè¿”å›çš„çŠ¶æ€ç åœ¨200å’Œ399ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<pre><code class="language-yaml">â€¦â€¦
  livenessProbe:
    httpGet:
      path: / #URIåœ°å€
      port: 80 #ç«¯å£å·
      host: 127.0.0.1 #ä¸»æœºåœ°å€
      scheme: HTTP #æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https
â€¦â€¦
</code></pre>
</li>
</ul>
<p>ä¸‹é¢ä»¥liveness probesä¸ºä¾‹ï¼Œåšå‡ ä¸ªæ¼”ç¤ºï¼š</p>
<p><strong>æ–¹å¼ä¸€ï¼šExec</strong></p>
<p>åˆ›å»ºpod-liveness-exec.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-exec
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports: 
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      exec:
        command: [&quot;/bin/cat&quot;,&quot;/tmp/hello.txt&quot;] # æ‰§è¡Œä¸€ä¸ªæŸ¥çœ‹æ–‡ä»¶çš„å‘½ä»¤
</code></pre>
<p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-liveness-exec.yaml
pod/pod-liveness-exec created

# æŸ¥çœ‹Podè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe pods pod-liveness-exec -n dev
......
  Normal   Created    20s (x2 over 50s)  kubelet, node1     Created container nginx
  Normal   Started    20s (x2 over 50s)  kubelet, node1     Started container nginx
  Normal   Killing    20s                kubelet, node1     Container nginx failed liveness probe, will be restarted
  Warning  Unhealthy  0s (x5 over 40s)   kubelet, node1     Liveness probe failed: cat: can't open '/tmp/hello11.txt': No such file or directory
  
# è§‚å¯Ÿä¸Šé¢çš„ä¿¡æ¯å°±ä¼šå‘ç°nginxå®¹å™¨å¯åŠ¨ä¹‹åå°±è¿›è¡Œäº†å¥åº·æ£€æŸ¥
# æ£€æŸ¥å¤±è´¥ä¹‹åï¼Œå®¹å™¨è¢«killæ‰ï¼Œç„¶åå°è¯•è¿›è¡Œé‡å¯ï¼ˆè¿™æ˜¯é‡å¯ç­–ç•¥çš„ä½œç”¨ï¼Œåé¢è®²è§£ï¼‰
# ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿
[root@k8s-master01 ~]# kubectl get pods pod-liveness-exec -n dev
NAME                READY   STATUS             RESTARTS   AGE
pod-liveness-exec   0/1     CrashLoopBackOff   2          3m19s

# å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œæ¯”å¦‚/tmp/hello.txtï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......
</code></pre>
<p><strong>æ–¹å¼äºŒï¼šTCPSocket</strong></p>
<p>åˆ›å»ºpod-liveness-tcpsocket.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-tcpsocket
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports: 
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      tcpSocket:
        port: 8080 # å°è¯•è®¿é—®8080ç«¯å£
</code></pre>
<p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-liveness-tcpsocket.yaml
pod/pod-liveness-tcpsocket created

# æŸ¥çœ‹Podè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe pods pod-liveness-tcpsocket -n dev
......
  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2
  Normal   Pulled     &lt;invalid&gt;                      kubelet, node2     Container image &quot;nginx:1.17.1&quot; already present on machine
  Normal   Created    &lt;invalid&gt;                      kubelet, node2     Created container nginx
  Normal   Started    &lt;invalid&gt;                      kubelet, node2     Started container nginx
  Warning  Unhealthy  &lt;invalid&gt; (x2 over &lt;invalid&gt;)  kubelet, node2     Liveness probe failed: dial tcp 10.244.2.44:8080: connect: connection refused
  
# è§‚å¯Ÿä¸Šé¢çš„ä¿¡æ¯ï¼Œå‘ç°å°è¯•è®¿é—®8080ç«¯å£,ä½†æ˜¯å¤±è´¥äº†
# ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿
[root@k8s-master01 ~]# kubectl get pods pod-liveness-tcpsocket  -n dev
NAME                     READY   STATUS             RESTARTS   AGE
pod-liveness-tcpsocket   0/1     CrashLoopBackOff   2          3m19s

# å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå¯ä»¥è®¿é—®çš„ç«¯å£ï¼Œæ¯”å¦‚80ï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......
</code></pre>
<p><strong>æ–¹å¼ä¸‰ï¼šHTTPGet</strong></p>
<p>åˆ›å»ºpod-liveness-httpget.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-httpget
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      httpGet:  # å…¶å®å°±æ˜¯è®¿é—®http://127.0.0.1:80/hello  
        scheme: HTTP #æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https
        port: 80 #ç«¯å£å·
        path: /hello #URIåœ°å€
</code></pre>
<p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-liveness-httpget.yaml
pod/pod-liveness-httpget created

# æŸ¥çœ‹Podè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe pod pod-liveness-httpget -n dev
.......
  Normal   Pulled     6s (x3 over 64s)  kubelet, node1     Container image &quot;nginx:1.17.1&quot; already present on machine
  Normal   Created    6s (x3 over 64s)  kubelet, node1     Created container nginx
  Normal   Started    6s (x3 over 63s)  kubelet, node1     Started container nginx
  Warning  Unhealthy  6s (x6 over 56s)  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404
  Normal   Killing    6s (x2 over 36s)  kubelet, node1     Container nginx failed liveness probe, will be restarted
  
# è§‚å¯Ÿä¸Šé¢ä¿¡æ¯ï¼Œå°è¯•è®¿é—®è·¯å¾„ï¼Œä½†æ˜¯æœªæ‰¾åˆ°,å‡ºç°404é”™è¯¯
# ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿
[root@k8s-master01 ~]# kubectl get pod pod-liveness-httpget -n dev
NAME                   READY   STATUS    RESTARTS   AGE
pod-liveness-httpget   1/1     Running   5          3m17s

# å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå¯ä»¥è®¿é—®çš„è·¯å¾„pathï¼Œæ¯”å¦‚/ï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......
</code></pre>
<p>è‡³æ­¤ï¼Œå·²ç»ä½¿ç”¨liveness Probeæ¼”ç¤ºäº†ä¸‰ç§æ¢æµ‹æ–¹å¼ï¼Œä½†æ˜¯æŸ¥çœ‹livenessProbeçš„å­å±æ€§ï¼Œä¼šå‘ç°é™¤äº†è¿™ä¸‰ç§æ–¹å¼ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„é…ç½®ï¼Œåœ¨è¿™é‡Œä¸€å¹¶è§£é‡Šä¸‹ï¼š</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl explain pod.spec.containers.livenessProbe
FIELDS:
   exec &lt;Object&gt;  
   tcpSocket    &lt;Object&gt;
   httpGet      &lt;Object&gt;
   initialDelaySeconds  &lt;integer&gt;  # å®¹å™¨å¯åŠ¨åç­‰å¾…å¤šå°‘ç§’æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹
   timeoutSeconds       &lt;integer&gt;  # æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’
   periodSeconds        &lt;integer&gt;  # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’
   failureThreshold     &lt;integer&gt;  # è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1
   successThreshold     &lt;integer&gt;  # è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯1
</code></pre>
<p>ä¸‹é¢ç¨å¾®é…ç½®ä¸¤ä¸ªï¼Œæ¼”ç¤ºä¸‹æ•ˆæœå³å¯ï¼š</p>
<pre><code class="language-yaml">[root@k8s-master01 ~]# more pod-liveness-httpget.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-httpget
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      httpGet:
        scheme: HTTP
        port: 80 
        path: /
      initialDelaySeconds: 30 # å®¹å™¨å¯åŠ¨å30så¼€å§‹æ¢æµ‹
      timeoutSeconds: 5 # æ¢æµ‹è¶…æ—¶æ—¶é—´ä¸º5s
</code></pre>
<h3 id="535-é‡å¯ç­–ç•¥">5.3.5 é‡å¯ç­–ç•¥</h3>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œä¸€æ—¦å®¹å™¨æ¢æµ‹å‡ºç°äº†é—®é¢˜ï¼Œkuberneteså°±ä¼šå¯¹å®¹å™¨æ‰€åœ¨çš„Podè¿›è¡Œé‡å¯ï¼Œå…¶å®è¿™æ˜¯ç”±podçš„é‡å¯ç­–ç•¥å†³å®šçš„ï¼Œpodçš„é‡å¯ç­–ç•¥æœ‰ 3 ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>Always ï¼šå®¹å™¨å¤±æ•ˆæ—¶ï¼Œè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚</li>
<li>OnFailure ï¼š å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶é‡å¯</li>
<li>Never ï¼š ä¸è®ºçŠ¶æ€ä¸ºä½•ï¼Œéƒ½ä¸é‡å¯è¯¥å®¹å™¨</li>
</ul>
<p>é‡å¯ç­–ç•¥é€‚ç”¨äºpodå¯¹è±¡ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œé¦–æ¬¡éœ€è¦é‡å¯çš„å®¹å™¨ï¼Œå°†åœ¨å…¶éœ€è¦æ—¶ç«‹å³è¿›è¡Œé‡å¯ï¼Œéšåå†æ¬¡éœ€è¦é‡å¯çš„æ“ä½œå°†ç”±kubeletå»¶è¿Ÿä¸€æ®µæ—¶é—´åè¿›è¡Œï¼Œä¸”åå¤çš„é‡å¯æ“ä½œçš„å»¶è¿Ÿæ—¶é•¿ä»¥æ­¤ä¸º10sã€20sã€40sã€80sã€160så’Œ300sï¼Œ300sæ˜¯æœ€å¤§å»¶è¿Ÿæ—¶é•¿ã€‚</p>
<p>åˆ›å»ºpod-restartpolicy.yamlï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-restartpolicy
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      httpGet:
        scheme: HTTP
        port: 80
        path: /hello
  restartPolicy: Never # è®¾ç½®é‡å¯ç­–ç•¥ä¸ºNever
</code></pre>
<p>è¿è¡ŒPodæµ‹è¯•</p>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-restartpolicy.yaml
pod/pod-restartpolicy created

# æŸ¥çœ‹Podè¯¦æƒ…ï¼Œå‘ç°nginxå®¹å™¨å¤±è´¥
[root@k8s-master01 ~]# kubectl  describe pods pod-restartpolicy  -n dev
......
  Warning  Unhealthy  15s (x3 over 35s)  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404
  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe
  
# å¤šç­‰ä¸€ä¼šï¼Œå†è§‚å¯Ÿpodçš„é‡å¯æ¬¡æ•°ï¼Œå‘ç°ä¸€ç›´æ˜¯0ï¼Œå¹¶æœªé‡å¯   
[root@k8s-master01 ~]# kubectl  get pods pod-restartpolicy -n dev
NAME                   READY   STATUS    RESTARTS   AGE
pod-restartpolicy      0/1     Running   0          5min42s
</code></pre>
<h2 id="54-podè°ƒåº¦">5.4 Podè°ƒåº¦</h2>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªPodåœ¨å“ªä¸ªNodeèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ˜¯ç”±Schedulerç»„ä»¶é‡‡ç”¨ç›¸åº”çš„ç®—æ³•è®¡ç®—å‡ºæ¥çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸å—äººå·¥æ§åˆ¶çš„ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™å¹¶ä¸æ»¡è¶³çš„éœ€æ±‚ï¼Œå› ä¸ºå¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³æ§åˆ¶æŸäº›Podåˆ°è¾¾æŸäº›èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±è¦æ±‚äº†è§£kuberneteså¯¹Podçš„è°ƒåº¦è§„åˆ™ï¼Œkubernetesæä¾›äº†å››å¤§ç±»è°ƒåº¦æ–¹å¼ï¼š</p>
<ul>
<li>è‡ªåŠ¨è°ƒåº¦ï¼šè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šå®Œå…¨ç”±Schedulerç»è¿‡ä¸€ç³»åˆ—çš„ç®—æ³•è®¡ç®—å¾—å‡º</li>
<li>å®šå‘è°ƒåº¦ï¼šNodeNameã€NodeSelector</li>
<li>äº²å’Œæ€§è°ƒåº¦ï¼šNodeAffinityã€PodAffinityã€PodAntiAffinity</li>
<li>æ±¡ç‚¹ï¼ˆå®¹å¿ï¼‰è°ƒåº¦ï¼šTaintsã€Toleration</li>
</ul>
<h3 id="541-å®šå‘è°ƒåº¦">5.4.1 å®šå‘è°ƒåº¦</h3>
<p>å®šå‘è°ƒåº¦ï¼ŒæŒ‡çš„æ˜¯åˆ©ç”¨åœ¨podä¸Šå£°æ˜nodeNameæˆ–è€…nodeSelectorï¼Œä»¥æ­¤å°†Podè°ƒåº¦åˆ°æœŸæœ›çš„nodeèŠ‚ç‚¹ä¸Šã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„è°ƒåº¦æ˜¯å¼ºåˆ¶çš„ï¼Œè¿™å°±æ„å‘³ç€å³ä½¿è¦è°ƒåº¦çš„ç›®æ ‡Nodeä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå‘ä¸Šé¢è¿›è¡Œè°ƒåº¦ï¼Œåªä¸è¿‡podè¿è¡Œå¤±è´¥è€Œå·²ã€‚</p>
<p><strong>NodeName</strong></p>
<p>NodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„Nameçš„NodeèŠ‚ç‚¹ä¸Šã€‚è¿™ç§æ–¹å¼ï¼Œå…¶å®æ˜¯ç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å°†Podè°ƒåº¦åˆ°æŒ‡å®šåç§°çš„èŠ‚ç‚¹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå®éªŒä¸€ä¸‹ï¼šåˆ›å»ºä¸€ä¸ªpod-nodename.yamlæ–‡ä»¶</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-nodename
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  nodeName: node1 # æŒ‡å®šè°ƒåº¦åˆ°node1èŠ‚ç‚¹ä¸Š
</code></pre>
<pre><code class="language-shell">#åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-nodename.yaml
pod/pod-nodename created

#æŸ¥çœ‹Podè°ƒåº¦åˆ°NODEå±æ€§ï¼Œç¡®å®æ˜¯è°ƒåº¦åˆ°äº†node1èŠ‚ç‚¹ä¸Š
[root@k8s-master01 ~]# kubectl get pods pod-nodename -n dev -o wide
NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......
pod-nodename   1/1     Running   0          56s   10.244.1.87   node1     ......   

# æ¥ä¸‹æ¥ï¼Œåˆ é™¤podï¼Œä¿®æ”¹nodeNameçš„å€¼ä¸ºnode3ï¼ˆå¹¶æ²¡æœ‰node3èŠ‚ç‚¹ï¼‰
[root@k8s-master01 ~]# kubectl delete -f pod-nodename.yaml
pod &quot;pod-nodename&quot; deleted
[root@k8s-master01 ~]# vim pod-nodename.yaml
[root@k8s-master01 ~]# kubectl create -f pod-nodename.yaml
pod/pod-nodename created

#å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°å·²ç»å‘Node3èŠ‚ç‚¹è°ƒåº¦ï¼Œä½†æ˜¯ç”±äºä¸å­˜åœ¨node3èŠ‚ç‚¹ï¼Œæ‰€ä»¥podæ— æ³•æ­£å¸¸è¿è¡Œ
[root@k8s-master01 ~]# kubectl get pods pod-nodename -n dev -o wide
NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......
pod-nodename   0/1     Pending   0          6s    &lt;none&gt;   node3   ......           
</code></pre>
<p><strong>NodeSelector</strong></p>
<p>NodeSelectorç”¨äºå°†podè°ƒåº¦åˆ°æ·»åŠ äº†æŒ‡å®šæ ‡ç­¾çš„nodeèŠ‚ç‚¹ä¸Šã€‚å®ƒæ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨podåˆ›å»ºä¹‹å‰ï¼Œä¼šç”±schedulerä½¿ç”¨MatchNodeSelectorè°ƒåº¦ç­–ç•¥è¿›è¡ŒlabelåŒ¹é…ï¼Œæ‰¾å‡ºç›®æ ‡nodeï¼Œç„¶åå°†podè°ƒåº¦åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå®éªŒä¸€ä¸‹ï¼š</p>
<p>1 é¦–å…ˆåˆ†åˆ«ä¸ºnodeèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl label nodes node1 nodeenv=pro
node/node2 labeled
[root@k8s-master01 ~]# kubectl label nodes node2 nodeenv=test
node/node2 labeled
</code></pre>
<p>2 åˆ›å»ºä¸€ä¸ªpod-nodeselector.yamlæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å®ƒåˆ›å»ºPod</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-nodeselector
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  nodeSelector: 
    nodeenv: pro # æŒ‡å®šè°ƒåº¦åˆ°å…·æœ‰nodeenv=proæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š
</code></pre>
<pre><code class="language-shell">#åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f pod-nodeselector.yaml
pod/pod-nodeselector created

#æŸ¥çœ‹Podè°ƒåº¦åˆ°NODEå±æ€§ï¼Œç¡®å®æ˜¯è°ƒåº¦åˆ°äº†node1èŠ‚ç‚¹ä¸Š
[root@k8s-master01 ~]# kubectl get pods pod-nodeselector -n dev -o wide
NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......
pod-nodeselector   1/1     Running   0          47s   10.244.1.87   node1   ......

# æ¥ä¸‹æ¥ï¼Œåˆ é™¤podï¼Œä¿®æ”¹nodeSelectorçš„å€¼ä¸ºnodeenv: xxxxï¼ˆä¸å­˜åœ¨æ‰“æœ‰æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ï¼‰
[root@k8s-master01 ~]# kubectl delete -f pod-nodeselector.yaml
pod &quot;pod-nodeselector&quot; deleted
[root@k8s-master01 ~]# vim pod-nodeselector.yaml
[root@k8s-master01 ~]# kubectl create -f pod-nodeselector.yaml
pod/pod-nodeselector created

#å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°podæ— æ³•æ­£å¸¸è¿è¡Œ,Nodeçš„å€¼ä¸ºnone
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    
pod-nodeselector   0/1     Pending   0          2m20s   &lt;none&gt;   &lt;none&gt;

# æŸ¥çœ‹è¯¦æƒ…,å‘ç°node selectoråŒ¹é…å¤±è´¥çš„æç¤º
[root@k8s-master01 ~]# kubectl describe pods pod-nodeselector -n dev
.......
Events:
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn't match node selector.
</code></pre>
<h3 id="542-äº²å’Œæ€§è°ƒåº¦">5.4.2 äº²å’Œæ€§è°ƒåº¦</h3>
<p>ä¸Šä¸€èŠ‚ï¼Œä»‹ç»äº†ä¸¤ç§å®šå‘è°ƒåº¦çš„æ–¹å¼ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„Nodeï¼Œé‚£ä¹ˆPodå°†ä¸ä¼šè¢«è¿è¡Œï¼Œå³ä½¿åœ¨é›†ç¾¤ä¸­è¿˜æœ‰å¯ç”¨Nodeåˆ—è¡¨ä¹Ÿä¸è¡Œï¼Œè¿™å°±é™åˆ¶äº†å®ƒçš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>åŸºäºä¸Šé¢çš„é—®é¢˜ï¼Œkubernetesè¿˜æä¾›äº†ä¸€ç§äº²å’Œæ€§è°ƒåº¦ï¼ˆAffinityï¼‰ã€‚å®ƒåœ¨NodeSelectorçš„åŸºç¡€ä¹‹ä¸Šçš„è¿›è¡Œäº†æ‰©å±•ï¼Œå¯ä»¥é€šè¿‡é…ç½®çš„å½¢å¼ï¼Œå®ç°ä¼˜å…ˆé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„Nodeè¿›è¡Œè°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿå¯ä»¥è°ƒåº¦åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œä½¿è°ƒåº¦æ›´åŠ çµæ´»ã€‚</p>
<p>Affinityä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>nodeAffinity(nodeäº²å’Œæ€§ï¼‰: ä»¥nodeä¸ºç›®æ ‡ï¼Œè§£å†³podå¯ä»¥è°ƒåº¦åˆ°å“ªäº›nodeçš„é—®é¢˜</li>
<li>podAffinity(podäº²å’Œæ€§) : ä»¥podä¸ºç›®æ ‡ï¼Œè§£å†³podå¯ä»¥å’Œå“ªäº›å·²å­˜åœ¨çš„podéƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜</li>
<li>podAntiAffinity(podåäº²å’Œæ€§) : ä»¥podä¸ºç›®æ ‡ï¼Œè§£å†³podä¸èƒ½å’Œå“ªäº›å·²å­˜åœ¨podéƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜</li>
</ul>
<blockquote>
<p>å…³äºäº²å’Œæ€§(åäº²å’Œæ€§)ä½¿ç”¨åœºæ™¯çš„è¯´æ˜ï¼š</p>
<p><strong>äº²å’Œæ€§</strong>ï¼šå¦‚æœä¸¤ä¸ªåº”ç”¨é¢‘ç¹äº¤äº’ï¼Œé‚£å°±æœ‰å¿…è¦åˆ©ç”¨äº²å’Œæ€§è®©ä¸¤ä¸ªåº”ç”¨çš„å°½å¯èƒ½çš„é è¿‘ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å› ç½‘ç»œé€šä¿¡è€Œå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</p>
<p><strong>åäº²å’Œæ€§</strong>ï¼šå½“åº”ç”¨çš„é‡‡ç”¨å¤šå‰¯æœ¬éƒ¨ç½²æ—¶ï¼Œæœ‰å¿…è¦é‡‡ç”¨åäº²å’Œæ€§è®©å„ä¸ªåº”ç”¨å®ä¾‹æ‰“æ•£åˆ†å¸ƒåœ¨å„ä¸ªnodeä¸Šï¼Œè¿™æ ·å¯ä»¥æé«˜æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚</p>
</blockquote>
<p><strong>NodeAffinity</strong></p>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹<code>NodeAffinity</code>çš„å¯é…ç½®é¡¹ï¼š</p>
<pre><code class="language-shell">pod.spec.affinity.nodeAffinity
  requiredDuringSchedulingIgnoredDuringExecution  NodeèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æŒ‡å®šçš„æ‰€æœ‰è§„åˆ™æ‰å¯ä»¥ï¼Œç›¸å½“äºç¡¬é™åˆ¶
    nodeSelectorTerms  èŠ‚ç‚¹é€‰æ‹©åˆ—è¡¨
      matchFields   æŒ‰èŠ‚ç‚¹å­—æ®µåˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨
      matchExpressions   æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
        key    é”®
        values å€¼
        operator å…³ç³»ç¬¦ æ”¯æŒExists, DoesNotExist, In, NotIn, Gt, Lt
  preferredDuringSchedulingIgnoredDuringExecution ä¼˜å…ˆè°ƒåº¦åˆ°æ»¡è¶³æŒ‡å®šçš„è§„åˆ™çš„Nodeï¼Œç›¸å½“äºè½¯é™åˆ¶ (å€¾å‘)
    preference   ä¸€ä¸ªèŠ‚ç‚¹é€‰æ‹©å™¨é¡¹ï¼Œä¸ç›¸åº”çš„æƒé‡ç›¸å…³è”
      matchFields   æŒ‰èŠ‚ç‚¹å­—æ®µåˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨
      matchExpressions   æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
        key    é”®
        values å€¼
        operator å…³ç³»ç¬¦ æ”¯æŒIn, NotIn, Exists, DoesNotExist, Gt, Lt
	weight å€¾å‘æƒé‡ï¼Œåœ¨èŒƒå›´1-100ã€‚
</code></pre>
<pre><code class="language-shell">å…³ç³»ç¬¦çš„ä½¿ç”¨è¯´æ˜:

- matchExpressions:
  - key: nodeenv              # åŒ¹é…å­˜åœ¨æ ‡ç­¾çš„keyä¸ºnodeenvçš„èŠ‚ç‚¹
    operator: Exists
  - key: nodeenv              # åŒ¹é…æ ‡ç­¾çš„keyä¸ºnodeenv,ä¸”valueæ˜¯&quot;xxx&quot;æˆ–&quot;yyy&quot;çš„èŠ‚ç‚¹
    operator: In
    values: [&quot;xxx&quot;,&quot;yyy&quot;]
  - key: nodeenv              # åŒ¹é…æ ‡ç­¾çš„keyä¸ºnodeenv,ä¸”valueå¤§äº&quot;xxx&quot;çš„èŠ‚ç‚¹
    operator: Gt
    values: &quot;xxx&quot;
</code></pre>
<p>æ¥ä¸‹æ¥é¦–å…ˆæ¼”ç¤ºä¸€ä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>åˆ›å»ºpod-nodeaffinity-required.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-nodeaffinity-required
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  affinity:  #äº²å’Œæ€§è®¾ç½®
    nodeAffinity: #è®¾ç½®nodeäº²å’Œæ€§
      requiredDuringSchedulingIgnoredDuringExecution: # ç¡¬é™åˆ¶
        nodeSelectorTerms:
        - matchExpressions: # åŒ¹é…envçš„å€¼åœ¨[&quot;xxx&quot;,&quot;yyy&quot;]ä¸­çš„æ ‡ç­¾
          - key: nodeenv
            operator: In
            values: [&quot;xxx&quot;,&quot;yyy&quot;]
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-nodeaffinity-required.yaml
pod/pod-nodeaffinity-required created

# æŸ¥çœ‹podçŠ¶æ€ ï¼ˆè¿è¡Œå¤±è´¥ï¼‰
[root@k8s-master01 ~]# kubectl get pods pod-nodeaffinity-required -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ...... 
pod-nodeaffinity-required   0/1     Pending   0          16s   &lt;none&gt;   &lt;none&gt;  ......

# æŸ¥çœ‹Podçš„è¯¦æƒ…
# å‘ç°è°ƒåº¦å¤±è´¥ï¼Œæç¤ºnodeé€‰æ‹©å¤±è´¥
[root@k8s-master01 ~]# kubectl describe pod pod-nodeaffinity-required -n dev
......
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn't match node selector.
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn't match node selector.

#æ¥ä¸‹æ¥ï¼Œåœæ­¢pod
[root@k8s-master01 ~]# kubectl delete -f pod-nodeaffinity-required.yaml
pod &quot;pod-nodeaffinity-required&quot; deleted

# ä¿®æ”¹æ–‡ä»¶ï¼Œå°†values: [&quot;xxx&quot;,&quot;yyy&quot;]------&gt; [&quot;pro&quot;,&quot;yyy&quot;]
[root@k8s-master01 ~]# vim pod-nodeaffinity-required.yaml

# å†æ¬¡å¯åŠ¨
[root@k8s-master01 ~]# kubectl create -f pod-nodeaffinity-required.yaml
pod/pod-nodeaffinity-required created

# æ­¤æ—¶æŸ¥çœ‹ï¼Œå‘ç°è°ƒåº¦æˆåŠŸï¼Œå·²ç»å°†podè°ƒåº¦åˆ°äº†node1ä¸Š
[root@k8s-master01 ~]# kubectl get pods pod-nodeaffinity-required -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ...... 
pod-nodeaffinity-required   1/1     Running   0          11s   10.244.1.89   node1 ......
</code></pre>
<p>æ¥ä¸‹æ¥å†æ¼”ç¤ºä¸€ä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>åˆ›å»ºpod-nodeaffinity-preferred.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-nodeaffinity-preferred
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  affinity:  #äº²å’Œæ€§è®¾ç½®
    nodeAffinity: #è®¾ç½®nodeäº²å’Œæ€§
      preferredDuringSchedulingIgnoredDuringExecution: # è½¯é™åˆ¶
      - weight: 1
        preference:
          matchExpressions: # åŒ¹é…envçš„å€¼åœ¨[&quot;xxx&quot;,&quot;yyy&quot;]ä¸­çš„æ ‡ç­¾(å½“å‰ç¯å¢ƒæ²¡æœ‰)
          - key: nodeenv
            operator: In
            values: [&quot;xxx&quot;,&quot;yyy&quot;]
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-nodeaffinity-preferred.yaml
pod/pod-nodeaffinity-preferred created

# æŸ¥çœ‹podçŠ¶æ€ ï¼ˆè¿è¡ŒæˆåŠŸï¼‰
[root@k8s-master01 ~]# kubectl get pod pod-nodeaffinity-preferred -n dev
NAME                         READY   STATUS    RESTARTS   AGE
pod-nodeaffinity-preferred   1/1     Running   0          40s
</code></pre>
<pre><code>NodeAffinityè§„åˆ™è®¾ç½®çš„æ³¨æ„äº‹é¡¹ï¼š
    1 å¦‚æœåŒæ—¶å®šä¹‰äº†nodeSelectorå’ŒnodeAffinityï¼Œé‚£ä¹ˆå¿…é¡»ä¸¤ä¸ªæ¡ä»¶éƒ½å¾—åˆ°æ»¡è¶³ï¼ŒPodæ‰èƒ½è¿è¡Œåœ¨æŒ‡å®šçš„Nodeä¸Š
    2 å¦‚æœnodeAffinityæŒ‡å®šäº†å¤šä¸ªnodeSelectorTermsï¼Œé‚£ä¹ˆåªéœ€è¦å…¶ä¸­ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…æˆåŠŸå³å¯
    3 å¦‚æœä¸€ä¸ªnodeSelectorTermsä¸­æœ‰å¤šä¸ªmatchExpressions ï¼Œåˆ™ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æ‰€æœ‰çš„æ‰èƒ½åŒ¹é…æˆåŠŸ
    4 å¦‚æœä¸€ä¸ªpodæ‰€åœ¨çš„Nodeåœ¨Podè¿è¡ŒæœŸé—´å…¶æ ‡ç­¾å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸å†ç¬¦åˆè¯¥Podçš„èŠ‚ç‚¹äº²å’Œæ€§éœ€æ±‚ï¼Œåˆ™ç³»ç»Ÿå°†å¿½ç•¥æ­¤å˜åŒ–
</code></pre>
<p><strong>PodAffinity</strong></p>
<p>PodAffinityä¸»è¦å®ç°ä»¥è¿è¡Œçš„Podä¸ºå‚ç…§ï¼Œå®ç°è®©æ–°åˆ›å»ºçš„Podè·Ÿå‚ç…§podåœ¨ä¸€ä¸ªåŒºåŸŸçš„åŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹<code>PodAffinity</code>çš„å¯é…ç½®é¡¹ï¼š</p>
<pre><code class="language-shell">pod.spec.affinity.podAffinity
  requiredDuringSchedulingIgnoredDuringExecution  ç¡¬é™åˆ¶
    namespaces       æŒ‡å®šå‚ç…§podçš„namespace
    topologyKey      æŒ‡å®šè°ƒåº¦ä½œç”¨åŸŸ
    labelSelector    æ ‡ç­¾é€‰æ‹©å™¨
      matchExpressions  æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
        key    é”®
        values å€¼
        operator å…³ç³»ç¬¦ æ”¯æŒIn, NotIn, Exists, DoesNotExist.
      matchLabels    æŒ‡å¤šä¸ªmatchExpressionsæ˜ å°„çš„å†…å®¹
  preferredDuringSchedulingIgnoredDuringExecution è½¯é™åˆ¶
    podAffinityTerm  é€‰é¡¹
      namespaces      
      topologyKey
      labelSelector
        matchExpressions  
          key    é”®
          values å€¼
          operator
        matchLabels 
    weight å€¾å‘æƒé‡ï¼Œåœ¨èŒƒå›´1-100
</code></pre>
<pre><code>topologyKeyç”¨äºæŒ‡å®šè°ƒåº¦æ—¶ä½œç”¨åŸŸ,ä¾‹å¦‚:
    å¦‚æœæŒ‡å®šä¸ºkubernetes.io/hostnameï¼Œé‚£å°±æ˜¯ä»¥NodeèŠ‚ç‚¹ä¸ºåŒºåˆ†èŒƒå›´
	å¦‚æœæŒ‡å®šä¸ºbeta.kubernetes.io/os,åˆ™ä»¥NodeèŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿç±»å‹æ¥åŒºåˆ†
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæ¼”ç¤ºä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</p>
<p>1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå‚ç…§Podï¼Œpod-podaffinity-target.yamlï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-podaffinity-target
  namespace: dev
  labels:
    podenv: pro #è®¾ç½®æ ‡ç­¾
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  nodeName: node1 # å°†ç›®æ ‡podåç¡®æŒ‡å®šåˆ°node1ä¸Š
</code></pre>
<pre><code class="language-shell"># å¯åŠ¨ç›®æ ‡pod
[root@k8s-master01 ~]# kubectl create -f pod-podaffinity-target.yaml
pod/pod-podaffinity-target created

# æŸ¥çœ‹podçŠ¶å†µ
[root@k8s-master01 ~]# kubectl get pods  pod-podaffinity-target -n dev
NAME                     READY   STATUS    RESTARTS   AGE
pod-podaffinity-target   1/1     Running   0          4s
</code></pre>
<p>2ï¼‰åˆ›å»ºpod-podaffinity-required.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-podaffinity-required
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  affinity:  #äº²å’Œæ€§è®¾ç½®
    podAffinity: #è®¾ç½®podäº²å’Œæ€§
      requiredDuringSchedulingIgnoredDuringExecution: # ç¡¬é™åˆ¶
      - labelSelector:
          matchExpressions: # åŒ¹é…envçš„å€¼åœ¨[&quot;xxx&quot;,&quot;yyy&quot;]ä¸­çš„æ ‡ç­¾
          - key: podenv
            operator: In
            values: [&quot;xxx&quot;,&quot;yyy&quot;]
        topologyKey: kubernetes.io/hostname
</code></pre>
<p>ä¸Šé¢é…ç½®è¡¨è¾¾çš„æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=xxxæˆ–è€…nodeenv=yyyçš„podåœ¨åŒä¸€Nodeä¸Šï¼Œæ˜¾ç„¶ç°åœ¨æ²¡æœ‰è¿™æ ·podï¼Œæ¥ä¸‹æ¥ï¼Œè¿è¡Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<pre><code class="language-shell"># å¯åŠ¨pod
[root@k8s-master01 ~]# kubectl create -f pod-podaffinity-required.yaml
pod/pod-podaffinity-required created

# æŸ¥çœ‹podçŠ¶æ€ï¼Œå‘ç°æœªè¿è¡Œ
[root@k8s-master01 ~]# kubectl get pods pod-podaffinity-required -n dev
NAME                       READY   STATUS    RESTARTS   AGE
pod-podaffinity-required   0/1     Pending   0          9s

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
[root@k8s-master01 ~]# kubectl describe pods pod-podaffinity-required  -n dev
......
Events:
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 2 node(s) didn't match pod affinity rules, 1 node(s) had taints that the pod didn't tolerate.

# æ¥ä¸‹æ¥ä¿®æ”¹  values: [&quot;xxx&quot;,&quot;yyy&quot;]-----&gt;values:[&quot;pro&quot;,&quot;yyy&quot;]
# æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=xxxæˆ–è€…nodeenv=yyyçš„podåœ¨åŒä¸€Nodeä¸Š
[root@k8s-master01 ~]# vim pod-podaffinity-required.yaml

# ç„¶åé‡æ–°åˆ›å»ºpodï¼ŒæŸ¥çœ‹æ•ˆæœ
[root@k8s-master01 ~]# kubectl delete -f  pod-podaffinity-required.yaml
pod &quot;pod-podaffinity-required&quot; deleted
[root@k8s-master01 ~]# kubectl create -f pod-podaffinity-required.yaml
pod/pod-podaffinity-required created

# å‘ç°æ­¤æ—¶Podè¿è¡Œæ­£å¸¸
[root@k8s-master01 ~]# kubectl get pods pod-podaffinity-required -n dev
NAME                       READY   STATUS    RESTARTS   AGE   LABELS
pod-podaffinity-required   1/1     Running   0          6s    &lt;none&gt;
</code></pre>
<p>å…³äº<code>PodAffinity</code>çš„ <code>preferredDuringSchedulingIgnoredDuringExecution</code>ï¼Œè¿™é‡Œä¸å†æ¼”ç¤ºã€‚</p>
<p><strong>PodAntiAffinity</strong></p>
<p>PodAntiAffinityä¸»è¦å®ç°ä»¥è¿è¡Œçš„Podä¸ºå‚ç…§ï¼Œè®©æ–°åˆ›å»ºçš„Podè·Ÿå‚ç…§podä¸åœ¨ä¸€ä¸ªåŒºåŸŸä¸­çš„åŠŸèƒ½ã€‚</p>
<p>å®ƒçš„é…ç½®æ–¹å¼å’Œé€‰é¡¹è·ŸPodAffintyæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸å†åšè¯¦ç»†è§£é‡Šï¼Œç›´æ¥åšä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ã€‚</p>
<p>1ï¼‰ç»§ç»­ä½¿ç”¨ä¸Šä¸ªæ¡ˆä¾‹ä¸­ç›®æ ‡pod</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl get pods -n dev -o wide --show-labels
NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS
pod-podaffinity-required 1/1     Running   0          3m29s   10.244.1.38   node1   &lt;none&gt;     
pod-podaffinity-target   1/1     Running   0          9m25s   10.244.1.37   node1   podenv=pro
</code></pre>
<p>2ï¼‰åˆ›å»ºpod-podantiaffinity-required.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-podantiaffinity-required
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  affinity:  #äº²å’Œæ€§è®¾ç½®
    podAntiAffinity: #è®¾ç½®podäº²å’Œæ€§
      requiredDuringSchedulingIgnoredDuringExecution: # ç¡¬é™åˆ¶
      - labelSelector:
          matchExpressions: # åŒ¹é…podenvçš„å€¼åœ¨[&quot;pro&quot;]ä¸­çš„æ ‡ç­¾
          - key: podenv
            operator: In
            values: [&quot;pro&quot;]
        topologyKey: kubernetes.io/hostname
</code></pre>
<p>ä¸Šé¢é…ç½®è¡¨è¾¾çš„æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=proçš„podä¸åœ¨åŒä¸€Nodeä¸Šï¼Œè¿è¡Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-podantiaffinity-required.yaml
pod/pod-podantiaffinity-required created

# æŸ¥çœ‹pod
# å‘ç°è°ƒåº¦åˆ°äº†node2ä¸Š
[root@k8s-master01 ~]# kubectl get pods pod-podantiaffinity-required -n dev -o wide
NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. 
pod-podantiaffinity-required   1/1     Running   0          30s   10.244.1.96   node2  ..
</code></pre>
<h3 id="543-æ±¡ç‚¹å’Œå®¹å¿">5.4.3 æ±¡ç‚¹å’Œå®¹å¿</h3>
<p><strong>æ±¡ç‚¹ï¼ˆTaintsï¼‰</strong></p>
<p>å‰é¢çš„è°ƒåº¦æ–¹å¼éƒ½æ˜¯ç«™åœ¨Podçš„è§’åº¦ä¸Šï¼Œé€šè¿‡åœ¨Podä¸Šæ·»åŠ å±æ€§ï¼Œæ¥ç¡®å®šPodæ˜¯å¦è¦è°ƒåº¦åˆ°æŒ‡å®šçš„Nodeä¸Šï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç«™åœ¨Nodeçš„è§’åº¦ä¸Šï¼Œé€šè¿‡åœ¨Nodeä¸Šæ·»åŠ <strong>æ±¡ç‚¹</strong>å±æ€§ï¼Œæ¥å†³å®šæ˜¯å¦å…è®¸Podè°ƒåº¦è¿‡æ¥ã€‚</p>
<p>Nodeè¢«è®¾ç½®ä¸Šæ±¡ç‚¹ä¹‹åå°±å’ŒPodä¹‹é—´å­˜åœ¨äº†ä¸€ç§ç›¸æ–¥çš„å…³ç³»ï¼Œè¿›è€Œæ‹’ç»Podè°ƒåº¦è¿›æ¥ï¼Œç”šè‡³å¯ä»¥å°†å·²ç»å­˜åœ¨çš„Podé©±é€å‡ºå»ã€‚</p>
<p>æ±¡ç‚¹çš„æ ¼å¼ä¸ºï¼š<code>key=value:effect</code>, keyå’Œvalueæ˜¯æ±¡ç‚¹çš„æ ‡ç­¾ï¼Œeffectæè¿°æ±¡ç‚¹çš„ä½œç”¨ï¼Œæ”¯æŒå¦‚ä¸‹ä¸‰ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>PreferNoScheduleï¼škuberneteså°†å°½é‡é¿å…æŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼Œé™¤éæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹å¯è°ƒåº¦</li>
<li>NoScheduleï¼škuberneteså°†ä¸ä¼šæŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼Œä½†ä¸ä¼šå½±å“å½“å‰Nodeä¸Šå·²å­˜åœ¨çš„Pod</li>
<li>NoExecuteï¼škuberneteså°†ä¸ä¼šæŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼ŒåŒæ—¶ä¹Ÿä¼šå°†Nodeä¸Šå·²å­˜åœ¨çš„Podé©±ç¦»</li>
</ul>
<figure data-type="image" tabindex="19"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gzkgqbjj30j8043q3c.jpg" alt="image-20200605021606508" loading="lazy"></figure>
<p>ä½¿ç”¨kubectlè®¾ç½®å’Œå»é™¤æ±¡ç‚¹çš„å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell"># è®¾ç½®æ±¡ç‚¹
kubectl taint nodes node1 key=value:effect

# å»é™¤æ±¡ç‚¹
kubectl taint nodes node1 key:effect-

# å»é™¤æ‰€æœ‰æ±¡ç‚¹
kubectl taint nodes node1 key-
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæ¼”ç¤ºä¸‹æ±¡ç‚¹çš„æ•ˆæœï¼š</p>
<ol>
<li>å‡†å¤‡èŠ‚ç‚¹node1ï¼ˆä¸ºäº†æ¼”ç¤ºæ•ˆæœæ›´åŠ æ˜æ˜¾ï¼Œæš‚æ—¶åœæ­¢node2èŠ‚ç‚¹ï¼‰</li>
<li>ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:PreferNoSchedule</code>ï¼›ç„¶ååˆ›å»ºpod1( pod1 å¯ä»¥ )</li>
<li>ä¿®æ”¹ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:NoSchedule</code>ï¼›ç„¶ååˆ›å»ºpod2( pod1 æ­£å¸¸ pod2 å¤±è´¥ )</li>
<li>ä¿®æ”¹ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:NoExecute</code>ï¼›ç„¶ååˆ›å»ºpod3 ( 3ä¸ªpodéƒ½å¤±è´¥ )</li>
</ol>
<pre><code class="language-shell"># ä¸ºnode1è®¾ç½®æ±¡ç‚¹(PreferNoSchedule)
[root@k8s-master01 ~]# kubectl taint nodes node1 tag=heima:PreferNoSchedule

# åˆ›å»ºpod1
[root@k8s-master01 ~]# kubectl run taint1 --image=nginx:1.17.1 -n dev
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   
taint1-7665f7fd85-574h4   1/1     Running   0          2m24s   10.244.1.59   node1    

# ä¸ºnode1è®¾ç½®æ±¡ç‚¹(å–æ¶ˆPreferNoScheduleï¼Œè®¾ç½®NoSchedule)
[root@k8s-master01 ~]# kubectl taint nodes node1 tag:PreferNoSchedule-
[root@k8s-master01 ~]# kubectl taint nodes node1 tag=heima:NoSchedule

# åˆ›å»ºpod2
[root@k8s-master01 ~]# kubectl run taint2 --image=nginx:1.17.1 -n dev
[root@k8s-master01 ~]# kubectl get pods taint2 -n dev -o wide
NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE
taint1-7665f7fd85-574h4   1/1     Running   0          2m24s   10.244.1.59   node1 
taint2-544694789-6zmlf    0/1     Pending   0          21s     &lt;none&gt;        &lt;none&gt;   

# ä¸ºnode1è®¾ç½®æ±¡ç‚¹(å–æ¶ˆNoScheduleï¼Œè®¾ç½®NoExecute)
[root@k8s-master01 ~]# kubectl taint nodes node1 tag:NoSchedule-
[root@k8s-master01 ~]# kubectl taint nodes node1 tag=heima:NoExecute

# åˆ›å»ºpod3
[root@k8s-master01 ~]# kubectl run taint3 --image=nginx:1.17.1 -n dev
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
taint1-7665f7fd85-htkmp   0/1     Pending   0          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;    
taint2-544694789-bn7wb    0/1     Pending   0          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;     
taint3-6d78dbd749-tktkq   0/1     Pending   0          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;     
</code></pre>
<pre><code>å°æç¤ºï¼š
    ä½¿ç”¨kubeadmæ­å»ºçš„é›†ç¾¤ï¼Œé»˜è®¤å°±ä¼šç»™masterèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹æ ‡è®°,æ‰€ä»¥podå°±ä¸ä¼šè°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Š.
</code></pre>
<p><strong>å®¹å¿ï¼ˆTolerationï¼‰</strong></p>
<p>ä¸Šé¢ä»‹ç»äº†æ±¡ç‚¹çš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨nodeä¸Šæ·»åŠ æ±¡ç‚¹ç”¨äºæ‹’ç»podè°ƒåº¦ä¸Šæ¥ï¼Œä½†æ˜¯å¦‚æœå°±æ˜¯æƒ³å°†ä¸€ä¸ªpodè°ƒåº¦åˆ°ä¸€ä¸ªæœ‰æ±¡ç‚¹çš„nodeä¸Šå»ï¼Œè¿™æ—¶å€™åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±è¦ä½¿ç”¨åˆ°<strong>å®¹å¿</strong>ã€‚</p>
<figure data-type="image" tabindex="20"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gzpiycoj30sb09cwff.jpg" alt="image-20200514095913741" loading="lazy"></figure>
<blockquote>
<p>æ±¡ç‚¹å°±æ˜¯æ‹’ç»ï¼Œå®¹å¿å°±æ˜¯å¿½ç•¥ï¼ŒNodeé€šè¿‡æ±¡ç‚¹æ‹’ç»podè°ƒåº¦ä¸Šå»ï¼ŒPodé€šè¿‡å®¹å¿å¿½ç•¥æ‹’ç»</p>
</blockquote>
<p>ä¸‹é¢å…ˆé€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹çœ‹ä¸‹æ•ˆæœï¼š</p>
<ol>
<li>ä¸Šä¸€å°èŠ‚ï¼Œå·²ç»åœ¨node1èŠ‚ç‚¹ä¸Šæ‰“ä¸Šäº†<code>NoExecute</code>çš„æ±¡ç‚¹ï¼Œæ­¤æ—¶podæ˜¯è°ƒåº¦ä¸ä¸Šå»çš„</li>
<li>æœ¬å°èŠ‚ï¼Œå¯ä»¥é€šè¿‡ç»™podæ·»åŠ å®¹å¿ï¼Œç„¶åå°†å…¶è°ƒåº¦ä¸Šå»</li>
</ol>
<p>åˆ›å»ºpod-toleration.yaml,å†…å®¹å¦‚ä¸‹</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-toleration
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
  tolerations:      # æ·»åŠ å®¹å¿
  - key: &quot;tag&quot;        # è¦å®¹å¿çš„æ±¡ç‚¹çš„key
    operator: &quot;Equal&quot; # æ“ä½œç¬¦
    value: &quot;heima&quot;    # å®¹å¿çš„æ±¡ç‚¹çš„value
    effect: &quot;NoExecute&quot;   # æ·»åŠ å®¹å¿çš„è§„åˆ™ï¼Œè¿™é‡Œå¿…é¡»å’Œæ ‡è®°çš„æ±¡ç‚¹è§„åˆ™ç›¸åŒ
</code></pre>
<pre><code class="language-shell"># æ·»åŠ å®¹å¿ä¹‹å‰çš„pod
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
pod-toleration   0/1     Pending   0          3s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           

# æ·»åŠ å®¹å¿ä¹‹åçš„pod
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED
pod-toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none&gt;        
</code></pre>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹å®¹å¿çš„è¯¦ç»†é…ç½®:</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl explain pod.spec.tolerations
......
FIELDS:
   key       # å¯¹åº”ç€è¦å®¹å¿çš„æ±¡ç‚¹çš„é”®ï¼Œç©ºæ„å‘³ç€åŒ¹é…æ‰€æœ‰çš„é”®
   value     # å¯¹åº”ç€è¦å®¹å¿çš„æ±¡ç‚¹çš„å€¼
   operator  # key-valueçš„è¿ç®—ç¬¦ï¼Œæ”¯æŒEqualå’ŒExistsï¼ˆé»˜è®¤ï¼‰
   effect    # å¯¹åº”æ±¡ç‚¹çš„effectï¼Œç©ºæ„å‘³ç€åŒ¹é…æ‰€æœ‰å½±å“
   tolerationSeconds   # å®¹å¿æ—¶é—´, å½“effectä¸ºNoExecuteæ—¶ç”Ÿæ•ˆï¼Œè¡¨ç¤ºpodåœ¨Nodeä¸Šçš„åœç•™æ—¶é—´
</code></pre>
<h1 id="6-podæ§åˆ¶å™¨è¯¦è§£">6. Podæ§åˆ¶å™¨è¯¦è§£</h1>
<h2 id="61-podæ§åˆ¶å™¨ä»‹ç»">6.1 Podæ§åˆ¶å™¨ä»‹ç»</h2>
<p>Podæ˜¯kubernetesçš„æœ€å°ç®¡ç†å•å…ƒï¼Œåœ¨kubernetesä¸­ï¼ŒæŒ‰ç…§podçš„åˆ›å»ºæ–¹å¼å¯ä»¥å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>è‡ªä¸»å¼podï¼škubernetesç›´æ¥åˆ›å»ºå‡ºæ¥çš„Podï¼Œè¿™ç§podåˆ é™¤åå°±æ²¡æœ‰äº†ï¼Œä¹Ÿä¸ä¼šé‡å»º</li>
<li>æ§åˆ¶å™¨åˆ›å»ºçš„podï¼škubernetesé€šè¿‡æ§åˆ¶å™¨åˆ›å»ºçš„podï¼Œè¿™ç§podåˆ é™¤äº†ä¹‹åè¿˜ä¼šè‡ªåŠ¨é‡å»º</li>
</ul>
<blockquote>
<p><strong><code>ä»€ä¹ˆæ˜¯Podæ§åˆ¶å™¨</code></strong></p>
<p>Podæ§åˆ¶å™¨æ˜¯ç®¡ç†podçš„ä¸­é—´å±‚ï¼Œä½¿ç”¨Podæ§åˆ¶å™¨ä¹‹åï¼Œåªéœ€è¦å‘Šè¯‰Podæ§åˆ¶å™¨ï¼Œæƒ³è¦å¤šå°‘ä¸ªä»€ä¹ˆæ ·çš„Podå°±å¯ä»¥äº†ï¼Œå®ƒä¼šåˆ›å»ºå‡ºæ»¡è¶³æ¡ä»¶çš„Podå¹¶ç¡®ä¿æ¯ä¸€ä¸ªPodèµ„æºå¤„äºç”¨æˆ·æœŸæœ›çš„ç›®æ ‡çŠ¶æ€ã€‚å¦‚æœPodèµ„æºåœ¨è¿è¡Œä¸­å‡ºç°æ•…éšœï¼Œå®ƒä¼šåŸºäºæŒ‡å®šç­–ç•¥é‡æ–°ç¼–æ’Podã€‚</p>
</blockquote>
<p>åœ¨kubernetesä¸­ï¼Œæœ‰å¾ˆå¤šç±»å‹çš„podæ§åˆ¶å™¨ï¼Œæ¯ç§éƒ½æœ‰è‡ªå·±çš„é€‚åˆçš„åœºæ™¯ï¼Œå¸¸è§çš„æœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<ul>
<li>ReplicationControllerï¼šæ¯”è¾ƒåŸå§‹çš„podæ§åˆ¶å™¨ï¼Œå·²ç»è¢«åºŸå¼ƒï¼Œç”±ReplicaSetæ›¿ä»£</li>
<li>ReplicaSetï¼šä¿è¯å‰¯æœ¬æ•°é‡ä¸€ç›´ç»´æŒåœ¨æœŸæœ›å€¼ï¼Œå¹¶æ”¯æŒpodæ•°é‡æ‰©ç¼©å®¹ï¼Œé•œåƒç‰ˆæœ¬å‡çº§</li>
<li>Deploymentï¼šé€šè¿‡æ§åˆ¶ReplicaSetæ¥æ§åˆ¶Podï¼Œå¹¶æ”¯æŒæ»šåŠ¨å‡çº§ã€å›é€€ç‰ˆæœ¬</li>
<li>Horizontal Pod Autoscalerï¼šå¯ä»¥æ ¹æ®é›†ç¾¤è´Ÿè½½è‡ªåŠ¨æ°´å¹³è°ƒæ•´Podçš„æ•°é‡ï¼Œå®ç°å‰Šå³°å¡«è°·</li>
<li>DaemonSetï¼šåœ¨é›†ç¾¤ä¸­çš„æŒ‡å®šNodeä¸Šè¿è¡Œä¸”ä»…è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œä¸€èˆ¬ç”¨äºå®ˆæŠ¤è¿›ç¨‹ç±»çš„ä»»åŠ¡</li>
<li>Jobï¼šå®ƒåˆ›å»ºå‡ºæ¥çš„podåªè¦å®Œæˆä»»åŠ¡å°±ç«‹å³é€€å‡ºï¼Œä¸éœ€è¦é‡å¯æˆ–é‡å»ºï¼Œç”¨äºæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡</li>
<li>Cronjobï¼šå®ƒåˆ›å»ºçš„Podè´Ÿè´£å‘¨æœŸæ€§ä»»åŠ¡æ§åˆ¶ï¼Œä¸éœ€è¦æŒç»­åå°è¿è¡Œ</li>
<li>StatefulSetï¼šç®¡ç†æœ‰çŠ¶æ€åº”ç”¨</li>
</ul>
<h2 id="62-replicasetrs">6.2 ReplicaSet(RS)</h2>
<p>ReplicaSetçš„ä¸»è¦ä½œç”¨æ˜¯<strong>ä¿è¯ä¸€å®šæ•°é‡çš„podæ­£å¸¸è¿è¡Œ</strong>ï¼Œå®ƒä¼šæŒç»­ç›‘å¬è¿™äº›Podçš„è¿è¡ŒçŠ¶æ€ï¼Œä¸€æ—¦Podå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šé‡å¯æˆ–é‡å»ºã€‚åŒæ—¶å®ƒè¿˜æ”¯æŒå¯¹podæ•°é‡çš„æ‰©ç¼©å®¹å’Œé•œåƒç‰ˆæœ¬çš„å‡é™çº§ã€‚</p>
<figure data-type="image" tabindex="21"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gztv5ppj30go055aab.jpg" alt="img" loading="lazy"></figure>
<p>ReplicaSetçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1 # ç‰ˆæœ¬å·
kind: ReplicaSet # ç±»å‹       
metadata: # å…ƒæ•°æ®
  name: # rsåç§° 
  namespace: # æ‰€å±å‘½åç©ºé—´ 
  labels: #æ ‡ç­¾
    controller: rs
spec: # è¯¦æƒ…æè¿°
  replicas: 3 # å‰¯æœ¬æ•°é‡
  selector: # é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod
    matchLabels:      # LabelsåŒ¹é…è§„åˆ™
      app: nginx-pod
    matchExpressions: # ExpressionsåŒ¹é…è§„åˆ™
      - {key: app, operator: In, values: [nginx-pod]}
  template: # æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80
</code></pre>
<p>åœ¨è¿™é‡Œé¢ï¼Œéœ€è¦æ–°äº†è§£çš„é…ç½®é¡¹å°±æ˜¯<code>spec</code>ä¸‹é¢å‡ ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>
<p>replicasï¼šæŒ‡å®šå‰¯æœ¬æ•°é‡ï¼Œå…¶å®å°±æ˜¯å½“å‰rsåˆ›å»ºå‡ºæ¥çš„podçš„æ•°é‡ï¼Œé»˜è®¤ä¸º1</p>
</li>
<li>
<p>selectorï¼šé€‰æ‹©å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å»ºç«‹podæ§åˆ¶å™¨å’Œpodä¹‹é—´çš„å…³è”å…³ç³»ï¼Œé‡‡ç”¨çš„Label Selectoræœºåˆ¶</p>
<p>åœ¨podæ¨¡æ¿ä¸Šå®šä¹‰labelï¼Œåœ¨æ§åˆ¶å™¨ä¸Šå®šä¹‰é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥è¡¨æ˜å½“å‰æ§åˆ¶å™¨èƒ½ç®¡ç†å“ªäº›podäº†</p>
</li>
<li>
<p>templateï¼šæ¨¡æ¿ï¼Œå°±æ˜¯å½“å‰æ§åˆ¶å™¨åˆ›å»ºpodæ‰€ä½¿ç”¨çš„æ¨¡æ¿æ¿ï¼Œé‡Œé¢å…¶å®å°±æ˜¯å‰ä¸€ç« å­¦è¿‡çš„podçš„å®šä¹‰</p>
</li>
</ul>
<p><strong>åˆ›å»ºReplicaSet</strong></p>
<p>åˆ›å»ºpc-replicaset.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: ReplicaSet   
metadata:
  name: pc-replicaset
  namespace: dev
spec:
  replicas: 3
  selector: 
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºrs
[root@k8s-master01 ~]# kubectl create -f pc-replicaset.yaml
replicaset.apps/pc-replicaset created

# æŸ¥çœ‹rs
# DESIRED:æœŸæœ›å‰¯æœ¬æ•°é‡  
# CURRENT:å½“å‰å‰¯æœ¬æ•°é‡  
# READY:å·²ç»å‡†å¤‡å¥½æä¾›æœåŠ¡çš„å‰¯æœ¬æ•°é‡
[root@k8s-master01 ~]# kubectl get rs pc-replicaset -n dev -o wide
NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
pc-replicaset 3         3       3     22s   nginx        nginx:1.17.1       app=nginx-pod

# æŸ¥çœ‹å½“å‰æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„pod
# è¿™é‡Œå‘ç°æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„podçš„åç§°æ˜¯åœ¨æ§åˆ¶å™¨åç§°åé¢æ‹¼æ¥äº†-xxxxxéšæœºç 
[root@k8s-master01 ~]# kubectl get pod -n dev
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   1/1     Running   0          54s
pc-replicaset-fmb8f   1/1     Running   0          54s
pc-replicaset-snrk2   1/1     Running   0          54s
</code></pre>
<p><strong>æ‰©ç¼©å®¹</strong></p>
<pre><code class="language-shell"># ç¼–è¾‘rsçš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹spec:replicas: 6å³å¯
[root@k8s-master01 ~]# kubectl edit rs pc-replicaset -n dev
replicaset.apps/pc-replicaset edited

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   1/1     Running   0          114m
pc-replicaset-cftnp   1/1     Running   0          10s
pc-replicaset-fjlm6   1/1     Running   0          10s
pc-replicaset-fmb8f   1/1     Running   0          114m
pc-replicaset-s2whj   1/1     Running   0          10s
pc-replicaset-snrk2   1/1     Running   0          114m

# å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å®ç°
# ä½¿ç”¨scaleå‘½ä»¤å®ç°æ‰©ç¼©å®¹ï¼Œ åé¢--replicas=nç›´æ¥æŒ‡å®šç›®æ ‡æ•°é‡å³å¯
[root@k8s-master01 ~]# kubectl scale rs pc-replicaset --replicas=2 -n dev
replicaset.apps/pc-replicaset scaled

# å‘½ä»¤è¿è¡Œå®Œæ¯•ï¼Œç«‹å³æŸ¥çœ‹ï¼Œå‘ç°å·²ç»æœ‰4ä¸ªå¼€å§‹å‡†å¤‡é€€å‡ºäº†
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                       READY   STATUS        RESTARTS   AGE
pc-replicaset-6vmvt   0/1     Terminating   0          118m
pc-replicaset-cftnp   0/1     Terminating   0          4m17s
pc-replicaset-fjlm6   0/1     Terminating   0          4m17s
pc-replicaset-fmb8f   1/1     Running       0          118m
pc-replicaset-s2whj   0/1     Terminating   0          4m17s
pc-replicaset-snrk2   1/1     Running       0          118m

#ç¨ç­‰ç‰‡åˆ»ï¼Œå°±åªå‰©ä¸‹2ä¸ªäº†
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                       READY   STATUS    RESTARTS   AGE
pc-replicaset-fmb8f   1/1     Running   0          119m
pc-replicaset-snrk2   1/1     Running   0          119m
</code></pre>
<p><strong>é•œåƒå‡çº§</strong></p>
<pre><code class="language-shell"># ç¼–è¾‘rsçš„å®¹å™¨é•œåƒ - image: nginx:1.17.2
[root@k8s-master01 ~]# kubectl edit rs pc-replicaset -n dev
replicaset.apps/pc-replicaset edited

# å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†
[root@k8s-master01 ~]# kubectl get rs -n dev -o wide
NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...
pc-replicaset       2        2         2       140m   nginx         nginx:1.17.2  ...

# åŒæ ·çš„é“ç†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤å®Œæˆè¿™ä¸ªå·¥ä½œ
# kubectl set image rs rsåç§° å®¹å™¨=é•œåƒç‰ˆæœ¬ -n namespace
[root@k8s-master01 ~]# kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev
replicaset.apps/pc-replicaset image updated

# å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†
[root@k8s-master01 ~]# kubectl get rs -n dev -o wide
NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...
pc-replicaset        2        2         2       145m   nginx        nginx:1.17.1 ... 
</code></pre>
<p><strong>åˆ é™¤ReplicaSet</strong></p>
<pre><code class="language-shell"># ä½¿ç”¨kubectl deleteå‘½ä»¤ä¼šåˆ é™¤æ­¤RSä»¥åŠå®ƒç®¡ç†çš„Pod
# åœ¨kubernetesåˆ é™¤RSå‰ï¼Œä¼šå°†RSçš„replicasclearè°ƒæ•´ä¸º0ï¼Œç­‰å¾…æ‰€æœ‰çš„Podè¢«åˆ é™¤åï¼Œåœ¨æ‰§è¡ŒRSå¯¹è±¡çš„åˆ é™¤
[root@k8s-master01 ~]# kubectl delete rs pc-replicaset -n dev
replicaset.apps &quot;pc-replicaset&quot; deleted
[root@k8s-master01 ~]# kubectl get pod -n dev -o wide
No resources found in dev namespace.

# å¦‚æœå¸Œæœ›ä»…ä»…åˆ é™¤RSå¯¹è±¡ï¼ˆä¿ç•™Podï¼‰ï¼Œå¯ä»¥ä½¿ç”¨kubectl deleteå‘½ä»¤æ—¶æ·»åŠ --cascade=falseé€‰é¡¹ï¼ˆä¸æ¨èï¼‰ã€‚
[root@k8s-master01 ~]# kubectl delete rs pc-replicaset -n dev --cascade=false
replicaset.apps &quot;pc-replicaset&quot; deleted
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                  READY   STATUS    RESTARTS   AGE
pc-replicaset-cl82j   1/1     Running   0          75s
pc-replicaset-dslhb   1/1     Running   0          75s

# ä¹Ÿå¯ä»¥ä½¿ç”¨yamlç›´æ¥åˆ é™¤(æ¨è)
[root@k8s-master01 ~]# kubectl delete -f pc-replicaset.yaml
replicaset.apps &quot;pc-replicaset&quot; deleted
</code></pre>
<h2 id="63-deploymentdeploy">6.3 Deployment(Deploy)</h2>
<p>ä¸ºäº†æ›´å¥½çš„è§£å†³æœåŠ¡ç¼–æ’çš„é—®é¢˜ï¼Œkubernetesåœ¨V1.2ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†Deploymentæ§åˆ¶å™¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§æ§åˆ¶å™¨å¹¶ä¸ç›´æ¥ç®¡ç†podï¼Œè€Œæ˜¯é€šè¿‡ç®¡ç†ReplicaSetæ¥ç®€ä»‹ç®¡ç†Podï¼Œå³ï¼šDeploymentç®¡ç†ReplicaSetï¼ŒReplicaSetç®¡ç†Podã€‚æ‰€ä»¥Deploymentæ¯”ReplicaSetåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚</p>
<figure data-type="image" tabindex="22"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0gzyelmqj30gw05q3yv.jpg" alt="img" loading="lazy"></figure>
<p>Deploymentä¸»è¦åŠŸèƒ½æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>æ”¯æŒReplicaSetçš„æ‰€æœ‰åŠŸèƒ½</li>
<li>æ”¯æŒå‘å¸ƒçš„åœæ­¢ã€ç»§ç»­</li>
<li>æ”¯æŒæ»šåŠ¨å‡çº§å’Œå›æ»šç‰ˆæœ¬</li>
</ul>
<p>Deploymentçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1 # ç‰ˆæœ¬å·
kind: Deployment # ç±»å‹       
metadata: # å…ƒæ•°æ®
  name: # rsåç§° 
  namespace: # æ‰€å±å‘½åç©ºé—´ 
  labels: #æ ‡ç­¾
    controller: deploy
spec: # è¯¦æƒ…æè¿°
  replicas: 3 # å‰¯æœ¬æ•°é‡
  revisionHistoryLimit: 3 # ä¿ç•™å†å²ç‰ˆæœ¬
  paused: false # æš‚åœéƒ¨ç½²ï¼Œé»˜è®¤æ˜¯false
  progressDeadlineSeconds: 600 # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆsï¼‰ï¼Œé»˜è®¤æ˜¯600
  strategy: # ç­–ç•¥
    type: RollingUpdate # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate: # æ»šåŠ¨æ›´æ–°
      maxSurge: 30% # æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°
      maxUnavailable: 30% # æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°
  selector: # é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod
    matchLabels:      # LabelsåŒ¹é…è§„åˆ™
      app: nginx-pod
    matchExpressions: # ExpressionsåŒ¹é…è§„åˆ™
      - {key: app, operator: In, values: [nginx-pod]}
  template: # æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80
</code></pre>
<p><strong>åˆ›å»ºdeployment</strong></p>
<p>åˆ›å»ºpc-deployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment      
metadata:
  name: pc-deployment
  namespace: dev
spec: 
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºdeployment
[root@k8s-master01 ~]# kubectl create -f pc-deployment.yaml --record=true
deployment.apps/pc-deployment created

# æŸ¥çœ‹deployment
# UP-TO-DATE æœ€æ–°ç‰ˆæœ¬çš„podçš„æ•°é‡
# AVAILABLE  å½“å‰å¯ç”¨çš„podçš„æ•°é‡
[root@k8s-master01 ~]# kubectl get deploy pc-deployment -n dev
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
pc-deployment   3/3     3            3           15s

# æŸ¥çœ‹rs
# å‘ç°rsçš„åç§°æ˜¯åœ¨åŸæ¥deploymentçš„åå­—åé¢æ·»åŠ äº†ä¸€ä¸ª10ä½æ•°çš„éšæœºä¸²
[root@k8s-master01 ~]# kubectl get rs -n dev
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   3         3         3       23s

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   1/1     Running   0          107s
pc-deployment-6696798b78-smpvp   1/1     Running   0          107s
pc-deployment-6696798b78-wvjd8   1/1     Running   0          107s
</code></pre>
<p><strong>æ‰©ç¼©å®¹</strong></p>
<pre><code class="language-shell"># å˜æ›´å‰¯æœ¬æ•°é‡ä¸º5ä¸ª
[root@k8s-master01 ~]# kubectl scale deploy pc-deployment --replicas=5  -n dev
deployment.apps/pc-deployment scaled

# æŸ¥çœ‹deployment
[root@k8s-master01 ~]# kubectl get deploy pc-deployment -n dev
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
pc-deployment   5/5     5            5           2m

# æŸ¥çœ‹pod
[root@k8s-master01 ~]#  kubectl get pods -n dev
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   1/1     Running   0          4m19s
pc-deployment-6696798b78-jxmdq   1/1     Running   0          94s
pc-deployment-6696798b78-mktqv   1/1     Running   0          93s
pc-deployment-6696798b78-smpvp   1/1     Running   0          4m19s
pc-deployment-6696798b78-wvjd8   1/1     Running   0          4m19s

# ç¼–è¾‘deploymentçš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹spec:replicas: 4å³å¯
[root@k8s-master01 ~]# kubectl edit deploy pc-deployment -n dev
deployment.apps/pc-deployment edited

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   1/1     Running   0          5m23s
pc-deployment-6696798b78-jxmdq   1/1     Running   0          2m38s
pc-deployment-6696798b78-smpvp   1/1     Running   0          5m23s
pc-deployment-6696798b78-wvjd8   1/1     Running   0          5m23s
</code></pre>
<p><strong>é•œåƒæ›´æ–°</strong></p>
<p>deploymentæ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥:<code>é‡å»ºæ›´æ–°</code>å’Œ<code>æ»šåŠ¨æ›´æ–°</code>,å¯ä»¥é€šè¿‡<code>strategy</code>æŒ‡å®šç­–ç•¥ç±»å‹,æ”¯æŒä¸¤ä¸ªå±æ€§:</p>
<pre><code class="language-yaml">strategyï¼šæŒ‡å®šæ–°çš„Podæ›¿æ¢æ—§çš„Podçš„ç­–ç•¥ï¼Œ æ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
  typeï¼šæŒ‡å®šç­–ç•¥ç±»å‹ï¼Œæ”¯æŒä¸¤ç§ç­–ç•¥
    Recreateï¼šåœ¨åˆ›å»ºå‡ºæ–°çš„Podä¹‹å‰ä¼šå…ˆæ€æ‰æ‰€æœ‰å·²å­˜åœ¨çš„Pod
    RollingUpdateï¼šæ»šåŠ¨æ›´æ–°ï¼Œå°±æ˜¯æ€æ­»ä¸€éƒ¨åˆ†ï¼Œå°±å¯åŠ¨ä¸€éƒ¨åˆ†ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬Pod
  rollingUpdateï¼šå½“typeä¸ºRollingUpdateæ—¶ç”Ÿæ•ˆï¼Œç”¨äºä¸ºRollingUpdateè®¾ç½®å‚æ•°ï¼Œæ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
    maxUnavailableï¼šç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­ä¸å¯ç”¨Podçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º25%ã€‚
    maxSurgeï¼š ç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥è¶…è¿‡æœŸæœ›çš„Podçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º25%ã€‚
</code></pre>
<p>é‡å»ºæ›´æ–°</p>
<ol>
<li>ç¼–è¾‘pc-deployment.yaml,åœ¨specèŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li>
</ol>
<pre><code class="language-yaml">spec:
  strategy: # ç­–ç•¥
    type: Recreate # é‡å»ºæ›´æ–°
</code></pre>
<ol start="2">
<li>åˆ›å»ºdeployè¿›è¡ŒéªŒè¯</li>
</ol>
<pre><code class="language-shell"># å˜æ›´é•œåƒ
[root@k8s-master01 ~]# kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev
deployment.apps/pc-deployment image updated

# è§‚å¯Ÿå‡çº§è¿‡ç¨‹
[root@k8s-master01 ~]#  kubectl get pods -n dev -w
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-5d89bdfbf9-65qcw   1/1     Running   0          31s
pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   0          31s
pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   0          31s

pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   0          41s
pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   0          41s
pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   0          41s

pc-deployment-675d469f8b-grn8z   0/1     Pending       0          0s
pc-deployment-675d469f8b-hbl4v   0/1     Pending       0          0s
pc-deployment-675d469f8b-67nz2   0/1     Pending       0          0s

pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   0          0s
pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   0          0s
pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   0          0s

pc-deployment-675d469f8b-grn8z   1/1     Running             0          1s
pc-deployment-675d469f8b-67nz2   1/1     Running             0          1s
pc-deployment-675d469f8b-hbl4v   1/1     Running             0          2s
</code></pre>
<p>æ»šåŠ¨æ›´æ–°</p>
<ol>
<li>ç¼–è¾‘pc-deployment.yaml,åœ¨specèŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li>
</ol>
<pre><code class="language-yaml">spec:
  strategy: # ç­–ç•¥
    type: RollingUpdate # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate:
      maxSurge: 25% 
      maxUnavailable: 25%
</code></pre>
<ol start="2">
<li>åˆ›å»ºdeployè¿›è¡ŒéªŒè¯</li>
</ol>
<pre><code class="language-shell"># å˜æ›´é•œåƒ
[root@k8s-master01 ~]# kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev 
deployment.apps/pc-deployment image updated

# è§‚å¯Ÿå‡çº§è¿‡ç¨‹
[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME                           READY   STATUS    RESTARTS   AGE
pc-deployment-c848d767-8rbzt   1/1     Running   0          31m
pc-deployment-c848d767-h4p68   1/1     Running   0          31m
pc-deployment-c848d767-hlmz4   1/1     Running   0          31m
pc-deployment-c848d767-rrqcn   1/1     Running   0          31m

pc-deployment-966bf7f44-226rx   0/1     Pending             0          0s
pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   0          0s
pc-deployment-966bf7f44-226rx   1/1     Running             0          1s
pc-deployment-c848d767-h4p68    0/1     Terminating         0          34m

pc-deployment-966bf7f44-cnd44   0/1     Pending             0          0s
pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   0          0s
pc-deployment-966bf7f44-cnd44   1/1     Running             0          2s
pc-deployment-c848d767-hlmz4    0/1     Terminating         0          34m

pc-deployment-966bf7f44-px48p   0/1     Pending             0          0s
pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   0          0s
pc-deployment-966bf7f44-px48p   1/1     Running             0          0s
pc-deployment-c848d767-8rbzt    0/1     Terminating         0          34m

pc-deployment-966bf7f44-dkmqp   0/1     Pending             0          0s
pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   0          0s
pc-deployment-966bf7f44-dkmqp   1/1     Running             0          2s
pc-deployment-c848d767-rrqcn    0/1     Terminating         0          34m

# è‡³æ­¤ï¼Œæ–°ç‰ˆæœ¬çš„podåˆ›å»ºå®Œæ¯•ï¼Œå°±ç‰ˆæœ¬çš„podé”€æ¯å®Œæ¯•
# ä¸­é—´è¿‡ç¨‹æ˜¯æ»šåŠ¨è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¾¹é”€æ¯è¾¹åˆ›å»º
</code></pre>
<p>æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ï¼š</p>
<figure data-type="image" tabindex="23"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h04059vj30v20enju0.jpg" alt="img" loading="lazy"></figure>
<p>é•œåƒæ›´æ–°ä¸­rsçš„å˜åŒ–</p>
<pre><code class="language-shell"># æŸ¥çœ‹rs,å‘ç°åŸæ¥çš„rsçš„ä¾æ—§å­˜åœ¨ï¼Œåªæ˜¯podæ•°é‡å˜ä¸ºäº†0ï¼Œè€Œååˆæ–°äº§ç”Ÿäº†ä¸€ä¸ªrsï¼Œpodæ•°é‡ä¸º4
# å…¶å®è¿™å°±æ˜¯deploymentèƒ½å¤Ÿè¿›è¡Œç‰ˆæœ¬å›é€€çš„å¥¥å¦™æ‰€åœ¨ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Š
[root@k8s-master01 ~]# kubectl get rs -n dev
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   0         0         0       7m37s
pc-deployment-6696798b11   0         0         0       5m37s
pc-deployment-c848d76789   4         4         4       72s
</code></pre>
<p><strong>ç‰ˆæœ¬å›é€€</strong></p>
<p>deploymentæ”¯æŒç‰ˆæœ¬å‡çº§è¿‡ç¨‹ä¸­çš„æš‚åœã€ç»§ç»­åŠŸèƒ½ä»¥åŠç‰ˆæœ¬å›é€€ç­‰è¯¸å¤šåŠŸèƒ½ï¼Œä¸‹é¢å…·ä½“æ¥çœ‹.</p>
<p>kubectl rolloutï¼š ç‰ˆæœ¬å‡çº§ç›¸å…³åŠŸèƒ½ï¼Œæ”¯æŒä¸‹é¢çš„é€‰é¡¹ï¼š</p>
<ul>
<li>status æ˜¾ç¤ºå½“å‰å‡çº§çŠ¶æ€</li>
<li>history æ˜¾ç¤º å‡çº§å†å²è®°å½•</li>
<li>pause æš‚åœç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>resume ç»§ç»­å·²ç»æš‚åœçš„ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>restart é‡å¯ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>undo å›æ»šåˆ°ä¸Šä¸€çº§ç‰ˆæœ¬ï¼ˆå¯ä»¥ä½¿ç”¨--to-revisionå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼‰</li>
</ul>
<pre><code class="language-shell"># æŸ¥çœ‹å½“å‰å‡çº§ç‰ˆæœ¬çš„çŠ¶æ€
[root@k8s-master01 ~]# kubectl rollout status deploy pc-deployment -n dev
deployment &quot;pc-deployment&quot; successfully rolled out

# æŸ¥çœ‹å‡çº§å†å²è®°å½•
[root@k8s-master01 ~]# kubectl rollout history deploy pc-deployment -n dev
deployment.apps/pc-deployment
REVISION  CHANGE-CAUSE
1         kubectl create --filename=pc-deployment.yaml --record=true
2         kubectl create --filename=pc-deployment.yaml --record=true
3         kubectl create --filename=pc-deployment.yaml --record=true
# å¯ä»¥å‘ç°æœ‰ä¸‰æ¬¡ç‰ˆæœ¬è®°å½•ï¼Œè¯´æ˜å®Œæˆè¿‡ä¸¤æ¬¡å‡çº§

# ç‰ˆæœ¬å›æ»š
# è¿™é‡Œç›´æ¥ä½¿ç”¨--to-revision=1å›æ»šåˆ°äº†1ç‰ˆæœ¬ï¼Œ å¦‚æœçœç•¥è¿™ä¸ªé€‰é¡¹ï¼Œå°±æ˜¯å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯2ç‰ˆæœ¬
[root@k8s-master01 ~]# kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev
deployment.apps/pc-deployment rolled back

# æŸ¥çœ‹å‘ç°ï¼Œé€šè¿‡nginxé•œåƒç‰ˆæœ¬å¯ä»¥å‘ç°åˆ°äº†ç¬¬ä¸€ç‰ˆ
[root@k8s-master01 ~]# kubectl get deploy -n dev -o wide
NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-deployment   4/4     4            4           74m   nginx        nginx:1.17.1   

# æŸ¥çœ‹rsï¼Œå‘ç°ç¬¬ä¸€ä¸ªrsä¸­æœ‰4ä¸ªpodè¿è¡Œï¼Œåé¢ä¸¤ä¸ªç‰ˆæœ¬çš„rsä¸­podä¸ºè¿è¡Œ
# å…¶å®deploymentä¹‹æ‰€ä»¥å¯æ˜¯å®ç°ç‰ˆæœ¬çš„å›æ»šï¼Œå°±æ˜¯é€šè¿‡è®°å½•ä¸‹å†å²rsæ¥å®ç°çš„ï¼Œ
# ä¸€æ—¦æƒ³å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬ï¼Œåªéœ€è¦å°†å½“å‰ç‰ˆæœ¬podæ•°é‡é™ä¸º0ï¼Œç„¶åå°†å›æ»šç‰ˆæœ¬çš„podæå‡ä¸ºç›®æ ‡æ•°é‡å°±å¯ä»¥äº†
[root@k8s-master01 ~]# kubectl get rs -n dev
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   4         4         4       78m
pc-deployment-966bf7f44    0         0         0       37m
pc-deployment-c848d767     0         0         0       71m
</code></pre>
<p><strong>é‡‘ä¸é›€å‘å¸ƒ</strong></p>
<p>Deploymentæ§åˆ¶å™¨æ”¯æŒæ§åˆ¶æ›´æ–°è¿‡ç¨‹ä¸­çš„æ§åˆ¶ï¼Œå¦‚â€œæš‚åœ(pause)â€æˆ–â€œç»§ç»­(resume)â€æ›´æ–°æ“ä½œã€‚</p>
<p>æ¯”å¦‚æœ‰ä¸€æ‰¹æ–°çš„Podèµ„æºåˆ›å»ºå®Œæˆåç«‹å³æš‚åœæ›´æ–°è¿‡ç¨‹ï¼Œæ­¤æ—¶ï¼Œä»…å­˜åœ¨ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œä¸»ä½“éƒ¨åˆ†è¿˜æ˜¯æ—§çš„ç‰ˆæœ¬ã€‚ç„¶åï¼Œå†ç­›é€‰ä¸€å°éƒ¨åˆ†çš„ç”¨æˆ·è¯·æ±‚è·¯ç”±åˆ°æ–°ç‰ˆæœ¬çš„Podåº”ç”¨ï¼Œç»§ç»­è§‚å¯Ÿèƒ½å¦ç¨³å®šåœ°æŒ‰æœŸæœ›çš„æ–¹å¼è¿è¡Œã€‚ç¡®å®šæ²¡é—®é¢˜ä¹‹åå†ç»§ç»­å®Œæˆä½™ä¸‹çš„Podèµ„æºæ»šåŠ¨æ›´æ–°ï¼Œå¦åˆ™ç«‹å³å›æ»šæ›´æ–°æ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„é‡‘ä¸é›€å‘å¸ƒã€‚</p>
<pre><code class="language-shell"># æ›´æ–°deploymentçš„ç‰ˆæœ¬ï¼Œå¹¶é…ç½®æš‚åœdeployment
[root@k8s-master01 ~]#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev
deployment.apps/pc-deployment image updated
deployment.apps/pc-deployment paused

#è§‚å¯Ÿæ›´æ–°çŠ¶æ€
[root@k8s-master01 ~]# kubectl rollout status deploy pc-deployment -n devã€€
Waiting for deployment &quot;pc-deployment&quot; rollout to finish: 2 out of 4 new replicas have been updated...

# ç›‘æ§æ›´æ–°çš„è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ–°å¢äº†ä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¹¶æœªæŒ‰ç…§é¢„æœŸçš„çŠ¶æ€å»åˆ é™¤ä¸€ä¸ªæ—§çš„èµ„æºï¼Œå°±æ˜¯å› ä¸ºä½¿ç”¨äº†pauseæš‚åœå‘½ä»¤

[root@k8s-master01 ~]# kubectl get rs -n dev -o wide
NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
pc-deployment-5d89bdfbf9   3         3         3       19m     nginx        nginx:1.17.1   
pc-deployment-675d469f8b   0         0         0       14m     nginx        nginx:1.17.2   
pc-deployment-6c9f56fcfb   2         2         2       3m16s   nginx        nginx:1.17.4   
[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   0          7m33s
pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   0          7m35s
pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   0          7m34s
pc-deployment-6c9f56fcfb-996rt   1/1     Running   0          3m31s
pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   0          3m31s

# ç¡®ä¿æ›´æ–°çš„podæ²¡é—®é¢˜äº†ï¼Œç»§ç»­æ›´æ–°
[root@k8s-master01 ~]# kubectl rollout resume deploy pc-deployment -n dev
deployment.apps/pc-deployment resumed

# æŸ¥çœ‹æœ€åçš„æ›´æ–°æƒ…å†µ
[root@k8s-master01 ~]# kubectl get rs -n dev -o wide
NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
pc-deployment-5d89bdfbf9   0         0         0       21m     nginx        nginx:1.17.1   
pc-deployment-675d469f8b   0         0         0       16m     nginx        nginx:1.17.2   
pc-deployment-6c9f56fcfb   4         4         4       5m11s   nginx        nginx:1.17.4   

[root@k8s-master01 ~]# kubectl get pods -n dev
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   0          37s
pc-deployment-6c9f56fcfb-996rt   1/1     Running   0          5m27s
pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   0          5m27s
pc-deployment-6c9f56fcfb-rf84v   1/1     Running   0          37s
</code></pre>
<p><strong>åˆ é™¤Deployment</strong></p>
<pre><code class="language-shell"># åˆ é™¤deploymentï¼Œå…¶ä¸‹çš„rså’Œpodä¹Ÿå°†è¢«åˆ é™¤
[root@k8s-master01 ~]# kubectl delete -f pc-deployment.yaml
deployment.apps &quot;pc-deployment&quot; deleted
</code></pre>
<h2 id="64-horizontal-pod-autoscalerhpa">6.4 Horizontal Pod Autoscaler(HPA)</h2>
<p>åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°é€šè¿‡æ‰‹å·¥æ‰§è¡Œ<code>kubectl scale</code>å‘½ä»¤å®ç°Podæ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯è¿™æ˜¾ç„¶ä¸ç¬¦åˆKubernetesçš„å®šä½ç›®æ ‡--è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€‚ KubernetesæœŸæœ›å¯ä»¥å®ç°é€šè¿‡ç›‘æµ‹Podçš„ä½¿ç”¨æƒ…å†µï¼Œå®ç°podæ•°é‡çš„è‡ªåŠ¨è°ƒæ•´ï¼Œäºæ˜¯å°±äº§ç”Ÿäº†Horizontal Pod Autoscalerï¼ˆHPAï¼‰è¿™ç§æ§åˆ¶å™¨ã€‚</p>
<p>HPAå¯ä»¥è·å–æ¯ä¸ªPodåˆ©ç”¨ç‡ï¼Œç„¶åå’ŒHPAä¸­å®šä¹‰çš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”ï¼ŒåŒæ—¶è®¡ç®—å‡ºéœ€è¦ä¼¸ç¼©çš„å…·ä½“å€¼ï¼Œæœ€åå®ç°Podçš„æ•°é‡çš„è°ƒæ•´ã€‚å…¶å®HPAä¸ä¹‹å‰çš„Deploymentä¸€æ ·ï¼Œä¹Ÿå±äºä¸€ç§Kubernetesèµ„æºå¯¹è±¡ï¼Œå®ƒé€šè¿‡è¿½è¸ªåˆ†æRCæ§åˆ¶çš„æ‰€æœ‰ç›®æ ‡Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦é’ˆå¯¹æ€§åœ°è°ƒæ•´ç›®æ ‡Podçš„å‰¯æœ¬æ•°ï¼Œè¿™æ˜¯HPAçš„å®ç°åŸç†ã€‚</p>
<figure data-type="image" tabindex="24"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h08uypfj30ha0ae3z2.jpg" alt="img" loading="lazy"></figure>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªå®éªŒ</p>
<p><strong>1 å®‰è£…metrics-server</strong></p>
<p>metrics-serverå¯ä»¥ç”¨æ¥æ”¶é›†é›†ç¾¤ä¸­çš„èµ„æºä½¿ç”¨æƒ…å†µ</p>
<pre><code class="language-shell"># å®‰è£…git
[root@k8s-master01 ~]# yum install git -y
# è·å–metrics-server, æ³¨æ„ä½¿ç”¨çš„ç‰ˆæœ¬
[root@k8s-master01 ~]# git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server
# ä¿®æ”¹deployment, æ³¨æ„ä¿®æ”¹çš„æ˜¯é•œåƒå’Œåˆå§‹åŒ–å‚æ•°
[root@k8s-master01 ~]# cd /root/metrics-server/deploy/1.8+/
[root@k8s-master01 1.8+]# vim metrics-server-deployment.yaml
æŒ‰å›¾ä¸­æ·»åŠ ä¸‹é¢é€‰é¡¹
hostNetwork: true
image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6
args:
- --kubelet-insecure-tls
- --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</code></pre>
<figure data-type="image" tabindex="25"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h0dzzk2j314i0bmjv0.jpg" alt="image-20200608163326496" loading="lazy"></figure>
<pre><code class="language-shell"># å®‰è£…metrics-server
[root@k8s-master01 1.8+]# kubectl apply -f ./

# æŸ¥çœ‹podè¿è¡Œæƒ…å†µ
[root@k8s-master01 1.8+]# kubectl get pod -n kube-system
metrics-server-6b976979db-2xwbj   1/1     Running   0          90s

# ä½¿ç”¨kubectl top node æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
[root@k8s-master01 1.8+]# kubectl top node
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
k8s-master01   289m         14%    1582Mi          54%       
k8s-node01     81m          4%     1195Mi          40%       
k8s-node02     72m          3%     1211Mi          41%  
[root@k8s-master01 1.8+]# kubectl top pod -n kube-system
NAME                              CPU(cores)   MEMORY(bytes)
coredns-6955765f44-7ptsb          3m           9Mi
coredns-6955765f44-vcwr5          3m           8Mi
etcd-master                       14m          145Mi
...
# è‡³æ­¤,metrics-serverå®‰è£…å®Œæˆ
</code></pre>
<p><strong>2 å‡†å¤‡deploymentå’Œservie</strong></p>
<p>åˆ›å»ºpc-hpa-pod.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: dev
spec:
  strategy: # ç­–ç•¥
    type: RollingUpdate # æ»šåŠ¨æ›´æ–°ç­–ç•¥
  replicas: 1
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        resources: # èµ„æºé…é¢
          limits:  # é™åˆ¶èµ„æºï¼ˆä¸Šé™ï¼‰
            cpu: &quot;1&quot; # CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°
          requests: # è¯·æ±‚èµ„æºï¼ˆä¸‹é™ï¼‰
            cpu: &quot;100m&quot;  # CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºservice
[root@k8s-master01 1.8+]# kubectl expose deployment nginx --type=NodePort --port=80 -n dev
</code></pre>
<pre><code class="language-shell"># æŸ¥çœ‹
[root@k8s-master01 1.8+]# kubectl get deployment,pod,svc -n dev
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   1/1     1            1           47s

NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7df9756ccc-bh8dr   1/1     Running   0          47s

NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s
</code></pre>
<p><strong>3 éƒ¨ç½²HPA</strong></p>
<p>åˆ›å»ºpc-hpa.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: pc-hpa
  namespace: dev
spec:
  minReplicas: 1  #æœ€å°podæ•°é‡
  maxReplicas: 10 #æœ€å¤§podæ•°é‡
  targetCPUUtilizationPercentage: 3 # CPUä½¿ç”¨ç‡æŒ‡æ ‡
  scaleTargetRef:   # æŒ‡å®šè¦æ§åˆ¶çš„nginxä¿¡æ¯
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºhpa
[root@k8s-master01 1.8+]# kubectl create -f pc-hpa.yaml
horizontalpodautoscaler.autoscaling/pc-hpa created

# æŸ¥çœ‹hpa
    [root@k8s-master01 1.8+]# kubectl get hpa -n dev
NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
pc-hpa   Deployment/nginx   0%/3%     1         10        1          62s
</code></pre>
<p><strong>4 æµ‹è¯•</strong></p>
<p>ä½¿ç”¨å‹æµ‹å·¥å…·å¯¹serviceåœ°å€<code>192.168.5.4:31830</code>è¿›è¡Œå‹æµ‹ï¼Œç„¶åé€šè¿‡æ§åˆ¶å°æŸ¥çœ‹hpaå’Œpodçš„å˜åŒ–</p>
<p>hpaå˜åŒ–</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl get hpa -n dev -w
NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
pc-hpa  Deployment/nginx  0%/3%   1     10     1      4m11s
pc-hpa  Deployment/nginx  0%/3%   1     10     1      5m19s
pc-hpa  Deployment/nginx  22%/3%   1     10     1      6m50s
pc-hpa  Deployment/nginx  22%/3%   1     10     4      7m5s
pc-hpa  Deployment/nginx  22%/3%   1     10     8      7m21s
pc-hpa  Deployment/nginx  6%/3%   1     10     8      7m51s
pc-hpa  Deployment/nginx  0%/3%   1     10     8      9m6s
pc-hpa  Deployment/nginx  0%/3%   1     10     8      13m
pc-hpa  Deployment/nginx  0%/3%   1     10     1      14m
</code></pre>
<p>deploymentå˜åŒ–</p>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl get deployment -n dev -w
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   1/1     1            1           11m
nginx   1/4     1            1           13m
nginx   1/4     1            1           13m
nginx   1/4     1            1           13m
nginx   1/4     4            1           13m
nginx   1/8     4            1           14m
nginx   1/8     4            1           14m
nginx   1/8     4            1           14m
nginx   1/8     8            1           14m
nginx   2/8     8            2           14m
nginx   3/8     8            3           14m
nginx   4/8     8            4           14m
nginx   5/8     8            5           14m
nginx   6/8     8            6           14m
nginx   7/8     8            7           14m
nginx   8/8     8            8           15m
nginx   8/1     8            8           20m
nginx   8/1     8            8           20m
nginx   1/1     1            1           20m
</code></pre>
<p>podå˜åŒ–</p>
<pre><code>[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7df9756ccc-bh8dr   1/1     Running   0          11m
nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s
nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s
nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s
nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     Pending             0          0s
nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s
nginx-7df9756ccc-fgst7   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   1/1     Running             0          19s
nginx-7df9756ccc-rr9bn   1/1     Running             0          30s
nginx-7df9756ccc-m9gsj   1/1     Running             0          21s
nginx-7df9756ccc-cpgrv   1/1     Running             0          47s
nginx-7df9756ccc-sl9c6   1/1     Running             0          33s
nginx-7df9756ccc-g56qb   1/1     Running             0          48s
nginx-7df9756ccc-fgst7   1/1     Running             0          66s
nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s
nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s
nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s
nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s
nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s
nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s
nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s
</code></pre>
<h2 id="65-daemonsetds">6.5 DaemonSet(DS)</h2>
<p>DaemonSetç±»å‹çš„æ§åˆ¶å™¨å¯ä»¥ä¿è¯åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸€å°ï¼ˆæˆ–æŒ‡å®šï¼‰èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ªå‰¯æœ¬ã€‚ä¸€èˆ¬é€‚ç”¨äºæ—¥å¿—æ”¶é›†ã€èŠ‚ç‚¹ç›‘æ§ç­‰åœºæ™¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªPodæä¾›çš„åŠŸèƒ½æ˜¯èŠ‚ç‚¹çº§åˆ«çš„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ä¸”åªéœ€è¦ä¸€ä¸ªï¼‰ï¼Œé‚£ä¹ˆè¿™ç±»Podå°±é€‚åˆä½¿ç”¨DaemonSetç±»å‹çš„æ§åˆ¶å™¨åˆ›å»ºã€‚</p>
<figure data-type="image" tabindex="26"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h0kzoppj30j107fmxu.jpg" alt="img" loading="lazy"></figure>
<p>DaemonSetæ§åˆ¶å™¨çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯å½“å‘é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒæŒ‡å®šçš„ Pod å‰¯æœ¬ä¹Ÿå°†æ·»åŠ åˆ°è¯¥èŠ‚ç‚¹ä¸Š</li>
<li>å½“èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤æ—¶ï¼ŒPod ä¹Ÿå°±è¢«åƒåœ¾å›æ”¶äº†</li>
</ul>
<p>ä¸‹é¢å…ˆæ¥çœ‹ä¸‹DaemonSetçš„èµ„æºæ¸…å•æ–‡ä»¶</p>
<pre><code class="language-yaml">apiVersion: apps/v1 # ç‰ˆæœ¬å·
kind: DaemonSet # ç±»å‹       
metadata: # å…ƒæ•°æ®
  name: # rsåç§° 
  namespace: # æ‰€å±å‘½åç©ºé—´ 
  labels: #æ ‡ç­¾
    controller: daemonset
spec: # è¯¦æƒ…æè¿°
  revisionHistoryLimit: 3 # ä¿ç•™å†å²ç‰ˆæœ¬
  updateStrategy: # æ›´æ–°ç­–ç•¥
    type: RollingUpdate # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate: # æ»šåŠ¨æ›´æ–°
      maxUnavailable: 1 # æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°
  selector: # é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod
    matchLabels:      # LabelsåŒ¹é…è§„åˆ™
      app: nginx-pod
    matchExpressions: # ExpressionsåŒ¹é…è§„åˆ™
      - {key: app, operator: In, values: [nginx-pod]}
  template: # æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80
</code></pre>
<p>åˆ›å»ºpc-daemonset.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: DaemonSet      
metadata:
  name: pc-daemonset
  namespace: dev
spec: 
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºdaemonset
[root@k8s-master01 ~]# kubectl create -f  pc-daemonset.yaml
daemonset.apps/pc-daemonset created

# æŸ¥çœ‹daemonset
[root@k8s-master01 ~]#  kubectl get ds -n dev -o wide
NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-daemonset   2        2        2      2           2        24s   nginx        nginx:1.17.1   

# æŸ¥çœ‹pod,å‘ç°åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œä¸€ä¸ªpod
[root@k8s-master01 ~]#  kubectl get pods -n dev -o wide
NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
pc-daemonset-9bck8   1/1     Running   0          37s   10.244.1.43   node1     
pc-daemonset-k224w   1/1     Running   0          37s   10.244.2.74   node2      

# åˆ é™¤daemonset
[root@k8s-master01 ~]# kubectl delete -f pc-daemonset.yaml
daemonset.apps &quot;pc-daemonset&quot; deleted
</code></pre>
<h2 id="66-job">6.6 Job</h2>
<p>Jobï¼Œä¸»è¦ç”¨äºè´Ÿè´£**æ‰¹é‡å¤„ç†(ä¸€æ¬¡è¦å¤„ç†æŒ‡å®šæ•°é‡ä»»åŠ¡)<strong>çŸ­æš‚çš„</strong>ä¸€æ¬¡æ€§(æ¯ä¸ªä»»åŠ¡ä»…è¿è¡Œä¸€æ¬¡å°±ç»“æŸ)**ä»»åŠ¡ã€‚Jobç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“Jobåˆ›å»ºçš„podæ‰§è¡ŒæˆåŠŸç»“æŸæ—¶ï¼ŒJobå°†è®°å½•æˆåŠŸç»“æŸçš„podæ•°é‡</li>
<li>å½“æˆåŠŸç»“æŸçš„podè¾¾åˆ°æŒ‡å®šçš„æ•°é‡æ—¶ï¼ŒJobå°†å®Œæˆæ‰§è¡Œ</li>
</ul>
<figure data-type="image" tabindex="27"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h0p7fasj30m9072aah.jpg" alt="img" loading="lazy"></figure>
<p>Jobçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">apiVersion: batch/v1 # ç‰ˆæœ¬å·
kind: Job # ç±»å‹       
metadata: # å…ƒæ•°æ®
  name: # rsåç§° 
  namespace: # æ‰€å±å‘½åç©ºé—´ 
  labels: #æ ‡ç­¾
    controller: job
spec: # è¯¦æƒ…æè¿°
  completions: 1 # æŒ‡å®šjobéœ€è¦æˆåŠŸè¿è¡ŒPodsçš„æ¬¡æ•°ã€‚é»˜è®¤å€¼: 1
  parallelism: 1 # æŒ‡å®šjobåœ¨ä»»ä¸€æ—¶åˆ»åº”è¯¥å¹¶å‘è¿è¡ŒPodsçš„æ•°é‡ã€‚é»˜è®¤å€¼: 1
  activeDeadlineSeconds: 30 # æŒ‡å®šjobå¯è¿è¡Œçš„æ—¶é—´æœŸé™ï¼Œè¶…è¿‡æ—¶é—´è¿˜æœªç»“æŸï¼Œç³»ç»Ÿå°†ä¼šå°è¯•è¿›è¡Œç»ˆæ­¢ã€‚
  backoffLimit: 6 # æŒ‡å®šjobå¤±è´¥åè¿›è¡Œé‡è¯•çš„æ¬¡æ•°ã€‚é»˜è®¤æ˜¯6
  manualSelector: true # æ˜¯å¦å¯ä»¥ä½¿ç”¨selectoré€‰æ‹©å™¨é€‰æ‹©podï¼Œé»˜è®¤æ˜¯false
  selector: # é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod
    matchLabels:      # LabelsåŒ¹é…è§„åˆ™
      app: counter-pod
    matchExpressions: # ExpressionsåŒ¹é…è§„åˆ™
      - {key: app, operator: In, values: [counter-pod]}
  template: # æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬
    metadata:
      labels:
        app: counter-pod
    spec:
      restartPolicy: Never # é‡å¯ç­–ç•¥åªèƒ½è®¾ç½®ä¸ºNeveræˆ–è€…OnFailure
      containers:
      - name: counter
        image: busybox:1.30
        command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;]
</code></pre>
<pre><code>å…³äºé‡å¯ç­–ç•¥è®¾ç½®çš„è¯´æ˜ï¼š
    å¦‚æœæŒ‡å®šä¸ºOnFailureï¼Œåˆ™jobä¼šåœ¨podå‡ºç°æ•…éšœæ—¶é‡å¯å®¹å™¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºpodï¼Œfailedæ¬¡æ•°ä¸å˜
    å¦‚æœæŒ‡å®šä¸ºNeverï¼Œåˆ™jobä¼šåœ¨podå‡ºç°æ•…éšœæ—¶åˆ›å»ºæ–°çš„podï¼Œå¹¶ä¸”æ•…éšœpodä¸ä¼šæ¶ˆå¤±ï¼Œä¹Ÿä¸ä¼šé‡å¯ï¼Œfailedæ¬¡æ•°åŠ 1
    å¦‚æœæŒ‡å®šä¸ºAlwaysçš„è¯ï¼Œå°±æ„å‘³ç€ä¸€ç›´é‡å¯ï¼Œæ„å‘³ç€jobä»»åŠ¡ä¼šé‡å¤å»æ‰§è¡Œäº†ï¼Œå½“ç„¶ä¸å¯¹ï¼Œæ‰€ä»¥ä¸èƒ½è®¾ç½®ä¸ºAlways
</code></pre>
<p>åˆ›å»ºpc-job.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: batch/v1
kind: Job      
metadata:
  name: pc-job
  namespace: dev
spec:
  manualSelector: true
  selector:
    matchLabels:
      app: counter-pod
  template:
    metadata:
      labels:
        app: counter-pod
    spec:
      restartPolicy: Never
      containers:
      - name: counter
        image: busybox:1.30
        command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;]
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºjob
[root@k8s-master01 ~]# kubectl create -f pc-job.yaml
job.batch/pc-job created

# æŸ¥çœ‹job
[root@k8s-master01 ~]# kubectl get job -n dev -o wide  -w
NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
pc-job   0/1           21s        21s   counter      busybox:1.30   app=counter-pod
pc-job   1/1           31s        79s   counter      busybox:1.30   app=counter-pod

# é€šè¿‡è§‚å¯ŸpodçŠ¶æ€å¯ä»¥çœ‹åˆ°ï¼Œpodåœ¨è¿è¡Œå®Œæ¯•ä»»åŠ¡åï¼Œå°±ä¼šå˜æˆCompletedçŠ¶æ€
[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME           READY   STATUS     RESTARTS      AGE
pc-job-rxg96   1/1     Running     0            29s
pc-job-rxg96   0/1     Completed   0            33s

# æ¥ä¸‹æ¥ï¼Œè°ƒæ•´ä¸‹podè¿è¡Œçš„æ€»æ•°é‡å’Œå¹¶è¡Œæ•°é‡ å³ï¼šåœ¨specä¸‹è®¾ç½®ä¸‹é¢ä¸¤ä¸ªé€‰é¡¹
#  completions: 6 # æŒ‡å®šjobéœ€è¦æˆåŠŸè¿è¡ŒPodsçš„æ¬¡æ•°ä¸º6
#  parallelism: 3 # æŒ‡å®šjobå¹¶å‘è¿è¡ŒPodsçš„æ•°é‡ä¸º3
#  ç„¶åé‡æ–°è¿è¡Œjobï¼Œè§‚å¯Ÿæ•ˆæœï¼Œæ­¤æ—¶ä¼šå‘ç°ï¼Œjobä¼šæ¯æ¬¡è¿è¡Œ3ä¸ªpodï¼Œæ€»å…±æ‰§è¡Œäº†6ä¸ªpod
[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME           READY   STATUS    RESTARTS   AGE
pc-job-684ft   1/1     Running   0          5s
pc-job-jhj49   1/1     Running   0          5s
pc-job-pfcvh   1/1     Running   0          5s
pc-job-684ft   0/1     Completed   0          11s
pc-job-v7rhr   0/1     Pending     0          0s
pc-job-v7rhr   0/1     Pending     0          0s
pc-job-v7rhr   0/1     ContainerCreating   0          0s
pc-job-jhj49   0/1     Completed           0          11s
pc-job-fhwf7   0/1     Pending             0          0s
pc-job-fhwf7   0/1     Pending             0          0s
pc-job-pfcvh   0/1     Completed           0          11s
pc-job-5vg2j   0/1     Pending             0          0s
pc-job-fhwf7   0/1     ContainerCreating   0          0s
pc-job-5vg2j   0/1     Pending             0          0s
pc-job-5vg2j   0/1     ContainerCreating   0          0s
pc-job-fhwf7   1/1     Running             0          2s
pc-job-v7rhr   1/1     Running             0          2s
pc-job-5vg2j   1/1     Running             0          3s
pc-job-fhwf7   0/1     Completed           0          12s
pc-job-v7rhr   0/1     Completed           0          12s
pc-job-5vg2j   0/1     Completed           0          12s

# åˆ é™¤job
[root@k8s-master01 ~]# kubectl delete -f pc-job.yaml
job.batch &quot;pc-job&quot; deleted
</code></pre>
<h2 id="67-cronjobcj">6.7 CronJob(CJ)</h2>
<p>CronJobæ§åˆ¶å™¨ä»¥Jobæ§åˆ¶å™¨èµ„æºä¸ºå…¶ç®¡æ§å¯¹è±¡ï¼Œå¹¶å€ŸåŠ©å®ƒç®¡ç†podèµ„æºå¯¹è±¡ï¼ŒJobæ§åˆ¶å™¨å®šä¹‰çš„ä½œä¸šä»»åŠ¡åœ¨å…¶æ§åˆ¶å™¨èµ„æºåˆ›å»ºä¹‹åä¾¿ä¼šç«‹å³æ‰§è¡Œï¼Œä½†CronJobå¯ä»¥ä»¥ç±»ä¼¼äºLinuxæ“ä½œç³»ç»Ÿçš„å‘¨æœŸæ€§ä»»åŠ¡ä½œä¸šè®¡åˆ’çš„æ–¹å¼æ§åˆ¶å…¶è¿è¡Œ<strong>æ—¶é—´ç‚¹</strong>åŠ<strong>é‡å¤è¿è¡Œ</strong>çš„æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>CronJobå¯ä»¥åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹(åå¤çš„)å»è¿è¡Œjobä»»åŠ¡</strong>ã€‚</p>
<figure data-type="image" tabindex="28"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h0uuni4j30n208d74v.jpg" alt="img" loading="lazy"></figure>
<p>CronJobçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">apiVersion: batch/v1beta1 # ç‰ˆæœ¬å·
kind: CronJob # ç±»å‹       
metadata: # å…ƒæ•°æ®
  name: # rsåç§° 
  namespace: # æ‰€å±å‘½åç©ºé—´ 
  labels: #æ ‡ç­¾
    controller: cronjob
spec: # è¯¦æƒ…æè¿°
  schedule: # cronæ ¼å¼çš„ä½œä¸šè°ƒåº¦è¿è¡Œæ—¶é—´ç‚¹,ç”¨äºæ§åˆ¶ä»»åŠ¡åœ¨ä»€ä¹ˆæ—¶é—´æ‰§è¡Œ
  concurrencyPolicy: # å¹¶å‘æ‰§è¡Œç­–ç•¥ï¼Œç”¨äºå®šä¹‰å‰ä¸€æ¬¡ä½œä¸šè¿è¡Œå°šæœªå®Œæˆæ—¶æ˜¯å¦ä»¥åŠå¦‚ä½•è¿è¡Œåä¸€æ¬¡çš„ä½œä¸š
  failedJobHistoryLimit: # ä¸ºå¤±è´¥çš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º1
  successfulJobHistoryLimit: # ä¸ºæˆåŠŸçš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º3
  startingDeadlineSeconds: # å¯åŠ¨ä½œä¸šé”™è¯¯çš„è¶…æ—¶æ—¶é•¿
  jobTemplate: # jobæ§åˆ¶å™¨æ¨¡æ¿ï¼Œç”¨äºä¸ºcronjobæ§åˆ¶å™¨ç”Ÿæˆjobå¯¹è±¡;ä¸‹é¢å…¶å®å°±æ˜¯jobçš„å®šä¹‰
    metadata:
    spec:
      completions: 1
      parallelism: 1
      activeDeadlineSeconds: 30
      backoffLimit: 6
      manualSelector: true
      selector:
        matchLabels:
          app: counter-pod
        matchExpressions: è§„åˆ™
          - {key: app, operator: In, values: [counter-pod]}
      template:
        metadata:
          labels:
            app: counter-pod
        spec:
          restartPolicy: Never 
          containers:
          - name: counter
            image: busybox:1.30
            command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;]
</code></pre>
<pre><code class="language-yaml">éœ€è¦é‡ç‚¹è§£é‡Šçš„å‡ ä¸ªé€‰é¡¹ï¼š
schedule: cronè¡¨è¾¾å¼ï¼Œç”¨äºæŒ‡å®šä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
    */1    *      *    *     *
    &lt;åˆ†é’Ÿ&gt; &lt;å°æ—¶&gt; &lt;æ—¥&gt; &lt;æœˆä»½&gt; &lt;æ˜ŸæœŸ&gt;

    åˆ†é’Ÿ å€¼ä» 0 åˆ° 59.
    å°æ—¶ å€¼ä» 0 åˆ° 23.
    æ—¥ å€¼ä» 1 åˆ° 31.
    æœˆ å€¼ä» 1 åˆ° 12.
    æ˜ŸæœŸ å€¼ä» 0 åˆ° 6, 0 ä»£è¡¨æ˜ŸæœŸæ—¥
    å¤šä¸ªæ—¶é—´å¯ä»¥ç”¨é€—å·éš”å¼€ï¼› èŒƒå›´å¯ä»¥ç”¨è¿å­—ç¬¦ç»™å‡ºï¼›*å¯ä»¥ä½œä¸ºé€šé…ç¬¦ï¼› /è¡¨ç¤ºæ¯...
concurrencyPolicy:
    Allow:   å…è®¸Jobså¹¶å‘è¿è¡Œ(é»˜è®¤)
    Forbid:  ç¦æ­¢å¹¶å‘è¿è¡Œï¼Œå¦‚æœä¸Šä¸€æ¬¡è¿è¡Œå°šæœªå®Œæˆï¼Œåˆ™è·³è¿‡ä¸‹ä¸€æ¬¡è¿è¡Œ
    Replace: æ›¿æ¢ï¼Œå–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„ä½œä¸šå¹¶ç”¨æ–°ä½œä¸šæ›¿æ¢å®ƒ
</code></pre>
<p>åˆ›å»ºpc-cronjob.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: pc-cronjob
  namespace: dev
  labels:
    controller: cronjob
spec:
  schedule: &quot;*/1 * * * *&quot;
  jobTemplate:
    metadata:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: counter
            image: busybox:1.30
            command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;]
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºcronjob
[root@k8s-master01 ~]# kubectl create -f pc-cronjob.yaml
cronjob.batch/pc-cronjob created

# æŸ¥çœ‹cronjob
[root@k8s-master01 ~]# kubectl get cronjobs -n dev
NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
pc-cronjob   */1 * * * *   False     0        &lt;none&gt;          6s

# æŸ¥çœ‹job
[root@k8s-master01 ~]# kubectl get jobs -n dev
NAME                    COMPLETIONS   DURATION   AGE
pc-cronjob-1592587800   1/1           28s        3m26s
pc-cronjob-1592587860   1/1           28s        2m26s
pc-cronjob-1592587920   1/1           28s        86s

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods -n dev
pc-cronjob-1592587800-x4tsm   0/1     Completed   0          2m24s
pc-cronjob-1592587860-r5gv4   0/1     Completed   0          84s
pc-cronjob-1592587920-9dxxq   1/1     Running     0          24s


# åˆ é™¤cronjob
[root@k8s-master01 ~]# kubectl  delete -f pc-cronjob.yaml
cronjob.batch &quot;pc-cronjob&quot; deleted
</code></pre>
<h1 id="7-serviceè¯¦è§£">7. Serviceè¯¦è§£</h1>
<h2 id="71-serviceä»‹ç»">7.1 Serviceä»‹ç»</h2>
<p>åœ¨kubernetesä¸­ï¼Œpodæ˜¯åº”ç”¨ç¨‹åºçš„è½½ä½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡podçš„ipæ¥è®¿é—®åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯podçš„ipåœ°å€ä¸æ˜¯å›ºå®šçš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸æ–¹ä¾¿ç›´æ¥é‡‡ç”¨podçš„ipå¯¹æœåŠ¡è¿›è¡Œè®¿é—®ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œkubernetesæä¾›äº†Serviceèµ„æºï¼ŒServiceä¼šå¯¹æä¾›åŒä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªpodè¿›è¡Œèšåˆï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ã€‚é€šè¿‡è®¿é—®Serviceçš„å…¥å£åœ°å€å°±èƒ½è®¿é—®åˆ°åé¢çš„podæœåŠ¡ã€‚</p>
<figure data-type="image" tabindex="29"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h0z1vlgj30tt0dtq4q.jpg" alt="img" loading="lazy"></figure>
<p>Serviceåœ¨å¾ˆå¤šæƒ…å†µä¸‹åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼ŒçœŸæ­£èµ·ä½œç”¨çš„å…¶å®æ˜¯kube-proxyæœåŠ¡è¿›ç¨‹ï¼Œæ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ªkube-proxyæœåŠ¡è¿›ç¨‹ã€‚å½“åˆ›å»ºServiceçš„æ—¶å€™ä¼šé€šè¿‡api-serverå‘etcdå†™å…¥åˆ›å»ºçš„serviceçš„ä¿¡æ¯ï¼Œè€Œkube-proxyä¼šåŸºäºç›‘å¬çš„æœºåˆ¶å‘ç°è¿™ç§Serviceçš„å˜åŠ¨ï¼Œç„¶å<strong>å®ƒä¼šå°†æœ€æ–°çš„Serviceä¿¡æ¯è½¬æ¢æˆå¯¹åº”çš„è®¿é—®è§„åˆ™</strong>ã€‚</p>
<figure data-type="image" tabindex="30"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h136a0gj30t409qq3v.jpg" alt="img" loading="lazy"></figure>
<pre><code># 10.97.97.97:80 æ˜¯serviceæä¾›çš„è®¿é—®å…¥å£
# å½“è®¿é—®è¿™ä¸ªå…¥å£çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°åé¢æœ‰ä¸‰ä¸ªpodçš„æœåŠ¡åœ¨ç­‰å¾…è°ƒç”¨ï¼Œ
# kube-proxyä¼šåŸºäºrrï¼ˆè½®è¯¢ï¼‰çš„ç­–ç•¥ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å…¶ä¸­ä¸€ä¸ªpodä¸Šå»
# è¿™ä¸ªè§„åˆ™ä¼šåŒæ—¶åœ¨é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½ç”Ÿæˆï¼Œæ‰€ä»¥åœ¨ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè®¿é—®éƒ½å¯ä»¥ã€‚
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0
</code></pre>
<p>kube-proxyç›®å‰æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼:</p>
<p><strong>userspace æ¨¡å¼</strong></p>
<p>userspaceæ¨¡å¼ä¸‹ï¼Œkube-proxyä¼šä¸ºæ¯ä¸€ä¸ªServiceåˆ›å»ºä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œå‘å‘Cluster IPçš„è¯·æ±‚è¢«Iptablesè§„åˆ™é‡å®šå‘åˆ°kube-proxyç›‘å¬çš„ç«¯å£ä¸Šï¼Œkube-proxyæ ¹æ®LBç®—æ³•é€‰æ‹©ä¸€ä¸ªæä¾›æœåŠ¡çš„Podå¹¶å’Œå…¶å»ºç«‹é“¾æ¥ï¼Œä»¥å°†è¯·æ±‚è½¬å‘åˆ°Podä¸Šã€‚  è¯¥æ¨¡å¼ä¸‹ï¼Œkube-proxyå……å½“äº†ä¸€ä¸ªå››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ã€‚ç”±äºkube-proxyè¿è¡Œåœ¨userspaceä¸­ï¼Œåœ¨è¿›è¡Œè½¬å‘å¤„ç†æ—¶ä¼šå¢åŠ å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œè™½ç„¶æ¯”è¾ƒç¨³å®šï¼Œä½†æ˜¯æ•ˆç‡æ¯”è¾ƒä½ã€‚</p>
<figure data-type="image" tabindex="31"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h162n35j30nn0ek75z.jpg" alt="img" loading="lazy"></figure>
<p><strong>iptables æ¨¡å¼</strong></p>
<p>iptablesæ¨¡å¼ä¸‹ï¼Œkube-proxyä¸ºserviceåç«¯çš„æ¯ä¸ªPodåˆ›å»ºå¯¹åº”çš„iptablesè§„åˆ™ï¼Œç›´æ¥å°†å‘å‘Cluster IPçš„è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªPod IPã€‚  è¯¥æ¨¡å¼ä¸‹kube-proxyä¸æ‰¿æ‹…å››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ï¼Œåªè´Ÿè´£åˆ›å»ºiptablesè§„åˆ™ã€‚è¯¥æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯è¾ƒuserspaceæ¨¡å¼æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸èƒ½æä¾›çµæ´»çš„LBç­–ç•¥ï¼Œå½“åç«¯Podä¸å¯ç”¨æ—¶ä¹Ÿæ— æ³•è¿›è¡Œé‡è¯•ã€‚</p>
<figure data-type="image" tabindex="32"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h19cj8nj30n90hu40b.jpg" alt="img" loading="lazy"></figure>
<p><strong>ipvs æ¨¡å¼</strong></p>
<p>ipvsæ¨¡å¼å’Œiptablesç±»ä¼¼ï¼Œkube-proxyç›‘æ§Podçš„å˜åŒ–å¹¶åˆ›å»ºç›¸åº”çš„ipvsè§„åˆ™ã€‚ipvsç›¸å¯¹iptablesè½¬å‘æ•ˆç‡æ›´é«˜ã€‚é™¤æ­¤ä»¥å¤–ï¼Œipvsæ”¯æŒæ›´å¤šçš„LBç®—æ³•ã€‚</p>
<figure data-type="image" tabindex="33"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h1d2wx1j30ms0hltad.jpg" alt="img" loading="lazy"></figure>
<pre><code class="language-shell"># æ­¤æ¨¡å¼å¿…é¡»å®‰è£…ipvså†…æ ¸æ¨¡å—ï¼Œå¦åˆ™ä¼šé™çº§ä¸ºiptables
# å¼€å¯ipvs
[root@k8s-master01 ~]# kubectl edit cm kube-proxy -n kube-system
# ä¿®æ”¹mode: &quot;ipvs&quot;
[root@k8s-master01 ~]# kubectl delete pod -l k8s-app=kube-proxy -n kube-system
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0
</code></pre>
<h2 id="72-serviceç±»å‹">7.2 Serviceç±»å‹</h2>
<p>Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">kind: Service  # èµ„æºç±»å‹
apiVersion: v1  # èµ„æºç‰ˆæœ¬
metadata: # å…ƒæ•°æ®
  name: service # èµ„æºåç§°
  namespace: dev # å‘½åç©ºé—´
spec: # æè¿°
  selector: # æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºç¡®å®šå½“å‰serviceä»£ç†å“ªäº›pod
    app: nginx
  type: # Serviceç±»å‹ï¼ŒæŒ‡å®šserviceçš„è®¿é—®æ–¹å¼
  clusterIP:  # è™šæ‹ŸæœåŠ¡çš„ipåœ°å€
  sessionAffinity: # sessionäº²å’Œæ€§ï¼Œæ”¯æŒClientIPã€Noneä¸¤ä¸ªé€‰é¡¹
  ports: # ç«¯å£ä¿¡æ¯
    - protocol: TCP 
      port: 3017  # serviceç«¯å£
      targetPort: 5003 # podç«¯å£
      nodePort: 31122 # ä¸»æœºç«¯å£
</code></pre>
<ul>
<li>ClusterIPï¼šé»˜è®¤å€¼ï¼Œå®ƒæ˜¯Kubernetesç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„è™šæ‹ŸIPï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®</li>
<li>NodePortï¼šå°†Serviceé€šè¿‡æŒ‡å®šçš„Nodeä¸Šçš„ç«¯å£æš´éœ²ç»™å¤–éƒ¨ï¼Œé€šè¿‡æ­¤æ–¹æ³•ï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡</li>
<li>LoadBalancerï¼šä½¿ç”¨å¤–æ¥è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡çš„è´Ÿè½½åˆ†å‘ï¼Œæ³¨æ„æ­¤æ¨¡å¼éœ€è¦å¤–éƒ¨äº‘ç¯å¢ƒæ”¯æŒ</li>
<li>ExternalNameï¼š æŠŠé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥é›†ç¾¤å†…éƒ¨ï¼Œç›´æ¥ä½¿ç”¨</li>
</ul>
<h2 id="73-serviceä½¿ç”¨">7.3 Serviceä½¿ç”¨</h2>
<h3 id="731-å®éªŒç¯å¢ƒå‡†å¤‡">7.3.1 å®éªŒç¯å¢ƒå‡†å¤‡</h3>
<p>åœ¨ä½¿ç”¨serviceä¹‹å‰ï¼Œé¦–å…ˆåˆ©ç”¨Deploymentåˆ›å»ºå‡º3ä¸ªpodï¼Œæ³¨æ„è¦ä¸ºpodè®¾ç½®<code>app=nginx-pod</code>çš„æ ‡ç­¾</p>
<p>åˆ›å»ºdeployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment      
metadata:
  name: pc-deployment
  namespace: dev
spec: 
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80
</code></pre>
<pre><code class="language-shell">[root@k8s-master01 ~]# kubectl create -f deployment.yaml
deployment.apps/pc-deployment created

# æŸ¥çœ‹podè¯¦æƒ…
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide --show-labels
NAME                             READY   STATUS     IP            NODE     LABELS
pc-deployment-66cb59b984-8p84h   1/1     Running    10.244.1.39   node1    app=nginx-pod
pc-deployment-66cb59b984-vx8vx   1/1     Running    10.244.2.33   node2    app=nginx-pod
pc-deployment-66cb59b984-wnncx   1/1     Running    10.244.1.40   node1    app=nginx-pod

# ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œä¿®æ”¹ä¸‹ä¸‰å°nginxçš„index.htmlé¡µé¢ï¼ˆä¸‰å°ä¿®æ”¹çš„IPåœ°å€ä¸ä¸€è‡´ï¼‰
# kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh
# echo &quot;10.244.1.39&quot; &gt; /usr/share/nginx/html/index.html

#ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œè®¿é—®æµ‹è¯•
[root@k8s-master01 ~]# curl 10.244.1.39
10.244.1.39
[root@k8s-master01 ~]# curl 10.244.2.33
10.244.2.33
[root@k8s-master01 ~]# curl 10.244.1.40
10.244.1.40
</code></pre>
<h3 id="732-clusteripç±»å‹çš„service">7.3.2 ClusterIPç±»å‹çš„Service</h3>
<p>åˆ›å»ºservice-clusterip.yamlæ–‡ä»¶</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: service-clusterip
  namespace: dev
spec:
  selector:
    app: nginx-pod
  clusterIP: 10.97.97.97 # serviceçš„ipåœ°å€ï¼Œå¦‚æœä¸å†™ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª
  type: ClusterIP
  ports:
  - port: 80  # Serviceç«¯å£       
    targetPort: 80 # podç«¯å£
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºservice
[root@k8s-master01 ~]# kubectl create -f service-clusterip.yaml
service/service-clusterip created

# æŸ¥çœ‹service
[root@k8s-master01 ~]# kubectl get svc -n dev -o wide
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service-clusterip   ClusterIP   10.97.97.97   &lt;none&gt;        80/TCP    13s   app=nginx-pod

# æŸ¥çœ‹serviceçš„è¯¦ç»†ä¿¡æ¯
# åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªEndpointsåˆ—è¡¨ï¼Œé‡Œé¢å°±æ˜¯å½“å‰serviceå¯ä»¥è´Ÿè½½åˆ°çš„æœåŠ¡å…¥å£
[root@k8s-master01 ~]# kubectl describe svc service-clusterip -n dev
Name:              service-clusterip
Namespace:         dev
Labels:            &lt;none&gt;
Annotations:       &lt;none&gt;
Selector:          app=nginx-pod
Type:              ClusterIP
IP:                10.97.97.97
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            &lt;none&gt;

# æŸ¥çœ‹ipvsçš„æ˜ å°„è§„åˆ™
[root@k8s-master01 ~]# ipvsadm -Ln
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0

# è®¿é—®10.97.97.97:80è§‚å¯Ÿæ•ˆæœ
[root@k8s-master01 ~]# curl 10.97.97.97:80
10.244.2.33
</code></pre>
<p><strong>Endpoint</strong></p>
<p>Endpointæ˜¯kubernetesä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œç”¨æ¥è®°å½•ä¸€ä¸ªserviceå¯¹åº”çš„æ‰€æœ‰podçš„è®¿é—®åœ°å€ï¼Œå®ƒæ˜¯æ ¹æ®serviceé…ç½®æ–‡ä»¶ä¸­selectoræè¿°äº§ç”Ÿçš„ã€‚</p>
<p>ä¸€ä¸ªServiceç”±ä¸€ç»„Podç»„æˆï¼Œè¿™äº›Podé€šè¿‡Endpointsæš´éœ²å‡ºæ¥ï¼Œ<strong>Endpointsæ˜¯å®ç°å®é™…æœåŠ¡çš„ç«¯ç‚¹é›†åˆ</strong>ã€‚æ¢å¥è¯è¯´ï¼Œserviceå’Œpodä¹‹é—´çš„è”ç³»æ˜¯é€šè¿‡endpointså®ç°çš„ã€‚</p>
<figure data-type="image" tabindex="34"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h1iorf4j30u70c0jts.jpg" alt="image-20200509191917069" loading="lazy"></figure>
<p><strong>è´Ÿè½½åˆ†å‘ç­–ç•¥</strong></p>
<p>å¯¹Serviceçš„è®¿é—®è¢«åˆ†å‘åˆ°äº†åç«¯çš„Podä¸Šå»ï¼Œç›®å‰kubernetesæä¾›äº†ä¸¤ç§è´Ÿè½½åˆ†å‘ç­–ç•¥ï¼š</p>
<ul>
<li>
<p>å¦‚æœä¸å®šä¹‰ï¼Œé»˜è®¤ä½¿ç”¨kube-proxyçš„ç­–ç•¥ï¼Œæ¯”å¦‚éšæœºã€è½®è¯¢</p>
</li>
<li>
<p>åŸºäºå®¢æˆ·ç«¯åœ°å€çš„ä¼šè¯ä¿æŒæ¨¡å¼ï¼Œå³æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè½¬å‘åˆ°å›ºå®šçš„ä¸€ä¸ªPodä¸Š</p>
<p>æ­¤æ¨¡å¼å¯ä»¥ä½¿åœ¨specä¸­æ·»åŠ <code>sessionAffinity:ClientIP</code>é€‰é¡¹</p>
</li>
</ul>
<pre><code class="language-shell"># æŸ¥çœ‹ipvsçš„æ˜ å°„è§„åˆ™ã€rr è½®è¯¢ã€‘
[root@k8s-master01 ~]# ipvsadm -Ln
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0

# å¾ªç¯è®¿é—®æµ‹è¯•
[root@k8s-master01 ~]# while true;do curl 10.97.97.97:80; sleep 5; done;
10.244.1.40
10.244.1.39
10.244.2.33
10.244.1.40
10.244.1.39
10.244.2.33

# ä¿®æ”¹åˆ†å‘ç­–ç•¥----sessionAffinity:ClientIP

# æŸ¥çœ‹ipvsè§„åˆ™ã€persistent ä»£è¡¨æŒä¹…ã€‘
[root@k8s-master01 ~]# ipvsadm -Ln
TCP  10.97.97.97:80 rr persistent 10800
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0

# å¾ªç¯è®¿é—®æµ‹è¯•
[root@k8s-master01 ~]# while true;do curl 10.97.97.97; sleep 5; done;
10.244.2.33
10.244.2.33
10.244.2.33
  
# åˆ é™¤service
[root@k8s-master01 ~]# kubectl delete -f service-clusterip.yaml
service &quot;service-clusterip&quot; deleted
</code></pre>
<h3 id="733-headlinessç±»å‹çš„service">7.3.3 HeadLinessç±»å‹çš„Service</h3>
<p>åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¼€å‘äººå‘˜å¯èƒ½ä¸æƒ³ä½¿ç”¨Serviceæä¾›çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè€Œå¸Œæœ›è‡ªå·±æ¥æ§åˆ¶è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetesæä¾›äº†HeadLiness Serviceï¼Œè¿™ç±»Serviceä¸ä¼šåˆ†é…Cluster IPï¼Œå¦‚æœæƒ³è¦è®¿é—®serviceï¼Œåªèƒ½é€šè¿‡serviceçš„åŸŸåè¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p>åˆ›å»ºservice-headliness.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: service-headliness
  namespace: dev
spec:
  selector:
    app: nginx-pod
  clusterIP: None # å°†clusterIPè®¾ç½®ä¸ºNoneï¼Œå³å¯åˆ›å»ºheadliness Service
  type: ClusterIP
  ports:
  - port: 80    
    targetPort: 80
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºservice
[root@k8s-master01 ~]# kubectl create -f service-headliness.yaml
service/service-headliness created

# è·å–serviceï¼Œ å‘ç°CLUSTER-IPæœªåˆ†é…
[root@k8s-master01 ~]# kubectl get svc service-headliness -n dev -o wide
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service-headliness   ClusterIP   None         &lt;none&gt;        80/TCP    11s   app=nginx-pod

# æŸ¥çœ‹serviceè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe svc service-headliness  -n dev
Name:              service-headliness
Namespace:         dev
Labels:            &lt;none&gt;
Annotations:       &lt;none&gt;
Selector:          app=nginx-pod
Type:              ClusterIP
IP:                None
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            &lt;none&gt;

# æŸ¥çœ‹åŸŸåçš„è§£ææƒ…å†µ
[root@k8s-master01 ~]# kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh
/ # cat /etc/resolv.conf
nameserver 10.96.0.10
search dev.svc.cluster.local svc.cluster.local cluster.local

[root@k8s-master01 ~]# dig @10.96.0.10 service-headliness.dev.svc.cluster.local
service-headliness.dev.svc.cluster.local. 30 IN A 10.244.1.40
service-headliness.dev.svc.cluster.local. 30 IN A 10.244.1.39
service-headliness.dev.svc.cluster.local. 30 IN A 10.244.2.33
</code></pre>
<h3 id="734-nodeportç±»å‹çš„service">7.3.4 NodePortç±»å‹çš„Service</h3>
<p>åœ¨ä¹‹å‰çš„æ ·ä¾‹ä¸­ï¼Œåˆ›å»ºçš„Serviceçš„ipåœ°å€åªæœ‰é›†ç¾¤å†…éƒ¨æ‰å¯ä»¥è®¿é—®ï¼Œå¦‚æœå¸Œæœ›å°†Serviceæš´éœ²ç»™é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨åˆ°å¦å¤–ä¸€ç§ç±»å‹çš„Serviceï¼Œç§°ä¸ºNodePortç±»å‹ã€‚NodePortçš„å·¥ä½œåŸç†å…¶å®å°±æ˜¯<strong>å°†serviceçš„ç«¯å£æ˜ å°„åˆ°Nodeçš„ä¸€ä¸ªç«¯å£ä¸Š</strong>ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡<code>NodeIp:NodePort</code>æ¥è®¿é—®serviceäº†ã€‚</p>
<figure data-type="image" tabindex="35"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h1odu2ij30f307agly.jpg" alt="img" loading="lazy"></figure>
<p>åˆ›å»ºservice-nodeport.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: service-nodeport
  namespace: dev
spec:
  selector:
    app: nginx-pod
  type: NodePort # serviceç±»å‹
  ports:
  - port: 80
    nodePort: 30002 # æŒ‡å®šç»‘å®šçš„nodeçš„ç«¯å£(é»˜è®¤çš„å–å€¼èŒƒå›´æ˜¯ï¼š30000-32767), å¦‚æœä¸æŒ‡å®šï¼Œä¼šé»˜è®¤åˆ†é…
    targetPort: 80
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºservice
[root@k8s-master01 ~]# kubectl create -f service-nodeport.yaml
service/service-nodeport created

# æŸ¥çœ‹service
[root@k8s-master01 ~]# kubectl get svc -n dev -o wide
NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)       SELECTOR
service-nodeport   NodePort   10.105.64.191   &lt;none&gt;        80:30002/TCP  app=nginx-pod

# æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ç”µè„‘ä¸»æœºçš„æµè§ˆå™¨å»è®¿é—®é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªnodeipçš„30002ç«¯å£ï¼Œå³å¯è®¿é—®åˆ°pod
</code></pre>
<h3 id="735-loadbalancerç±»å‹çš„service">7.3.5 LoadBalancerç±»å‹çš„Service</h3>
<p>LoadBalancerå’ŒNodePortå¾ˆç›¸ä¼¼ï¼Œç›®çš„éƒ½æ˜¯å‘å¤–éƒ¨æš´éœ²ä¸€ä¸ªç«¯å£ï¼ŒåŒºåˆ«åœ¨äºLoadBalancerä¼šåœ¨é›†ç¾¤çš„å¤–éƒ¨å†æ¥åšä¸€ä¸ªè´Ÿè½½å‡è¡¡è®¾å¤‡ï¼Œè€Œè¿™ä¸ªè®¾å¤‡éœ€è¦å¤–éƒ¨ç¯å¢ƒæ”¯æŒçš„ï¼Œå¤–éƒ¨æœåŠ¡å‘é€åˆ°è¿™ä¸ªè®¾å¤‡ä¸Šçš„è¯·æ±‚ï¼Œä¼šè¢«è®¾å¤‡è´Ÿè½½ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­ã€‚</p>
<figure data-type="image" tabindex="36"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h1t0wesj30ul0bn400.jpg" alt="img" loading="lazy"></figure>
<h3 id="736-externalnameç±»å‹çš„service">7.3.6 ExternalNameç±»å‹çš„Service</h3>
<p>ExternalNameç±»å‹çš„Serviceç”¨äºå¼•å…¥é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼Œå®ƒé€šè¿‡<code>externalName</code>å±æ€§æŒ‡å®šå¤–éƒ¨ä¸€ä¸ªæœåŠ¡çš„åœ°å€ï¼Œç„¶ååœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æ­¤serviceå°±å¯ä»¥è®¿é—®åˆ°å¤–éƒ¨çš„æœåŠ¡äº†ã€‚</p>
<figure data-type="image" tabindex="37"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h1wt3pkj30ln08g0t7.jpg" alt="img" loading="lazy"></figure>
<pre><code class="language-shell">apiVersion: v1
kind: Service
metadata:
  name: service-externalname
  namespace: dev
spec:
  type: ExternalName # serviceç±»å‹
  externalName: www.baidu.com  #æ”¹æˆipåœ°å€ä¹Ÿå¯ä»¥
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºservice
[root@k8s-master01 ~]# kubectl  create -f service-externalname.yaml
service/service-externalname created

# åŸŸåè§£æ
[root@k8s-master01 ~]# dig @10.96.0.10 service-externalname.dev.svc.cluster.local
service-externalname.dev.svc.cluster.local. 30 IN CNAME www.baidu.com.
www.baidu.com.          30      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       30      IN      A       39.156.66.18
www.a.shifen.com.       30      IN      A       39.156.66.14
</code></pre>
<h2 id="74-ingressä»‹ç»">7.4 Ingressä»‹ç»</h2>
<p>åœ¨å‰é¢è¯¾ç¨‹ä¸­å·²ç»æåˆ°ï¼ŒServiceå¯¹é›†ç¾¤ä¹‹å¤–æš´éœ²æœåŠ¡çš„ä¸»è¦æ–¹å¼æœ‰ä¸¤ç§ï¼šNotePortå’ŒLoadBalancerï¼Œä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼ï¼Œéƒ½æœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>NodePortæ–¹å¼çš„ç¼ºç‚¹æ˜¯ä¼šå ç”¨å¾ˆå¤šé›†ç¾¤æœºå™¨çš„ç«¯å£ï¼Œé‚£ä¹ˆå½“é›†ç¾¤æœåŠ¡å˜å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªç¼ºç‚¹å°±æ„ˆå‘æ˜æ˜¾</li>
<li>LBæ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯ä¸ªserviceéœ€è¦ä¸€ä¸ªLBï¼Œæµªè´¹ã€éº»çƒ¦ï¼Œå¹¶ä¸”éœ€è¦kubernetesä¹‹å¤–è®¾å¤‡çš„æ”¯æŒ</li>
</ul>
<p>åŸºäºè¿™ç§ç°çŠ¶ï¼Œkubernetesæä¾›äº†Ingressèµ„æºå¯¹è±¡ï¼ŒIngressåªéœ€è¦ä¸€ä¸ªNodePortæˆ–è€…ä¸€ä¸ªLBå°±å¯ä»¥æ»¡è¶³æš´éœ²å¤šä¸ªServiceçš„éœ€æ±‚ã€‚å·¥ä½œæœºåˆ¶å¤§è‡´å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p>
<figure data-type="image" tabindex="38"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h201ge9j30rk0bqq4x.jpg" alt="img" loading="lazy"></figure>
<p>å®é™…ä¸Šï¼ŒIngressç›¸å½“äºä¸€ä¸ª7å±‚çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæ˜¯kuberneteså¯¹åå‘ä»£ç†çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äºNginxï¼Œå¯ä»¥ç†è§£æˆåœ¨<strong>Ingressé‡Œå»ºç«‹è¯¸å¤šæ˜ å°„è§„åˆ™ï¼ŒIngress Controlleré€šè¿‡ç›‘å¬è¿™äº›é…ç½®è§„åˆ™å¹¶è½¬åŒ–æˆNginxçš„åå‘ä»£ç†é…ç½® , ç„¶åå¯¹å¤–éƒ¨æä¾›æœåŠ¡</strong>ã€‚åœ¨è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p>
<ul>
<li>ingressï¼škubernetesä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ°serviceçš„è§„åˆ™</li>
<li>ingress controllerï¼šå…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ï¼Œå®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Nginx, Contour, Haproxyç­‰ç­‰</li>
</ul>
<p>Ingressï¼ˆä»¥Nginxä¸ºä¾‹ï¼‰çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·ç¼–å†™Ingressè§„åˆ™ï¼Œè¯´æ˜å“ªä¸ªåŸŸåå¯¹åº”kubernetesé›†ç¾¤ä¸­çš„å“ªä¸ªService</li>
<li>Ingressæ§åˆ¶å™¨åŠ¨æ€æ„ŸçŸ¥IngressæœåŠ¡è§„åˆ™çš„å˜åŒ–ï¼Œç„¶åç”Ÿæˆä¸€æ®µå¯¹åº”çš„Nginxåå‘ä»£ç†é…ç½®</li>
<li>Ingressæ§åˆ¶å™¨ä¼šå°†ç”Ÿæˆçš„Nginxé…ç½®å†™å…¥åˆ°ä¸€ä¸ªè¿è¡Œç€çš„NginxæœåŠ¡ä¸­ï¼Œå¹¶åŠ¨æ€æ›´æ–°</li>
<li>åˆ°æ­¤ä¸ºæ­¢ï¼Œå…¶å®çœŸæ­£åœ¨å·¥ä½œçš„å°±æ˜¯ä¸€ä¸ªNginxäº†ï¼Œå†…éƒ¨é…ç½®äº†ç”¨æˆ·å®šä¹‰çš„è¯·æ±‚è½¬å‘è§„åˆ™</li>
</ol>
<figure data-type="image" tabindex="39"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h23q6f0j30p60c1ta3.jpg" alt="img" loading="lazy"></figure>
<h2 id="75-ingressä½¿ç”¨">7.5 Ingressä½¿ç”¨</h2>
<h3 id="751-ç¯å¢ƒå‡†å¤‡">7.5.1 ç¯å¢ƒå‡†å¤‡</h3>
<p><strong>æ­å»ºingressç¯å¢ƒ</strong></p>
<pre><code># åˆ›å»ºæ–‡ä»¶å¤¹
[root@k8s-master01 ~]# mkdir ingress-controller
[root@k8s-master01 ~]# cd ingress-controller/

# è·å–ingress-nginxï¼Œæœ¬æ¬¡æ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯0.30ç‰ˆæœ¬
[root@k8s-master01 ingress-controller]# wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml
[root@k8s-master01 ingress-controller]# wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml

# ä¿®æ”¹mandatory.yamlæ–‡ä»¶ä¸­çš„ä»“åº“
# ä¿®æ”¹quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
# ä¸ºquay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
# åˆ›å»ºingress-nginx
[root@k8s-master01 ingress-controller]# kubectl apply -f ./

# æŸ¥çœ‹ingress-nginx
[root@k8s-master01 ingress-controller]# kubectl get pod -n ingress-nginx
NAME                                           READY   STATUS    RESTARTS   AGE
pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h

# æŸ¥çœ‹service
[root@k8s-master01 ingress-controller]# kubectl get svc -n ingress-nginx
NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx   NodePort   10.98.75.163   &lt;none&gt;        80:32240/TCP,443:31335/TCP   11h
</code></pre>
<p><strong>å‡†å¤‡serviceå’Œpod</strong></p>
<p>ä¸ºäº†åé¢çš„å®éªŒæ¯”è¾ƒæ–¹ä¾¿ï¼Œåˆ›å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ¨¡å‹</p>
<figure data-type="image" tabindex="40"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h27i7xij30pa09yjsp.jpg" alt="img" loading="lazy"></figure>
<p>åˆ›å»ºtomcat-nginx.yaml</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: dev
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.1
        ports:
        - containerPort: 80

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: tomcat-deployment
  namespace: dev
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tomcat-pod
  template:
    metadata:
      labels:
        app: tomcat-pod
    spec:
      containers:
      - name: tomcat
        image: tomcat:8.5-jre10-slim
        ports:
        - containerPort: 8080

---

apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: dev
spec:
  selector:
    app: nginx-pod
  clusterIP: None
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 80

---

apiVersion: v1
kind: Service
metadata:
  name: tomcat-service
  namespace: dev
spec:
  selector:
    app: tomcat-pod
  clusterIP: None
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
</code></pre>
<pre><code class="language-shell"># åˆ›å»º
[root@k8s-master01 ~]# kubectl create -f tomcat-nginx.yaml

# æŸ¥çœ‹
[root@k8s-master01 ~]# kubectl get svc -n dev
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
nginx-service    ClusterIP   None         &lt;none&gt;        80/TCP     48s
tomcat-service   ClusterIP   None         &lt;none&gt;        8080/TCP   48s
</code></pre>
<h3 id="752-httpä»£ç†">7.5.2 Httpä»£ç†</h3>
<p>åˆ›å»ºingress-http.yaml</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-http
  namespace: dev
spec:
  rules:
  - host: nginx.itheima.com
    http:
      paths:
      - path: /
        backend:
          serviceName: nginx-service
          servicePort: 80
  - host: tomcat.itheima.com
    http:
      paths:
      - path: /
        backend:
          serviceName: tomcat-service
          servicePort: 8080
</code></pre>
<pre><code class="language-shell"># åˆ›å»º
[root@k8s-master01 ~]# kubectl create -f ingress-http.yaml
ingress.extensions/ingress-http created

# æŸ¥çœ‹
[root@k8s-master01 ~]# kubectl get ing ingress-http -n dev
NAME           HOSTS                                  ADDRESS   PORTS   AGE
ingress-http   nginx.itheima.com,tomcat.itheima.com             80      22s

# æŸ¥çœ‹è¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe ing ingress-http  -n dev
...
Rules:
Host                Path  Backends
----                ----  --------
nginx.itheima.com   / nginx-service:80 (10.244.1.96:80,10.244.1.97:80,10.244.2.112:80)
tomcat.itheima.com  / tomcat-service:8080(10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080)
...

# æ¥ä¸‹æ¥,åœ¨æœ¬åœ°ç”µè„‘ä¸Šé…ç½®hostæ–‡ä»¶,è§£æä¸Šé¢çš„ä¸¤ä¸ªåŸŸååˆ°192.168.109.100(master)ä¸Š
# ç„¶å,å°±å¯ä»¥åˆ†åˆ«è®¿é—®tomcat.itheima.com:32240  å’Œ  nginx.itheima.com:32240 æŸ¥çœ‹æ•ˆæœäº†
</code></pre>
<h3 id="753-httpsä»£ç†">7.5.3 Httpsä»£ç†</h3>
<p>åˆ›å»ºè¯ä¹¦</p>
<pre><code class="language-shell"># ç”Ÿæˆè¯ä¹¦
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&quot;

# åˆ›å»ºå¯†é’¥
kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</code></pre>
<p>åˆ›å»ºingress-https.yaml</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-https
  namespace: dev
spec:
  tls:
    - hosts:
      - nginx.itheima.com
      - tomcat.itheima.com
      secretName: tls-secret # æŒ‡å®šç§˜é’¥
  rules:
  - host: nginx.itheima.com
    http:
      paths:
      - path: /
        backend:
          serviceName: nginx-service
          servicePort: 80
  - host: tomcat.itheima.com
    http:
      paths:
      - path: /
        backend:
          serviceName: tomcat-service
          servicePort: 8080
</code></pre>
<pre><code class="language-shell"># åˆ›å»º
[root@k8s-master01 ~]# kubectl create -f ingress-https.yaml
ingress.extensions/ingress-https created

# æŸ¥çœ‹
[root@k8s-master01 ~]# kubectl get ing ingress-https -n dev
NAME            HOSTS                                  ADDRESS         PORTS     AGE
ingress-https   nginx.itheima.com,tomcat.itheima.com   10.104.184.38   80, 443   2m42s

# æŸ¥çœ‹è¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe ing ingress-https -n dev
...
TLS:
  tls-secret terminates nginx.itheima.com,tomcat.itheima.com
Rules:
Host              Path Backends
----              ---- --------
nginx.itheima.com  /  nginx-service:80 (10.244.1.97:80,10.244.1.98:80,10.244.2.119:80)
tomcat.itheima.com /  tomcat-service:8080(10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080)
...

# ä¸‹é¢å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®https://nginx.itheima.com:31335 å’Œ https://tomcat.itheima.com:31335æ¥æŸ¥çœ‹äº†
</code></pre>
<h1 id="8-æ•°æ®å­˜å‚¨">8. æ•°æ®å­˜å‚¨</h1>
<p>åœ¨å‰é¢å·²ç»æåˆ°ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¾ˆçŸ­ï¼Œä¼šè¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ã€‚é‚£ä¹ˆå®¹å™¨åœ¨é”€æ¯æ—¶ï¼Œä¿å­˜åœ¨å®¹å™¨ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚è¿™ç§ç»“æœå¯¹ç”¨æˆ·æ¥è¯´ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸ä¹æ„çœ‹åˆ°çš„ã€‚ä¸ºäº†æŒä¹…åŒ–ä¿å­˜å®¹å™¨çš„æ•°æ®ï¼Œkuberneteså¼•å…¥äº†Volumeçš„æ¦‚å¿µã€‚</p>
<p>Volumeæ˜¯Podä¸­èƒ½å¤Ÿè¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼Œå®ƒè¢«å®šä¹‰åœ¨Podä¸Šï¼Œç„¶åè¢«ä¸€ä¸ªPodé‡Œçš„å¤šä¸ªå®¹å™¨æŒ‚è½½åˆ°å…·ä½“çš„æ–‡ä»¶ç›®å½•ä¸‹ï¼Œkubernetesé€šè¿‡Volumeå®ç°åŒä¸€ä¸ªPodä¸­ä¸åŒå®¹å™¨ä¹‹é—´çš„æ•°æ®å…±äº«ä»¥åŠæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚Volumeçš„ç”Ÿå‘½å®¹å™¨ä¸ä¸Podä¸­å•ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œå½“å®¹å™¨ç»ˆæ­¢æˆ–è€…é‡å¯æ—¶ï¼ŒVolumeä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p>
<p>kubernetesçš„Volumeæ”¯æŒå¤šç§ç±»å‹ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>ç®€å•å­˜å‚¨ï¼šEmptyDirã€HostPathã€NFS</li>
<li>é«˜çº§å­˜å‚¨ï¼šPVã€PVC</li>
<li>é…ç½®å­˜å‚¨ï¼šConfigMapã€Secret</li>
</ul>
<h2 id="81-åŸºæœ¬å­˜å‚¨">8.1 åŸºæœ¬å­˜å‚¨</h2>
<h3 id="811-emptydir">8.1.1 EmptyDir</h3>
<p>EmptyDiræ˜¯æœ€åŸºç¡€çš„Volumeç±»å‹ï¼Œä¸€ä¸ªEmptyDirå°±æ˜¯Hostä¸Šçš„ä¸€ä¸ªç©ºç›®å½•ã€‚</p>
<p>EmptyDiræ˜¯åœ¨Podè¢«åˆ†é…åˆ°Nodeæ—¶åˆ›å»ºçš„ï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸ºkubernetesä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç›®å½•ï¼Œå½“Podé”€æ¯æ—¶ï¼Œ EmptyDirä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚ EmptyDirç”¨é€”å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸´æ—¶ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºæŸäº›åº”ç”¨ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€çš„ä¸´æ—¶ç›®å½•ï¼Œä¸”æ— é¡»æ°¸ä¹…ä¿ç•™</li>
<li>ä¸€ä¸ªå®¹å™¨éœ€è¦ä»å¦ä¸€ä¸ªå®¹å™¨ä¸­è·å–æ•°æ®çš„ç›®å½•ï¼ˆå¤šå®¹å™¨å…±äº«ç›®å½•ï¼‰</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ä¸€ä¸ªå®¹å™¨ä¹‹é—´æ–‡ä»¶å…±äº«çš„æ¡ˆä¾‹æ¥ä½¿ç”¨ä¸€ä¸‹EmptyDirã€‚</p>
<p>åœ¨ä¸€ä¸ªPodä¸­å‡†å¤‡ä¸¤ä¸ªå®¹å™¨nginxå’Œbusyboxï¼Œç„¶åå£°æ˜ä¸€ä¸ªVolumeåˆ†åˆ«æŒ‚åœ¨åˆ°ä¸¤ä¸ªå®¹å™¨çš„ç›®å½•ä¸­ï¼Œç„¶ånginxå®¹å™¨è´Ÿè´£å‘Volumeä¸­å†™æ—¥å¿—ï¼Œbusyboxä¸­é€šè¿‡å‘½ä»¤å°†æ—¥å¿—å†…å®¹è¯»åˆ°æ§åˆ¶å°ã€‚</p>
<figure data-type="image" tabindex="41"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h2dm06ej30qz0bmwfi.jpg" alt="img" loading="lazy"></figure>
<p>åˆ›å»ºä¸€ä¸ªvolume-emptydir.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: volume-emptydir
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - containerPort: 80
    volumeMounts:  # å°†logs-volumeæŒ‚åœ¨åˆ°nginxå®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /var/log/nginx
    - name: logs-volume
      mountPath: /var/log/nginx
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;] # åˆå§‹å‘½ä»¤ï¼ŒåŠ¨æ€è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­å†…å®¹
    volumeMounts:  # å°†logs-volume æŒ‚åœ¨åˆ°busyboxå®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /logs
    - name: logs-volume
      mountPath: /logs
  volumes: # å£°æ˜volumeï¼Œ nameä¸ºlogs-volumeï¼Œç±»å‹ä¸ºemptyDir
  - name: logs-volume
    emptyDir: {}
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f volume-emptydir.yaml
pod/volume-emptydir created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods volume-emptydir -n dev -o wide
NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   ...... 
volume-emptydir       2/2     Running   0          97s   10.42.2.9   node1  ......

# é€šè¿‡podIpè®¿é—®nginx
[root@k8s-master01 ~]# curl 10.42.2.9
......

# é€šè¿‡kubectl logså‘½ä»¤æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„æ ‡å‡†è¾“å‡º
[root@k8s-master01 ~]# kubectl logs -f volume-emptydir -n dev -c busybox
10.42.1.0 - - [27/Jun/2021:15:08:54 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;
</code></pre>
<h3 id="812-hostpath">8.1.2 HostPath</h3>
<p>ä¸ŠèŠ‚è¯¾æåˆ°ï¼ŒEmptyDirä¸­æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œå®ƒä¼šéšç€Podçš„ç»“æŸè€Œé”€æ¯ï¼Œå¦‚æœæƒ³ç®€å•çš„å°†æ•°æ®æŒä¹…åŒ–åˆ°ä¸»æœºä¸­ï¼Œå¯ä»¥é€‰æ‹©HostPathã€‚</p>
<p>HostPathå°±æ˜¯å°†Nodeä¸»æœºä¸­ä¸€ä¸ªå®é™…ç›®å½•æŒ‚åœ¨åˆ°Podä¸­ï¼Œä»¥ä¾›å®¹å™¨ä½¿ç”¨ï¼Œè¿™æ ·çš„è®¾è®¡å°±å¯ä»¥ä¿è¯Podé”€æ¯äº†ï¼Œä½†æ˜¯æ•°æ®ä¾æ®å¯ä»¥å­˜åœ¨äºNodeä¸»æœºä¸Šã€‚</p>
<figure data-type="image" tabindex="42"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h2hdtwsj30ve0ejjsu.jpg" alt="img" loading="lazy"></figure>
<p>åˆ›å»ºä¸€ä¸ªvolume-hostpath.yamlï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: volume-hostpath
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - containerPort: 80
    volumeMounts:
    - name: logs-volume
      mountPath: /var/log/nginx
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;]
    volumeMounts:
    - name: logs-volume
      mountPath: /logs
  volumes:
  - name: logs-volume
    hostPath: 
      path: /root/logs
      type: DirectoryOrCreate  # ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨
</code></pre>
<pre><code>å…³äºtypeçš„å€¼çš„ä¸€ç‚¹è¯´æ˜ï¼š
    DirectoryOrCreate ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨
    Directory   ç›®å½•å¿…é¡»å­˜åœ¨
    FileOrCreate  æ–‡ä»¶å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨
    File æ–‡ä»¶å¿…é¡»å­˜åœ¨ 
    Socket  unixå¥—æ¥å­—å¿…é¡»å­˜åœ¨
    CharDevice  å­—ç¬¦è®¾å¤‡å¿…é¡»å­˜åœ¨
    BlockDevice å—è®¾å¤‡å¿…é¡»å­˜åœ¨
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºPod
[root@k8s-master01 ~]# kubectl create -f volume-hostpath.yaml
pod/volume-hostpath created

# æŸ¥çœ‹Pod
[root@k8s-master01 ~]# kubectl get pods volume-hostpath -n dev -o wide
NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   ......
pod-volume-hostpath   2/2     Running   0          16s   10.42.2.10     node1  ......

#è®¿é—®nginx
[root@k8s-master01 ~]# curl 10.42.2.10

# æ¥ä¸‹æ¥å°±å¯ä»¥å»hostçš„/root/logsç›®å½•ä¸‹æŸ¥çœ‹å­˜å‚¨çš„æ–‡ä»¶äº†
###  æ³¨æ„: ä¸‹é¢çš„æ“ä½œéœ€è¦åˆ°Podæ‰€åœ¨çš„èŠ‚ç‚¹è¿è¡Œï¼ˆæ¡ˆä¾‹ä¸­æ˜¯node1ï¼‰
[root@node1 ~]# ls /root/logs/
access.log  error.log

# åŒæ ·çš„é“ç†ï¼Œå¦‚æœåœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ°å®¹å™¨ä¸­ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°çš„
</code></pre>
<h3 id="813-nfs">8.1.3 NFS</h3>
<p>HostPathå¯ä»¥è§£å†³æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦NodeèŠ‚ç‚¹æ•…éšœäº†ï¼ŒPodå¦‚æœè½¬ç§»åˆ°äº†åˆ«çš„èŠ‚ç‚¹ï¼Œåˆä¼šå‡ºç°é—®é¢˜äº†ï¼Œæ­¤æ—¶éœ€è¦å‡†å¤‡å•ç‹¬çš„ç½‘ç»œå­˜å‚¨ç³»ç»Ÿï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ç”¨NFSã€CIFSã€‚</p>
<p>NFSæ˜¯ä¸€ä¸ªç½‘ç»œæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥æ­å»ºä¸€å°NFSæœåŠ¡å™¨ï¼Œç„¶åå°†Podä¸­çš„å­˜å‚¨ç›´æ¥è¿æ¥åˆ°NFSç³»ç»Ÿä¸Šï¼Œè¿™æ ·çš„è¯ï¼Œæ— è®ºPodåœ¨èŠ‚ç‚¹ä¸Šæ€ä¹ˆè½¬ç§»ï¼Œåªè¦Nodeè·ŸNFSçš„å¯¹æ¥æ²¡é—®é¢˜ï¼Œæ•°æ®å°±å¯ä»¥æˆåŠŸè®¿é—®ã€‚</p>
<figure data-type="image" tabindex="43"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h2mfijvj31000at75s.jpg" alt="img" loading="lazy"></figure>
<p>1ï¼‰é¦–å…ˆè¦å‡†å¤‡nfsçš„æœåŠ¡å™¨ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥æ˜¯masterèŠ‚ç‚¹åšnfsæœåŠ¡å™¨</p>
<pre><code class="language-shell"># åœ¨nfsä¸Šå®‰è£…nfsæœåŠ¡
[root@nfs ~]# yum install nfs-utils -y

# å‡†å¤‡ä¸€ä¸ªå…±äº«ç›®å½•
[root@nfs ~]# mkdir /root/data/nfs -pv

# å°†å…±äº«ç›®å½•ä»¥è¯»å†™æƒé™æš´éœ²ç»™192.168.5.0/24ç½‘æ®µä¸­çš„æ‰€æœ‰ä¸»æœº
[root@nfs ~]# vim /etc/exports
[root@nfs ~]# more /etc/exports
/root/data/nfs     192.168.5.0/24(rw,no_root_squash)

# å¯åŠ¨nfsæœåŠ¡
[root@nfs ~]# systemctl restart nfs
</code></pre>
<p>2ï¼‰æ¥ä¸‹æ¥ï¼Œè¦åœ¨çš„æ¯ä¸ªnodeèŠ‚ç‚¹ä¸Šéƒ½å®‰è£…ä¸‹nfsï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº†nodeèŠ‚ç‚¹å¯ä»¥é©±åŠ¨nfsè®¾å¤‡</p>
<pre><code class="language-shell"># åœ¨nodeä¸Šå®‰è£…nfsæœåŠ¡ï¼Œæ³¨æ„ä¸éœ€è¦å¯åŠ¨
[root@k8s-master01 ~]# yum install nfs-utils -y
</code></pre>
<p>3ï¼‰æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥ç¼–å†™podçš„é…ç½®æ–‡ä»¶äº†ï¼Œåˆ›å»ºvolume-nfs.yaml</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: volume-nfs
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - containerPort: 80
    volumeMounts:
    - name: logs-volume
      mountPath: /var/log/nginx
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;] 
    volumeMounts:
    - name: logs-volume
      mountPath: /logs
  volumes:
  - name: logs-volume
    nfs:
      server: 192.168.5.6  #nfsæœåŠ¡å™¨åœ°å€
      path: /root/data/nfs #å…±äº«æ–‡ä»¶è·¯å¾„
</code></pre>
<p>4ï¼‰æœ€åï¼Œè¿è¡Œä¸‹podï¼Œè§‚å¯Ÿç»“æœ</p>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f volume-nfs.yaml
pod/volume-nfs created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods volume-nfs -n dev
NAME                  READY   STATUS    RESTARTS   AGE
volume-nfs        2/2     Running   0          2m9s

# æŸ¥çœ‹nfsæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ï¼Œå‘ç°å·²ç»æœ‰æ–‡ä»¶äº†
[root@k8s-master01 ~]# ls /root/data/
access.log  error.log
</code></pre>
<h2 id="82-é«˜çº§å­˜å‚¨">8.2 é«˜çº§å­˜å‚¨</h2>
<p>å‰é¢å·²ç»å­¦ä¹ äº†ä½¿ç”¨NFSæä¾›å­˜å‚¨ï¼Œæ­¤æ—¶å°±è¦æ±‚ç”¨æˆ·ä¼šæ­å»ºNFSç³»ç»Ÿï¼Œå¹¶ä¸”ä¼šåœ¨yamlé…ç½®nfsã€‚ç”±äºkubernetesæ”¯æŒçš„å­˜å‚¨ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œè¦æ±‚å®¢æˆ·å…¨éƒ½æŒæ¡ï¼Œæ˜¾ç„¶ä¸ç°å®ã€‚ä¸ºäº†èƒ½å¤Ÿå±è”½åº•å±‚å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼Œ kuberneteså¼•å…¥PVå’ŒPVCä¸¤ç§èµ„æºå¯¹è±¡ã€‚</p>
<p>PVï¼ˆPersistent Volumeï¼‰æ˜¯æŒä¹…åŒ–å·çš„æ„æ€ï¼Œæ˜¯å¯¹åº•å±‚çš„å…±äº«å­˜å‚¨çš„ä¸€ç§æŠ½è±¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹PVç”±kubernetesç®¡ç†å‘˜è¿›è¡Œåˆ›å»ºå’Œé…ç½®ï¼Œå®ƒä¸åº•å±‚å…·ä½“çš„å…±äº«å­˜å‚¨æŠ€æœ¯æœ‰å…³ï¼Œå¹¶é€šè¿‡æ’ä»¶å®Œæˆä¸å…±äº«å­˜å‚¨çš„å¯¹æ¥ã€‚</p>
<p>PVCï¼ˆPersistent Volume Claimï¼‰æ˜¯æŒä¹…å·å£°æ˜çš„æ„æ€ï¼Œæ˜¯ç”¨æˆ·å¯¹äºå­˜å‚¨éœ€æ±‚çš„ä¸€ç§å£°æ˜ã€‚æ¢å¥è¯è¯´ï¼ŒPVCå…¶å®å°±æ˜¯ç”¨æˆ·å‘kubernetesç³»ç»Ÿå‘å‡ºçš„ä¸€ç§èµ„æºéœ€æ±‚ç”³è¯·ã€‚</p>
<figure data-type="image" tabindex="44"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h2uh4jwj30uj0hu406.jpg" alt="img" loading="lazy"></figure>
<p>ä½¿ç”¨äº†PVå’ŒPVCä¹‹åï¼Œå·¥ä½œå¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥çš„ç»†åˆ†ï¼š</p>
<ul>
<li>å­˜å‚¨ï¼šå­˜å‚¨å·¥ç¨‹å¸ˆç»´æŠ¤</li>
<li>PVï¼š kubernetesç®¡ç†å‘˜ç»´æŠ¤</li>
<li>PVCï¼škubernetesç”¨æˆ·ç»´æŠ¤</li>
</ul>
<h3 id="821-pv">8.2.1 PV</h3>
<p>PVæ˜¯å­˜å‚¨èµ„æºçš„æŠ½è±¡ï¼Œä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p>
<pre><code class="language-yaml">apiVersion: v1  
kind: PersistentVolume
metadata:
  name: pv2
spec:
  nfs: # å­˜å‚¨ç±»å‹ï¼Œä¸åº•å±‚çœŸæ­£å­˜å‚¨å¯¹åº”
  capacity:  # å­˜å‚¨èƒ½åŠ›ï¼Œç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®
    storage: 2Gi
  accessModes:  # è®¿é—®æ¨¡å¼
  storageClassName: # å­˜å‚¨ç±»åˆ«
  persistentVolumeReclaimPolicy: # å›æ”¶ç­–ç•¥
</code></pre>
<p>PV çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>
<p><strong>å­˜å‚¨ç±»å‹</strong></p>
<p>åº•å±‚å®é™…å­˜å‚¨çš„ç±»å‹ï¼Œkubernetesæ”¯æŒå¤šç§å­˜å‚¨ç±»å‹ï¼Œæ¯ç§å­˜å‚¨ç±»å‹çš„é…ç½®éƒ½æœ‰æ‰€å·®å¼‚</p>
</li>
<li>
<p><strong>å­˜å‚¨èƒ½åŠ›ï¼ˆcapacityï¼‰</strong></p>
</li>
</ul>
<p>ç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®( storage=1Gi )ï¼Œä¸è¿‡æœªæ¥å¯èƒ½ä¼šåŠ å…¥IOPSã€ååé‡ç­‰æŒ‡æ ‡çš„é…ç½®</p>
<ul>
<li>
<p><strong>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</strong></p>
<p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š</p>
<ul>
<li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadOnlyManyï¼ˆROXï¼‰ï¼š åªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
</ul>
<p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„è®¿é—®æ¨¡å¼ä¸åŒ</code></p>
</li>
<li>
<p><strong>å›æ”¶ç­–ç•¥ï¼ˆpersistentVolumeReclaimPolicyï¼‰</strong></p>
<p>å½“PVä¸å†è¢«ä½¿ç”¨äº†ä¹‹åï¼Œå¯¹å…¶çš„å¤„ç†æ–¹å¼ã€‚ç›®å‰æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š</p>
<ul>
<li>Retain ï¼ˆä¿ç•™ï¼‰ ä¿ç•™æ•°æ®ï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹å·¥æ¸…ç†æ•°æ®</li>
<li>Recycleï¼ˆå›æ”¶ï¼‰ æ¸…é™¤ PV ä¸­çš„æ•°æ®ï¼Œæ•ˆæœç›¸å½“äºæ‰§è¡Œ rm -rf /thevolume/*</li>
<li>Delete ï¼ˆåˆ é™¤ï¼‰ ä¸ PV ç›¸è¿çš„åç«¯å­˜å‚¨å®Œæˆ volume çš„åˆ é™¤æ“ä½œï¼Œå½“ç„¶è¿™å¸¸è§äºäº‘æœåŠ¡å•†çš„å­˜å‚¨æœåŠ¡</li>
</ul>
<p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„å›æ”¶ç­–ç•¥ä¸åŒ</code></p>
</li>
<li>
<p><strong>å­˜å‚¨ç±»åˆ«</strong></p>
<p>PVå¯ä»¥é€šè¿‡storageClassNameå‚æ•°æŒ‡å®šä¸€ä¸ªå­˜å‚¨ç±»åˆ«</p>
<ul>
<li>å…·æœ‰ç‰¹å®šç±»åˆ«çš„PVåªèƒ½ä¸è¯·æ±‚äº†è¯¥ç±»åˆ«çš„PVCè¿›è¡Œç»‘å®š</li>
<li>æœªè®¾å®šç±»åˆ«çš„PVåˆ™åªèƒ½ä¸ä¸è¯·æ±‚ä»»ä½•ç±»åˆ«çš„PVCè¿›è¡Œç»‘å®š</li>
</ul>
</li>
<li>
<p><strong>çŠ¶æ€ï¼ˆstatusï¼‰</strong></p>
<p>ä¸€ä¸ª PV çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº4ä¸­ä¸åŒçš„é˜¶æ®µï¼š</p>
<ul>
<li>Availableï¼ˆå¯ç”¨ï¼‰ï¼š è¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š</li>
<li>Boundï¼ˆå·²ç»‘å®šï¼‰ï¼š è¡¨ç¤º PV å·²ç»è¢« PVC ç»‘å®š</li>
<li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼š è¡¨ç¤º PVC è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜</li>
<li>Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</li>
</ul>
</li>
</ul>
<p><strong>å®éªŒ</strong></p>
<p>ä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œæ¥æ¼”ç¤ºPVçš„ä½¿ç”¨ï¼Œåˆ›å»º3ä¸ªPVï¼Œå¯¹åº”NFSä¸­çš„3ä¸ªæš´éœ²çš„è·¯å¾„ã€‚</p>
<ol>
<li>å‡†å¤‡NFSç¯å¢ƒ</li>
</ol>
<pre><code class="language-shell"># åˆ›å»ºç›®å½•
[root@nfs ~]# mkdir /root/data/{pv1,pv2,pv3} -pv

# æš´éœ²æœåŠ¡
[root@nfs ~]# more /etc/exports
/root/data/pv1     192.168.5.0/24(rw,no_root_squash)
/root/data/pv2     192.168.5.0/24(rw,no_root_squash)
/root/data/pv3     192.168.5.0/24(rw,no_root_squash)

# é‡å¯æœåŠ¡
[root@nfs ~]#  systemctl restart nfs
</code></pre>
<ol start="2">
<li>åˆ›å»ºpv.yaml</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name:  pv1
spec:
  capacity: 
    storage: 1Gi
  accessModes:
  - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /root/data/pv1
    server: 192.168.5.6

---

apiVersion: v1
kind: PersistentVolume
metadata:
  name:  pv2
spec:
  capacity: 
    storage: 2Gi
  accessModes:
  - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /root/data/pv2
    server: 192.168.5.6
    
---

apiVersion: v1
kind: PersistentVolume
metadata:
  name:  pv3
spec:
  capacity: 
    storage: 3Gi
  accessModes:
  - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /root/data/pv3
    server: 192.168.5.6
</code></pre>
<pre><code class="language-shell"># åˆ›å»º pv
[root@k8s-master01 ~]# kubectl create -f pv.yaml
persistentvolume/pv1 created
persistentvolume/pv2 created
persistentvolume/pv3 created

# æŸ¥çœ‹pv
[root@k8s-master01 ~]# kubectl get pv -o wide
NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
pv1    1Gi        RWX            Retain        Available    10s   Filesystem
pv2    2Gi        RWX            Retain        Available    10s   Filesystem
pv3    3Gi        RWX            Retain        Available    9s    Filesystem
</code></pre>
<h3 id="822-pvc">8.2.2 PVC</h3>
<p>PVCæ˜¯èµ„æºçš„ç”³è¯·ï¼Œç”¨æ¥å£°æ˜å¯¹å­˜å‚¨ç©ºé—´ã€è®¿é—®æ¨¡å¼ã€å­˜å‚¨ç±»åˆ«éœ€æ±‚ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc
  namespace: dev
spec:
  accessModes: # è®¿é—®æ¨¡å¼
  selector: # é‡‡ç”¨æ ‡ç­¾å¯¹PVé€‰æ‹©
  storageClassName: # å­˜å‚¨ç±»åˆ«
  resources: # è¯·æ±‚ç©ºé—´
    requests:
      storage: 5Gi
</code></pre>
<p>PVC çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><strong>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</strong></li>
</ul>
<p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™</p>
<ul>
<li>
<p><strong>é€‰æ‹©æ¡ä»¶ï¼ˆselectorï¼‰</strong></p>
<p>é€šè¿‡Label Selectorçš„è®¾ç½®ï¼Œå¯ä½¿PVCå¯¹äºç³»ç»Ÿä¸­å·±å­˜åœ¨çš„PVè¿›è¡Œç­›é€‰</p>
</li>
<li>
<p><strong>å­˜å‚¨ç±»åˆ«ï¼ˆstorageClassNameï¼‰</strong></p>
<p>PVCåœ¨å®šä¹‰æ—¶å¯ä»¥è®¾å®šéœ€è¦çš„åç«¯å­˜å‚¨çš„ç±»åˆ«ï¼Œåªæœ‰è®¾ç½®äº†è¯¥classçš„pvæ‰èƒ½è¢«ç³»ç»Ÿé€‰å‡º</p>
</li>
<li>
<p><strong>èµ„æºè¯·æ±‚ï¼ˆResources ï¼‰</strong></p>
<p>æè¿°å¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚</p>
</li>
</ul>
<p><strong>å®éªŒ</strong></p>
<ol>
<li>åˆ›å»ºpvc.yamlï¼Œç”³è¯·pv</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc1
  namespace: dev
spec:
  accessModes: 
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc2
  namespace: dev
spec:
  accessModes: 
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc3
  namespace: dev
spec:
  accessModes: 
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpvc
[root@k8s-master01 ~]# kubectl create -f pvc.yaml
persistentvolumeclaim/pvc1 created
persistentvolumeclaim/pvc2 created
persistentvolumeclaim/pvc3 created

# æŸ¥çœ‹pvc
[root@k8s-master01 ~]# kubectl get pvc  -n dev -o wide
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem

# æŸ¥çœ‹pv
[root@k8s-master01 ~]# kubectl get pv -o wide
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem   
</code></pre>
<ol start="2">
<li>åˆ›å»ºpods.yaml, ä½¿ç”¨pv</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod1
  namespace: dev
spec:
  containers:
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&quot;]
    volumeMounts:
    - name: volume
      mountPath: /root/
  volumes:
    - name: volume
      persistentVolumeClaim:
        claimName: pvc1
        readOnly: false
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
  namespace: dev
spec:
  containers:
  - name: busybox
    image: busybox:1.30
    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&quot;]
    volumeMounts:
    - name: volume
      mountPath: /root/
  volumes:
    - name: volume
      persistentVolumeClaim:
        claimName: pvc2
        readOnly: false
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pods.yaml
pod/pod1 created
pod/pod2 created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pods -n dev -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   
pod1   1/1     Running   0          14s   10.244.1.69   node1   
pod2   1/1     Running   0          14s   10.244.1.70   node1  

# æŸ¥çœ‹pvc
[root@k8s-master01 ~]# kubectl get pvc -n dev -o wide
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem

# æŸ¥çœ‹pv
[root@k8s-master01 ~]# kubectl get pv -n dev -o wide
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem

# æŸ¥çœ‹nfsä¸­çš„æ–‡ä»¶å­˜å‚¨
[root@nfs ~]# more /root/data/pv1/out.txt
node1
node1
[root@nfs ~]# more /root/data/pv2/out.txt
node2
node2
</code></pre>
<h3 id="823-ç”Ÿå‘½å‘¨æœŸ">8.2.3 ç”Ÿå‘½å‘¨æœŸ</h3>
<p>PVCå’ŒPVæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ŒPVå’ŒPVCä¹‹é—´çš„ç›¸äº’ä½œç”¨éµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p>
<ul>
<li>
<p><strong>èµ„æºä¾›åº”</strong>ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºåº•å±‚å­˜å‚¨å’ŒPV</p>
</li>
<li>
<p><strong>èµ„æºç»‘å®š</strong>ï¼šç”¨æˆ·åˆ›å»ºPVCï¼Œkubernetesè´Ÿè´£æ ¹æ®PVCçš„å£°æ˜å»å¯»æ‰¾PVï¼Œå¹¶ç»‘å®š</p>
<p>åœ¨ç”¨æˆ·å®šä¹‰å¥½PVCä¹‹åï¼Œç³»ç»Ÿå°†æ ¹æ®PVCå¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚åœ¨å·²å­˜åœ¨çš„PVä¸­é€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„</p>
<ul>
<li>ä¸€æ—¦æ‰¾åˆ°ï¼Œå°±å°†è¯¥PVä¸ç”¨æˆ·å®šä¹‰çš„PVCè¿›è¡Œç»‘å®šï¼Œç”¨æˆ·çš„åº”ç”¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªPVCäº†</li>
<li>å¦‚æœæ‰¾ä¸åˆ°ï¼ŒPVCåˆ™ä¼šæ— é™æœŸå¤„äºPendingçŠ¶æ€ï¼Œç›´åˆ°ç­‰åˆ°ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºäº†ä¸€ä¸ªç¬¦åˆå…¶è¦æ±‚çš„PV</li>
</ul>
<p>PVä¸€æ—¦ç»‘å®šåˆ°æŸä¸ªPVCä¸Šï¼Œå°±ä¼šè¢«è¿™ä¸ªPVCç‹¬å ï¼Œä¸èƒ½å†ä¸å…¶ä»–PVCè¿›è¡Œç»‘å®šäº†</p>
</li>
<li>
<p><strong>èµ„æºä½¿ç”¨</strong>ï¼šç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvc</p>
<p>Podä½¿ç”¨Volumeçš„å®šä¹‰ï¼Œå°†PVCæŒ‚è½½åˆ°å®¹å™¨å†…çš„æŸä¸ªè·¯å¾„è¿›è¡Œä½¿ç”¨ã€‚</p>
</li>
<li>
<p><strong>èµ„æºé‡Šæ”¾</strong>ï¼šç”¨æˆ·åˆ é™¤pvcæ¥é‡Šæ”¾pv</p>
<p>å½“å­˜å‚¨èµ„æºä½¿ç”¨å®Œæ¯•åï¼Œç”¨æˆ·å¯ä»¥åˆ é™¤PVCï¼Œä¸è¯¥PVCç»‘å®šçš„PVå°†ä¼šè¢«æ ‡è®°ä¸ºâ€œå·²é‡Šæ”¾â€ï¼Œä½†è¿˜ä¸èƒ½ç«‹åˆ»ä¸å…¶ä»–PVCè¿›è¡Œç»‘å®šã€‚é€šè¿‡ä¹‹å‰PVCå†™å…¥çš„æ•°æ®å¯èƒ½è¿˜è¢«ç•™åœ¨å­˜å‚¨è®¾å¤‡ä¸Šï¼Œåªæœ‰åœ¨æ¸…é™¤ä¹‹åè¯¥PVæ‰èƒ½å†æ¬¡ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><strong>èµ„æºå›æ”¶</strong>ï¼škubernetesæ ¹æ®pvè®¾ç½®çš„å›æ”¶ç­–ç•¥è¿›è¡Œèµ„æºçš„å›æ”¶</p>
<p>å¯¹äºPVï¼Œç®¡ç†å‘˜å¯ä»¥è®¾å®šå›æ”¶ç­–ç•¥ï¼Œç”¨äºè®¾ç½®ä¸ä¹‹ç»‘å®šçš„PVCé‡Šæ”¾èµ„æºä¹‹åå¦‚ä½•å¤„ç†é—ç•™æ•°æ®çš„é—®é¢˜ã€‚åªæœ‰PVçš„å­˜å‚¨ç©ºé—´å®Œæˆå›æ”¶ï¼Œæ‰èƒ½ä¾›æ–°çš„PVCç»‘å®šå’Œä½¿ç”¨</p>
</li>
</ul>
<figure data-type="image" tabindex="45"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h31cz9bj30xv0f20vb.jpg" alt="img" loading="lazy"></figure>
<h2 id="83-é…ç½®å­˜å‚¨">8.3 é…ç½®å­˜å‚¨</h2>
<h3 id="831-configmap">8.3.1 ConfigMap</h3>
<p>ConfigMapæ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„å­˜å‚¨å·ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å­˜å‚¨é…ç½®ä¿¡æ¯çš„ã€‚</p>
<p>åˆ›å»ºconfigmap.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: configmap
  namespace: dev
data:
  info: |
    username:admin
    password:123456
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶åˆ›å»ºconfigmap</p>
<pre><code class="language-shell"># åˆ›å»ºconfigmap
[root@k8s-master01 ~]# kubectl create -f configmap.yaml
configmap/configmap created

# æŸ¥çœ‹configmapè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe cm configmap -n dev
Name:         configmap
Namespace:    dev
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
info:
----
username:admin
password:123456

Events:  &lt;none&gt;
</code></pre>
<p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªpod-configmap.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„configmapæŒ‚è½½è¿›å»</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-configmap
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    volumeMounts: # å°†configmapæŒ‚è½½åˆ°ç›®å½•
    - name: config
      mountPath: /configmap/config
  volumes: # å¼•ç”¨configmap
  - name: config
    configMap:
      name: configmap
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-configmap.yaml
pod/pod-configmap created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pod pod-configmap -n dev
NAME            READY   STATUS    RESTARTS   AGE
pod-configmap   1/1     Running   0          6s

#è¿›å…¥å®¹å™¨
[root@k8s-master01 ~]# kubectl exec -it pod-configmap -n dev /bin/sh
# cd /configmap/config/
# ls
info
# more info
username:admin
password:123456

# å¯ä»¥çœ‹åˆ°æ˜ å°„å·²ç»æˆåŠŸï¼Œæ¯ä¸ªconfigmapéƒ½æ˜ å°„æˆäº†ä¸€ä¸ªç›®å½•
# key---&gt;æ–‡ä»¶     value----&gt;æ–‡ä»¶ä¸­çš„å†…å®¹
# æ­¤æ—¶å¦‚æœæ›´æ–°configmapçš„å†…å®¹, å®¹å™¨ä¸­çš„å€¼ä¹Ÿä¼šåŠ¨æ€æ›´æ–°
</code></pre>
<h3 id="832-secret">8.3.2 Secret</h3>
<p>åœ¨kubernetesä¸­ï¼Œè¿˜å­˜åœ¨ä¸€ç§å’ŒConfigMapéå¸¸ç±»ä¼¼çš„å¯¹è±¡ï¼Œç§°ä¸ºSecretå¯¹è±¡ã€‚å®ƒä¸»è¦ç”¨äºå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€ç§˜é’¥ã€è¯ä¹¦ç­‰ç­‰ã€‚</p>
<ol>
<li>é¦–å…ˆä½¿ç”¨base64å¯¹æ•°æ®è¿›è¡Œç¼–ç </li>
</ol>
<pre><code class="language-shell">[root@k8s-master01 ~]# echo -n 'admin' | base64 #å‡†å¤‡username
YWRtaW4=
[root@k8s-master01 ~]# echo -n '123456' | base64 #å‡†å¤‡password
MTIzNDU2
</code></pre>
<ol start="2">
<li>æ¥ä¸‹æ¥ç¼–å†™secret.yamlï¼Œå¹¶åˆ›å»ºSecret</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: secret
  namespace: dev
type: Opaque
data:
  username: YWRtaW4=
  password: MTIzNDU2
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºsecret
[root@k8s-master01 ~]# kubectl create -f secret.yaml
secret/secret created

# æŸ¥çœ‹secretè¯¦æƒ…
[root@k8s-master01 ~]# kubectl describe secret secret -n dev
Name:         secret
Namespace:    dev
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Type:  Opaque
Data
====
password:  6 bytes
username:  5 bytes
</code></pre>
<ol start="3">
<li>åˆ›å»ºpod-secret.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„secretæŒ‚è½½è¿›å»ï¼š</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod-secret
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    volumeMounts: # å°†secretæŒ‚è½½åˆ°ç›®å½•
    - name: config
      mountPath: /secret/config
  volumes:
  - name: config
    secret:
      secretName: secret
</code></pre>
<pre><code class="language-shell"># åˆ›å»ºpod
[root@k8s-master01 ~]# kubectl create -f pod-secret.yaml
pod/pod-secret created

# æŸ¥çœ‹pod
[root@k8s-master01 ~]# kubectl get pod pod-secret -n dev
NAME            READY   STATUS    RESTARTS   AGE
pod-secret      1/1     Running   0          2m28s

# è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹secretä¿¡æ¯ï¼Œå‘ç°å·²ç»è‡ªåŠ¨è§£ç äº†
[root@k8s-master01 ~]# kubectl exec -it pod-secret /bin/sh -n dev
/ # ls /secret/config/
password  username
/ # more /secret/config/username
admin
/ # more /secret/config/password
123456
</code></pre>
<p>è‡³æ­¤ï¼Œå·²ç»å®ç°äº†åˆ©ç”¨secretå®ç°äº†ä¿¡æ¯çš„ç¼–ç ã€‚</p>
<h1 id="9-å®‰å…¨è®¤è¯">9. å®‰å…¨è®¤è¯</h1>
<h2 id="91-è®¿é—®æ§åˆ¶æ¦‚è¿°">9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°</h2>
<p>Kubernetesä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯å…¶ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡ã€‚æ‰€è°“çš„å®‰å…¨æ€§å…¶å®å°±æ˜¯ä¿è¯å¯¹Kubernetesçš„å„ç§<strong>å®¢æˆ·ç«¯</strong>è¿›è¡Œ<strong>è®¤è¯å’Œé‰´æƒ</strong>æ“ä½œã€‚</p>
<p><strong>å®¢æˆ·ç«¯</strong></p>
<p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œå®¢æˆ·ç«¯é€šå¸¸æœ‰ä¸¤ç±»ï¼š</p>
<ul>
<li><strong>User Account</strong>ï¼šä¸€èˆ¬æ˜¯ç‹¬ç«‹äºkubernetesä¹‹å¤–çš„å…¶ä»–æœåŠ¡ç®¡ç†çš„ç”¨æˆ·è´¦å·ã€‚</li>
<li><strong>Service Account</strong>ï¼škubernetesç®¡ç†çš„è´¦å·ï¼Œç”¨äºä¸ºPodä¸­çš„æœåŠ¡è¿›ç¨‹åœ¨è®¿é—®Kubernetesæ—¶æä¾›èº«ä»½æ ‡è¯†ã€‚</li>
</ul>
<figure data-type="image" tabindex="46"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3748alj30nt07z0tg.jpg" alt="img" loading="lazy"></figure>
<p><strong>è®¤è¯ã€æˆæƒä¸å‡†å…¥æ§åˆ¶</strong></p>
<p>ApiServeræ˜¯è®¿é—®åŠç®¡ç†èµ„æºå¯¹è±¡çš„å”¯ä¸€å…¥å£ã€‚ä»»ä½•ä¸€ä¸ªè¯·æ±‚è®¿é—®ApiServerï¼Œéƒ½è¦ç»è¿‡ä¸‹é¢ä¸‰ä¸ªæµç¨‹ï¼š</p>
<ul>
<li>Authenticationï¼ˆè®¤è¯ï¼‰ï¼šèº«ä»½é‰´åˆ«ï¼Œåªæœ‰æ­£ç¡®çš„è´¦å·æ‰èƒ½å¤Ÿé€šè¿‡è®¤è¯</li>
<li>Authorizationï¼ˆæˆæƒï¼‰ï¼š åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å¯¹è®¿é—®çš„èµ„æºæ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ</li>
<li>Admission Controlï¼ˆå‡†å…¥æ§åˆ¶ï¼‰ï¼šç”¨äºè¡¥å……æˆæƒæœºåˆ¶ä»¥å®ç°æ›´åŠ ç²¾ç»†çš„è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚</li>
</ul>
<figure data-type="image" tabindex="47"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3bvb48j30s905ygmc.jpg" alt="img" loading="lazy"></figure>
<h2 id="92-è®¤è¯ç®¡ç†">9.2 è®¤è¯ç®¡ç†</h2>
<p>Kubernetesé›†ç¾¤å®‰å…¨çš„æœ€å…³é”®ç‚¹åœ¨äºå¦‚ä½•è¯†åˆ«å¹¶è®¤è¯å®¢æˆ·ç«¯èº«ä»½ï¼Œå®ƒæä¾›äº†3ç§å®¢æˆ·ç«¯èº«ä»½è®¤è¯æ–¹å¼ï¼š</p>
<ul>
<li>
<p>HTTP Baseè®¤è¯ï¼šé€šè¿‡ç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯</p>
<pre><code>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯æŠŠâ€œç”¨æˆ·å:å¯†ç â€ç”¨BASE64ç®—æ³•è¿›è¡Œç¼–ç åçš„å­—ç¬¦ä¸²æ”¾åœ¨HTTPè¯·æ±‚ä¸­çš„Header AuthorizationåŸŸé‡Œå‘é€ç»™æœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ”¶åˆ°åè¿›è¡Œè§£ç ï¼Œè·å–ç”¨æˆ·ååŠå¯†ç ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚
</code></pre>
</li>
<li>
<p>HTTP Tokenè®¤è¯ï¼šé€šè¿‡ä¸€ä¸ªTokenæ¥è¯†åˆ«åˆæ³•ç”¨æˆ·</p>
<pre><code>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªå¾ˆé•¿çš„éš¾ä»¥è¢«æ¨¡ä»¿çš„å­—ç¬¦ä¸²--Tokenæ¥è¡¨æ˜å®¢æˆ·èº«ä»½çš„ä¸€ç§æ–¹å¼ã€‚æ¯ä¸ªTokenå¯¹åº”ä¸€ä¸ªç”¨æˆ·åï¼Œå½“å®¢æˆ·ç«¯å‘èµ·APIè°ƒç”¨è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨HTTP Headeré‡Œæ”¾å…¥Tokenï¼ŒAPI Serveræ¥åˆ°Tokenåä¼šè·ŸæœåŠ¡å™¨ä¸­ä¿å­˜çš„tokenè¿›è¡Œæ¯”å¯¹ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚
</code></pre>
</li>
<li>
<p>HTTPSè¯ä¹¦è®¤è¯ï¼šåŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼</p>
<pre><code>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯å®‰å…¨æ€§æœ€é«˜çš„ä¸€ç§æ–¹å¼ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ˜¯æ“ä½œèµ·æ¥æœ€éº»çƒ¦çš„ä¸€ç§æ–¹å¼ã€‚
</code></pre>
</li>
</ul>
<figure data-type="image" tabindex="48"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3fh42nj30r80djdha.jpg" alt="img" loading="lazy"></figure>
<p><strong>HTTPSè®¤è¯å¤§ä½“åˆ†ä¸º3ä¸ªè¿‡ç¨‹ï¼š</strong></p>
<ol>
<li>
<p>è¯ä¹¦ç”³è¯·å’Œä¸‹å‘</p>
<pre><code>  HTTPSé€šä¿¡åŒæ–¹çš„æœåŠ¡å™¨å‘CAæœºæ„ç”³è¯·è¯ä¹¦ï¼ŒCAæœºæ„ä¸‹å‘æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦åŠç§é’¥ç»™ç”³è¯·è€…
</code></pre>
</li>
<li>
<p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒå‘è®¤è¯</p>
<pre><code>  1&gt; å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¸‹å‘è‡ªå·±çš„è¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼Œ
     å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œåœ¨è¯ä¹¦ä¸­è·å¾—æœåŠ¡ç«¯çš„å…¬é’¥ï¼Œ
     å®¢æˆ·ç«¯åˆ©ç”¨æœåŠ¡å™¨ç«¯çš„å…¬é’¥è®¤è¯è¯ä¹¦ä¸­çš„ä¿¡æ¯ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™è®¤å¯è¿™ä¸ªæœåŠ¡å™¨
  2&gt; å®¢æˆ·ç«¯å‘é€è‡ªå·±çš„è¯ä¹¦ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œ
     åœ¨è¯ä¹¦ä¸­è·å¾—å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œå¹¶ç”¨è¯¥å…¬é’¥è®¤è¯è¯ä¹¦ä¿¡æ¯ï¼Œç¡®è®¤å®¢æˆ·ç«¯æ˜¯å¦åˆæ³•
</code></pre>
</li>
<li>
<p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡</p>
<pre><code>  æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åå•†å¥½åŠ å¯†æ–¹æ¡ˆåï¼Œå®¢æˆ·ç«¯ä¼šäº§ç”Ÿä¸€ä¸ªéšæœºçš„ç§˜é’¥å¹¶åŠ å¯†ï¼Œç„¶åå‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚
  æœåŠ¡å™¨ç«¯æ¥æ”¶è¿™ä¸ªç§˜é’¥åï¼ŒåŒæ–¹æ¥ä¸‹æ¥é€šä¿¡çš„æ‰€æœ‰å†…å®¹éƒ½é€šè¿‡è¯¥éšæœºç§˜é’¥åŠ å¯†
</code></pre>
</li>
</ol>
<blockquote>
<p>æ³¨æ„: Kuberneteså…è®¸åŒæ—¶é…ç½®å¤šç§è®¤è¯æ–¹å¼ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ–¹å¼è®¤è¯é€šè¿‡å³å¯</p>
</blockquote>
<h2 id="93-æˆæƒç®¡ç†">9.3 æˆæƒç®¡ç†</h2>
<p>æˆæƒå‘ç”Ÿåœ¨è®¤è¯æˆåŠŸä¹‹åï¼Œé€šè¿‡è®¤è¯å°±å¯ä»¥çŸ¥é“è¯·æ±‚ç”¨æˆ·æ˜¯è°ï¼Œ ç„¶åKubernetesä¼šæ ¹æ®äº‹å…ˆå®šä¹‰çš„æˆæƒç­–ç•¥æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¸ºæˆæƒã€‚</p>
<p>æ¯ä¸ªå‘é€åˆ°ApiServerçš„è¯·æ±‚éƒ½å¸¦ä¸Šäº†ç”¨æˆ·å’Œèµ„æºçš„ä¿¡æ¯ï¼šæ¯”å¦‚å‘é€è¯·æ±‚çš„ç”¨æˆ·ã€è¯·æ±‚çš„è·¯å¾„ã€è¯·æ±‚çš„åŠ¨ä½œç­‰ï¼Œæˆæƒå°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯å’Œæˆæƒç­–ç•¥è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç¬¦åˆç­–ç•¥ï¼Œåˆ™è®¤ä¸ºæˆæƒé€šè¿‡ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯ã€‚</p>
<p>API Serverç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æˆæƒç­–ç•¥ï¼š</p>
<ul>
<li>AlwaysDenyï¼šè¡¨ç¤ºæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li>
<li>AlwaysAllowï¼šå…è®¸æ¥æ”¶æ‰€æœ‰è¯·æ±‚ï¼Œç›¸å½“äºé›†ç¾¤ä¸éœ€è¦æˆæƒæµç¨‹ï¼ˆKubernetesé»˜è®¤çš„ç­–ç•¥ï¼‰</li>
<li>ABACï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œè¡¨ç¤ºä½¿ç”¨ç”¨æˆ·é…ç½®çš„æˆæƒè§„åˆ™å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡ŒåŒ¹é…å’Œæ§åˆ¶</li>
<li>Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨RESTæœåŠ¡å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒ</li>
<li>Nodeï¼šæ˜¯ä¸€ç§ä¸“ç”¨æ¨¡å¼ï¼Œç”¨äºå¯¹kubeletå‘å‡ºçš„è¯·æ±‚è¿›è¡Œè®¿é—®æ§åˆ¶</li>
<li>RBACï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆkubeadmå®‰è£…æ–¹å¼ä¸‹çš„é»˜è®¤é€‰é¡¹ï¼‰</li>
</ul>
<p>RBAC(Role-Based Access Control) åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œä¸»è¦æ˜¯åœ¨æè¿°ä¸€ä»¶äº‹æƒ…ï¼š<strong>ç»™å“ªäº›å¯¹è±¡æˆäºˆäº†å“ªäº›æƒé™</strong></p>
<p>å…¶ä¸­æ¶‰åŠåˆ°äº†ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>å¯¹è±¡ï¼šUserã€Groupsã€ServiceAccount</li>
<li>è§’è‰²ï¼šä»£è¡¨ç€ä¸€ç»„å®šä¹‰åœ¨èµ„æºä¸Šçš„å¯æ“ä½œåŠ¨ä½œ(æƒé™)çš„é›†åˆ</li>
<li>ç»‘å®šï¼šå°†å®šä¹‰å¥½çš„è§’è‰²è·Ÿç”¨æˆ·ç»‘å®šåœ¨ä¸€èµ·</li>
</ul>
<figure data-type="image" tabindex="49"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3k7lzcj30pb0cwmyj.jpg" alt="img" loading="lazy"></figure>
<p>RBACå¼•å…¥äº†4ä¸ªé¡¶çº§èµ„æºå¯¹è±¡ï¼š</p>
<ul>
<li>Roleã€ClusterRoleï¼šè§’è‰²ï¼Œç”¨äºæŒ‡å®šä¸€ç»„æƒé™</li>
<li>RoleBindingã€ClusterRoleBindingï¼šè§’è‰²ç»‘å®šï¼Œç”¨äºå°†è§’è‰²ï¼ˆæƒé™ï¼‰èµ‹äºˆç»™å¯¹è±¡</li>
</ul>
<p><strong>Roleã€ClusterRole</strong></p>
<p>ä¸€ä¸ªè§’è‰²å°±æ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œè¿™é‡Œçš„æƒé™éƒ½æ˜¯è®¸å¯å½¢å¼çš„ï¼ˆç™½åå•ï¼‰ã€‚</p>
<pre><code class="language-yaml"># Roleåªèƒ½å¯¹å‘½åç©ºé—´å†…çš„èµ„æºè¿›è¡Œæˆæƒï¼Œéœ€è¦æŒ‡å®šnameapce
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: dev
  name: authorization-role
rules:
- apiGroups: [&quot;&quot;]  # æ”¯æŒçš„APIç»„åˆ—è¡¨,&quot;&quot; ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ ¸å¿ƒAPIç¾¤
  resources: [&quot;pods&quot;] # æ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] # å…è®¸çš„å¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨
</code></pre>
<pre><code class="language-yaml"># ClusterRoleå¯ä»¥å¯¹é›†ç¾¤èŒƒå›´å†…èµ„æºã€è·¨namespacesçš„èŒƒå›´èµ„æºã€éèµ„æºç±»å‹è¿›è¡Œæˆæƒ
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
 name: authorization-clusterrole
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
</code></pre>
<p>éœ€è¦è¯¦ç»†è¯´æ˜çš„æ˜¯ï¼Œrulesä¸­çš„å‚æ•°ï¼š</p>
<ul>
<li>
<p>apiGroups: æ”¯æŒçš„APIç»„åˆ—è¡¨</p>
<pre><code>&quot;&quot;,&quot;apps&quot;, &quot;autoscaling&quot;, &quot;batch&quot;
</code></pre>
</li>
<li>
<p>resourcesï¼šæ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨</p>
<pre><code>&quot;services&quot;, &quot;endpoints&quot;, &quot;pods&quot;,&quot;secrets&quot;,&quot;configmaps&quot;,&quot;crontabs&quot;,&quot;deployments&quot;,&quot;jobs&quot;,
&quot;nodes&quot;,&quot;rolebindings&quot;,&quot;clusterroles&quot;,&quot;daemonsets&quot;,&quot;replicasets&quot;,&quot;statefulsets&quot;,
&quot;horizontalpodautoscalers&quot;,&quot;replicationcontrollers&quot;,&quot;cronjobs&quot;
</code></pre>
</li>
<li>
<p>verbsï¼šå¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨</p>
<pre><code>&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;, &quot;exec&quot;
</code></pre>
</li>
</ul>
<p><strong>RoleBindingã€ClusterRoleBinding</strong></p>
<p>è§’è‰²ç»‘å®šç”¨æ¥æŠŠä¸€ä¸ªè§’è‰²ç»‘å®šåˆ°ä¸€ä¸ªç›®æ ‡å¯¹è±¡ä¸Šï¼Œç»‘å®šç›®æ ‡å¯ä»¥æ˜¯Userã€Groupæˆ–è€…ServiceAccountã€‚</p>
<pre><code class="language-yaml"># RoleBindingå¯ä»¥å°†åŒä¸€namespaceä¸­çš„subjectç»‘å®šåˆ°æŸä¸ªRoleä¸‹ï¼Œåˆ™æ­¤subjectå³å…·æœ‰è¯¥Roleå®šä¹‰çš„æƒé™
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: authorization-role-binding
  namespace: dev
subjects:
- kind: User
  name: heima
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: authorization-role
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<pre><code class="language-yaml"># ClusterRoleBindingåœ¨æ•´ä¸ªé›†ç¾¤çº§åˆ«å’Œæ‰€æœ‰namespaceså°†ç‰¹å®šçš„subjectä¸ClusterRoleç»‘å®šï¼Œæˆäºˆæƒé™
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
 name: authorization-clusterrole-binding
subjects:
- kind: User
  name: heima
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: authorization-clusterrole
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<p><strong>RoleBindingå¼•ç”¨ClusterRoleè¿›è¡Œæˆæƒ</strong></p>
<p>RoleBindingå¯ä»¥å¼•ç”¨ClusterRoleï¼Œå¯¹å±äºåŒä¸€å‘½åç©ºé—´å†…ClusterRoleå®šä¹‰çš„èµ„æºä¸»ä½“è¿›è¡Œæˆæƒã€‚</p>
<pre><code>    ä¸€ç§å¾ˆå¸¸ç”¨çš„åšæ³•å°±æ˜¯ï¼Œé›†ç¾¤ç®¡ç†å‘˜ä¸ºé›†ç¾¤èŒƒå›´é¢„å®šä¹‰å¥½ä¸€ç»„è§’è‰²ï¼ˆClusterRoleï¼‰ï¼Œç„¶ååœ¨å¤šä¸ªå‘½åç©ºé—´ä¸­é‡å¤ä½¿ç”¨è¿™äº›ClusterRoleã€‚è¿™æ ·å¯ä»¥å¤§å¹…æé«˜æˆæƒç®¡ç†å·¥ä½œæ•ˆç‡ï¼Œä¹Ÿä½¿å¾—å„ä¸ªå‘½åç©ºé—´ä¸‹çš„åŸºç¡€æ€§æˆæƒè§„åˆ™ä¸ä½¿ç”¨ä½“éªŒä¿æŒä¸€è‡´ã€‚
</code></pre>
<pre><code class="language-yaml"># è™½ç„¶authorization-clusterroleæ˜¯ä¸€ä¸ªé›†ç¾¤è§’è‰²ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨äº†RoleBinding
# æ‰€ä»¥heimaåªèƒ½è¯»å–devå‘½åç©ºé—´ä¸­çš„èµ„æº
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: authorization-role-binding-ns
  namespace: dev
subjects:
- kind: User
  name: heima
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: authorization-clusterrole
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<p><strong>å®æˆ˜ï¼šåˆ›å»ºä¸€ä¸ªåªèƒ½ç®¡ç†devç©ºé—´ä¸‹Podsèµ„æºçš„è´¦å·</strong></p>
<ol>
<li>åˆ›å»ºè´¦å·</li>
</ol>
<pre><code class="language-shell"># 1) åˆ›å»ºè¯ä¹¦
[root@k8s-master01 pki]# cd /etc/kubernetes/pki/
[root@k8s-master01 pki]# (umask 077;openssl genrsa -out devman.key 2048)

# 2) ç”¨apiserverçš„è¯ä¹¦å»ç­¾ç½²
# 2-1) ç­¾åç”³è¯·ï¼Œç”³è¯·çš„ç”¨æˆ·æ˜¯devman,ç»„æ˜¯devgroup
[root@k8s-master01 pki]# openssl req -new -key devman.key -out devman.csr -subj &quot;/CN=devman/O=devgroup&quot;     
# 2-2) ç­¾ç½²è¯ä¹¦
[root@k8s-master01 pki]# openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650

# 3) è®¾ç½®é›†ç¾¤ã€ç”¨æˆ·ã€ä¸Šä¸‹æ–‡ä¿¡æ¯
[root@k8s-master01 pki]# kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443

[root@k8s-master01 pki]# kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key

[root@k8s-master01 pki]# kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman

# åˆ‡æ¢è´¦æˆ·åˆ°devman
[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes
Switched to context &quot;devman@kubernetes&quot;.

# æŸ¥çœ‹devä¸‹podï¼Œå‘ç°æ²¡æœ‰æƒé™
[root@k8s-master01 pki]# kubectl get pods -n dev
Error from server (Forbidden): pods is forbidden: User &quot;devman&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;dev&quot;

# åˆ‡æ¢åˆ°adminè´¦æˆ·
[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes
Switched to context &quot;kubernetes-admin@kubernetes&quot;.
</code></pre>
<p>2ï¼‰ åˆ›å»ºRoleå’ŒRoleBindingï¼Œä¸ºdevmanç”¨æˆ·æˆæƒ</p>
<pre><code class="language-yaml">kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: dev
  name: dev-role
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
  
---

kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: authorization-role-binding
  namespace: dev
subjects:
- kind: User
  name: devman
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: dev-role
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<pre><code class="language-shell">[root@k8s-master01 pki]# kubectl create -f dev-role.yaml
role.rbac.authorization.k8s.io/dev-role created
rolebinding.rbac.authorization.k8s.io/authorization-role-binding created
</code></pre>
<ol start="3">
<li>åˆ‡æ¢è´¦æˆ·ï¼Œå†æ¬¡éªŒè¯</li>
</ol>
<pre><code class="language-shell"># åˆ‡æ¢è´¦æˆ·åˆ°devman
[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes
Switched to context &quot;devman@kubernetes&quot;.

# å†æ¬¡æŸ¥çœ‹
[root@k8s-master01 pki]# kubectl get pods -n dev
NAME                                 READY   STATUS             RESTARTS   AGE
nginx-deployment-66cb59b984-8wp2k    1/1     Running            0          4d1h
nginx-deployment-66cb59b984-dc46j    1/1     Running            0          4d1h
nginx-deployment-66cb59b984-thfck    1/1     Running            0          4d1h

# ä¸ºäº†ä¸å½±å“åé¢çš„å­¦ä¹ ,åˆ‡å›adminè´¦æˆ·
[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes
Switched to context &quot;kubernetes-admin@kubernetes&quot;.
</code></pre>
<h2 id="94-å‡†å…¥æ§åˆ¶">9.4 å‡†å…¥æ§åˆ¶</h2>
<p>é€šè¿‡äº†å‰é¢çš„è®¤è¯å’Œæˆæƒä¹‹åï¼Œè¿˜éœ€è¦ç»è¿‡å‡†å…¥æ§åˆ¶å¤„ç†é€šè¿‡ä¹‹åï¼Œapiserveræ‰ä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p>
<p>å‡†å…¥æ§åˆ¶æ˜¯ä¸€ä¸ªå¯é…ç½®çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡åœ¨Api-Serverä¸Šé€šè¿‡å‘½ä»¤è¡Œè®¾ç½®é€‰æ‹©æ‰§è¡Œå“ªäº›å‡†å…¥æ§åˆ¶å™¨ï¼š</p>
<pre><code>--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</code></pre>
<p>åªæœ‰å½“æ‰€æœ‰çš„å‡†å…¥æ§åˆ¶å™¨éƒ½æ£€æŸ¥é€šè¿‡ä¹‹åï¼Œapiserveræ‰æ‰§è¡Œè¯¥è¯·æ±‚ï¼Œå¦åˆ™è¿”å›æ‹’ç»ã€‚</p>
<p>å½“å‰å¯é…ç½®çš„Admission Controlå‡†å…¥æ§åˆ¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>AlwaysAdmitï¼šå…è®¸æ‰€æœ‰è¯·æ±‚</li>
<li>AlwaysDenyï¼šç¦æ­¢æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li>
<li>AlwaysPullImagesï¼šåœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ€»å»ä¸‹è½½é•œåƒ</li>
<li>DenyExecOnPrivilegedï¼šå®ƒä¼šæ‹¦æˆªæ‰€æœ‰æƒ³åœ¨Privileged Containerä¸Šæ‰§è¡Œå‘½ä»¤çš„è¯·æ±‚</li>
<li>ImagePolicyWebhookï¼šè¿™ä¸ªæ’ä»¶å°†å…è®¸åç«¯çš„ä¸€ä¸ªWebhookç¨‹åºæ¥å®Œæˆadmission controllerçš„åŠŸèƒ½ã€‚</li>
<li>Service Accountï¼šå®ç°ServiceAccountå®ç°äº†è‡ªåŠ¨åŒ–</li>
<li>SecurityContextDenyï¼šè¿™ä¸ªæ’ä»¶å°†ä½¿ç”¨SecurityContextçš„Podä¸­çš„å®šä¹‰å…¨éƒ¨å¤±æ•ˆ</li>
<li>ResourceQuotaï¼šç”¨äºèµ„æºé…é¢ç®¡ç†ç›®çš„ï¼Œè§‚å¯Ÿæ‰€æœ‰è¯·æ±‚ï¼Œç¡®ä¿åœ¨namespaceä¸Šçš„é…é¢ä¸ä¼šè¶…æ ‡</li>
<li>LimitRangerï¼šç”¨äºèµ„æºé™åˆ¶ç®¡ç†ï¼Œä½œç”¨äºnamespaceä¸Šï¼Œç¡®ä¿å¯¹Podè¿›è¡Œèµ„æºé™åˆ¶</li>
<li>InitialResourcesï¼šä¸ºæœªè®¾ç½®èµ„æºè¯·æ±‚ä¸é™åˆ¶çš„Podï¼Œæ ¹æ®å…¶é•œåƒçš„å†å²èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œè®¾ç½®</li>
<li>NamespaceLifecycleï¼šå¦‚æœå°è¯•åœ¨ä¸€ä¸ªä¸å­˜åœ¨çš„namespaceä¸­åˆ›å»ºèµ„æºå¯¹è±¡ï¼Œåˆ™è¯¥åˆ›å»ºè¯·æ±‚å°†è¢«æ‹’ç»ã€‚å½“åˆ é™¤ä¸€ä¸ªnamespaceæ—¶ï¼Œç³»ç»Ÿå°†ä¼šåˆ é™¤è¯¥namespaceä¸­æ‰€æœ‰å¯¹è±¡ã€‚</li>
<li>DefaultStorageClassï¼šä¸ºäº†å®ç°å…±äº«å­˜å‚¨çš„åŠ¨æ€ä¾›åº”ï¼Œä¸ºæœªæŒ‡å®šStorageClassæˆ–PVçš„PVCå°è¯•åŒ¹é…é»˜è®¤çš„StorageClassï¼Œå°½å¯èƒ½å‡å°‘ç”¨æˆ·åœ¨ç”³è¯·PVCæ—¶æ‰€éœ€äº†è§£çš„åç«¯å­˜å‚¨ç»†èŠ‚</li>
<li>DefaultTolerationSecondsï¼šè¿™ä¸ªæ’ä»¶ä¸ºé‚£äº›æ²¡æœ‰è®¾ç½®forgiveness tolerationså¹¶å…·æœ‰notready:NoExecuteå’Œunreachable:NoExecuteä¸¤ç§taintsçš„Podè®¾ç½®é»˜è®¤çš„â€œå®¹å¿â€æ—¶é—´ï¼Œä¸º5min</li>
<li>PodSecurityPolicyï¼šè¿™ä¸ªæ’ä»¶ç”¨äºåœ¨åˆ›å»ºæˆ–ä¿®æ”¹Podæ—¶å†³å®šæ˜¯å¦æ ¹æ®Podçš„security contextå’Œå¯ç”¨çš„PodSecurityPolicyå¯¹Podçš„å®‰å…¨ç­–ç•¥è¿›è¡Œæ§åˆ¶</li>
</ul>
<h1 id="10-dashboard">10. DashBoard</h1>
<p>ä¹‹å‰åœ¨kubernetesä¸­å®Œæˆçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯é€šè¿‡å‘½ä»¤è¡Œå·¥å…·kubectlå®Œæˆçš„ã€‚å…¶å®ï¼Œä¸ºäº†æä¾›æ›´ä¸°å¯Œçš„ç”¨æˆ·ä½“éªŒï¼Œkubernetesè¿˜å¼€å‘äº†ä¸€ä¸ªåŸºäºwebçš„ç”¨æˆ·ç•Œé¢ï¼ˆDashboardï¼‰ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨Dashboardéƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ï¼Œè¿˜å¯ä»¥ç›‘æ§åº”ç”¨çš„çŠ¶æ€ï¼Œæ‰§è¡Œæ•…éšœæ’æŸ¥ä»¥åŠç®¡ç†kubernetesä¸­å„ç§èµ„æºã€‚</p>
<h2 id="101-éƒ¨ç½²dashboard">10.1 éƒ¨ç½²Dashboard</h2>
<ol>
<li>ä¸‹è½½yamlï¼Œå¹¶è¿è¡ŒDashboard</li>
</ol>
<pre><code class="language-shell"># ä¸‹è½½yaml
[root@k8s-master01 ~]# wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml

# ä¿®æ”¹kubernetes-dashboardçš„Serviceç±»å‹
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  # æ–°å¢
  ports:
    - port: 443
      targetPort: 8443
      nodePort: 30009  # æ–°å¢
  selector:
    k8s-app: kubernetes-dashboard

# éƒ¨ç½²
[root@k8s-master01 ~]# kubectl create -f recommended.yaml

# æŸ¥çœ‹namespaceä¸‹çš„kubernetes-dashboardä¸‹çš„èµ„æº
[root@k8s-master01 ~]# kubectl get pod,svc -n kubernetes-dashboard
NAME                                            READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   1/1     Running   0          111s
pod/kubernetes-dashboard-56484d4c5-z95z5        1/1     Running   0          111s

NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)         AGE
service/dashboard-metrics-scraper  ClusterIP  10.96.89.218    &lt;none&gt;       8000/TCP        111s
service/kubernetes-dashboard       NodePort   10.104.178.171  &lt;none&gt;       443:30009/TCP   111s
</code></pre>
<p>2ï¼‰åˆ›å»ºè®¿é—®è´¦æˆ·ï¼Œè·å–token</p>
<pre><code class="language-shell"># åˆ›å»ºè´¦å·
[root@k8s-master01-1 ~]# kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard

# æˆæƒ
[root@k8s-master01-1 ~]# kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin

# è·å–è´¦å·token
[root@k8s-master01 ~]#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin
dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   3      2m35s

[root@k8s-master01 ~]# kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard
Name:         dashboard-admin-token-xbqhh
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039

Type:  kubernetes.io/service-account-token

Data
====
namespace:  20 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw
ca.crt:     1025 bytes
</code></pre>
<p>3ï¼‰é€šè¿‡æµè§ˆå™¨è®¿é—®Dashboardçš„UI</p>
<p>åœ¨ç™»å½•é¡µé¢ä¸Šè¾“å…¥ä¸Šé¢çš„token</p>
<figure data-type="image" tabindex="50"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3snlagj30sm0eoju5.jpg" alt="image-20200520144548997" loading="lazy"></figure>
<p>å‡ºç°ä¸‹é¢çš„é¡µé¢ä»£è¡¨æˆåŠŸ</p>
<figure data-type="image" tabindex="51"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h3vv20aj31h30ppn04.jpg" alt="image-20200520144959353" loading="lazy"></figure>
<h2 id="102-ä½¿ç”¨dashboard">10.2 ä½¿ç”¨DashBoard</h2>
<p>æœ¬ç« èŠ‚ä»¥Deploymentä¸ºä¾‹æ¼”ç¤ºDashBoardçš„ä½¿ç”¨</p>
<p><strong>æŸ¥çœ‹</strong></p>
<p>é€‰æ‹©æŒ‡å®šçš„å‘½åç©ºé—´<code>dev</code>ï¼Œç„¶åç‚¹å‡»<code>Deployments</code>ï¼ŒæŸ¥çœ‹devç©ºé—´ä¸‹çš„æ‰€æœ‰deployment</p>
<figure data-type="image" tabindex="52"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h40658oj31gi0atq3z.jpg" alt="img" loading="lazy"></figure>
<p><strong>æ‰©ç¼©å®¹</strong></p>
<p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>è§„æ¨¡</code>ï¼Œç„¶åæŒ‡å®š<code>ç›®æ ‡å‰¯æœ¬æ•°é‡</code>ï¼Œç‚¹å‡»ç¡®å®š</p>
<figure data-type="image" tabindex="53"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h43wtwqj317z0h4ac3.jpg" alt="img" loading="lazy"></figure>
<p><strong>ç¼–è¾‘</strong></p>
<p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>ç¼–è¾‘</code>ï¼Œç„¶åä¿®æ”¹<code>yamlæ–‡ä»¶</code>ï¼Œç‚¹å‡»ç¡®å®š</p>
<figure data-type="image" tabindex="54"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h47hae7j31790amabo.jpg" alt="image-20200520163253644" loading="lazy"></figure>
<p><strong>æŸ¥çœ‹Pod</strong></p>
<p>ç‚¹å‡»<code>Pods</code>, æŸ¥çœ‹podsåˆ—è¡¨</p>
<figure data-type="image" tabindex="55"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h4bx3qfj31g70ev415.jpg" alt="img" loading="lazy"></figure>
<p><strong>æ“ä½œPod</strong></p>
<p>é€‰ä¸­æŸä¸ªPodï¼Œå¯ä»¥å¯¹å…¶æ‰§è¡Œæ—¥å¿—ï¼ˆlogsï¼‰ã€è¿›å…¥æ‰§è¡Œï¼ˆexecï¼‰ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ</p>
<figure data-type="image" tabindex="56"><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0h4g1x03j316i08pq47.jpg" alt="img" loading="lazy"></figure>
<blockquote>
<p>Dashboardæä¾›äº†kubectlçš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€æ¼”ç¤º</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é«˜æ•ˆä»£ç ]]></title>
        <id>https://WheatJack.github.io/post/aLiCode/</id>
        <link href="https://WheatJack.github.io/post/aLiCode/">
        </link>
        <updated>2020-10-28T13:45:42.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h2 id="1å¸¸é‡å˜é‡"><strong>1.å¸¸é‡&amp;å˜é‡</strong></h2>
<h3 id="11ç›´æ¥èµ‹å€¼å¸¸é‡å€¼ç¦æ­¢å£°æ˜æ–°å¯¹è±¡"><strong>1.1.ç›´æ¥èµ‹å€¼å¸¸é‡å€¼ï¼Œç¦æ­¢å£°æ˜æ–°å¯¹è±¡</strong></h3>
<p>ç›´æ¥èµ‹å€¼å¸¸é‡å€¼ï¼Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å¼•ç”¨æŒ‡å‘å¸¸é‡å€¼ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>Long i = new Long(1L);String s = new String(&quot;abc&quot;);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>Long i = 1L;String s = &quot;abc&quot;;
</code></pre>
<h3 id="12å½“æˆå‘˜å˜é‡å€¼æ— éœ€æ”¹å˜æ—¶å°½é‡å®šä¹‰ä¸ºé™æ€å¸¸é‡"><strong>1.2.å½“æˆå‘˜å˜é‡å€¼æ— éœ€æ”¹å˜æ—¶ï¼Œå°½é‡å®šä¹‰ä¸ºé™æ€å¸¸é‡</strong></h3>
<p>åœ¨ç±»çš„æ¯ä¸ªå¯¹è±¡å®ä¾‹ä¸­ï¼Œæ¯ä¸ªæˆå‘˜å˜é‡éƒ½æœ‰ä¸€ä»½å‰¯æœ¬ï¼Œè€Œæˆå‘˜é™æ€å¸¸é‡åªæœ‰ä¸€ä»½å®ä¾‹ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public class HttpConnection {    private final long timeout = 5L;    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public class HttpConnection {    private static final long TIMEOUT = 5L;    ...}
</code></pre>
<h3 id="13å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹é¿å…è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±"><strong>1.3.å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé¿å…è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±</strong></h3>
<p>Java ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹doubleã€floatã€longã€intã€shortã€charã€booleanï¼Œåˆ†åˆ«å¯¹åº”åŒ…è£…ç±»Doubleã€Floatã€Longã€Integerã€Shortã€Characterã€Booleanã€‚JVMæ”¯æŒåŸºæœ¬ç±»å‹ä¸å¯¹åº”åŒ…è£…ç±»çš„è‡ªåŠ¨è½¬æ¢ï¼Œè¢«ç§°ä¸ºè‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±ã€‚è£…ç®±å’Œæ‹†ç®±éƒ½æ˜¯éœ€è¦CPUå’Œå†…å­˜èµ„æºçš„ï¼Œæ‰€ä»¥åº”å°½é‡é¿å…ä½¿ç”¨è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>Integer sum = 0;int[] values = ...;for (int value : values) {    sum += value; // ç›¸å½“äºresult = Integer.valueOf(result.intValue() + value);}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>int sum = 0;int[] values = ...;for (int value : values) {    sum += value;}
</code></pre>
<h3 id="14å¦‚æœå˜é‡çš„åˆå€¼ä¼šè¢«è¦†ç›–å°±æ²¡æœ‰å¿…è¦ç»™å˜é‡èµ‹åˆå€¼"><strong>1.4.å¦‚æœå˜é‡çš„åˆå€¼ä¼šè¢«è¦†ç›–ï¼Œå°±æ²¡æœ‰å¿…è¦ç»™å˜é‡èµ‹åˆå€¼</strong></h3>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList = new ArrayList&lt;&gt;();if (isAll) {    userList = userDAO.queryAll();} else {    userList = userDAO.queryActive();}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList;if (isAll) {    userList = userDAO.queryAll();} else {    userList = userDAO.queryActive();}
</code></pre>
<h3 id="15å°½é‡ä½¿ç”¨å‡½æ•°å†…çš„åŸºæœ¬ç±»å‹ä¸´æ—¶å˜é‡"><strong>1.5.å°½é‡ä½¿ç”¨å‡½æ•°å†…çš„åŸºæœ¬ç±»å‹ä¸´æ—¶å˜é‡</strong></h3>
<p>åœ¨å‡½æ•°å†…ï¼ŒåŸºæœ¬ç±»å‹çš„å‚æ•°å’Œä¸´æ—¶å˜é‡éƒ½ä¿å­˜åœ¨æ ˆï¼ˆStackï¼‰ä¸­ï¼Œè®¿é—®é€Ÿåº¦è¾ƒå¿«ï¼›å¯¹è±¡ç±»å‹çš„å‚æ•°å’Œä¸´æ—¶å˜é‡çš„å¼•ç”¨éƒ½ä¿å­˜åœ¨æ ˆï¼ˆStackï¼‰ä¸­ï¼Œå†…å®¹éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œè®¿é—®é€Ÿåº¦è¾ƒæ…¢ã€‚åœ¨ç±»ä¸­ï¼Œä»»ä½•ç±»å‹çš„æˆå‘˜å˜é‡éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œè®¿é—®é€Ÿåº¦è¾ƒæ…¢ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">public final class Accumulator {    private double result = 0.0D;    public void addAll(@NonNull double[] values) {        for(double value : values) {            result += value;        }    }    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public final class Accumulator {    private double result = 0.0D;    public void addAll(@NonNull double[] values) {        double sum = 0.0D;        for(double value : values) {            sum += value;        }        result += sum;    }    ...}
</code></pre>
<h3 id="16å°½é‡ä¸è¦åœ¨å¾ªç¯ä½“å¤–å®šä¹‰å˜é‡"><strong>1.6.å°½é‡ä¸è¦åœ¨å¾ªç¯ä½“å¤–å®šä¹‰å˜é‡</strong></h3>
<p>åœ¨è€ç‰ˆJDKä¸­ï¼Œå»ºè®®â€œå°½é‡ä¸è¦åœ¨å¾ªç¯ä½“å†…å®šä¹‰å˜é‡â€ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆçš„JDKä¸­å·²ç»åšäº†ä¼˜åŒ–ã€‚é€šè¿‡å¯¹ç¼–è¯‘åçš„å­—èŠ‚ç åˆ†æï¼Œå˜é‡å®šä¹‰åœ¨å¾ªç¯ä½“å¤–å’Œå¾ªç¯ä½“å†…æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œè¿è¡Œæ•ˆç‡åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>åè€Œï¼Œæ ¹æ®â€œ å±€éƒ¨å˜é‡ä½œç”¨åŸŸæœ€å°åŒ– â€åŸåˆ™ï¼Œå˜é‡å®šä¹‰åœ¨å¾ªç¯ä½“å†…æ›´ç§‘å­¦æ›´ä¾¿äºç»´æŠ¤ï¼Œé¿å…äº†å»¶é•¿å¤§å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå¯¼è‡´å»¶ç¼“å›æ”¶é—®é¢˜ ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>UserVO userVO;List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());for (UserDO userDO : userDOList) {    userVO = new UserVO();    userVO.setId(userDO.getId());    ...    userVOList.add(userVO);}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());for (UserDO userDO : userDOList) {    UserVO userVO = new UserVO();    userVO.setId(userDO.getId());    ...    userVOList.add(userVO);}
</code></pre>
<h3 id="17ä¸å¯å˜çš„é™æ€å¸¸é‡å°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»"><strong>1.7.ä¸å¯å˜çš„é™æ€å¸¸é‡ï¼Œå°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»</strong></h3>
<p>ä¸å¯å˜çš„é™æ€å¸¸é‡ï¼Œè™½ç„¶éœ€è¦æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public static final Map&lt;String, Class&gt; CLASS_MAP;static {    Map&lt;String, Class&gt; classMap = new ConcurrentHashMap&lt;&gt;(16);    classMap.put(&quot;VARCHAR&quot;, java.lang.String.class);    ...    CLASS_MAP = Collections.unmodifiableMap(classMap);}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static final Map&lt;String, Class&gt; CLASS_MAP;static {    Map&lt;String, Class&gt; classMap = new HashMap&lt;&gt;(16);    classMap.put(&quot;VARCHAR&quot;, java.lang.String.class);    ...    CLASS_MAP = Collections.unmodifiableMap(classMap);}
</code></pre>
<h3 id="18ä¸å¯å˜çš„æˆå‘˜å˜é‡å°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»">1.8.ä¸å¯å˜çš„æˆå‘˜å˜é‡ï¼Œå°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»**</h3>
<p>ä¸å¯å˜çš„æˆå‘˜å˜é‡ï¼Œè™½ç„¶éœ€è¦æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>@Servicepublic class StrategyFactory implements InitializingBean {    @Autowired    private List&lt;Strategy&gt; strategyList;    private Map&lt;String, Strategy&gt; strategyMap;    @Override    public void afterPropertiesSet() {        if (CollectionUtils.isNotEmpty(strategyList)) {            int size = (int) Math.ceil(strategyList.size() * 4.0 / 3);            Map&lt;String, Strategy&gt; map = new ConcurrentHashMap&lt;&gt;(size);            for (Strategy strategy : strategyList) {                map.put(strategy.getType(), strategy);            }            strategyMap = Collections.unmodifiableMap(map);        }    }    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>@Servicepublic class StrategyFactory implements InitializingBean {    @Autowired    private List&lt;Strategy&gt; strategyList;    private Map&lt;String, Strategy&gt; strategyMap;    @Override    public void afterPropertiesSet() {        if (CollectionUtils.isNotEmpty(strategyList)) {            int size = (int) Math.ceil(strategyList.size() * 4.0 / 3);            Map&lt;String, Strategy&gt; map = new HashMap&lt;&gt;(size);            for (Strategy strategy : strategyList) {                map.put(strategy.getType(), strategy);            }            strategyMap = Collections.unmodifiableMap(map);        }    }    ...
</code></pre>
<h2 id=""></h2>
<h2 id="2å¯¹è±¡ç±»"><strong>2</strong>.å¯¹è±¡&amp;ç±»</h2>
<h3 id="21ç¦æ­¢ä½¿ç”¨jsonè½¬åŒ–å¯¹è±¡"><strong>2.1.ç¦æ­¢ä½¿ç”¨JSONè½¬åŒ–å¯¹è±¡</strong></h3>
<p>JSONæä¾›æŠŠå¯¹è±¡è½¬åŒ–ä¸ºJSONå­—ç¬¦ä¸²ã€æŠŠJSONå­—ç¬¦ä¸²è½¬ä¸ºå¯¹è±¡çš„åŠŸèƒ½ï¼Œäºæ˜¯è¢«æŸäº›äººç”¨æ¥è½¬åŒ–å¯¹è±¡ã€‚è¿™ç§å¯¹è±¡è½¬åŒ–æ–¹å¼ï¼Œè™½ç„¶åœ¨åŠŸèƒ½ä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šå´å­˜åœ¨é—®é¢˜ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = JSON.parseArray(JSON.toJSONString(userDOList), UserVO.class);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());for (UserDO userDO : userDOList) {    UserVO userVO = new UserVO();    userVO.setId(userDO.getId());    ...    userVOList.add(userVO);}
</code></pre>
<h3 id="22å°½é‡ä¸ä½¿ç”¨åå°„èµ‹å€¼å¯¹è±¡"><strong>2.2.å°½é‡ä¸ä½¿ç”¨åå°„èµ‹å€¼å¯¹è±¡</strong></h3>
<p>ç”¨åå°„èµ‹å€¼å¯¹è±¡ï¼Œä¸»è¦ä¼˜ç‚¹æ˜¯èŠ‚çœäº†ä»£ç é‡ï¼Œä¸»è¦ç¼ºç‚¹å´æ˜¯æ€§èƒ½æœ‰æ‰€ä¸‹é™ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());for (UserDO userDO : userDOList) {    UserVO userVO = new UserVO();    BeanUtils.copyProperties(userDO, userVO);    userVOList.add(userVO);}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userDOList = ...;List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());for (UserDO userDO : userDOList) {    UserVO userVO = new UserVO();    userVO.setId(userDO.getId());    ...    userVOList.add(userVO);}
</code></pre>
<h3 id="-2"></h3>
<h3 id="23é‡‡ç”¨lambdaè¡¨è¾¾å¼æ›¿æ¢å†…éƒ¨åŒ¿åç±»"><strong>2.3.é‡‡ç”¨Lambdaè¡¨è¾¾å¼æ›¿æ¢å†…éƒ¨åŒ¿åç±»</strong></h3>
<p>å¯¹äºå¤§å¤šæ•°åˆšæ¥è§¦JDK8çš„åŒå­¦æ¥è¯´ï¼Œéƒ½ä¼šè®¤ä¸ºLambdaè¡¨è¾¾å¼å°±æ˜¯åŒ¿åå†…éƒ¨ç±»çš„è¯­æ³•ç³–ã€‚å®é™…ä¸Šï¼Œ Lambdaè¡¨è¾¾å¼åœ¨å¤§å¤šæ•°è™šæ‹Ÿæœºä¸­é‡‡ç”¨invokeDynamicæŒ‡ä»¤å®ç°ï¼Œç›¸å¯¹äºåŒ¿åå†…éƒ¨ç±»åœ¨æ•ˆç‡ä¸Šä¼šæ›´é«˜ä¸€äº›ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;User&gt; userList = ...;Collections.sort(userList, new Comparator&lt;User&gt;() {    @Override    public int compare(User user1, User user2) {        Long userId1 = user1.getId();        Long userId2 = user2.getId();        ...        return userId1.compareTo(userId2);    }});
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;User&gt; userList = ...;Collections.sort(userList, (user1, user2) -&gt; {    Long userId1 = user1.getId();    Long userId2 = user2.getId();    ...    return userId1.compareTo(userId2);});
</code></pre>
<h3 id="-3"></h3>
<h3 id="24å°½é‡é¿å…å®šä¹‰ä¸å¿…è¦çš„å­ç±»"><strong>2.4.å°½é‡é¿å…å®šä¹‰ä¸å¿…è¦çš„å­ç±»</strong></h3>
<p>å¤šä¸€ä¸ªç±»å°±éœ€è¦å¤šä¸€ä»½ç±»åŠ è½½ï¼Œæ‰€ä»¥å°½é‡é¿å…å®šä¹‰ä¸å¿…è¦çš„å­ç±»ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public static final Map&lt;String, Class&gt; CLASS_MAP =    Collections.unmodifiableMap(new HashMap&lt;String, Class&gt;(16) {    private static final long serialVersionUID = 1L;    {        put(&quot;VARCHAR&quot;, java.lang.String.class);    }});
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static final Map&lt;String, Class&gt; CLASS_MAP;static {    Map&lt;String, Class&gt; classMap = new HashMap&lt;&gt;(16);    classMap.put(&quot;VARCHAR&quot;, java.lang.String.class);    ...    CLASS_MAP = Collections.unmodifiableMap(classMap);}
</code></pre>
<h3 id="-4"></h3>
<h3 id="25å°½é‡æŒ‡å®šç±»çš„finalä¿®é¥°ç¬¦"><strong>2.5.å°½é‡æŒ‡å®šç±»çš„finalä¿®é¥°ç¬¦</strong></h3>
<p>ä¸ºç±»æŒ‡å®šfinalä¿®é¥°ç¬¦ï¼Œå¯ä»¥è®©è¯¥ç±»ä¸å¯ä»¥è¢«ç»§æ‰¿ã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªç±»ä¸ºfinalï¼Œåˆ™è¯¥ç±»æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯finalçš„ï¼ŒJavaç¼–è¯‘å™¨ä¼šå¯»æ‰¾æœºä¼šå†…è”æ‰€æœ‰çš„finalæ–¹æ³•ã€‚å†…è”å¯¹äºæå‡Javaè¿è¡Œæ•ˆç‡ä½œç”¨é‡å¤§ï¼Œå…·ä½“å¯å‚è§Javaè¿è¡ŒæœŸä¼˜åŒ–ï¼Œèƒ½å¤Ÿä½¿æ€§èƒ½å¹³å‡æé«˜50%ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public class DateHelper {    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public final class DateHelper {    ...}
</code></pre>
<p>æ³¨æ„ï¼šä½¿ç”¨Springçš„AOPç‰¹æ€§æ—¶ï¼Œéœ€è¦å¯¹Beanè¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå¦‚æœBeanç±»æ·»åŠ äº†finalä¿®é¥°ï¼Œä¼šå¯¼è‡´å¼‚å¸¸ã€‚</p>
<h2 id="3æ–¹æ³•"><strong>3.æ–¹æ³•</strong></h2>
<h3 id="31æŠŠè·Ÿç±»æˆå‘˜å˜é‡æ— å…³çš„æ–¹æ³•å£°æ˜æˆé™æ€æ–¹æ³•"><strong>3.1.æŠŠè·Ÿç±»æˆå‘˜å˜é‡æ— å…³çš„æ–¹æ³•å£°æ˜æˆé™æ€æ–¹æ³•</strong></h3>
<p>é™æ€æ–¹æ³•çš„å¥½å¤„å°±æ˜¯ä¸ç”¨ç”Ÿæˆç±»çš„å®ä¾‹å°±å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚é™æ€æ–¹æ³•ä¸å†å±äºæŸä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯å±äºå®ƒæ‰€åœ¨çš„ç±»ã€‚åªéœ€è¦é€šè¿‡å…¶ç±»åå°±å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦å†æ¶ˆè€—èµ„æºå»åå¤åˆ›å»ºå¯¹è±¡ã€‚å³ä¾¿åœ¨ç±»å†…éƒ¨çš„ç§æœ‰æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨åˆ°ç±»æˆå‘˜å˜é‡ï¼Œä¹Ÿåº”è¯¥å£°æ˜ä¸ºé™æ€æ–¹æ³•ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public int getMonth(Date date) {  Calendar calendar = Calendar.getInstance();  calendar.setTime(date);  return calendar.get(Calendar.MONTH) + 1;}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static int getMonth(Date date) {  Calendar calendar = Calendar.getInstance();  calendar.setTime(date);  return calendar.get(Calendar.MONTH) + 1;}
</code></pre>
<h3 id="32å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ä½œä¸ºæ–¹æ³•å‚æ•°ç±»å‹é¿å…ä¸å¿…è¦çš„è£…ç®±-æ‹†ç®±å’Œç©ºæŒ‡é’ˆåˆ¤æ–­"><strong>3.2.å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ä½œä¸ºæ–¹æ³•å‚æ•°ç±»å‹ï¼Œé¿å…ä¸å¿…è¦çš„è£…ç®±ã€æ‹†ç®±å’Œç©ºæŒ‡é’ˆåˆ¤æ–­</strong></h3>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public static double sum(Double value1, Double value2) {    double double1 = Objects.isNull(value1) ? 0.0D : value1;    double double2 = Objects.isNull(value2) ? 0.0D : value2;    return double1 + double2;}double result = sum(1.0D, 2.0D);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static double sum(double value1, double value2) {    return value1 + value2;}double result = sum(1.0D, 2.0D);
</code></pre>
<h3 id="33å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ä½œä¸ºæ–¹æ³•è¿”å›å€¼ç±»å‹é¿å…ä¸å¿…è¦çš„è£…ç®±-æ‹†ç®±å’Œç©ºæŒ‡é’ˆåˆ¤æ–­">3.3.å°½é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ä½œä¸ºæ–¹æ³•è¿”å›å€¼ç±»å‹ï¼Œé¿å…ä¸å¿…è¦çš„è£…ç®±ã€æ‹†ç®±å’Œç©ºæŒ‡é’ˆåˆ¤æ–­</h3>
<p>åœ¨JDKç±»åº“çš„æ–¹æ³•ä¸­ï¼Œå¾ˆå¤šæ–¹æ³•è¿”å›å€¼éƒ½é‡‡ç”¨äº†åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé¦–å…ˆæ˜¯ä¸ºäº†é¿å…ä¸å¿…è¦çš„è£…ç®±å’Œæ‹†ç®±ï¼Œå…¶æ¬¡æ˜¯ä¸ºäº†é¿å…è¿”å›å€¼çš„ç©ºæŒ‡é’ˆåˆ¤æ–­ã€‚æ¯”å¦‚ï¼šCollection.isEmpty()å’ŒMap.size()ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public static Boolean isValid(UserDO user) {    if (Objects.isNull(user)) {        return false;    }  return Boolean.TRUE.equals(user.getIsValid());}
// è°ƒç”¨ä»£ç UserDO user = ...;Boolean isValid = isValid(user);if (Objects.nonNull(isValid) &amp;&amp; isValid.booleanValue()) {     ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static boolean isValid(UserDO user) {    if (Objects.isNull(user)) {        return false;    }  return Boolean.TRUE.equals(user.getIsValid());}
// è°ƒç”¨ä»£ç UserDO user = ...;if (isValid(user)) {    ...}
</code></pre>
<h3 id="-5"></h3>
<h3 id="34åè®®æ–¹æ³•å‚æ•°å€¼éç©ºé¿å…ä¸å¿…è¦çš„ç©ºæŒ‡é’ˆåˆ¤æ–­"><strong>3.4.åè®®æ–¹æ³•å‚æ•°å€¼éç©ºï¼Œé¿å…ä¸å¿…è¦çš„ç©ºæŒ‡é’ˆåˆ¤æ–­</strong></h3>
<p>åè®®ç¼–ç¨‹ï¼Œå¯ä»¥@NonNullå’Œ@Nullableæ ‡æ³¨å‚æ•°ï¼Œæ˜¯å¦éµå¾ªå…¨å‡­è°ƒç”¨è€…è‡ªè§‰ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public static boolean isValid(UserDO user) {    if (Objects.isNull(user)) {        return false;    }  return Boolean.TRUE.equals(user.getIsValid());}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public static boolean isValid(@NonNull UserDO user) {  return Boolean.TRUE.equals(user.getIsValid());}
</code></pre>
<h3 id="-6"></h3>
<h3 id="35åè®®æ–¹æ³•è¿”å›å€¼éç©ºé¿å…ä¸å¿…è¦çš„ç©ºæŒ‡é’ˆåˆ¤æ–­"><strong>3.5.åè®®æ–¹æ³•è¿”å›å€¼éç©ºï¼Œé¿å…ä¸å¿…è¦çš„ç©ºæŒ‡é’ˆåˆ¤æ–­</strong></h3>
<p>åè®®ç¼–ç¨‹ï¼Œå¯ä»¥@NonNullå’Œ@Nullableæ ‡æ³¨å‚æ•°ï¼Œæ˜¯å¦éµå¾ªå…¨å‡­å®ç°è€…è‡ªè§‰ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>// å®šä¹‰æ¥å£public interface OrderService {    public List&lt;OrderVO&gt; queryUserOrder(Long userId);}
// è°ƒç”¨ä»£ç List&lt;OrderVO&gt; orderList = orderService.queryUserOrder(userId);if (CollectionUtils.isNotEmpty(orderList)) {    for (OrderVO order : orderList) {        ...    }}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>// å®šä¹‰æ¥å£public interface OrderService {    @NonNull    public List&lt;OrderVO&gt; queryUserOrder(Long userId);}
// è°ƒç”¨ä»£ç List&lt;OrderVO&gt; orderList = orderService.queryUserOrder(userId);for (OrderVO order : orderList) {    ...}
</code></pre>
<h3 id="-7"></h3>
<h3 id="36è¢«è°ƒç”¨æ–¹æ³•å·²æ”¯æŒåˆ¤ç©ºå¤„ç†è°ƒç”¨æ–¹æ³•æ— éœ€å†è¿›è¡Œåˆ¤ç©ºå¤„ç†"><strong>3.6.è¢«è°ƒç”¨æ–¹æ³•å·²æ”¯æŒåˆ¤ç©ºå¤„ç†ï¼Œè°ƒç”¨æ–¹æ³•æ— éœ€å†è¿›è¡Œåˆ¤ç©ºå¤„ç†</strong></h3>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>UserDO user = null;if (StringUtils.isNotBlank(value)) {    user = JSON.parseObject(value, UserDO.class);}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>UserDO user = JSON.parseObject(value, UserDO.class);
</code></pre>
<h3 id="37å°½é‡é¿å…ä¸å¿…è¦çš„å‡½æ•°å°è£…"><strong>3.7.å°½é‡é¿å…ä¸å¿…è¦çš„å‡½æ•°å°è£…</strong></h3>
<p>æ–¹æ³•è°ƒç”¨ä¼šå¼•èµ·å…¥æ ˆå’Œå‡ºæ ˆï¼Œå¯¼è‡´æ¶ˆè€—æ›´å¤šçš„CPUå’Œå†…å­˜ï¼Œåº”å½“å°½é‡é¿å…ä¸å¿…è¦çš„å‡½æ•°å°è£…ã€‚å½“ç„¶ï¼Œä¸ºäº†ä½¿ä»£ç æ›´ç®€æ´ã€æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ï¼Œå¢åŠ ä¸€å®šçš„æ–¹æ³•è°ƒç”¨æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯å€¼å¾—çš„ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>// å‡½æ•°å°è£…public static boolean isVip(Boolean isVip) {    return Boolean.TRUE.equals(isVip);}
// ä½¿ç”¨ä»£ç boolean isVip = isVip(user.getVip());
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>boolean isVip = Boolean.TRUE.equals(user.getVip());
</code></pre>
<h3 id="38å°½é‡æŒ‡å®šæ–¹æ³•çš„finalä¿®é¥°ç¬¦"><strong>3.8.å°½é‡æŒ‡å®šæ–¹æ³•çš„finalä¿®é¥°ç¬¦</strong></h3>
<p>æ–¹æ³•æŒ‡å®šfinalä¿®é¥°ç¬¦ï¼Œå¯ä»¥è®©æ–¹æ³•ä¸å¯ä»¥è¢«é‡å†™ï¼ŒJavaç¼–è¯‘å™¨ä¼šå¯»æ‰¾æœºä¼šå†…è”æ‰€æœ‰çš„finalæ–¹æ³•ã€‚å†…è”å¯¹äºæå‡Javaè¿è¡Œæ•ˆç‡ä½œç”¨é‡å¤§ï¼Œå…·ä½“å¯å‚è§Javaè¿è¡ŒæœŸä¼˜åŒ–ï¼Œèƒ½å¤Ÿä½¿æ€§èƒ½å¹³å‡æé«˜50%ã€‚</p>
<p>æ³¨æ„ï¼šæ‰€æœ‰çš„privateæ–¹æ³•ä¼šéšå¼åœ°è¢«æŒ‡å®šfinalä¿®é¥°ç¬¦ï¼Œæ‰€ä»¥æ— é¡»å†ä¸ºå…¶æŒ‡å®šfinalä¿®é¥°ç¬¦ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>public class Rectangle {    ...    public double area() {        ...    }}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>public class Rectangle {    ...    public final double area() {        ...    }}
</code></pre>
<p>æ³¨æ„ï¼šä½¿ç”¨Springçš„AOPç‰¹æ€§æ—¶ï¼Œéœ€è¦å¯¹Beanè¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ–¹æ³•æ·»åŠ äº†finalä¿®é¥°ï¼Œå°†ä¸ä¼šè¢«ä»£ç†ã€‚</p>
<h2 id="4è¡¨è¾¾å¼"><strong>4.è¡¨è¾¾å¼</strong></h2>
<h3 id="41å°½é‡å‡å°‘æ–¹æ³•çš„é‡å¤è°ƒç”¨"><strong>4.1.å°½é‡å‡å°‘æ–¹æ³•çš„é‡å¤è°ƒç”¨</strong></h3>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList = ...;for (int i = 0; i &lt; userList.size(); i++) {    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList = ...;int userLength = userList.size();for (int i = 0; i &lt; userLength; i++) {    ...}
</code></pre>
<h3 id="-8"></h3>
<h3 id="42å°½é‡é¿å…ä¸å¿…è¦çš„æ–¹æ³•è°ƒç”¨"><strong>4.2.å°½é‡é¿å…ä¸å¿…è¦çš„æ–¹æ³•è°ƒç”¨</strong></h3>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList = userDAO.queryActive();if (isAll) {    userList = userDAO.queryAll();}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>List&lt;UserDO&gt; userList;if (isAll) {    userList = userDAO.queryAll();} else {    userList = userDAO.queryActive();}
</code></pre>
<h3 id="-9"></h3>
<h3 id="43å°½é‡ä½¿ç”¨ç§»ä½æ¥ä»£æ›¿æ­£æ•´æ•°ä¹˜é™¤"><strong>4.3.å°½é‡ä½¿ç”¨ç§»ä½æ¥ä»£æ›¿æ­£æ•´æ•°ä¹˜é™¤</strong></h3>
<p>ç”¨ç§»ä½æ“ä½œå¯ä»¥æå¤§åœ°æé«˜æ€§èƒ½ã€‚å¯¹äºä¹˜é™¤2^n(nä¸ºæ­£æ•´æ•°)çš„æ­£æ•´æ•°è®¡ç®—ï¼Œå¯ä»¥ç”¨ç§»ä½æ“ä½œæ¥ä»£æ›¿ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>int num1 = a * 4;int num2 = a / 4;
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>int num1 = a &lt;&lt; 2;int num2 = a &gt;&gt; 2;
</code></pre>
<h3 id="-10"></h3>
<h3 id="44æå–å…¬å…±è¡¨è¾¾å¼é¿å…é‡å¤è®¡ç®—"><strong>4.4.æå–å…¬å…±è¡¨è¾¾å¼ï¼Œé¿å…é‡å¤è®¡ç®—</strong></h3>
<p>æå–å…¬å…±è¡¨è¾¾å¼ï¼Œåªè®¡ç®—ä¸€æ¬¡å€¼ï¼Œç„¶åé‡å¤åˆ©ç”¨å€¼ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>double distance = Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>double dx = x2 - x1;double dy = y2 - y1;double distance = Math.sqrt(dx * dx + dy * dy);æˆ–double distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
</code></pre>
<h3 id="-11"></h3>
<h3 id="45å°½é‡ä¸åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ç”¨å–å"><strong>4.5.å°½é‡ä¸åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ç”¨!å–å</strong></h3>
<p>ä½¿ç”¨!å–åä¼šå¤šä¸€æ¬¡è®¡ç®—ï¼Œå¦‚æœæ²¡æœ‰å¿…è¦åˆ™ä¼˜åŒ–æ‰ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>if (!(a &gt;= 10)) {    ... // æ¡ä»¶å¤„ç†1} else {    ... // æ¡ä»¶å¤„ç†2}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>if (a &lt; 10) {    ... // æ¡ä»¶å¤„ç†1} else {    ... // æ¡ä»¶å¤„ç†2}
</code></pre>
<h3 id="-12"></h3>
<h3 id="46å¯¹äºå¤šå¸¸é‡é€‰æ‹©åˆ†æ”¯å°½é‡ä½¿ç”¨switchè¯­å¥è€Œä¸æ˜¯if-elseè¯­å¥"><strong>4.6.å¯¹äºå¤šå¸¸é‡é€‰æ‹©åˆ†æ”¯ï¼Œå°½é‡ä½¿ç”¨switchè¯­å¥è€Œä¸æ˜¯if-elseè¯­å¥</strong></h3>
<p>if-elseè¯­å¥ï¼Œæ¯ä¸ªifæ¡ä»¶è¯­å¥éƒ½è¦åŠ è£…è®¡ç®—ï¼Œç›´åˆ°ifæ¡ä»¶è¯­å¥ä¸ºtrueä¸ºæ­¢ã€‚switchè¯­å¥è¿›è¡Œäº†è·³è½¬ä¼˜åŒ–ï¼ŒJavaä¸­é‡‡ç”¨tableswitchæˆ–lookupswitchæŒ‡ä»¤å®ç°ï¼Œå¯¹äºå¤šå¸¸é‡é€‰æ‹©åˆ†æ”¯å¤„ç†æ•ˆç‡æ›´é«˜ã€‚ç»è¿‡è¯•éªŒè¯æ˜ï¼šåœ¨æ¯ä¸ªåˆ†æ”¯å‡ºç°æ¦‚ç‡ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œä½äº5ä¸ªåˆ†æ”¯æ—¶if-elseè¯­å¥æ•ˆç‡æ›´é«˜ï¼Œé«˜äº5ä¸ªåˆ†æ”¯æ—¶switchè¯­å¥æ•ˆç‡æ›´é«˜ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>if (i == 1) {    ...; // åˆ†æ”¯1} else if (i == 2) {    ...; // åˆ†æ”¯2} else if (i == ...) {    ...; // åˆ†æ”¯n} else {    ...; // åˆ†æ”¯n+1}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>switch (i) {    case 1 :        ... // åˆ†æ”¯1        break;    case 2 :        ... // åˆ†æ”¯2        break;    case ... :        ... // åˆ†æ”¯n        break;    default :        ... // åˆ†æ”¯n+1        break;}
</code></pre>
<p>å¤‡æ³¨ï¼šå¦‚æœä¸šåŠ¡å¤æ‚ï¼Œå¯ä»¥é‡‡ç”¨Mapå®ç°ç­–ç•¥æ¨¡å¼ã€‚</p>
<h2 id="5å­—ç¬¦ä¸²"><strong>5.å­—ç¬¦ä¸²</strong></h2>
<h3 id="51å°½é‡ä¸è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…"><strong>5.1.å°½é‡ä¸è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</strong></h3>
<p>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ•ˆç‡è¾ƒä½ï¼Œå°½é‡ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…æ“ä½œã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">String source = &quot;a::1,b::2,c::3,d::4&quot;;
String target = source.replaceAll(&quot;::&quot;, &quot;=&quot;);
Stringp[] targets = source.spit(&quot;::&quot;);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">String source = &quot;a::1,b::2,c::3,d::4&quot;;
String target = source.replace(&quot;::&quot;, &quot;=&quot;);
Stringp[] targets = StringUtils.split(source, &quot;::&quot;);
</code></pre>
<h3 id="-13"></h3>
<h3 id="52å°½é‡ä½¿ç”¨å­—ç¬¦æ›¿æ¢å­—ç¬¦ä¸²"><strong>5.2.å°½é‡ä½¿ç”¨å­—ç¬¦æ›¿æ¢å­—ç¬¦ä¸²</strong></h3>
<p>å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ç¡®å®šï¼Œè€Œå­—ç¬¦çš„é•¿åº¦å›ºå®šä¸º1ï¼ŒæŸ¥æ‰¾å’ŒåŒ¹é…çš„æ•ˆç‡è‡ªç„¶æé«˜äº†</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">String source = &quot;a:1,b:2,c:3,d:4&quot;;
int index = source.indexOf(&quot;:&quot;);
String target = source.replace(&quot;:&quot;, &quot;=&quot;);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">String source = &quot;a:1,b:2,c:3,d:4&quot;;
int index = source.indexOf(':');
String target = source.replace(':', '=');
</code></pre>
<h3 id="-14"></h3>
<h3 id="53å°½é‡ä½¿ç”¨stringbuilderè¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥"><strong>5.3.å°½é‡ä½¿ç”¨StringBuilderè¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥</strong></h3>
<p>Stringæ˜¯finalç±»ï¼Œå†…å®¹ä¸å¯ä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡å­—ç¬¦ä¸²æ‹¼æ¥éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°å¯¹è±¡ã€‚StringBuilderåœ¨åˆå§‹åŒ–æ—¶ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œä»¥åçš„å­—ç¬¦ä¸²æ‹¼æ¥éƒ½åœ¨è¿™å—å†…å­˜ä¸­æ‰§è¡Œï¼Œä¸ä¼šç”³è¯·æ–°å†…å­˜å’Œç”Ÿæˆæ–°å¯¹è±¡ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        String s = &quot;&quot;;
        for (int i = 0; i &lt; 10; i++) {
            if (i != 0) {
                s += ',';
            }
            s += i;
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        StringBuilder sb = new StringBuilder(128);
        for (int i = 0; i &lt; 10; i++) {
            if (i != 0) {
                sb.append(',');
            }
            sb.append(i);
        }
</code></pre>
<h3 id="-15"></h3>
<h3 id="54ä¸è¦ä½¿ç”¨è½¬åŒ–å­—ç¬¦ä¸²"><strong>5.4.ä¸è¦ä½¿ç”¨&quot;&quot;+è½¬åŒ–å­—ç¬¦ä¸²</strong></h3>
<p>ä½¿ç”¨&quot;&quot;+è¿›è¡Œå­—ç¬¦ä¸²è½¬åŒ–ï¼Œä½¿ç”¨æ–¹ä¾¿ä½†æ˜¯æ•ˆç‡ä½ï¼Œå»ºè®®ä½¿ç”¨String.valueOf.</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code>int i = 12345;String s = &quot;&quot; + i;
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code>int i = 12345;String s = String.valueOf(i);
</code></pre>
<h2 id="-16"></h2>
<h2 id="6æ•°ç»„"><strong>6.æ•°ç»„</strong></h2>
<h3 id="61ä¸è¦ä½¿ç”¨å¾ªç¯æ‹·è´æ•°ç»„å°½é‡ä½¿ç”¨systemarraycopyæ‹·è´æ•°ç»„"><strong>6.1.ä¸è¦ä½¿ç”¨å¾ªç¯æ‹·è´æ•°ç»„ï¼Œå°½é‡ä½¿ç”¨System.arraycopyæ‹·è´æ•°ç»„</strong></h3>
<p>æ¨èä½¿ç”¨System.arraycopyæ‹·è´æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Arrays.copyOfæ‹·è´æ•°ç»„ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">int[] sources = new int[] {1, 2, 3, 4, 5};
int[] targets = new int[sources.length];
for (int i = 0; i &lt; targets.length; i++) {    targets[i] = sources[i];}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">int[] sources = new int[] {1, 2, 3, 4, 5};
int[] targets = new int[sources.length];
System.arraycopy(sources, 0, targets, 0, targets.length);
</code></pre>
<h3 id="-17"></h3>
<h3 id="62é›†åˆè½¬åŒ–ä¸ºç±»å‹tæ•°ç»„æ—¶å°½é‡ä¼ å…¥ç©ºæ•°ç»„t0"><strong>6.2.é›†åˆè½¬åŒ–ä¸ºç±»å‹Tæ•°ç»„æ—¶ï¼Œå°½é‡ä¼ å…¥ç©ºæ•°ç»„T[0]</strong></h3>
<p>å°†é›†åˆè½¬æ¢ä¸ºæ•°ç»„æœ‰2ç§å½¢å¼ï¼štoArray(new T[n])å’ŒtoArray(new T[0])ã€‚åœ¨æ—§çš„Javaç‰ˆæœ¬ä¸­ï¼Œå»ºè®®ä½¿ç”¨toArray(new T[n])ï¼Œå› ä¸ºåˆ›å»ºæ•°ç»„æ—¶æ‰€éœ€çš„åå°„è°ƒç”¨éå¸¸æ…¢ã€‚åœ¨OpenJDK6åï¼Œåå°„è°ƒç”¨æ˜¯å†…åœ¨çš„ï¼Œä½¿å¾—æ€§èƒ½å¾—ä»¥æé«˜ï¼ŒtoArray(new T[0])æ¯”toArray(new T[n])æ•ˆç‡æ›´é«˜ã€‚æ­¤å¤–ï¼ŒtoArray(new T[n])æ¯”toArray(new T[0])å¤šè·å–ä¸€æ¬¡åˆ—è¡¨å¤§å°ï¼Œå¦‚æœè®¡ç®—åˆ—è¡¨å¤§å°è€—æ—¶è¿‡é•¿ï¼Œä¹Ÿä¼šå¯¼è‡´toArray(new T[n])æ•ˆç‡é™ä½</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">List&lt;Integer&gt; integerList = Arrays.asList(1, 2, 3, 4, 5, ...);
Integer[] integers = integerList.toArray(new Integer[integerList.size()]);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">List&lt;Integer&gt; integerList = Arrays.asList(1, 2, 3, 4, 5, ...);
Integer[] integers = integerList.toArray(new Integer[0]); // å‹¿ç”¨new Integer[]{}
</code></pre>
<p>å»ºè®®ï¼šé›†åˆåº”è¯¥æä¾›ä¸€ä¸ªtoArray(Class<T> clazz)æ–¹æ³•ï¼Œé¿å…æ— ç”¨çš„ç©ºæ•°ç»„åˆå§‹åŒ–ï¼ˆnew T[0]ï¼‰ã€‚</p>
<h3 id="63é›†åˆè½¬åŒ–ä¸ºobjectæ•°ç»„æ—¶å°½é‡ä½¿ç”¨toarrayæ–¹æ³•"><strong>6.3.é›†åˆè½¬åŒ–ä¸ºObjectæ•°ç»„æ—¶ï¼Œå°½é‡ä½¿ç”¨toArray()æ–¹æ³•</strong></h3>
<p>è½¬åŒ–Objectæ•°ç»„æ—¶ï¼Œæ²¡æœ‰å¿…è¦ä½¿ç”¨toArray[new Object[0]]ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨toArray()ã€‚é¿å…äº†ç±»å‹çš„åˆ¤æ–­ï¼Œä¹Ÿé¿å…äº†ç©ºæ•°ç»„çš„ç”³è¯·ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šæ›´é«˜ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">List&lt;Object&gt; objectList = Arrays.asList(1, &quot;2&quot;, 3, &quot;4&quot;, 5, ...);
Object[] objects = objectList.toArray(new Object[0]);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">List&lt;Object&gt; objectList = Arrays.asList(1, &quot;2&quot;, 3, &quot;4&quot;, 5, ...);
Object[] objects = objectList.toArray();
</code></pre>
<h2 id="-18"></h2>
<h2 id="7é›†åˆ"><strong>7.é›†åˆ</strong></h2>
<h3 id="71åˆå§‹åŒ–é›†åˆæ—¶å°½é‡æŒ‡å®šé›†åˆå¤§å°"><strong>7.1.åˆå§‹åŒ–é›†åˆæ—¶ï¼Œå°½é‡æŒ‡å®šé›†åˆå¤§å°</strong></h3>
<p>Javaé›†åˆåˆå§‹åŒ–æ—¶éƒ½ä¼šæŒ‡å®šä¸€ä¸ªé»˜è®¤å¤§å°ï¼Œå½“é»˜è®¤å¤§å°ä¸å†æ»¡è¶³æ•°æ®éœ€æ±‚æ—¶å°±ä¼šæ‰©å®¹ï¼Œæ¯æ¬¡æ‰©å®¹çš„æ—¶é—´å¤æ‚åº¦æœ‰å¯èƒ½æ˜¯O(n)ã€‚æ‰€ä»¥ï¼Œå°½é‡æŒ‡å®šé¢„çŸ¥çš„é›†åˆå¤§å°ï¼Œå°±èƒ½é¿å…æˆ–å‡å°‘é›†åˆçš„æ‰©å®¹æ¬¡æ•°ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; userDOList = ...;
        Set&lt;Long&gt; userSet = new HashSet&lt;&gt;();
        Map&lt;Long, UserDO&gt; userMap = new HashMap&lt;&gt;();
        List&lt;UserVO&gt; userList = new ArrayList&lt;&gt;();
        for (UserDO userDO : userDOList) {
            userSet.add(userDO.getId());
            userMap.put(userDO.getId(), userDO);
            userList.add(transUser(userDO));
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; userDOList = ...;
        int userSize = userDOList.size();
        Set&lt;Long&gt; userSet = new HashSet&lt;&gt;(userSize);
        Map&lt;Long, UserDO&gt; userMap = new HashMap&lt;&gt;((int) Math.ceil(userSize * 4.0 / 3));
        List&lt;UserVO&gt; userList = new ArrayList&lt;&gt;(userSize);
        for (UserDO userDO : userDOList) {
            userSet.add(userDO.getId());
            userMap.put(userDO.getId(), userDO);
            userList.add(transUser(userDO));
        }
</code></pre>
<h3 id="-19"></h3>
<h3 id="72ä¸è¦ä½¿ç”¨å¾ªç¯æ‹·è´é›†åˆå°½é‡ä½¿ç”¨jdkæä¾›çš„æ–¹æ³•æ‹·è´é›†åˆ"><strong>7.2.ä¸è¦ä½¿ç”¨å¾ªç¯æ‹·è´é›†åˆï¼Œå°½é‡ä½¿ç”¨JDKæä¾›çš„æ–¹æ³•æ‹·è´é›†åˆ</strong></h3>
<p>JDKæä¾›çš„æ–¹æ³•å¯ä»¥ä¸€æ­¥æŒ‡å®šé›†åˆçš„å®¹é‡ï¼Œé¿å…å¤šæ¬¡æ‰©å®¹æµªè´¹æ—¶é—´å’Œç©ºé—´ã€‚åŒæ—¶ï¼Œè¿™äº›æ–¹æ³•çš„åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨System.arraycopyæ–¹æ³•å®ç°ï¼Œè¿›è¡Œæ•°æ®çš„æ‰¹é‡æ‹·è´æ•ˆç‡æ›´é«˜ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; user1List = ...;
        List&lt;UserDO&gt; user2List = ...;
        List&lt;UserDO&gt; userList = new ArrayList&lt;&gt;(user1List.size() + user2List.size());
        for (UserDO user1 : user1List) {
            userList.add(user1);
        }
        for (UserDO user2 : user2List) {
            userList.add(user2);
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; user1List = ...;
        List&lt;UserDO&gt; user2List = ...;
        List&lt;UserDO&gt; userList = new ArrayList&lt;&gt;(user1List.size() + user2List.size());
        userList.addAll(user1List);
        userList.addAll(user2List);
</code></pre>
<h3 id="-20"></h3>
<h3 id="73å°½é‡ä½¿ç”¨arraysaslistè½¬åŒ–æ•°ç»„ä¸ºåˆ—è¡¨"><strong>7.3.å°½é‡ä½¿ç”¨Arrays.asListè½¬åŒ–æ•°ç»„ä¸ºåˆ—è¡¨</strong></h3>
<p>åŸç†ä¸&quot;ä¸è¦ä½¿ç”¨å¾ªç¯æ‹·è´é›†åˆï¼Œå°½é‡ä½¿ç”¨JDKæä¾›çš„æ–¹æ³•æ‹·è´é›†åˆ&quot;ç±»ä¼¼ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;String&gt; typeList = new ArrayList&lt;&gt;(8);
        typeList.add(&quot;Short&quot;);
        typeList.add(&quot;Integer&quot;);
        typeList.add(&quot;Long&quot;);
        String[] names = ...;
        List&lt;String&gt; nameList = ...;
        for (String name : names) {
            nameList.add(name);
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;String&gt; typeList = Arrays.asList(&quot;Short&quot;, &quot;Integer&quot;, &quot;Long&quot;);
        String[] names = ...;
        List&lt;String&gt; nameList = ...;
        nameList.addAll(Arrays.asList(names));
</code></pre>
<h3 id="-21"></h3>
<h3 id="74ç›´æ¥è¿­ä»£éœ€è¦ä½¿ç”¨çš„é›†åˆ"><strong>7.4.ç›´æ¥è¿­ä»£éœ€è¦ä½¿ç”¨çš„é›†åˆ</strong></h3>
<p>ç›´æ¥è¿­ä»£éœ€è¦ä½¿ç”¨çš„é›†åˆï¼Œæ— éœ€é€šè¿‡å…¶å®ƒæ“ä½œè·å–æ•°æ®ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        Map&lt;Long, UserDO&gt; userMap = ...;
        for (Long userId : userMap.keySet()) {
            UserDO user = userMap.get(userId);    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        Map&lt;Long, UserDO&gt; userMap = ...;
        for (Map.Entry&lt;Long, UserDO&gt; userEntry : userMap.entrySet()) {
            Long userId = userEntry.getKey();
            UserDO user = userEntry.getValue();    ...}
</code></pre>
<h3 id="-22"></h3>
<h3 id="75ä¸è¦ä½¿ç”¨sizeæ–¹æ³•æ£€æµ‹ç©ºå¿…é¡»ä½¿ç”¨isemptyæ–¹æ³•æ£€æµ‹ç©º"><strong>7.5.ä¸è¦ä½¿ç”¨sizeæ–¹æ³•æ£€æµ‹ç©ºï¼Œå¿…é¡»ä½¿ç”¨isEmptyæ–¹æ³•æ£€æµ‹ç©º</strong></h3>
<p>ä½¿ç”¨sizeæ–¹æ³•æ¥æ£€æµ‹ç©ºé€»è¾‘ä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½†ä½¿ç”¨isEmptyæ–¹æ³•ä½¿å¾—ä»£ç æ›´æ˜“è¯»ï¼Œå¹¶ä¸”å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ä»»ä½•isEmptyæ–¹æ³•å®ç°çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼Œä½†æ˜¯æŸäº›sizeæ–¹æ³•å®ç°çš„æ—¶é—´å¤æ‚åº¦æœ‰å¯èƒ½æ˜¯O(n)ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; userList = ...;
        if (userList.size() == 0) {    ...}
        Map&lt;Long, UserDO&gt; userMap = ...;
        if (userMap.size() == 0) {    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;UserDO&gt; userList = ...;
        if (userList.isEmpty()) {    ...} 
        Map&lt;Long, UserDO&gt; userMap = ...;
        if (userMap.isEmpty()) {    ...}
</code></pre>
<h3 id="-23"></h3>
<h3 id="76ééšæœºè®¿é—®çš„listå°½é‡ä½¿ç”¨è¿­ä»£ä»£æ›¿éšæœºè®¿é—®"><strong>7.6.ééšæœºè®¿é—®çš„Listï¼Œå°½é‡ä½¿ç”¨è¿­ä»£ä»£æ›¿éšæœºè®¿é—®</strong></h3>
<p>å¯¹äºåˆ—è¡¨ï¼Œå¯åˆ†ä¸ºéšæœºè®¿é—®å’Œééšæœºè®¿é—®ä¸¤ç±»ï¼Œå¯ä»¥ç”¨æ˜¯å¦å®ç°RandomAccessæ¥å£åˆ¤æ–­ã€‚éšæœºè®¿é—®åˆ—è¡¨ï¼Œç›´æ¥é€šè¿‡getè·å–æ•°æ®ä¸å½±å“æ•ˆç‡ã€‚è€Œééšæœºè®¿é—®åˆ—è¡¨ï¼Œé€šè¿‡getè·å–æ•°æ®æ•ˆç‡æä½ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        LinkedList&lt;UserDO&gt; userDOList = ...;
        int size = userDOList.size();
        for (int i = 0; i &lt; size; i++) {
            UserDO userDO = userDOList.get(i);    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        LinkedList&lt;UserDO&gt; userDOList = ...;
        for (UserDO userDO : userDOList) {    ...}
</code></pre>
<p>å…¶å®ï¼Œä¸ç®¡åˆ—è¡¨æ”¯ä¸æ”¯æŒéšæœºè®¿é—®ï¼Œéƒ½åº”è¯¥ä½¿ç”¨è¿­ä»£è¿›è¡Œéå†ã€‚</p>
<h3 id="77å°½é‡ä½¿ç”¨hashsetåˆ¤æ–­å€¼å­˜åœ¨"><strong>7.7.å°½é‡ä½¿ç”¨HashSetåˆ¤æ–­å€¼å­˜åœ¨</strong></h3>
<p>åœ¨Javaé›†åˆç±»åº“ä¸­ï¼ŒListçš„containsæ–¹æ³•æ™®éæ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œè€ŒHashSetçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚å¦‚æœéœ€è¦é¢‘ç¹è°ƒç”¨containsæ–¹æ³•æŸ¥æ‰¾æ•°æ®ï¼Œå¯ä»¥å…ˆå°†Listè½¬æ¢æˆHashSetã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        List&lt;Long&gt; adminIdList = ...;
        List&lt;UserDO&gt; userDOList = ...;
        List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());
        for (UserDO userDO : userDOList) {
            if (adminIdList.contains(userDO.getId())) {
                userVOList.add(transUser(userDO));
            }
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        Set&lt;Long&gt; adminIdSet = ...;
        List&lt;UserDO&gt; userDOList = ...;
        List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;(userDOList.size());
        for (UserDO userDO : userDOList) {
            if (adminIdSet.contains(userDO.getId())) {
                userVOList.add(transUser(userDO));
            }
        }
</code></pre>
<h3 id="-24"></h3>
<h3 id="78é¿å…å…ˆåˆ¤æ–­å­˜åœ¨å†è¿›è¡Œè·å–"><strong>7.8.é¿å…å…ˆåˆ¤æ–­å­˜åœ¨å†è¿›è¡Œè·å–</strong></h3>
<p>å¦‚æœéœ€è¦å…ˆåˆ¤æ–­å­˜åœ¨å†è¿›è¡Œè·å–ï¼Œå¯ä»¥ç›´æ¥è·å–å¹¶åˆ¤æ–­ç©ºï¼Œä»è€Œé¿å…äº†äºŒæ¬¡æŸ¥æ‰¾æ“ä½œã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">    public static UserVO transUser(UserDO user, Map&lt;Long, RoleDO&gt; roleMap) {
        UserVO userVO = new UserVO();
        userVO.setId(user.getId());    ...if (roleMap.contains(user.getRoleId())) {
            RoleDO role = roleMap.get(user.getRoleId());
            userVO.setRole(transRole(role));
        }
    }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">    public static UserVO transUser(UserDO user, Map&lt;Long, RoleDO&gt; roleMap) {
        UserVO userVO = new UserVO();
        userVO.setId(user.getId());    ...RoleDO role = roleMap.get(user.getRoleId());
        if (Objects.nonNull(role)) {
            userVO.setRole(transRole(role));
        }
    }
</code></pre>
<h2 id="-25"></h2>
<h2 id="8å¼‚å¸¸"><strong>8.å¼‚å¸¸</strong></h2>
<h3 id="81ç›´æ¥æ•è·å¯¹åº”çš„å¼‚å¸¸"><strong>8.1.ç›´æ¥æ•è·å¯¹åº”çš„å¼‚å¸¸</strong></h3>
<p>ç›´æ¥æ•è·å¯¹åº”çš„å¼‚å¸¸ï¼Œé¿å…ç”¨instanceofåˆ¤æ–­ï¼Œæ•ˆç‡æ›´é«˜ä»£ç æ›´ç®€æ´ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        try {
            saveData();
        } catch (Exception e) {
            if (e instanceof IOException) {
                log.error(&quot;ä¿å­˜æ•°æ®IOå¼‚å¸¸&quot;, e);
            } else {
                log.error(&quot;ä¿å­˜æ•°æ®å…¶å®ƒå¼‚å¸¸&quot;, e);
            }
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        try {
            saveData();
        } catch (IOException e) {
            log.error(&quot;ä¿å­˜æ•°æ®IOå¼‚å¸¸&quot;, e);
        } catch (Exception e) {
            log.error(&quot;ä¿å­˜æ•°æ®å…¶å®ƒå¼‚å¸¸&quot;, e);
        }
</code></pre>
<h3 id="-26"></h3>
<h3 id="82å°½é‡é¿å…åœ¨å¾ªç¯ä¸­æ•è·å¼‚å¸¸"><strong>8.2.å°½é‡é¿å…åœ¨å¾ªç¯ä¸­æ•è·å¼‚å¸¸</strong></h3>
<p>å½“å¾ªç¯ä½“æŠ›å‡ºå¼‚å¸¸åï¼Œæ— éœ€å¾ªç¯ç»§ç»­æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰å¿…è¦åœ¨å¾ªç¯ä½“ä¸­æ•è·å¼‚å¸¸ã€‚å› ä¸ºï¼Œè¿‡å¤šçš„æ•è·å¼‚å¸¸ä¼šé™ä½ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        public Double sum (List &lt; String &gt; valueList) {
            double sum = 0.0D;
            for (String value : valueList) {
                try {
                    sum += Double.parseDouble(value);
                } catch (NumberFormatException e) {
                    return null;
                }
            }
            return sum;
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        public Double sum (List &lt; String &gt; valueList) {
            double sum = 0.0D;
            try {
                for (String value : valueList) {
                    sum += Double.parseDouble(value);
                }
            } catch (NumberFormatException e) {
                return null;
            }
            return sum;
        }
</code></pre>
<h3 id="-27"></h3>
<h3 id="83ç¦æ­¢ä½¿ç”¨å¼‚å¸¸æ§åˆ¶ä¸šåŠ¡æµç¨‹"><strong>8.3.ç¦æ­¢ä½¿ç”¨å¼‚å¸¸æ§åˆ¶ä¸šåŠ¡æµç¨‹</strong></h3>
<p>ç›¸å¯¹äºæ¡ä»¶è¡¨è¾¾å¼ï¼Œå¼‚å¸¸çš„å¤„ç†æ•ˆç‡æ›´ä½ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        public static boolean isValid (UserDO user){
            try {
                return Boolean.TRUE.equals(user.getIsValid());
            } catch (NullPointerException e) {
                return false;
            }
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        public static boolean isValid (UserDO user){
            if (Objects.isNull(user)) {
                return false;
            }
            return Boolean.TRUE.equals(user.getIsValid());
        }
</code></pre>
<h2 id="-28"></h2>
<h2 id="9ç¼“å†²åŒº"><strong>9.ç¼“å†²åŒº</strong></h2>
<h3 id="91åˆå§‹åŒ–æ—¶å°½é‡æŒ‡å®šç¼“å†²åŒºå¤§å°"><strong>9.1.åˆå§‹åŒ–æ—¶å°½é‡æŒ‡å®šç¼“å†²åŒºå¤§å°</strong></h3>
<p>åˆå§‹åŒ–æ—¶ï¼ŒæŒ‡å®šç¼“å†²åŒºçš„é¢„æœŸå®¹é‡å¤§å°ï¼Œé¿å…å¤šæ¬¡æ‰©å®¹æµªè´¹æ—¶é—´å’Œç©ºé—´ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">StringBuffer buffer = new StringBuffer();
StringBuilder builder = new StringBuilder();
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">StringBuffer buffer = new StringBuffer(1024);
StringBuilder builder = new StringBuilder(1024);
</code></pre>
<h3 id="-29"></h3>
<h3 id="92å°½é‡é‡å¤ä½¿ç”¨åŒä¸€ç¼“å†²åŒº"><strong>9.2.å°½é‡é‡å¤ä½¿ç”¨åŒä¸€ç¼“å†²åŒº</strong></h3>
<p>é’ˆå¯¹ç¼“å†²åŒºï¼ŒJavaè™šæ‹Ÿæœºéœ€è¦èŠ±æ—¶é—´ç”Ÿæˆå¯¹è±¡ï¼Œè¿˜è¦èŠ±æ—¶é—´è¿›è¡Œåƒåœ¾å›æ”¶å¤„ç†ã€‚æ‰€ä»¥ï¼Œå°½é‡é‡å¤åˆ©ç”¨ç¼“å†²åŒºã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        StringBuilder builder1 = new StringBuilder(128);
        builder1.append(&quot;update t_user set name = '&quot;).append(userName).append(&quot;' where id = &quot;).append(userId);
        statement.executeUpdate(builder1.toString());
        StringBuilder builder2 = new StringBuilder(128);
        builder2.append(&quot;select id, name from t_user where id = &quot;).append(userId);
        ResultSet resultSet = statement.executeQuery(builder2.toString());...
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        StringBuilder builder = new StringBuilder(128);
        builder.append(&quot;update t_user set name = '&quot;).append(userName).append(&quot;' where id = &quot;).append(userId);
        statement.executeUpdate(builder.toString());
        builder.setLength(0);
        builder.append(&quot;select id, name from t_user where id = &quot;).append(userId);
        ResultSet resultSet = statement.executeQuery(builder.toString());...
</code></pre>
<p>å…¶ä¸­ï¼Œä½¿ç”¨setLengthæ–¹æ³•è®©ç¼“å†²åŒºé‡æ–°ä»0å¼€å§‹ã€‚</p>
<h3 id="93å°½é‡è®¾è®¡ä½¿ç”¨åŒä¸€ç¼“å†²åŒº"><strong>9.3.å°½é‡è®¾è®¡ä½¿ç”¨åŒä¸€ç¼“å†²åŒº</strong></h3>
<p>ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåœ¨è®¾è®¡ä¸Šå°½é‡ä½¿ç”¨åŒä¸€ç¼“å†²åŒºã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        // è½¬åŒ–XML(UserDO)
         public static String toXml (UserDO user){
            StringBuilder builder = new StringBuilder(128);
            builder.append(&quot;&lt;UserDO&gt;&quot;);
            builder.append(toXml(user.getId()));
            builder.append(toXml(user.getName()));
            builder.append(toXml(user.getRole()));
            builder.append(&quot;&lt;/UserDO&gt;&quot;);
            return builder.toString();
        }
        // è½¬åŒ–XML(Long)
        public static String toXml (Long value){
            StringBuilder builder = new StringBuilder(128);
            builder.append(&quot;&lt;Long&gt;&quot;);
            builder.append(value);
            builder.append(&quot;&lt;/Long&gt;&quot;);
            return builder.toString();
        }...
        // ä½¿ç”¨ä»£ç 
        UserDO user = ...;
        String xml = toXml(user);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">        // è½¬åŒ–XML(UserDO)
        public static void toXml (StringBuilder builder, UserDO user){
            builder.append(&quot;&lt;UserDO&gt;&quot;);
            toXml(builder, user.getId());
            toXml(builder, user.getName());
            toXml(builder, user.getRole());
            builder.append(&quot;&lt;/UserDO&gt;&quot;);
        }
        // è½¬åŒ–XML(Long)
        public static void toXml (StringBuilder builder, Long value){
            builder.append(&quot;&lt;Long&gt;&quot;);
            builder.append(value);
            builder.append(&quot;&lt;/Long&gt;&quot;);
        }...
        // ä½¿ç”¨ä»£ç 
        UserDO user = ...;
        StringBuilder builder = new StringBuilder(1024);
        toXml(builder, user);
        String xml = builder.toString();
</code></pre>
<p>å»æ‰æ¯ä¸ªè½¬åŒ–æ–¹æ³•ä¸­çš„ç¼“å†²åŒºç”³è¯·ï¼Œç”³è¯·ä¸€ä¸ªç¼“å†²åŒºç»™æ¯ä¸ªè½¬åŒ–æ–¹æ³•ä½¿ç”¨ã€‚ä»æ—¶é—´ä¸Šæ¥è¯´ï¼ŒèŠ‚çº¦äº†å¤§é‡ç¼“å†²åŒºçš„ç”³è¯·é‡Šæ”¾æ—¶é—´ï¼›ä»ç©ºé—´ä¸Šæ¥è¯´ï¼ŒèŠ‚çº¦äº†å¤§é‡ç¼“å†²åŒºçš„ä¸´æ—¶å­˜å‚¨ç©ºé—´ã€‚</p>
<h3 id="94å°½é‡ä½¿ç”¨ç¼“å†²æµå‡å°‘ioæ“ä½œ"><strong>9.4.å°½é‡ä½¿ç”¨ç¼“å†²æµå‡å°‘IOæ“ä½œ</strong></h3>
<p>ä½¿ç”¨ç¼“å†²æµBufferedReaderã€BufferedWriterã€BufferedInputStreamã€BufferedOutputStreamç­‰ï¼Œå¯ä»¥å¤§å¹…è¾ƒå°‘IOæ¬¡æ•°å¹¶æå‡IOé€Ÿåº¦ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        try (FileInputStream input = new FileInputStream(&quot;a&quot;); FileOutputStream output = new FileOutputStream(&quot;b&quot;)) {
            int size = 0;
            byte[] temp = new byte[1024];
            while ((size = input.read(temp)) != -1) {
                output.write(temp, 0, size);
            }
        } catch (IOException e) {
            log.error(&quot;å¤åˆ¶æ–‡ä»¶å¼‚å¸¸&quot;, e);
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-javascript">        try (BufferedInputStream input = new BufferedInputStream(new FileInputStream(&quot;a&quot;)); BufferedOutputStream output = new BufferedOutputStream(new FileOutputStream(&quot;b&quot;))) {
            int size = 0;
            byte[] temp = new byte[1024];
            while ((size = input.read(temp)) != -1) {
                output.write(temp, 0, size);
            }
        } catch (IOException e) {
            log.error(&quot;å¤åˆ¶æ–‡ä»¶å¼‚å¸¸&quot;, e);
        }
</code></pre>
<p>å…¶ä¸­ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ‰‹åŠ¨æŒ‡å®šç¼“å†²æµçš„å¤§å°ï¼ŒæŠŠç¼“å†²æµçš„ç¼“å†²ä½œç”¨å‘æŒ¥åˆ°æœ€å¤§ã€‚</p>
<h2 id="10çº¿ç¨‹"><strong>10.çº¿ç¨‹</strong></h2>
<h3 id="101åœ¨å•çº¿ç¨‹ä¸­å°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»"><strong>10.1.åœ¨å•çº¿ç¨‹ä¸­ï¼Œå°½é‡ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»</strong></h3>
<p>ä½¿ç”¨éçº¿ç¨‹å®‰å…¨ç±»ï¼Œé¿å…äº†ä¸å¿…è¦çš„åŒæ­¥å¼€é”€ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">StringBuffer buffer = new StringBuffer(128);
buffer.append(&quot;select * from &quot;).append(T_USER).append(&quot; where id = ?&quot;);
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">StringBuilder buffer = new StringBuilder(128);
buffer.append(&quot;select * from &quot;).append(T_USER).append(&quot; where id = ?&quot;);
</code></pre>
<h3 id="-30"></h3>
<h3 id="102åœ¨å¤šçº¿ç¨‹ä¸­å°½é‡ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»"><strong>10.2.åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå°½é‡ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»</strong></h3>
<p>ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»ï¼Œæ¯”è‡ªå·±å®ç°çš„åŒæ­¥ä»£ç æ›´ç®€æ´æ›´é«˜æ•ˆã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">				private volatile int counter = 0;
        public void access (Long userId){
            synchronized (this) {
                counter++;
            }    ...}
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">private final AtomicInteger counter = new AtomicInteger(0);
        public void access (Long userId){
            counter.incrementAndGet();    ...}
</code></pre>
<h3 id="-31"></h3>
<h3 id="103å°½é‡å‡å°‘åŒæ­¥ä»£ç å—èŒƒå›´"><strong>10.3.å°½é‡å‡å°‘åŒæ­¥ä»£ç å—èŒƒå›´</strong></h3>
<p>åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œå¯èƒ½åªæœ‰ä¸€å°éƒ¨åˆ†çš„é€»è¾‘æ˜¯éœ€è¦åŒæ­¥æ§åˆ¶çš„ï¼Œå¦‚æœåŒæ­¥æ§åˆ¶äº†æ•´ä¸ªæ–¹æ³•ä¼šå½±å“æ‰§è¡Œæ•ˆç‡ã€‚æ‰€ä»¥ï¼Œå°½é‡å‡å°‘åŒæ­¥ä»£ç å—çš„èŒƒå›´ï¼Œåªå¯¹éœ€è¦è¿›è¡ŒåŒæ­¥çš„ä»£ç è¿›è¡ŒåŒæ­¥ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">  		  private volatile int counter = 0;
        public synchronized void access (Long userId){
            counter++;    ... // éåŒæ­¥æ“ä½œ
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">				private volatile int counter = 0;
        public void access (Long userId){
            synchronized (this) {
                counter++;
            }    ... // éåŒæ­¥æ“ä½œ}
</code></pre>
<h3 id="-32"></h3>
<h3 id="104å°½é‡åˆå¹¶ä¸ºåŒä¸€åŒæ­¥ä»£ç å—"><strong>10.4.å°½é‡åˆå¹¶ä¸ºåŒä¸€åŒæ­¥ä»£ç å—</strong></h3>
<p>åŒæ­¥ä»£ç å—æ˜¯æœ‰æ€§èƒ½å¼€é”€çš„ï¼Œå¦‚æœç¡®å®šå¯ä»¥åˆå¹¶ä¸ºåŒä¸€åŒæ­¥ä»£ç å—ï¼Œå°±åº”è¯¥å°½é‡åˆå¹¶ä¸ºåŒä¸€åŒæ­¥ä»£ç å—ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">				// å¤„ç†å•ä¸€è®¢å•
        public synchronized handleOrder(OrderDO order) {    ...}
        // å¤„ç†æ‰€æœ‰è®¢å•
        public void handleOrder (List &lt; OrderDO &gt; orderList) {
            for (OrderDO order : orderList) {
                handleOrder(order);
            }
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java"> 				 // å¤„ç†å•ä¸€è®¢å•
         public handleOrder(OrderDO order) {    ...}
        // å¤„ç†æ‰€æœ‰è®¢å•
        public synchronized void handleOrder (List &lt; OrderDO &gt; orderList) {
            for (OrderDO order : orderList) {
                handleOrder(order);
            }
        }
</code></pre>
<h3 id="-33"></h3>
<h3 id="105å°½é‡ä½¿ç”¨çº¿ç¨‹æ± å‡å°‘çº¿ç¨‹å¼€é”€"><strong>10.5.å°½é‡ä½¿ç”¨çº¿ç¨‹æ± å‡å°‘çº¿ç¨‹å¼€é”€</strong></h3>
<p>å¤šçº¿ç¨‹ä¸­ä¸¤ä¸ªå¿…è¦çš„å¼€é”€ï¼šçº¿ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚é‡‡ç”¨çº¿ç¨‹æ± ï¼Œå¯ä»¥å°½é‡åœ°é¿å…è¿™äº›å¼€é”€ã€‚</p>
<p><strong>åä¾‹ï¼š</strong></p>
<pre><code class="language-java">        public void executeTask (Runnable runnable){
            new Thread(runnable).start();
        }
</code></pre>
<p><strong>æ­£ä¾‹ï¼š</strong></p>
<pre><code class="language-java">private static final ExecutorService EXECUTOR_SERVICE = Executors.newFixedThreadPool(10);
        public void executeTask (Runnable runnable){
            executorService.execute(runnable);
        }
</code></pre>
<h2 id="-34"></h2>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç¬¬ä¸€æ¬¡é•¿é€”è‡ªé©¾å‘€]]></title>
        <id>https://WheatJack.github.io/post/travel0911/</id>
        <link href="https://WheatJack.github.io/post/travel0911/">
        </link>
        <updated>2020-10-17T14:52:31.000Z</updated>
        <content type="html"><![CDATA[<h1 id="é’ç”˜å¤§ç¯çº¿ä¸ƒæ—¥æ”»ç•¥æ€»ç»“">é’ç”˜å¤§ç¯çº¿ä¸ƒæ—¥æ”»ç•¥æ€»ç»“</h1>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giw2e1rqefj311c0s8dxr.jpg" alt="image-20200919165906897" loading="lazy"></figure>
<blockquote>
<p>ä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹ç”Ÿæ´»ï¼Œæ€•è€äº†å¿˜è®°äº†è¿™æ¬¡æ—…è¡Œã€‚ä¹‹å‰å‡ºå‘å‰ä¹Ÿæ˜¯å„ç§æ‰¾æ”»ç•¥ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä»½å¾ˆå…¨çš„æ”»ç•¥ï¼Œéƒ½æ˜¯ä¸ƒé›¶å…«è½çš„ï¼Œä½†æ˜¯è¿™æ¬¡æ˜¯è‡ªå·±äº²èº«ç»å†ï¼ŒæŠ±ç€å¼€æºçš„æ€æƒ³ï¼Œè¿˜æ˜¯æŠŠå‘å‘æ´¼æ´¼çš„ç»å†å‘Šè¯‰å¤§å®¶ï¼Œé¿å…å¤§å®¶è¸©å‘å‘ï¼Œå¥½äº†ï¼Œæˆ‘ä»¬çš„æ—…é€”å¼€å§‹äº†ã€‚GOGOGOã€‚æˆ‘ä»¬æ˜¯ä¸‰äººè‡ªé©¾æ¸¸ï¼Œä¸‰ä¸ªå•èº«ç‹—ã€‚ç¬¬ä¸€æ¬¡è‡ªé©¾ä¸‰åƒå…¬é‡Œï¼Œçªç„¶å‘ç°æœ‰ç‚¹çŒ›ï¼Œæ—¶é—´ä¸º20200911-20200919ï¼Œä¸€æ¬¡ä¸ä¸€æ ·çš„æ—…è¡Œâœˆï¸âœˆï¸âœˆï¸ã€‚ä¸Šé¢é‚£å¼ å›¾æ˜¯æ•´ä¸ªç¯çº¿çš„å¤§å›¾ï¼Œä¸‹é¢è¿˜æœ‰è¯¦ç»†çš„å°å›¾çš„ã€‚</p>
</blockquote>
<h2 id="å¿…å¤‡ç‰©å“æ¸…å•">å¿…å¤‡ç‰©å“æ¸…å•</h2>
<blockquote>
<p>æˆ‘ä»¬çš„ç»„åˆæ¯”ä¾‹æ˜¯ä¸¤ç”·ä¸€å¥³ï¼Œä¸‰ä¸ªæ­»å•èº«ç‹—ï¼Œå¹¶ä¸”å¦¹å­ä¹Ÿä¸åŒ–å¦†ï¼Œæ‰€ä»¥ä¸œè¥¿éƒ½æ˜¯ä¸ªäººçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªäººæ˜¯24å¯¸è¡Œæç®±ï¼Œå¦å¤–ä¸€ä¸ªç²¾è‡´ç”·å¸¦äº†ä¸€ä¸ªäºŒåå¯¸çš„å°ç®±å­ï¼Œä½†æ˜¯æ„Ÿè§‰è‡ªå·±å¸¦å°‘äº†ï¼Œæˆ‘ä»¬å¸¦äº†å†…è¡£è¢œå­å•¥çš„ï¼Œä¹‹å‰åœ¨ç½‘ä¸Šçœ‹æ”»ç•¥ï¼Œè¦å¸¦ä¸€æ¬¡æ€§å†…è£¤ï¼Œä¹‹åæ‰å‘ç°ç¡®å®è¦å¸¦ï¼Œæ²¡å¾—åæ‚”è¯åƒï¼Œå› ä¸ºé‚£è¾¹å¥½å¤šåº—æ²¡ç©ºè°ƒï¼Œæ´—äº†è¡£æœæ ¹æœ¬å¹²ä¸äº†ï¼Œæ‰€ä»¥æœ‹å‹éƒ½æ˜¯æ‹¿å¹é£æœºæ­»å‘½çš„å¹ï¼Œå¯æ€œäº†å®¾é¦†çš„å¹é£æœºã€‚æœ‰ç©ºè°ƒçš„å®¾é¦†ï¼Œå¼€çƒ­é£ï¼Œä¸‰ååº¦ï¼Œæ™šä¸Šéƒ½çƒ­é†’äº†ã€‚æ‰€ä»¥emmmmï¼Œè¿˜æ˜¯å¤šå¸¦ç‚¹è¡£æœã€‚å…·ä½“çœ‹ä¸‹é¢çš„æ¸…å•ğŸ§¾å§ã€‚</p>
</blockquote>
<h3 id="1-æ‘„å½±ç¯‡">1ã€æ‘„å½±ç¯‡</h3>
<p>é¦–å…ˆæœ‰æ— äººæœºä¸€å®šè¦å¸¦æ— äººæœºï¼Œå› ä¸ºå¥½å¤šæ™¯ç‚¹éƒ½éœ€è¦ä¸Šå¸è§†è§’æ¥çœ‹æ‰æ˜¯æœ€ç¾çš„ï¼Œæœ‰æ— äººæœºå¯ä»¥æ‹å‡ºè£…é€¼çš„ç…§ç‰‡å’Œè§†é¢‘ã€‚å¥½å¤šåœ°æ–¹éƒ½éœ€è¦æ— äººæœºéƒ½æ‹çš„å‡ºæ¥ï¼Œä»€ä¹ˆæ¶é­”ä¹‹çœ¼ï¼Œæ°´ä¸Šé›…ä¸¹ç­‰ï¼›å…¶æ¬¡ï¼Œæœ‰ç›¸æœºå°±å¸¦ç›¸æœºï¼Œå¦‚æœè¦æ‹æ˜Ÿæ˜Ÿâœ¨ï¼Œè®°å¾—ä¸€å®šè¦å¸¦å¤§å…‰åœˆé•œå¤´ï¼Œå› ä¸ºè¿™è¾¹å¤©é»‘äº†ä»¥åï¼Œé“¶æ²³æ˜Ÿç©ºéƒ½æ˜¯è‚‰çœ¼å¯è§é‚£ç§ï¼Œæ²¡å¸¦é•œå¤´ï¼Œè¦å“­äº†ï¼Œè²Œä¼¼ç‰›é€¼çš„åä¸ºä¹Ÿå¯ä»¥æ‹å‡ºæ˜Ÿç©ºæ¥ã€‚ä½†æ˜¯ä¸“ä¸šçš„äº‹æƒ…è¿˜æ˜¯è¦ä¸“ä¸šçš„è®¾å¤‡æ¥æ‹ã€‚å‡ºè‰²çš„æ‰‹æœºä¹Ÿæ˜¯å¾ˆå¼ºçš„ï¼Œè¿˜æ˜¯è¦å¤šæ‹æ‹ï¼Œæ¯•ç«Ÿæ‹äº†æ‰å¯ä»¥é€‰ï¼Œä¸æ‹è‚¯å®šæ²¡å¾—é€‰ï¼Œå¤šæ‹ï¼Œç„¶åå¸¦ä¸Šä¸‡èƒ½çš„å¢¨é•œæ‘†poseï¼Œå¢¨é•œä¸€æˆ´ï¼Œè°ä¹Ÿä¸çˆ±ã€‚å“ˆå“ˆå“ˆå“ˆã€‚</p>
<h3 id="2-æŠ¤è‚¤ç¯‡">2ã€æŠ¤è‚¤ç¯‡</h3>
<p>è¿™è¾¹åŠå…¶å¹²ç‡¥ï¼Œå¿…é¡»å¸¦æŠ¤è‚¤å“æ¥ï¼Œå¹²åˆ°å“­æ³£é‚£ç§ï¼Œç©ä¸ªä¸ƒå¤©ï¼Œæ„Ÿè§‰é¢å®¹å˜å¾—æå…¶æ²§æ¡‘ã€‚é˜²æ™’å¿…é¡»å¸¦è¿‡å»ï¼Œå¤ªé˜³å¤ªå¤§äº†ï¼ŒåŠå…¶å¤§ï¼Œç´«å¤–çº¿åŠå…¶å¼ºã€‚æ˜¯ä¸ªå¦¹å­è®°å¾—å¤šå¸¦é¢è†œï¼Œè¡¥è¡¥æ°´ï¼Œä½œä¸ºä¸€ä¸ªæ±‰å­éƒ½æƒ³å¸¦ï¼Œåæ‚”æ²¡å¸¦ã€‚</p>
<h3 id="3-è¡£æœç¯‡">3ã€è¡£æœç¯‡</h3>
<p>å¿…å¤‡è¡£æœå•¥çš„è®°å¾—éƒ½å¸¦ï¼Œè½»è–„ç¾½ç»’æœä¹Ÿæ˜¯å¯ä»¥å¸¦çš„ï¼Œå› ä¸ºæ—©æ™šæ¸©åº¦è¶…çº§ä½ã€‚å†…è¡£å†…è£¤è¢œå­å•¥çš„è®°å¾—å¤šå¸¦ç‚¹ï¼Œè¿™è¾¹å¥½å¤šæ—…åº—æ²¡ç©ºè°ƒçš„ï¼Œç„¶åæš–æ°”ä¹Ÿæ²¡å¼€ï¼Œå¯¼è‡´æ´—äº†è¡£æœæ ¹æœ¬å¹²ä¸äº†ï¼Œä¸€å®šè¦å¸¦å¢¨é•œğŸ•¶ï¸ï¼Œå¸½å­ğŸ©ï¼Œé¢å·¾ğŸ­ï¼Œå› ä¸ºç´«å¤–çº¿çœŸçš„å¼ºäº†ï¼Œå…‰çº¿å¯ä»¥ç…§çç‹—çœ¼ğŸ¶ğŸ‘€ã€‚è®°å¾—å¸¦ä¸ªæ‹–é‹ï¼Œå› ä¸ºå®¾é¦†çš„å¤ªè„äº†ã€‚æ•å¤´å¥—è®°å¾—å¸¦ä¸ªã€‚è¦å¥½çœ‹ï¼Œæ¯å¤©ç©¿ä¸ä¸€æ ·çš„ï¼Œè‚¯å®šå¤šå¸¦å¥½çœ‹çš„è¡£æœå˜›ï¼Œå±•ç°ä¸ä¸€æ ·çš„è‡ªå·±ã€‚</p>
<h3 id="4-é£Ÿç‰©ç¯‡">4ã€é£Ÿç‰©ç¯‡</h3>
<p>ç›´æ¥å»è¶…å¸‚ä¹°å¥½å‡ å¤©çš„åƒçš„ä¸œè¥¿å°±è¡Œï¼Œå¤šä¹°æ°´æœï¼Œå¤šä¹°å–çš„ï¼Œå› ä¸ºåŠå…¶å¹²ï¼Œå¤šè¡¥å……æ°´ä»½ï¼›å¤šä¹°äº›é«˜çƒ­é‡çš„ä¸œè¥¿ï¼Œå› ä¸ºç»å¸¸æ˜¯æ²¡æœ‰åœ°æ–¹åƒåˆé¥­å’Œæ™šé¥­ï¼Œå› ä¸ºä¸€ç›´åœ¨è·¯ä¸Šï¼Œemmmmmã€‚</p>
<p>é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œä¸€å®šè¦å¸¦ä¸€ä¸ª<strong>ç©ºæ°”åŠ æ¹¿å™¨</strong>ï¼Œ**ç©ºæ°”åŠ æ¹¿å™¨ï¼Œç©ºæ°”åŠ æ¹¿å™¨ï¼Œ**ä¸€å®šè®°å¾—ï¼Œå¥½ç‚¹çš„é…’åº—æˆ¿é—´é‡Œæœ‰è¿™ä¸ªï¼Œå¤§éƒ¨åˆ†é…’åº—æ˜¯æ²¡è¿™ä¸ªçš„ï¼Œä¹°å¸¦USBé‚£ç§ï¼Œå¯ä»¥æ”¾åœ¨è½¦ä¸Šå¼€ç€ä½¿ç”¨ã€‚</p>
<p><strong>å¢¨é•œå¢¨é•œå¢¨é•œï¼Œå¸½å­å¸½å­å¸½å­ï¼Œä¸€å®šè¦å¸¦ï¼Œå¯ä»¥é®é˜³ï¼Œåˆå¯ä»¥å½“é“å…·ã€‚</strong></p>
<h3 id="5-è¯ç‰©ç¯‡">5ã€è¯ç‰©ç¯‡</h3>
<p>è¿™è¾¹æ²¡æœ‰é«˜åï¼Œæ‰€ä»¥ä»€ä¹ˆé«˜åŸè¯å°±ä¸è¦å¸¦äº†ï¼Œå¯ä»¥å¸¦ç‚¹æ„Ÿå†’è¯å•¥çš„ï¼Œè‚ èƒƒä¸å¥½å¸¦ä¸ªè‚ ç‚å®æ¥ï¼Œå¯ä»¥å¸¦ä¸ªæŒ‡ç”²å‰ªæ¥ï¼Œè§‰å¾—åœ¨è¿™è¾¹æŒ‡ç”²é•¿çš„ç‰¹åˆ«å¿«ã€‚</p>
<p>----------------------æˆ‘æ˜¯ä¸€æ¡æ²¡æœ‰æ„Ÿæƒ…çš„åˆ†å‰²çº¿-----------------------</p>
<p>é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œä¸€å®šè¦å¸¦ä¸€ä¸ª<strong>ç©ºæ°”åŠ æ¹¿å™¨</strong>ï¼Œ**ç©ºæ°”åŠ æ¹¿å™¨ï¼Œç©ºæ°”åŠ æ¹¿å™¨ï¼Œ**ä¸€å®šè®°å¾—ï¼Œå¥½ç‚¹çš„é…’åº—æˆ¿é—´é‡Œæœ‰è¿™ä¸ªï¼Œå¤§éƒ¨åˆ†é…’åº—æ˜¯æ²¡è¿™ä¸ªçš„ï¼Œä¹°å¸¦USBé‚£ç§ï¼Œå¯ä»¥æ”¾åœ¨è½¦ä¸Šå¼€ç€ä½¿ç”¨ã€‚</p>
<p><strong>å¢¨é•œå¢¨é•œå¢¨é•œï¼Œå¸½å­å¸½å­å¸½å­ï¼Œä¸€å®šè¦å¸¦ï¼Œå¯ä»¥é®é˜³ï¼Œåˆå¯ä»¥å½“é“å…·ã€‚</strong></p>
<p>----------------------æˆ‘æ˜¯ä¸€æ¡æ²¡æœ‰æ„Ÿæƒ…çš„åˆ†å‰²çº¿-----------------------</p>
<h2 id="æ—…è¡Œè·¯çº¿">æ—…è¡Œè·¯çº¿</h2>
<blockquote>
<p>è¿™ä¸ªè·¯çº¿ä¸»è¦èµ°çš„å°±æ˜¯ä¸€ä¸ªç¯çº¿ï¼Œå…¨é•¿2400å…¬é‡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¼€äº†ä¸‰åƒå…¬é‡Œï¼Œemmmï¼Œä¼°è®¡æ˜¯èµ°äº†å¤ªå¤šçš„å¼¯è·¯ï¼Œæˆ‘ä»¬æ˜¯å‘¨äº”æ™šä¸Šé£æœºé£åˆ°è¥¿å®ï¼Œç„¶ååœ¨è¥¿å®ç§Ÿè½¦ï¼Œç„¶åè¥¿å®è¿‡å¤œã€‚æ‰€ä»¥è¥¿å®æ˜¯èµ·ç‚¹ä¹Ÿæ˜¯ç»ˆç‚¹ğŸã€‚ç½‘ä¸Šç±»å‹çš„ç¯çº¿åœ°å›¾å¾ˆå¤šï¼Œç»™å¤§å®¶æ‰¾äº†ä¸€ä¸ªæ ‡å‡†çš„ã€‚åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ä¸ªï¼Œåªæ˜¯ç»†èŠ‚å¤šå°‘çš„åŸå› ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ç§Ÿè½¦ï¼Œå› ä¸ºè‡ªç”±ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰ç‚¹ç´¯çš„ï¼Œæ¯•ç«Ÿè¦å¤©å¤©å¼€è½¦ï¼›ä¹‹å‰çœ‹æ”»ç•¥ï¼Œä¹Ÿæ˜¯å¯ä»¥åŒ…è½¦çš„ï¼Œä¹Ÿè‡ªç”±ï¼Œä½†æ˜¯è¿™ç§åœ°æ–¹è¿˜æ˜¯éœ€è¦æ–¹å‘ç›˜æŒæ¡è‡ªå·±æ‰‹ä¸Šï¼ŒåŒ…è½¦åº”è¯¥ä¼šå¤šèŠ±é’±ï¼Œæ¯•ç«Ÿå¸¦äº†ä¸€ä¸ªä¸“èŒå¸æœºï¼Œè¿˜æ˜¯æœ¬åœ°äººï¼Œä½†æ˜¯ä¸€èˆ¬éƒ½æ˜¯æœ¬åœ°äººå‘æ¸¸å®¢çš„ï¼Œå“ˆå“ˆå“ˆå“ˆï¼Œå¤§å®¶æ ¹æ®è‡ªå·±æƒ…å†µæ¥ã€‚å¦‚æœæ˜¯è‡ªé©¾ï¼Œé‚£ä¹ˆä½ å¤§å¯ä»¥æ”¾å¿ƒå¼€ï¼Œè¿™è¾¹è·¯å†µçœŸçš„å¾ˆå¥½ï¼Œæœ‰çš„å›½é“æ¯”é«˜é€Ÿè·¯è¿˜å¥½ï¼Œè€Œä¸”å°±ä¸€æ®µå‘å‘æ´¼æ´¼çš„è·¯ï¼Œå…¶ä»–çš„è·¯éƒ½å¾ˆå¥½ï¼Œåœ¨è·¯ä¸Šçœ‹åˆ°äº†å¾ˆå¤šè½¿è½¦éƒ½è·‘è¿™ä¸ªè·¯ï¼Œæ¯”å¦‚20å¹´å‰çš„Santanaï¼Œè¿˜æœ‰è½¦ä¸­ä¹‹ç‹--äº”è±å®å…‰å¤§å“¥ï¼Œæ‰€ä»¥ï¼Œå…„å¼Ÿåˆ«çŠ¹è±«äº†ï¼Œèµ¶ç´§ä¸Šè·¯å§ï¼Œè½¦åªæ˜¯å·¥å…·ï¼Œä¸»è¦æ˜¯æœ‰ä¸€é¢—å¥”è·‘çš„å¿ƒã€‚</p>
</blockquote>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjtc6d72shj30lq0pqjvo.jpg" alt="IMG_2932" loading="lazy"></figure>
<p>å› ä¸ºæˆ‘ä»¬æ¥çš„é‚£å¤©ï¼Œé’æµ·çš„å¤©æ°”ä¸å¥½ï¼Œç”˜è‚ƒçš„å¤©æ°”å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬èµ°çš„æ˜¯é’ç”˜ç¯çº¿çš„åæ–¹å‘ï¼Œæˆ‘ä»¬å…ˆå¾€ç”˜è‚ƒèµ°ï¼Œç„¶ååœ¨ç»•ä¸€ä¸ªåœˆå­åˆ°è¥¿å®ï¼Œç¬¬ä¸€å¤©ä½å®¿åœ¨è¥¿å®ã€‚</p>
<h3 id="1-day01">1ã€Day01</h3>
<blockquote>
<p>å…¨é•¿340KMï¼Œè¡Œç¨‹æ¯”è¾ƒè½»æ¾(ç›¸å¯¹äºåé¢çš„è·¯ç¨‹ï¼ŒçœŸçš„å¥½è½»æ¾)ï¼Œåˆ°ç¥è¿å±±è‰åŸæ—¶æµ·æ‹”è¾ƒé«˜ï¼Œå¼¯é“æ¯”è¾ƒå¤šï¼Œå…ˆæ˜¯ä¸Šå±±è·¯æ®µï¼Œç„¶åå°±æ˜¯ä¸‹å±±è·¯æ®µï¼Œç„¶åå°±æ˜¯ä¸€ç›´å¤§ç›´é©¬è·¯äº†ï¼Œå±±è·¯å¼€è½¦æ—¶éœ€è¦æ³¨æ„ã€‚è€Œä¸”è·¯è¾¹çš„å•æ‰€æ¯”è¾ƒå°‘ï¼Œæœ‰å…¬å…±å•æ‰€ä¹Ÿæ˜¯ä¸€å…ƒä¸€æ¬¡çš„æ”¶è´¹å•æ‰€ï¼Œæ³¨æ„ä¸è¦å–å¤ªå¤šæ°´ã€‚</p>
</blockquote>
<p><strong>è·¯çº¿ï¼šè¥¿å®â€”é»‘æ³‰æ°´åº“â€”ç¥è¿å±±è§‚æ™¯å°â€”é—¨æºæ²¹èœèŠ±â€”ç¥è¿å±±å¤§è‰åŸâ€”å¼ æ–</strong></p>
<p>ç¬¬ä¸€å¤©è¿˜æ²¡æœ‰æ„Ÿå—åˆ°è¥¿å®çš„å¹²ç‡¥ï¼Œå› ä¸ºä¸‹é›¨ï¼Œæˆ¿é—´æœ‰åŠ æ¹¿å™¨ã€‚ç¬¬ä¸€å¤©çš„è¡Œç¨‹æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å»é€›äº†ä¸€ä¸‹è¶…å¸‚ï¼Œæ¯•ç«Ÿå¥½å¤šæ—¶é—´åœ¨è½¦å­ä¸Šï¼Œæ‰€ä»¥ä¹°äº†å¥½å¤šçš„åƒåƒå–å–çš„ï¼Œè¿˜æœ‰æ°´æœå•¥çš„ï¼Œæ»¡æ»¡ä¸€å¤§è¢‹è¢‹è´­ç‰©è½¦ğŸ›’ï¼Œè‡ªåŠ©çš„æ”¶é“¶çš„å‘ç¥¨éƒ½å¥½é•¿ï¼Œå¦‚å›¾ã€‚</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj4egzs7erj30u0268kjn.jpg" alt="IMG_3038" style="zoom:25%;" />
<p>è´­ç‰©å®Œï¼Œæˆ‘ä»¬å°±å¼€å§‹ä¸Šè·¯ï¼Œç¬¬ä¸€å¤©æ²¡æ‰¾åˆ°åƒæ—©é¤çš„åœ°æ–¹ï¼Œå…¨é æ—©ä¸Šä¹°çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ…¢æ…¢å¼€ï¼Œç„¶åå¾€æ°´åº“å‡ºå‘ã€‚åœ¨åŠè·¯ä¸Šï¼Œçœ‹åˆ°é£æ™¯è¿˜ä¸é”™ï¼Œæˆ‘ä»¬å°±ä¸‹è½¦æ‹äº†ä¸€äº›ç…§ç‰‡ï¼Œè¿˜æ²¡æœ‰åˆ°æ°´åº“ã€‚å°±çæ‹äº†å‡ å¼ ç…§ç‰‡ï¼Œæ„Ÿå—äº†ä¸€ä¸‹å¤§è‡ªç„¶çš„ç¾ä¸½ï¼Œç¡®å®æ²¡è§è¿‡ç±»ä¼¼çš„åœºæ™¯ã€‚å“ˆå“ˆå“ˆã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjtc6otl8rj31400u01ky.jpg" alt="IMG_1719" loading="lazy"></figure>
<p>è·¯è¾¹çš„æ°´emmmmmã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjtc70r7ikj31hc0u04qv.jpg" alt="DJI_0020-1" loading="lazy">ç„¶åå°±æ˜¯ä¸€è·¯ä¸Šçš„èµ¶è·¯äº†ï¼Œ<strong>é»‘æ³‰æ°´åº“</strong>å°±æ˜¯ä¸€ä¸ªæ°´åº“ï¼Œæˆ‘ä»¬ç›´æ¥å¼€è¿‡å»äº†ï¼Œæ²¡åœä¸‹æ¥æ‹ç…§ã€‚ç„¶åå¤©æ°”é€æ¸å˜å¥½ï¼Œæˆ‘ä»¬å°±èµ¶åˆ°äº†ä¸‹ä¸€ä¸ª<strong>æ™¯ç‚¹ç¥è¿å±±è§‚æ™¯å°</strong>ï¼Œè¿™è¾¹ä¿¯ç°æ•´ä¸ªå±±ä¸‹çœŸçš„è¶…çº§ç¾ï¼Œè€Œä¸”é‚£å¤©çš„å¤©æ°”ä¹Ÿç›¸å½“çš„å¥½ï¼Œä¸è¯´ğŸ™Šç›´æ¥ä¸Šå›¾ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj4faizrbsj31400u0kjq.jpg" alt="IMG_1722" loading="lazy"></figure>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjtc7coydnj31400u07wo.jpg" alt="IMG_1744"  />
<p><em><strong>å¸®å‚»é›•æ‹çš„ç…§ç‰‡ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</strong></em></p>
<p>è¿™é‡Œå°±æ˜¯è§‚æ™¯å°äº†ï¼Œemmmmå¥½å¤šäººï¼Œåƒä¸‡åˆ«ä¹°é‚£è¾¹å–çš„ç‰ç±³ï¼Œè¶…çº§è€ï¼Œé‚£è¾¹åœè½¦æ”¶è´¹äº”å—é’±ï¼Œæœ‰å•æ‰€å“Ÿã€‚</p>
<p>ç„¶åå°±å¼€å§‹ä¸‹å±±è·¯äº†ï¼Œé—¨æºæˆ‘ä»¬æ²¡å»ï¼Œå› ä¸ºæ˜¯æ±Ÿè¥¿äººï¼Œçœ‹å¤šäº†æ²¹èœèŠ±ï¼Œæ²¡å»æœ‰ç‚¹åæ‚”ï¼Œçœ‹äº†åˆ«äººçš„ç…§ç‰‡å‘ç°åˆ«äººå®¶çš„æ²¹èœèŠ±è¿˜æ˜¯é¦™çš„ã€‚ç„¶åæˆ‘ä»¬å°±ç›´å¥”å¤§è‰åŸäº†ã€‚è·¯ä¸Šçœ‹åˆ°è‚‰çœ¼å¯è§çš„é›ªå±±ï¼Œå¦ˆå‘€ç¬¬ä¸€æ¬¡çœ‹è§é›ªå±±ï¼Œæœ‰ç‚¹æ¿€åŠ¨ã€‚å¤©çœŸè“å‘€ã€‚</p>
<p><strong>è¿œçœºå²—ä»€å¡é›ªå³°</strong></p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj4fn2pnnvj31400u0x6t.jpg" alt="IMG_1749"  />
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj4ftspt82j31400u0x6r.jpg" alt="IMG_1754" loading="lazy"></figure>
<p>ç„¶åå°±æ˜¯ä¸€è·¯ä¸Šå¼€å¼€å¼€äº†ï¼Œè¿™227çœŸçš„æ˜¯æœ€ç¾å›½é“(æ¥ä¸‹æ¥ä¼šæ‰“è„¸çš„)ã€‚</p>
<p>ä¸çŸ¥é“å“ªä¸ªå±±å¤´ã€‚ã€‚ã€‚ã€‚ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjspnao9caj31hc0u0qv8.jpg" alt="DJI_0032-1" loading="lazy"></figure>
<p>ä¸€è·¯ç¥è¿è‰åŸè¿ç‰‡ï¼Œç‰›ç¾Šæˆç¾¤ã€‚ç»è¿‡æ‰éƒ½å³¡ï¼Œåé¢å°±æ²¡æ‹ç…§äº†ï¼Œä¸€ç›´åœ¨èµ¶è·¯ã€‚è·¯ä¸Šåˆ°è¾¾å¼ æ–ã€‚</p>
<p>ç¬¬ä¸€å¤©ï¼Œæ—©ä¸Šæ²¡åƒï¼Œä¸­åˆåƒäº†ä¸€ç¢—ç‰›è‚‰é¢ã€‚æ™šä¸Šåœ¨å¼ æ–åƒäº†é¥­ã€‚å»äº†æ˜¯å¼ æ–æœ€æœ‰åå°åƒåº—ï¼Œemmmmmåˆ«å»ï¼Œå¥½éš¾åƒã€‚å¤ªæ²¹è…»äº†ï¼Œåƒä¸ä¸‹ã€‚åˆ«è½»æ˜“å°è¯•ï¼Œä¸€å°è¯•å°±å¤±è´¥ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gjspoxw1aij31400u07wo.jpg" alt="IMG_1773" loading="lazy"></figure>
<p><strong>ä»Šå¤©ä¸€å¤©çš„ä¸‰äººå¼€æ”¯å¦‚ä¸‹ï¼š</strong></p>
<p><strong>è¶…å¸‚é›¶é£Ÿ608 ã€è¿‡è·¯è´¹ 38 ã€åˆé¥­ 41ã€æ„å¤–é™© 27ã€åŠ æ²¹ 130ã€ä½å®¿ 190ã€æ™šé¥­ 176</strong></p>
<h3 id="2-day-02">2ã€day 02</h3>
<blockquote>
<p>ä»Šå¤©çš„è¡Œç¨‹æ˜¯å¼ æ–ä¸€æ—¥æ¸¸ï¼Œç„¶åèµ¶è·¯å»æ•¦ç…Œå¸‚ã€‚ä»Šå¤©çš„è¡Œç¨‹å¤§æ¦‚600+å…¬é‡Œï¼Œæ„Ÿè§‰å¼€äº†ä¸€è·¯ä¸Šçš„è½¦å­ã€‚å¼ æ–çš„ä¸¹éœåœ°è²Œå€¼å¾—ä¸€çœ‹ï¼Œå°¤å…¶æ˜¯ç¬¬äºŒä¸ªç«™æœ€é«˜ç‚¹çœ‹çš„åœ°è²Œéå¸¸çš„éœ‡æ’¼ï¼Œå€¼å¾—çˆ¬ä¸Šå»ä¸€çœ‹ã€‚</p>
</blockquote>
<p>å¼ æ– â€” ä¸¹éœåœ°è²Œ â€” å˜‰å³ªå…³å¸‚ â€” æ•¦ç…Œ</p>
<p>å¼ æ–ä¸ƒå½©ä¸¹éœ å“å°”å±± ç‰›å¿ƒå±±æ—©é¤åå‰å¾€å¼ æ–ä¸ƒå½©ä¸¹éœï¼Œå¼ æ–ä¸ƒå½©ä¸¹éœåœ°è²Œå¥‡è§‚å½¢æˆäº600ä¸‡å¹´å‰ï¼Œä½äºå¼ æ–å¸‚ä¸´æ³½ã€è‚ƒå—å¿å¢ƒå†…ï¼Œè¿™é‡Œæ˜¯å›½å†…å”¯ä¸€çš„ä¸¹éœåœ°è²Œä¸è‰²å½©èƒ½ä¸˜é™µæ™¯è§‚å¤åˆåŒºã€‚è¿™é‡Œä¹Ÿè¢«Â«ä¸­å›½å›½å®¶åœ°ç†Â»æ‚å¿—è¯„ä¸ºä¸­å›½æœ€ç¾çš„ä¸ƒå¤§ä¸¹éœåœ°è²Œä¹‹ä¸€ï¼Œæ™¯åŒºå†…æœ‰å¤šä¸ªè§‚æ™¯å°ä¾›å¤§å®¶è¿›è¡Œæ¸¸è§ˆã€æ‘„å½±ã€‚ä¸¹éœæ™¯åŒºæ˜¯å¼ æ–ä¸¹éœå›½å®¶åœ°è´¨å…¬å›­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œåˆ†ä¸ºå°è¥¿å¤©æ™¯è§‚åŒºå’Œå¤§è¥¿å¤©æ™¯è§‚åŒºã€‚å®ƒæ˜¯ä¸­å›½å¹²æ—±åœ°åŒºæœ€ä¸ºå…¸å‹çš„ä¸¹éœåœ°è²Œï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸­å›½å‘è‚²æœ€å®Œæ•´ï¼Œé€ å‹æœ€ä¸ºå¥‡ç‰¹çš„ä¸¹éœåœ°è²Œä¹‹ä¸€ã€‚</p>
<p>day 03</p>
<p>æ•¦ç…Œ â€” æ•¦ç…Œè«é«˜çªŸ â€” é¸£æ²™å±±ã€æœˆç‰™æ³‰</p>
<p>è«é«˜çªŸä¿—ç§°åƒä½›æ´ï¼Œåè½åœ¨æ²³è¥¿èµ°å»Šè¥¿ç«¯çš„æ•¦ç…Œã€‚å®ƒå§‹å»ºäºåå…­å›½çš„å‰ç§¦æ—¶æœŸï¼Œå†ç»åå…­å›½ï¼šåŒ—æœã€éš‹ã€å”ã€äº”ä»£ã€è¥¿å¤ã€å…ƒç­‰å†ä»£çš„å…´å»ºï¼Œå½¢æˆå·¨å¤§çš„è§„æ¨¡ï¼Œæœ‰æ´çªŸ735ä¸ªï¼Œå£ç”»4.5ä¸‡å¹³æ–¹ç±³ã€æ³¥è´¨å½©å¡‘2415å°Šï¼Œæ˜¯ä¸–ç•Œä¸Šç°å­˜è§„æ¨¡æœ€å¤§ã€å†…å®¹æœ€ä¸°å¯Œçš„ä½›æ•™è‰ºæœ¯åœ°ã€‚1961å¹´ï¼Œè«é«˜çªŸè¢«ä¸­åäººæ°‘å…±å’Œå›½å›½åŠ¡é™¢å…¬å¸ƒä¸ºç¬¬ä¸€æ‰¹å…¨å›½é‡ç‚¹æ–‡ç‰©ä¿æŠ¤å•ä½ä¹‹ä¸€ã€‚1987å¹´ï¼Œè«é«˜çªŸè¢«åˆ—ä¸ºä¸–ç•Œæ–‡åŒ–é—äº§ã€‚è«é«˜çªŸé—¨ç¥¨è´­ä¹°ç½‘å€http://www.mgk.org.cn/index.htmï¼Œæå‰30å¤©è´­ä¹°ï¼Œ7ã€8æœˆä»½å¿…é¡»æå‰è´­ä¹°ï¼Œå¦åˆ™åªèƒ½åˆ°ç°åœºåä¹°åˆ°åº”æ€¥ç¥¨ã€‚</p>
<p>é¸£æ²™å±±æœˆç‰™æ³‰é£æ™¯åèƒœåŒºï¼Œ1994å¹´è¢«å®šä¸ºå›½å®¶é‡ç‚¹é£æ™¯åèƒœåŒºï¼Œè£è·â€œä¸­å›½æœ€ç¾çš„äº”å¤§æ²™æ¼ ä¹‹ä¸€â€ç­‰è£èª‰ç§°å·ã€‚2015å¹´7æœˆ20æ—¥ï¼Œè¢«æ‰¹å‡†ä¸ºå›½å®¶AAAAAçº§æ—…æ¸¸æ™¯åŒºã€‚2016å¹´1æœˆï¼Œå›½å®¶æ—…æ¸¸å±€å’Œç¯ä¿éƒ¨æ‹Ÿè®¤å®šç”˜è‚ƒçœé…’æ³‰å¸‚é¸£æ²™å±±æœˆç‰™æ³‰æ™¯åŒºä¸ºå›½å®¶ç”Ÿæ€æ—…æ¸¸ç¤ºèŒƒåŒºã€‚</p>
<p>é—¨ç¥¨ï¼šè«é«˜çªŸ 200ï¼ˆæ·¡å­£ 100ï¼‰ï¼›é¸£æ²™å±±æœˆç‰™æ³‰ 110 éª†é©¼100</p>
<p>Day04</p>
<p>æ•¦ç…Œ â€” é˜³å…³ â€” é˜¿å…‹å¡ â€” çŸ³æ²¹å°é•‡ â€” å†·æ¹–é•‡ â€” å¤§æŸ´æ—¦</p>
<p>Day1:è¥¿å®-å¼ æ–--ä¸¹éœå£æ—…æ¸¸å°é•‡--ä¸ƒå½©ä¸¹éœ--å˜‰å³ªå…³</p>
<p>Day3ï¼šå˜‰å³ªå…³åŸæ¥¼--æ•¦ç…Œ--é¸£æ²™å±±ã€æœˆäº®æ³‰--æ•¦ç…Œ</p>
<p>Day4ï¼šæ•¦ç…Œ--è«é«˜çªŸ--çŸ³æ²¹å°é•‡--å¤§æŸ´æ—¦/å¾·ä»¤å“ˆ</p>
<p>Day5ï¼šå¤§æŸ´æ—¦/å¾·ä»¤å“ˆ--å¯é²å…‹æ¹–--èŒ¶å¡ç›æ¹–--èŒ¶å¡é•‡/å…±å’Œ</p>
<p>Day6ï¼šèŒ¶å¡/å…±å’Œ--é’æµ·æ¹–--é’æµ·æ¹–è¾¹æ²¹èœèŠ±ç”°--è—æ—æ°‘ä¿—æ‘--è¥¿å®</p>
<p>Day7ï¼šè¥¿å®--äº’åŠ©å½©è™¹éƒ¨è½--å¡”å°”å¯º</p>
<p>å¡”å°”å¯ºä½äºé’æµ·çœè¥¿å®å¸‚æ¹Ÿä¸­å¿é²æ²™å°”é•‡è¥¿å—éš…çš„è²èŠ±å±±å³ä¸­ã€‚å¡”å°”å¯ºé™¢ä¾å±±åŠ¿å»ºç­‘ï¼Œç”±ä¼—å¤šæ®¿å®‡ã€ç»å ‚ã€ä½›å¡”ã€åƒ§èˆç­‰ç»„æˆï¼Œå¸ƒå±€ä¸¥è°¨ï¼Œå»ºç­‘å·å³¨ï¼Œé‡‘ç¢§è¾‰ç…Œï¼Œæ°”åŠ¿æ¢å®ï¼Œæ˜¯æˆ‘å›½è‘—åçš„è—ä¼ ä½›æ•™æ ¼é²æ´¾å…­å¤§å¯ºé™¢ä¹‹ä¸€ã€‚å¡”å°”å¯ºæ˜¯é’æµ·çœä½›å­¦é™¢çš„æœ€é«˜å­¦åºœï¼Œç°è®¾æœ‰æ˜¾å®—ã€å¯†å®—ã€æ—¶è½®ã€åŒ»æ˜å››å¤§å­¦é™¢ï¼ˆç»é™¢ï¼‰ï¼Œè—è¯­åˆ†åˆ«ç§°ä¸ºå‚å°¼ã€å±…å·´ã€ä¸ç§‘ã€æ›¼å·´ceæœ­ä»“ã€‚</p>
<p>äºŒéƒå‰‘æ™¯åŒºä½äºæ·±å…¥<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/10799.html">é’æµ·æ¹–</a>ä¸­çš„ç‰¹æ®Šåœ°ç†ä½ç½®ï¼Œä»¥è‰åŸã€æ²™æ»©ã€åŠ¨æ¤ç‰©ä¸ºä¸»çš„ç”Ÿæ€è‡ªç„¶èµ„æºï¼Œä»¥æ°‘é—´æ–‡åŒ–æ´»åŠ¨ä¸ºå†…å®¹ï¼Œæˆä¸º<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/10799.html">é’æµ·æ¹–</a>æ—…æ¸¸åŒºä¸€é¢—è€€çœ¼çš„æ˜ç ã€‚ç›®å‰ï¼Œå·²ç»å»ºæˆäº†ä»¥è§‚é¸Ÿå°ã€è§‚é¹¿å›­ã€è§‚æµ·æ¡¥ã€è§‚æµ·äº­ä¸ºç»„åˆçš„è§‚èµåŒºï¼Œä»¥ç å¤´å¹¿åœºã€å‰ç¥¥å››ç‘é›•å¡‘ä¸ºç»„åˆçš„ä¼‘é—²åŒºã€ä»¥æ°´ä¸Šæ‘©æ‰˜ã€è‡ªé©¾æ¸¸è‰‡ä¸ºæ´»åŠ¨å†…å®¹çš„æ°´ä¸Šå¨±ä¹åŒºï¼Œå¯ä»¥è¿‘è·ç¦»æ¥è§¦åˆ°<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/10799.html">é’æµ·æ¹–</a>ã€‚</p>
<p>é»‘é©¬æ²³ä½äºè¥¿å®ä»¥è¥¿çº¦220å…¬é‡Œå¤„çš„<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/10799.html">é’æµ·æ¹–</a>è¾¹ï¼Œæ˜¯<a href="http://www.mafengwo.cn/travel-scenic-spot/mafengwo/10799.html">é’æµ·æ¹–</a>ç¯æ¹–å…¬è·¯çš„èµ·ç‚¹ï¼Œç”±æ­¤æ²¿ç¯æ¹–å…¬è·¯èµ°70å…¬é‡Œå¯è¾¾è‘—åçš„é¸Ÿå²›ï¼Œé»‘é©¬æ²³å¾€é¸Ÿå²›æ–¹å‘è¿™ä¸€æ®µï¼Œåˆè¢«ç§°ä¸ºç¯æ¹–è¥¿è·¯ï¼Œä¸å°‘&quot;æš´èµ°æ—&quot;é©´å‹æˆ–è‡ªè¡Œè½¦è¿·ï¼Œéƒ½é€‰æ‹©ä»é»‘é©¬æ²³å¼€å§‹ä»–ä»¬çš„ç¯æ¹–æ¢¦å¹»ä¹‹æ—…ã€‚</p>
<p>èŒ¶å¡ç›æ¹–ä½äºé’æµ·çœæµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·ä¹Œå…°å¿èŒ¶å¡é•‡é™„è¿‘ï¼Œç›æ¹–å››å‘¨é›ªå±±ç¯ç»•ï¼Œçº¯å‡€ã€è“ç™½ã€å€’å½±äº¤ç»‡ï¼Œæè‹¥ä¸€é¢å¤©ç„¶æ˜é•œã€‚å› å…¶æ—…æ¸¸èµ„æºç¦€èµ‹å¯ä¸ç»åˆ©ç»´äºšä¹Œå°¤å°¼ç›æ²¼ç›¸åª²ç¾ï¼Œäº«æœ‰ä¸­å›½&quot;å¤©ç©ºä¹‹é•œ&quot;ä¹‹ç¾ç§°ï¼Œæ˜¯&quot;é’æµ·å››å¤§æ™¯&quot;ä¹‹ä¸€ï¼Œæ˜¯å›½å®¶æ—…æ¸¸åœ°ç†æ‚å¿—è¯„é€‰çš„&quot;äººä¸€ç”Ÿå¿…å»çš„55ä¸ªåœ°æ–¹&quot;ä¹‹ä¸€ã€‚</p>
<p>ç¬¬ä¸€å¤©ï¼Œè¥¿å®å‡ºå‘ï¼Œå¡”å°”å¯ºï¼Œæ‹‰é¸¡å±±æ—…æ¸¸å…¬è·¯ï¼ŒäºŒéƒå‰‘151åŸºåœ°ã€åˆ°è¾¾é»‘é©¬æ²³ï¼Œä½é»‘é©¬æ²³ã€‚</p>
<p>ç¬¬äºŒå¤© é»‘é©¬æ²³çœ‹æ—¥å‡ºï¼ŒèŒ¶å¡ç›æ¹–ã€æŸ´è¾¾æœ¨ã€å¾·ä»¤å“ˆã€å¤–æ˜Ÿäººé—å€ã€ç¿¡ç¿ æ¹–,å¤§æŸ´æ—¦ä½å®¿ã€‚</p>
<p>ç¬¬ä¸‰å¤© å¤§æŸ´æ—¦å‡ºå‘ï¼Œé’æµ·é›…ä¸¹é­”é¬¼åŸï¼Œé˜³å…³ï¼Œæ•¦ç…Œå¤åŸï¼Œæ•¦ç…Œä½å®¿ï¼Œæ•¦ç…Œå¤œå¸‚ã€‚</p>
<p>ç¬¬å››å¤©ï¼Œè«é«˜çªŸï¼Œé¸£æ²™å±±ï¼Œæœˆç‰™æ³‰ï¼Œæ•¦ç…Œä½å®¿ã€‚</p>
<p>ç¬¬äº”å¤© æ•¦ç…Œå‡ºå‘ï¼Œå˜‰å³ªå…³åŸæ¥¼ã€ä¸ƒå½©ä¸¹éœåˆ°è¾¾å¼ æ–ã€‚</p>
<p>ç¬¬å…­å¤©  å¼ æ–å‡ºå‘ï¼Œæ‰éƒ½å£é£æ™¯æ—…æ¸¸åŒºã€ç¥è¿å±±å¤§è‰åŸã€é˜¿æŸ”å¤§å¯ºã€ç¥è¿å“å°”å±±é£æ™¯åŒºï¼Œä½ç¥è¿ã€‚</p>
<p>ç¬¬ä¸ƒå¤©ï¼Œç¥è¿å‡ºå‘ï¼Œå²—å¡ä»€é›ªå³°ï¼Œé—¨æºï¼Œé»‘æ³‰æ°´åº“ï¼Œåˆ°è¾¾è¥¿å®</p>
<p>Day1ï¼šè¥¿å®-é’æµ·æ¹–-èŒ¶å¡ç›æ¹–-å¾·ä»¤å“ˆ</p>
<p>Day2ï¼šç¿¡ç¿ æ¹–-Uå‹å…¬è·¯-ä¸œå°-æ°´ä¸Šé›…ä¸¹</p>
<p>Day3ï¼šè¥¿å°å‰ä¹ƒå°”æ¹–-ç«æ˜Ÿä¸€å·å…¬è·¯-ç«æ˜Ÿè¥åœ°</p>
<p>Day4ï¼šæ¶é­”ä¹‹çœ¼-å†·æ¹–-çŸ³æ²¹å°é•‡ é˜¿å…‹å¡è€å¿åŸ</p>
<p>Day5ï¼šæ•¦ç…Œè«é«˜çªŸ-é¸£æ²™å±±-æœˆç‰™æ³‰</p>
<p>Day6ï¼šæ•¦ç…Œ-å˜‰å³ªå…³-å¼ æ–ä¸ƒå½©ä¸¹éœ</p>
<p>Day7ï¼šå¼ æ–-é—¨æº-ç¥è¿å¤§è‰åŸ-è¥¿å®</p>
<p>ô²®ô²¯ô°šô±°ô³–ô´˜ô·ºô·»ô·¦ô³œô³ô³ô±«ô³Œô¶‰ô·¼ô³‘ô·½ô±‰ô±Šô±‹ô±«ô±‰ô±Šô±‹ô·¾ô·¿ô±¦ è¥¿å®*â€”30kmâ€”<em>å¡”å°”å¯º</em>â€”120kmâ€”<em>é’æµ·æ¹–ç•”</em>â€”80kmâ€”*é»‘é©¬æ²³ï¼Œå¤œå®¿é»‘é©¬æ²³ã€‚</p>
<p>æ—©æ™¨ 8 ç‚¹å·¦å³å‡ºå‘å³å¯ï¼Œå¡”å°”å¯ºæ¸¸ç©æ—¶é—´ä¸€èˆ¬åœ¨ 2 å°æ—¶ï¼Œç„¶åé©±è½¦å‰å¾€é’æµ·æ¹–ï¼Œä¸€è·¯è¾¹èµ°è¾¹ç©ï¼Œç»è¿‡æ—¥æœˆå±±ï¼Œåˆ°è¾¾é’æµ·æ¹–å—å²¸ã€‚åœ¨é’æµ·æ¹–è¾¹ï¼Œè¿‘è·ç¦»ä½“éªŒæ¹–æ°´ã€‚ç„¶ååˆ°è¾¾é»‘é©¬æ²³è¾¹ä½å®¿ä¼‘æ¯ï¼Œè¿˜èƒ½å†æ¬¡å»é’æµ·æ¹–è¾¹ï¼Œç»§ç»­æ¬£èµã€‚é—¨ç¥¨ï¼šå¡”å°”å¯º 80 å…ƒï¼›æ—¥æœˆå±± 40 å…ƒï¼›é’æµ·æ¹–äºŒéƒå‰‘ 100 å…ƒï¼›é’æµ·æ¹–è¿›å…¥ç‰§æ°‘å®¶ 20 å…ƒå·¦å³ï¼›</p>
<p>ä¸»è¦çœ‹ç‚¹ï¼šè—ä¼ ä½›æ•™å¡”å°”å¯ºã€é«˜åŸè“å®çŸ³é’æµ·æ¹–ã€é’æµ·æ¹–æ˜Ÿç©ºã€‚</p>
<p>é»‘é©¬æ²³*â€”80kmâ€”<em>èŒ¶å¡ç›æ¹–</em>â€”220kmâ€”<em>å¾·ä»¤å“ˆ</em>â€”240kmâ€”*å¤§æŸ´æ—¦é•‡ï¼›</p>
<p>ä»èŒ¶å¡ç›æ¹–å‡ºæ¥åï¼Œå°±å‘å¾·ä»¤å“ˆæ–¹å‘å»ã€‚å¾·ä»¤å“ˆæœ‰å¯é²å…‹æ¹–ã€æ‰˜ç´ æ¹–ã€å¤–æ˜Ÿäººé—å€ï¼Œéƒ½æ˜¯è·¯è¿‡å³å¯ï¼Œæ²¡å¿…è¦ä¹°ç¥¨è¿›å…¥ã€‚ç»è¿‡å¾·ä»¤å“ˆåä¸€è·¯ç›´å¥”å¤§æŸ´æ—¦ï¼Œè¿™ä¸ªå°é•‡å­ï¼Œæ¯å¹´å¤å­£æ¯å¤©æœ‰è¿‘ 1 ä¸‡äººå…¥ä½ã€‚</p>
<p>é—¨ç¥¨ï¼šèŒ¶å¡ç›æ¹– 70ï¼›å¯é²å…‹æ¹– 20</p>
<p>ä¸»è¦çœ‹ç‚¹ï¼šé»‘é©¬æ²³æ—¥å‡ºã€èŒ¶å¡ç›æ¹–ã€æˆˆå£å…¬è·¯</p>
<p>å¤§æŸ´æ—¦*â€”20kmâ€”<em>æŸ´è¾¾æœ¨ç›†åœ°å…¬è·¯</em>â€”200kmâ€”<em>é’æµ·å†·æ¹–é›…ä¸¹</em>â€”40kmâ€”<em>é˜¿å…‹å¡</em>â€”64kmâ€”<em>é˜³å…³é—å€</em>â€”63kmâ€”<em>æ•¦ç…Œå¸‚ï¼ˆæˆ–æ˜¯å¤§æŸ´æ—¦</em>â€”20kmâ€”<em>æŸ´è¾¾æœ¨ç›†åœ°å…¬è·¯</em>â€”240kmâ€”<em>é˜¿å…‹å¡</em>â€”122kmâ€”<em>ç‰é—¨å…³</em>â€”60kmâ€”<em>æ•¦ç…Œé›…ä¸¹é­”é¬¼åŸ</em>â€”170kmâ€”*æ•¦ç…Œå¸‚ï¼‰ï¼›</p>
<p>è¿™ä¸¤ä¸ªèµ°æ³•çš„ä¸»è¦å·®åˆ«åœ¨äºâ€”â€”é›…ä¸¹ï¼Œä½ æ˜¯èµ°é’æµ·çš„å†·æ¹–é›…ä¸¹ï¼Œè¿˜æ˜¯èµ°æ•¦ç…Œçš„é›…ä¸¹ã€‚ä¸¤å¤„é›…ä¸¹å„æœ‰ä¼˜åŠ£ï¼Œç›®å‰æ¥è¯´å¤§ç¯çº¿å¤šæ•°éƒ½æ˜¯èµ°é’æµ·é›…ä¸¹ã€‚åŸå› æœ‰ä¸‰ï¼šæ— éœ€é—¨ç¥¨ï¼Œå¯ä»¥éšä¾¿è¿›å…¥ï¼›äºšæ´²è§„æ¨¡æœ€å¤§ï¼›è·¯ç¨‹è½»æ¾äº›ã€‚æ•¦ç…Œé›…ä¸¹è¿›å…¥æ˜¯æ†ç»‘ç‰é—¨å…³çš„é—¨ç¥¨ã€‚æ•¦ç…Œé›…ä¸¹æ°”åŠ¿æ›´å‡Œäººï¼Œä½†ç‰é—¨å…³è‹¥ä¸æ˜¯å‡ å¥è¯—è¯ï¼Œç¡®æ˜¯æœ‰äº›ä¸å°½äººæ„çš„ã€‚</p>
<p>ä»å¤§æŸ´æ—¦é•‡å‡ºæ¥åï¼Œå°±æ˜¯åœ¨æŸ´è¾¾æœ¨ç›†åœ°çš„å¤–ä¾§äº†ï¼Œå…¬è·¯ç¬”ç›´çš„å»¶ä¼¸åœ¨æˆˆå£æ»©ä¸Šï¼Œé›…ä¸¹åœ°è²Œæ’åˆ—åœ¨è·¯çš„ä¸¤è¾¹ã€‚åˆ°è¾¾å†·æ¹–åï¼Œé’æµ·çš„é›…ä¸¹åœ°è²Œç¾¤å°½æ˜¾ï¼Œå£®è§‚å¨ä¸¥ã€‚åˆ° â€œè¥¿å‡ºé˜³å…³æ— æ•…äººâ€ çš„é˜³å…³åï¼Œå†ä¸€èµå¤äººé¢å¯¹æˆˆå£çš„æ— é™è‹å‡‰ã€‚ç„¶åå…¥ä½æ•¦ç…Œï¼Œå°½äº«ç¹åã€‚</p>
<p>é—¨ç¥¨ï¼šé’æµ·é›…ä¸¹é­”é¬¼åŸå…è´¹ï¼Œé˜³å…³é—å€ 60ï¼Œç‰é—¨å…³ 40</p>
<p>ä¸»è¦çœ‹ç‚¹ï¼šé’æµ·é›…ä¸¹ã€æŸ´è¾¾æœ¨ç›†åœ°å…¬è·¯ç‰‡ã€é˜³å…³</p>
]]></content>
    </entry>
</feed>